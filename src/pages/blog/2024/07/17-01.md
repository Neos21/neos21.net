---
title        : Cloudflare D1 ã‚’ Alpha ç‰ˆã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆã™ã‚‹
created      : 2024-07-17
last-modified: 2024-07-17
header-date  : true
path:
  - /index.html Neo's World
  - /blog/index.html Blog
  - /blog/2024/index.html 2024å¹´
  - /blog/2024/07/index.html 07æœˆ
---

**[æ‡ã‹ã—æ²ç¤ºæ¿ BBS(https://legacy-of-bbs.pages.dev/)** ã§ä½¿ã£ã¦ã„ã‚‹ Cloudflare D1ã€‚SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã ãŒã€ã‚³ãƒãƒ©ã® Alpha ç‰ˆãŒ 2024-08-15 ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦æ­£å¼ç‰ˆã«ãªã‚‹ã‚ˆã†ã§ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã­ã¨é€šçŸ¥ãŒæ¥ãŸã®ã§å¯¾å¿œã™ã‚‹ã€‚

- å‚è€ƒ : [Cloudflare D1 docs - Alpha database migration guide](https://developers.cloudflare.com/d1/platform/alpha-migration/)
  - ã‚³ãƒãƒ©ã®å…¬å¼ã®æ‰‹é †ã«æ²¿ã£ã¦ä½œæ¥­ã—ãŸã®ã¿

---

- Prerequisites : äº‹å‰æº–å‚™
  - Wrangler CLI ã®æœ€æ–°ç‰ˆã‚’å…¥ã‚Œã¦ãŠã

```bash
$ npm install -g wrangler
$ wrangler -v

 â›…ï¸ wrangler 3.64.0
```

- 1. Verify that a database is alpha : ä½œæ¥­å‰ã®çŠ¶æ…‹ç¢ºèª
  - `version` ãŒ `alpha` ãªã“ã¨ãŒåˆ†ã‹ã‚‹

```bash
$ wrangler d1 info legacy-of-bbs

 â›…ï¸ wrangler 3.64.0
-------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DB            â”‚ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ name          â”‚ legacy-of-bbs                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ created_at    â”‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ version       â”‚ alpha                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ num_tables    â”‚ 3                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ database_size â”‚ 344 kB                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- 2. Create a manual backup : ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹

```bash
$ wrangler d1 backup create legacy-of-bbs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ created_at               â”‚ id                                   â”‚ num_tables â”‚ size   â”‚ state â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2024-07-16T09:28:06.983Z â”‚ yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy â”‚ 3          â”‚ 344 kB â”‚ done  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

- 3. Download the manual backup : ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

```bash
$ wrangler d1 backup download legacy-of-bbs yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy
ğŸŒ€ Downloading backup yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy from 'legacy-of-bbs'
ğŸŒ€ Saving to /home/neo/Documents/Dev/GitHub/legacy-of-bbs/legacy-of-bbs.yyyyyyyy.sqlite3
ğŸŒ€ Done!
```

- 4. Convert the manual backup into SQL statements : `.sqlite3` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `.sql` ãƒ•ã‚¡ã‚¤ãƒ« (SQL æ–‡) ã«å¤‰æ›ã™ã‚‹

```bash
$ sqlite3 --version
3.42.0 2023-05-16 12:36:15 831d0fb2836b71c9bc51067c49fee4b8f18047814f2ff22d817d25195cf350b0
$ sqlite3 ./legacy-of-bbs.yyyyyyyy.sqlite3 .dump > db.sql
```

- 4.1. Remove `BEGIN TRANSACTION` and `COMMIT;` from the file.
  - ç”Ÿæˆã—ãŸ `db.sql` ã‹ã‚‰ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ–‡ã‚’æ¶ˆã™
- 4.2. Remove the following table creation statement: `CREATE TABLE _cf_KV`
  - `_cf_KV` ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©ã¯ãªã‹ã£ãŸã®ã§ç„¡è¦–
- 5. Create a new D1 database : æ–°ãŸãª DB ã‚’ä½œã‚‹

```bash
$ wrangler d1 create legacy-of-bbs-20240716

 â›…ï¸ wrangler 3.64.0
-------------------

âœ… Successfully created DB 'legacy-of-bbs-20240716' in region APAC
Created your new D1 database.

[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "legacy-of-bbs-20240716"
database_id = "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"
```

- 6. Run SQL statements against the new D1 database : SQL æ–‡ã‚’æµã™

```bash
$ wrangler d1 execute legacy-of-bbs-20240716 --remote --file=./db.sql

 â›…ï¸ wrangler 3.64.0
-------------------

âœ” âš ï¸ This process may take some time, during which your D1 database will be unavailable to serve queries.
  Ok to proceed? â€¦ yes
ğŸŒ€ Executing on remote database legacy-of-bbs-20240716 (zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz):
ğŸŒ€ To execute on your local development database, remove the --remote flag from your wrangler command.
Note: if the execution fails to complete, your DB will return to its original state and you can safely retry.
â”œ ğŸŒ€ Uploading zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz.zzzzzzzzzzzzzzzz.sql 
â”‚ ğŸŒ€ Uploading complete.
â”‚ 
ğŸŒ€ Starting import...
ğŸš£ Executed 1166 queries in 0.04 seconds (2163 rows read, 2251 rows written)
   Database is currently at bookmark 00000000-0000000f-00004dd0-843e4bf18c5f1d42f18aafa13380ea18.
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Total queries executed â”‚ Rows read â”‚ Rows written â”‚ Database size (MB) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1166                   â”‚ 2163      â”‚ 2251         â”‚ 0.27               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- 7. Delete your alpha database : å¤ã„ DB ã‚’æ¶ˆã™

```bash
$ wrangler d1 delete legacy-of-bbs
```

- æ–° DB ã‚’ç¢ºèªã™ã‚‹

```bash
$ wrangler d1 info legacy-of-bbs-20240716

 â›…ï¸ wrangler 3.64.0
-------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DB                â”‚ zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ name              â”‚ legacy-of-bbs-20240716               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ created_at        â”‚ 2024-07-16T09:34:13.005Z             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ num_tables        â”‚ 4                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ running_in_region â”‚ APAC                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ database_size     â”‚ 274 kB                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ read_queries_24h  â”‚ 0                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ write_queries_24h â”‚ 1                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rows_read_24h     â”‚ 2,163                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rows_written_24h  â”‚ 2,251                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ã¨ã„ã†ãƒ¯ã‚±ã§ã€Alpha ç‰ˆã® DB ã‹ã‚‰ SQL æ–‡ã‚’å‡ºåŠ›ã—ã¦ã€æ–° DB ã‚’ç«‹ã¦ã¦ãã¡ã‚‰ã«æµã™ã€ã¨ã„ã†åŸå§‹çš„ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•ã ã£ãŸã€‚

ã‚ã¨ã¯ Cloudflare Pages ã§æ–° DB ã‚’æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ç’°å¢ƒè¨­å®šã‚’ã—ç›´ã—ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°ä½œæ¥­å®Œäº†ã€‚
