---
title        : Flask RESTful ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹
created      : 2020-02-21
last-modified: 2020-02-21
header-date  : true
path:
  - /index.html Neo's World
  - /blog/index.html Blog
  - /blog/2020/index.html 2020å¹´
  - /blog/2020/02/index.html 02æœˆ
hidden-info:
  original-blog: Corredor
---

Flask RESTful (`pipenv install flask_restful`) ã®å°ãƒã‚¿ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¿œã˜ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¤‰ãˆã¦ã„ããŒã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã‚„ã€ä¸­ã§ã®å‡¦ç†ã«å¤±æ•—ã—ãŸæ™‚ã«ã€403 ã¨ã‹ 500 ã¨ã‹ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ãŸã„ã“ã¨ãŒã‚ã‚‹ã€‚Flask RESTful ã§ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚Œã°ä¸Šæ‰‹ãã„ãã€‚

```python
from flask import Blueprint, request
from flask_restful import Api, Resource

# BitFlyer API
import pybitflyer
bit_flyer_api = pybitflyer.API()

# Blueprint
blueprint_api = Blueprint('api', __name__, url_prefix = '/api')
api = Api(blueprint_api)

# æŒ‡å®šã®ä»®æƒ³é€šè²¨ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹ (pybitflyer ä½¿ç”¨)
class Rate(Resource):
  def get(self, code):
    try:
      if(code == 'btc'):
        return { 'code': code, 'bid': str(bit_flyer_api.ticker(product_code = 'BTC_JPY')['best_bid']) }
      if(code == 'eth'):
        return { 'code': code, 'bid': str(bit_flyer_api.ticker(product_code = 'ETH_JPY')['best_bid']) }
      
      return { 'message': 'Unknown code' }, 403
    except:
      return { 'message': 'Failed to get ticker' }, 500
api.add_resource(Rate, '/rate/<string:code>')
```

ã“ã® API ã¯ã€

- `http://localhost:5000/api/rate/btc`
- `http://localhost:5000/api/rate/eth`

ã¨ã„ã£ãŸ URL ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€pybitflyer ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦å–å¾—ã—ãŸã€ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã®æƒ…å ±ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã€‚

```json
// http://localhost:5000/api/rate/btc ã‚’ã‚³ãƒ¼ãƒ«ã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
{
  "code": "btc",
  "bid" : "10000.5"
}
```

- å‚è€ƒ : [Quickstart â€” Flask-RESTful 0.3.6 documentation](https://flask-restful.readthedocs.io/en/0.3.6/quickstart.html#resourceful-routing)
  - `api.add_resource(Rate, '/rate/<string:code>')` éƒ¨åˆ†ã® *Resourceful Routing* ã§å®Ÿç¾ã—ã¦ã„ã‚‹

ã§ã€`btc` ã§ã‚‚ `eth` ã§ã‚‚ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚‚ã‚‰ã£ãŸå ´åˆã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¶³ã‚Šãªã„ã¨ã„ã†ã“ã¨ã§ 403 ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ãŸã„ã€‚ã‚„ã‚Šæ–¹ã‚’è‰²ã€…èª¿ã¹ãŸãŒã€**Flask RESTful ã®å ´åˆã¯ `jsonify()` ã‚„ `json.dumps()` ã§å‡¦ç†ã™ã‚‹ã“ã¨ãªãç›´æ¥é€£æƒ³é…åˆ—ã‚’ `return`** ã—ã¦ã‚„ã‚Šã€*`return` ã®2ã¤ç›®ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã™ã‚‹*ã“ã¨ã§å®Ÿç¾ã§ããŸã€‚

```python
# ã“ã®éƒ¨åˆ† â†“
return { 'message': 'Unknown code' }, 403
```

ã¤ã„ã§ã«ã€`try`ãƒ»`except` ã‚’ä½¿ã£ã¦ã€pybitflyer ã®å‡¦ç†ã«å¤±æ•—ã—ãŸæ™‚ã¯ 500 ã‚’è¿”ã™ã‚ˆã†å®Ÿè£…ã—ãŸã€‚

```python
return { 'message': 'Failed to get ticker' }, 500
```

ã“ã® `return` éƒ¨åˆ†ã§

- `flask.jsonify({ 'message': '...' })`
- `json.dumps({ 'message': '...' })`

ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã—ã¾ã†ã¨ã€Flask RESTful ã®å ´åˆã¯ `TypeError` ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ãã®ã¾ã¾é€£æƒ³é…åˆ—ã‚’æ›¸ã‘ã°è‰¯ã„ã€‚

- [Flask ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¡ãƒ¢ - ã‚ˆã†ã¸ã„ã®æ—¥ã€…ç²¾é€²XP](https://inokara.hateblo.jp/entry/2016/10/01/123923)
  - Flask ã®å ´åˆã€‚`abort()` ã‚’ä½¿ã†æ‰‹æ³•
- [flaskã§httpã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”å´ã™ã‚‹æ–¹æ³• - Qiita](https://qiita.com/mink0212/items/52e0ebd66bd94e1303c1)
  - Flask ã®å ´åˆã€‚`return` ã®2ã¤ç›®ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã™ã‚‹
- [python - Flask API TypeError: Object of type 'Response' is not JSON serializable - Stack Overflow](https://stackoverflow.com/questions/44430906/flask-api-typeerror-object-of-type-response-is-not-json-serializable)
  - `is not JSON serializable` ã¨ã„ã£ãŸã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦æ³•ã‚’èª¿ã¹ã¦ã„ãŸæ™‚ã®è¨˜äº‹
- [Flask RESTfulã‚’è©¦ã™ - CLOVERğŸ€](https://kazuhira-r.hatenablog.com/entry/2019/08/14/235805)
  - ã‚³ãƒ¬ãŒç­”ãˆã ã£ãŸ

ã¤ã„ã§ã«ã€Flask ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ‡å®šã§ã¯5000ç•ªãƒãƒ¼ãƒˆã§ã‚µãƒ¼ãƒãŒèµ·å‹•ã™ã‚‹ãŒã€ã‚³ãƒ¬ã¯å¤–éƒ¨å…¬é–‹ã•ã‚Œã¦ã„ãªã„ã®ã§ã€80ç•ªãƒãƒ¼ãƒˆã§å¤–éƒ¨ã«å…¬é–‹ã—ãŸã„ã€ã¨ã„ã£ãŸå ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```python
# ã‚µãƒ¼ãƒã‚’èµ·å‹•ã™ã‚‹
if __name__ == '__main__':
  app.run(debug = False, host = '0.0.0.0', port = 80)
```

- å‚è€ƒ : [Flaskã®ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨å…¬é–‹ã•ã‚Œã¦ãªã„ - Qiita](https://qiita.com/tomboyboy/items/122dfdb41188176e45b5)

ã‚¦ã‚§ãƒ«ãƒã‚¦ãƒ³ãƒ»ãƒãƒ¼ãƒˆã§å…¬é–‹ã™ã‚‹å ´åˆã¯ root ãƒ¦ãƒ¼ã‚¶ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
