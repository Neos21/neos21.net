---
title        : シェルスクリプトファイルに実行権限を付与する意味は？
created      : 2020-09-17
last-modified: 2020-09-17
header-date  : true
path:
  - /index.html Neo's World
  - /blog/index.html Blog
  - /blog/2020/index.html 2020年
  - /blog/2020/09/index.html 09月
hidden-info:
  original-blog: Corredor
---

実行権限が必要な理由を考えた。

## 目次

## 疑問

Linux で、次のようなシェルスクリプトを書いた。

```bash
#!/bin/bash

echo 'Hello World'
```

コレを `example` という拡張子なしのファイル名で保存し、ターミナルで次のように実行した。

```bash
$ bash ./example
```

続いて、このファイルに__実行権限__を付与し、次のように実行してみた。

```bash
$ chmod 755 ./example
$ ./example
```

正しく実行できる。

さらに、このファイルを PATH が通っている `${HOME}/bin/` 配下に移動し実行してみる。

```bash
$ mv ./example "${HOME}/bin/"
$ example
```

PATH が通っているので実行できた。

そしたら、今度は実行権限を外してみる。

```bash
$ chmod 644 "${HOME}/bin/example"
$ example
-bash: /Users/Neo/bin/example: Permission denied
```

今度は実行権限がなく動かせなくなってしまった。

でも、

```bash
$ bash "${HOME}/bin/example"
```

と書いたら実行できる。

…はて、_ファイルの実行権限_とは何なのだろう。

__シェルスクリプトの場合は `bash` コマンドを使ってやれば、実行権限がなくとも実行できるが、何のために実行権限を付けるのだろう？__

## ユーザがインタプリタを知らずに実行できるようになる

自分が書いた Bash スクリプトを見ると、

```bash
$ chmod 755 ./example && ./example
$ bash ./example
```

どっちでも実行できるならわざわざ実行権限なんて付与せず `bash` コマンドで動かしたらいいじゃーん、と思ってしまいがち。

だが、この場合の問題は__そのファイルを本当に `bash` コマンドで実行できるのかを事前に知っておかないといけない__ということ。

`example` というファイル名だけでは、その中身が Bash 製なのか Ruby 製なのか、区別が付かない。シェル環境の場合、通常は拡張子を見て実行するソフトを切り替えたりはしないので、その代わりにファイルの1行目に_シバン (Shebang)_ を書いて、インタプリタを知らせるワケだ。

実行権限を付与し、ファイル名のみを指定して実行した場合は、シバンで指定されたインタプリタを自動的に利用してプログラムが動く。これが実行権限の効果である。

- 参考：[linux - Why do we need execution permission although we can run any script without it using "bash script file"? - Stack Overflow](https://stackoverflow.com/questions/40534795/why-do-we-need-execution-permission-although-we-can-run-any-script-without-it-us)

## バイナリファイルを実行して良いかどうかの目印

コレまでシェルスクリプトを前提に話してきたが、コレがバイナリ形式の実行ファイルだったらどうか。

ユーザが何らかの方法で Read (読み取り) しようとしているのか、それともそのバイナリ自体を実行しようとしているのか、を区別してやる必要がある。Read と Write のパーミッションだけではそれを区別できないために、実行権限が存在するという考え。

また、最近だとついつい自分のローカルマシンで、自分が唯一のユーザであり管理者である、という環境が多いが、管理ユーザと一般ユーザがいるようなサーバを考えてみると、「一般ユーザはこのバイナリを実行するのは許可するけど、ファイルとしての読み出しは禁止する」といった時に、実行権限のみ付与して読み取り権限を外したりして制御できる。ファイルをコピーされてリバースエンジニアリングされたりとか、余計な操作をされないように制御できるワケだ。

- 参考：[読み取り権限がなく実行権限だけのファイルが実行できるのはなぜ？ - カーネルのソースを読む - - 猫型の蓄音機は 1 分間に 45 回にゃあと鳴く](https://nekogata.hatenablog.com/entry/2014/03/28/060547)

今日ではそのような状況が少ないが、そうした制御も出来るようになっているようだ。

## インタプリタで実行するスクリプトは読み込み権限と実行権限が必要

前述の参考文献で改めて気付いたが、ファイルの1行目にシバンを書くようなスクリプトファイルの場合、

- シェルが fork して exec する
- 1行目のシバンを読み取り、そのインタプリタに処理を任せる
  - ココまでは実行権限によって動作する
- 処理を任されたインタプリタがファイルを読み取り、実行していく
  - ココでインタプリタにとって読み取り権限が必要になる

というワケで、読み取り権限と実行権限の両方がないと、スクリプトファイルの場合は実行できない。

`$ bash example` と書いた場合は、インタプリタを指定しているので実行権限は要らず、読み取り権限によってインタプリタがファイルを読み込んで実行できるので、読み取り権限だけで動作するというワケ。

## 腑に落ちた？

なんだかほぼほぼ腑に落ちたような、まだちょっとだけ腑に落ちないような。

自分がシェルスクリプトを作って配布する時は、意図せずうっかり実行されないようにという思いから、実行権限は付与せずに渡して、

```bash
$ bash ./example
```

で動かしてね、とお願いすることが多いのだが、コレが親切なのか分からなくなってきた。

シバンは `#!/bin/bash` でちゃんと Bash を指定して書いていることだし、実行権限は付与しておいて

```bash
$ ./example
```

で実行してください、と伝えた方がシンプルなのかもしれない。

どっちが良いのかなー。

- 参考：[reason to add execute permissions to a shell script - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/351263/reason-to-add-execute-permissions-to-a-shell-script)
