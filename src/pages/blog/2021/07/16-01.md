---
title        : Cloudflare Workers ã«ã‚ˆã‚‹ FaaSãƒ»Cloudflare Workers KV ã«ã‚ˆã‚‹ Key-Value Store ã‚’è©¦ã—ã¦ã¿ãŸ
created      : 2021-07-16
last-modified: 2021-07-16
header-date  : true
path:
  - /index.html Neo's World
  - /blog/index.html Blog
  - /blog/2021/index.html 2021å¹´
  - /blog/2021/07/index.html 07æœˆ
---

CDN ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ _Cloudflare_ ã ãŒã€æœ€è¿‘ä»¥ä¸‹ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã—ã¦ã„ã‚‹ã€‚

- Cloudflare Workers : FaaSãƒ»Functions
- Cloudflare Workers KV : Key-Value Storeãƒ»NoSQL
- Cloudflare Pages : Static Website Hosting
- Cloudflare Web Analytics : Web Analytics

ã„ãšã‚Œã‚‚ç„¡æ–™æ ãŒã‚ã‚Šã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰å…¥åŠ›ã‚‚ãªãç„¡æ–™ã§åˆ©ç”¨ã—å§‹ã‚ã‚‰ã‚Œã‚‹ã®ãŒç‰¹å¾´ã€‚

ä»Šå›ã¯ã“ã®ä¸­ã®ä¸Š2ã¤ã€FaaS ã¨ NoSQL ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ã€_Cloudflare Workers_ ãŠã‚ˆã³ __Cloudflare Workers KV__ ã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚

## ç›®æ¬¡

## Cloudflare ã¸ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²

äºˆã‚ã€Cloudflare ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¦ãŠã“ã†ã€‚

- [Cloudflare - The Web Performance & Security Company | Cloudflare](https://www.cloudflare.com/)

æ™®é€šã« Sign Up ã™ã‚‹ã ã‘ã€‚ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰å…¥åŠ›ãŒå¿…è¦ãªãã¦å®‰å¿ƒã€‚

## ä»•æ§˜ã¨åˆ¶ç´„

Workersãƒ»Workers KV ã¨ã‚‚ã«ã€ç„¡æ–™æ ã§ã¯ã„ãã¤ã‹ã®åˆ¶é™äº‹é …ãŒã‚ã‚‹ã€‚å‰è¿°ã®ã¨ãŠã‚Šã‚¯ãƒ¬ã‚«å…¥åŠ›ã—ã¦ã„ãªã„ã®ã§ã€ã„ããªã‚Šèª²é‡‘ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã¯ãªã„ãŒã€å¤§è¦æ¨¡ãªã‚¢ãƒ—ãƒªã‚’ç„¡æ–™æ ã§å‹•ã‹ãã†ã¨ã™ã‚‹ã®ã¯ç„¡ç†ãŒã‚ã‚‹ã®ã§ã€ã‚ˆãã‚ˆãæ³¨æ„ã—ã¦ã»ã—ã„ã€‚

åˆã‚ã« Workers ã®åˆ¶é™ã‚’ç¢ºèªã™ã‚‹ã€‚

- [Cloudflare WorkersÂ®](https://workers.cloudflare.com/)
- [Limits Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/platform/limits)
  - é…ç½®ã§ãã‚‹ Workers ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯30å€‹ã¾ã§
  - 1æ—¥10ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
  - 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ãŸã‚Š 10ms ä»¥å†…ã«å‡¦ç†ã™ã‚‹ã“ã¨ (åŒæœŸå‡¦ç†ã«ã‹ã‹ã‚‹æ™‚é–“ã‚‰ã—ã„ãƒ»æœ‰æ–™ç‰ˆã§ã‚‚ 50ms ãŒä¸Šé™)
  - Workers ã®ãƒ¡ãƒ¢ãƒªã¯ 128MB (ã‚³ãƒ¬ã¯æœ‰æ–™ç‰ˆã§ã‚‚åŒã˜)

â†’ AWS Lambda ãªã©ã¨æ¯”ã¹ã‚‹ã¨ãƒ¡ãƒ¢ãƒªãŒå°‘ãªãã€å®Ÿè¡Œæ™‚é–“ã®åˆ¶ç´„ã‚‚å³ã—ã‚ã€‚ã‚´ãƒªã‚´ãƒªã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã‚’ã‚„ã‚‰ã›ã‚‹ç”¨é€”ã«ã¯å‘ã‹ãšã€ãƒ—ãƒ­ã‚­ã‚·çš„ãªåˆ©ç”¨ãŒã‚®ãƒªã‚®ãƒªã ã‚ã†ã€‚ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰é›†ã‚‚å‚è€ƒã«ã€‚

- [Examples Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/examples)

æ¬¡ã« Workers KV ã®åˆ¶é™ã€‚

- [Cloudflare Workers KV | Serverless Computing | Cloudflare](https://www.cloudflare.com/products/workers-kv/)
- [KV - Limits Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/platform/limits#kv)
  - å®¹é‡ 1GB ã¾ã§
  - 1æ—¥ã‚ãŸã‚Š10ä¸‡å›ã®èª­ã¿å–ã‚Šã€1,000å›ã®æ›¸ãè¾¼ã¿ãŒä¸Šé™
  - 1ã¤ã® Value ã«ç™»éŒ²ã§ãã‚‹ã®ã¯ 25MB ã¾ã§

èª­ã¿æ›¸ãã®å›æ•°ã«ä¸Šé™ãŒã‚ã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®å¤šã„ã‚¢ãƒ—ãƒªã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ãŠã†ã¨ã™ã‚‹ã¨ã€ã™ããƒ¬ãƒ¼ãƒˆåˆ¶é™ã«å¼•ã£æ›ã‹ã£ã¦ã—ã¾ã†ã ã‚ã†ã€‚

## CLI ãƒ„ãƒ¼ãƒ«ã€ŒWranglerã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã‹ã‚‰ã§ã‚‚ä½œæˆã§ãã‚‹ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒãŒç”¨æ„ã§ããŸã‚Šã—ã¦ä¾¿åˆ©ãªã®ã§ã€Cloudflare ãŒæä¾›ã™ã‚‹å…¬å¼ CLI ãƒ„ãƒ¼ãƒ«ã® __Wrangler__ ã‚’ä½¿ã£ã¦ã„ãã€‚

- [Install / Update Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/cli-wrangler/install-update)

npm ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°è‰¯ã„ãŒã€è£ã¯ Rust è£½ãªã®ã§ Cargo ã§ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã¿ãŸã„ã€‚

```bash
$ npm i -g @cloudflare/wrangler

$ wrangler --version
wrangler 1.17.0
```

## Wrangler ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹

ç¶šã„ã¦ã€`wrangler login` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€‚

- [Authentication Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/cli-wrangler/authentication)
  - WSL ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€ã€ŒUbuntuã€ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã€‚VSCode çµ±åˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã‹ãšã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒé€²ã¾ãªã‹ã£ãŸ

```bash
$ wrangler login
Allow Wrangler to open a page in your browser? [y/n]
y
ğŸ’  Opened a link in your default browser: https://dash.cloudflare.com/wrangler?ã€â€¦â€¦ã€‘
â ’   Waiting for API token...

# ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã®ã§è¨±å¯ã‚’é€²ã‚ã¦ã„ã

ğŸ’  Validating credentials...
âœ¨  Successfully configured. You can find your configuration file at: /home/neo/.wrangler/config/default.toml

# ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›¸ã‹ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ã¦ã„ã‚‹ã®ã§ç¢ºèªã™ã‚‹
$ cat ~/.wrangler/config/default.toml
api_token = "ã€API ãƒˆãƒ¼ã‚¯ãƒ³ã€‘"

# ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã‚’ç¢ºèªã™ã‚‹
$ wrangler whoami

  â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  â”‚                                                                                                  â”‚
  â”‚      ğŸ‘‹  You are logged in with an API Token, associated with the email 'neos21@gmail.com'!      â”‚
  â”‚                                                                                                  â”‚
  â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

+----------------------------+----------------------------------+
| Account Name               | Account ID                       |
+----------------------------+----------------------------------+
| Neos21@gmail.com's Account | ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ IDã€‘                |
+----------------------------+----------------------------------+
```

ã“ã‚“ãªæ„Ÿã˜ã€‚

è©¦ã—ã« KV ã‚’ä½œã£ã¦ã¿ã‚‹ã‹ã¨æ€ã£ãŸã‘ã©ã€KV ã¯ Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã‹ã‚‰ã§ãªã„ã¨ä½œæˆã§ããªã‹ã£ãŸã€‚__KV ã¯ç´ä»˜ã‘ãŸ Workers ã‹ã‚‰ã®ã¿å‘¼ã³å‡ºã—ãŒã§ãã‚‹__ã‚ˆã†ã ã€‚

```bash
# KV ã‹ã‚‰å…ˆã«ã¯ä½œã‚Œãªã„
$ wrangler kv:namespace create practice
Error: wrangler.toml not found
```

## Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

ã¨ã„ã†ãƒ¯ã‚±ã§ã€å…ˆã« `wrangler generate` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ã€‚

```bash
# Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ã€‚ã“ã®æ™‚ç‚¹ã§ã¯ Publish ã¯ã•ã‚Œã¦ãŠã‚‰ãšãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ä½•ã‚‚å‡ºãªã„
$ wrangler generate practice
 Creating project called `practice`...
 Done! New project created /home/neo/practice
ğŸ•µï¸  You can find your zone_id in the right sidebar of a zone's overview tab at https://dash.cloudflare.com
ğŸ•µï¸  You can copy your account_id below
+----------------------------+----------------------------------+
| Account Name               | Account ID                       |
+----------------------------+----------------------------------+
| Neos21@gmail.com's Account | ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ IDã€‘                |
+----------------------------+----------------------------------+
ğŸ•µï¸  You will need to update the following fields in the created wrangler.toml file before continuing:
- account_id
```

ã‚³ãƒãƒ³ãƒ‰ã§æŒ‡å®šã—ãŸåå‰ã©ãŠã‚Šã€`practice/` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã§ãã€ãã®ä¸‹ã«å„ç¨®ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹æƒ…å ±ã¯ã€_`wrangler.toml`_ ã¨ã„ã†è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ã„ãã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã‚„ã‚¾ãƒ¼ãƒ³ ID ãªã©ã€ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã£ã½ã„é›°å›²æ°—ã®é …ç›®ã‚‚ã‚ã‚‹ã®ã ãŒã€ã“ã‚Œã‚‰ã¯ `wrangler.toml` ã«ãƒ™ã‚¿æ›¸ãã—ã¦ GitHub å…¬é–‹ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚

- å‚è€ƒï¼š[whoami should display `account_id` Â· Issue #630 Â· cloudflare/wrangler](https://github.com/cloudflare/wrangler/issues/630)
- å‚è€ƒï¼š[wrangler.toml Secrets Â· Issue #17 Â· cloudflare/wrangler-action](https://github.com/cloudflare/wrangler-action/issues/17)

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã‚’ã€ç”Ÿæˆã•ã‚ŒãŸ `wrangler.toml` ã«è¨˜è¼‰ã™ã‚‹ã€‚ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é©å½“ã«èª¿æ•´ã—ãŸã€‚

- `wrangler.toml`

```toml
name = "practice"
type = "javascript"

account_id = "07100c21a5c21a0afb93ab435ba46712"
workers_dev = true
route = ""
zone_id = ""
```

- `index.js`

```javascript
/**
 * Main
 */
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

/**
 * Response With Hello World Text
 * 
 * @param {Request} _request Request
 */
async function handleRequest(_request) {
  return new Response('Hello World', {
    headers: { 'content-type': 'text/plain' }
  });
}
```

## ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã—ã¦ã¿ã‚‹

ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”¨æ„ã§ããŸã‚‰ã€`wrangler dev` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã« Workers ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã‚‹ã€‚

```bash
$ wrangler dev
ğŸ’  watching "./"
ğŸ‘‚  Listening on http://127.0.0.1:8787
[2021-07-08 09:38:39] GET practice.neos21.workers.dev/ HTTP/1.1 200 OK
[2021-07-08 09:38:40] GET practice.neos21.workers.dev/favicon.ico HTTP/1.1 200 OK
```

`http://127.0.0.1:8787/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`Hello World` ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã£ãŸã€‚`index.js` ã®å†…å®¹ã«æ²¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå‡¦ç†ã•ã‚Œã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã€‚

## Cloudflare Workers ã«å…¬é–‹ã™ã‚‹

å‹•ä½œç¢ºèªãŒã§ããŸã‚‰ã€`wrangler publish` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿéš›ã«å…¬é–‹ã—ã¦ã¿ã‚‹ã€‚

```bash
$ wrangler publish
âœ¨  Basic JavaScript project found. Skipping unnecessary build!
âœ¨  Successfully published your script to
 https://practice.neos21.workers.dev
```

ã‚³ãƒ¬ã§å…¬é–‹ã§ããŸã€‚<https://practice.neos21.workers.dev/> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ `Hello World` ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã£ãŸã€‚

ãƒ–ãƒ©ã‚¦ã‚¶ã§è¦‹ã‚‰ã‚Œã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚åˆå›è¡¨ç¤ºã¾ã§ã¯2ãƒ»3åˆ†å¾…ã¤å¿…è¦ã‚ã‚Šã€‚

- å‚è€ƒï¼š[Cloudflare Workersã§ã‚µãƒ¼ãƒãƒ¬ã‚¹é–‹ç™º â€“ Rest Term](https://rest-term.com/archives/3603/)

## KV ã‚’ä½œæˆã™ã‚‹

ç¶šã„ã¦ KV ã‚’ä½œæˆã—ã¦ã„ãã€‚

```bash
$ wrangler kv:namespace create kv
ğŸŒ€  Creating namespace with title "practice-kv"
âœ¨  Success!
Add the following to your configuration file:
kv_namespaces = [
         { binding = "kv", id = "32d76002a7784decb07151acf413098b" }
]
```

ã€Œåå‰ç©ºé–“ã®åå‰ã€ã¨ã—ã¦ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨æŒ‡å®šã—ãŸåå‰ç©ºé–“ã‚’ãƒã‚¤ãƒ•ãƒ³ã§çµåˆã—ãŸã€`practice-kv` ã¨ã„ã†ãƒ¢ãƒã«ãªã‚‹ã€‚

å¾Œè¿°ã™ã‚‹ãŒ `index.js` å†…ã§å‚ç…§ã™ã‚‹åå‰ç©ºé–“ã¨ã—ã¦ã¯ã€ã“ã®å†…ã® `kv` éƒ¨åˆ†ã ã‘è¨˜è¿°ã™ã‚Œã°è‰¯ã„ã€‚`index.js` ã§å¤‰æ•°åã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ãŸã‚ã‹ã€åå‰ç©ºé–“ã«ã¯ãƒã‚¤ãƒ•ãƒ³ãŒä½¿ãˆãšã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã§ã—ã‹åŒºåˆ‡ã‚Œãªã„ã€‚

ã²ã¨ã¾ãšã€ä½•ã‚„ã‚‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€Œã‚³ãƒ¬ã‚’è¿½è¨˜ã—ã‚ã€ã¨å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã®å†…å®¹ã‚’ `wrangler.toml` ã«è¿½è¨˜ã—ã¦ãŠãã€‚

```toml
# Worker å : `https://ã€ã“ã® Worker åã€‘.ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã€‘.workers.dev/` ã§å…¬é–‹ã§ãã‚‹
name = "practice"
# `$ worker build` ã‚³ãƒãƒ³ãƒ‰ã§ã®ãƒ“ãƒ«ãƒ‰æ–¹æ³•ã‚’æŒ‡å®šã™ã‚‹ãƒ»`javascript` ã«ã™ã‚‹ã¨ Webpack ãŒä½¿ã‚ã‚Œã‚‹
type = "javascript"
# `webpack.config.js` ã‚’è‡ªå‰ã§ç”¨æ„ã—ãŸå ´åˆã¯ `webpack_config` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã™ã‚‹

# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID
account_id = "07100c21a5c21a0afb93ab435ba46712"
# `workers.dev` ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã¯ `true` ã«ã™ã‚‹
workers_dev = true
# `workers.dev` ã§ã¯ãªãç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã§å…¬é–‹ã™ã‚‹éš›ã«æŒ‡å®šã™ã‚‹ãƒ»`workers.dev` ã§å…¬é–‹ã™ã‚‹å ´åˆã¯ç©ºæ–‡å­—ã§è‰¯ã„
route = ""
# `workers.dev` ã§å…¬é–‹ã™ã‚‹å ´åˆã¯ç©ºæ–‡å­—ã§è‰¯ã„
zone_id = ""

# KV : â†“ ã‚³ãƒ¬ã‚’è¿½è¨˜ã—ãŸ
kv_namespaces = [
  { binding = "kv", id = "32d76002a7784decb07151acf413098b" }
]
```

- å‚è€ƒï¼š[Configuration Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/cli-wrangler/configuration)
- å‚è€ƒï¼š[Webpack Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/cli-wrangler/webpack)

## Wrangler CLI ã§ KV ã®å‚ç…§ãƒ»æ“ä½œ

Workers KV ã¯åŸå‰‡ã€ç´ä»˜ã‘ãŸ Workers ã‹ã‚‰ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã®ã ãŒã€ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã® Wrangler CLI ã§ã‚ã‚Œã°ã€`wrangler.toml` ã®å†…å®¹ã‚’å‚ç…§ã—ãªãŒã‚‰ã€KV ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚

```bash
# åå‰ç©ºé–“åã‚’æŒ‡å®šã—ã¦ã‚­ãƒ¼ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã™ã‚‹
$ wrangler kv:key list --binding 'kv'
[]

# JSON é…åˆ—ã£ã½ã„å€¤ã‚’ `test` ã¨ã„ã†ã‚­ãƒ¼åã§ç™»éŒ²ã™ã‚‹
$ wrangler kv:key put 'test' '[ { "id": 1, "text": "Hello World" } ]' --binding 'kv'
âœ¨  Success

# ç™»éŒ²ã—ãŸã‚­ãƒ¼åãŒè¦‹ãˆãŸ
$ wrangler kv:key list --binding 'kv'
[{"name":"test"}]

# ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆãŸ
$ wrangler kv:key get 'test' --binding 'kv'
[ { "id": 1, "text": "Hello World" } ]

# ã“ã®å†…å®¹ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ã‚‚ç¢ºèªã§ãã‚‹ (= å®Ÿéš›ã«ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹)
```

- å‚è€ƒï¼š[Cloudflare Workers KV ã®åˆæ­© - 30æ­³ã‹ã‚‰ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°](https://numb86-tech.hatenablog.com/entry/2021/06/22/233701)

## é–‹ç™ºç’°å¢ƒç”¨ã® KV ã‚’ä½œã‚‹

ã“ã®ã¾ã¾ã§ã‚‚ã€`wrangler publish` ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å½“è©² KV ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ãã‚‹ã®ã ãŒã€`wrangler dev` ã§ç«‹ã¦ãŸãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‹ã‚‰ã¯ã“ã® KV ãŒå‚ç…§ã§ããªã„ã€‚

ãã“ã§ã€`--preview` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã€é–‹ç™ºç’°å¢ƒç”¨ã® KV ã‚’åˆ¥é€”ä½œæˆã™ã‚‹ã€‚

```bash
# é–‹ç™ºç’°å¢ƒ (`wrangler dev`) ç”¨ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ KV ã‚’ä½œã‚‹
$ wrangler kv:namespace create 'kv' --preview
ğŸŒ€  Creating namespace with title "practice-kv_preview"
âœ¨  Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "kv", preview_id = "9f23b9bb89db4af7a2eca3230e50780f", id = "32d76002a7784decb07151acf413098b" }
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã¨ã€_`practice-kv_preview`_ ã¨ã„ã†åå‰ç©ºé–“ã®åå‰ã§ KV ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã€‚åå‰ãŒé•ã†ã ã‘ã§ã€KV ã®å‹•ä½œã¨ã—ã¦ã¯å¤‰ã‚ã‚Šãªã„ã‚ˆã†ã ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹å†…å®¹ã‚’å‚è€ƒã«ã—ã¦ã€`wrangler.toml` ã® `kv_namespaces` éƒ¨åˆ†ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã€‚

```toml
kv_namespaces = [
  { binding = "kv", id = "32d76002a7784decb07151acf413098b", preview_id = "9f23b9bb89db4af7a2eca3230e50780f" }
]
```

æœ€åˆã«ä½œæˆã—ãŸ KV ã®è¨˜è¿°ã‚’ãã®ã¾ã¾ã«ã€`preview_id` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã€`practice-kv_preview` ã® ID ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚

## é–‹ç™ºç’°å¢ƒç”¨ã® KV ã« Wrangler CLI ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

Wrangler CLI ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã« `--preview` ã‚’ä»˜ã‘ãªãŒã‚‰æ“ä½œã™ã‚Œã°ã€å…ˆç¨‹è©¦ã—ãŸã‚³ãƒãƒ³ãƒ‰ã¨å¤‰ã‚ã‚‰ãšã« KV ãŒæ“ä½œã§ãã‚‹ã€‚

```bash
# åå‰ç©ºé–“åã‚’æŒ‡å®šã—ã¦ã‚­ãƒ¼ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã™ã‚‹ (`--preview` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ã‘è¿½è¨˜ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„)
$ wrangler kv:key list --binding 'kv' --preview
[]
# `practice-kv` ã®æ–¹ã«ã¯å…ˆç¨‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ãŸãŒã€`practice-kv_preview` ã«ã¯ã¾ã ä½•ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ãªã„ã®ã§ã€ã‚­ãƒ¼ä¸€è¦§ã‚‚ç©ºã«ãªã£ã¦ã„ã‚‹

# JSON é…åˆ—ã£ã½ã„å€¤ã‚’ `test` ã¨ã„ã†ã‚­ãƒ¼åã§ç™»éŒ²ã™ã‚‹
$ wrangler kv:key put 'test' '[ { "id": 1, "text": "Hello World Preview" } ]' --binding 'kv' --preview
âœ¨  Success

# ã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
$ wrangler kv:key list --binding 'kv'
[{"name":"test"}]

# ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒç¢ºèªã§ãã‚‹ãŒã€`practice-kv` ã¨ã¯ç•°ãªã‚‹å€¤ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹
$ wrangler kv:key get 'test' --binding 'kv'
[ { "id": 1, "text": "Hello World Preview" } ]
# ã“ã®å†…å®¹ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ã‚‚ç¢ºèªã§ãã‚‹ (= å®Ÿéš›ã«ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹)
```

## Workers ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ KV ã‚’å‚ç…§ã™ã‚‹

Wrangler CLI ã‹ã‚‰ KV ã®å‚ç…§ãƒ»æ“ä½œãŒã§ããŸã®ã§ã€ã„ã‚ˆã„ã‚ˆ Workers ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿®æ­£ã—ã€Workers ã‹ã‚‰ KV ã‚’å‚ç…§ãƒ»æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã€‚

- `index.js`

```javascript
/**
 * Main
 */
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

/**
 * Response With KV Value
 * 
 * @param {Request} _request Request
 */
async function handleRequest(_request) {
  const content = await kv.get("test");  // å¤‰æ•° `kv` ã¯ Cloudflare Workers ã«ã‚ˆã£ã¦ KV ã®åå‰ç©ºé–“å `kv` ãŒãã®ã¾ã¾å¤‰æ•°åã«ä½¿ã‚ã‚Œã¦è‡ªå‹•çš„ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
  console.log(`Console Log : $${content}`);
  return new Response(content, {
    headers: { 'content-type': 'application/json' }
  });
}
```

ä»Šå›ã¯ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã ã‘ã€‚ã„ããªã‚Š `kv.get()` ã¨ã‹ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å©ã„ã¦ã„ã‚‹ãŒã€ã‚³ã‚³ã§å‡ºã¦ãã‚‹ `kv` ã¨ã„ã†ã®ã¯ã€`wrangler.toml` ã§ `binding = "kv"` ã¨æŒ‡å®šã—ã¦ã„ã‚‹ã€åå‰ç©ºé–“åã§ã‚ã‚‹ã€‚ã‚³ãƒ¬ãŒã„ããªã‚Šã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©ã•ã‚ŒãŸçŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãã„ã¤ã® `get()` ã‚„ `put()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã€å½“è©² KV ã‚’æ“ä½œã—ã¦ã„ãã“ã¨ã«ãªã‚‹ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§å‹•ä½œç¢ºèª (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ KV ã¨æ¥ç¶š)

`index.js` ã®å†…å®¹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€`wrangler dev` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã™ã‚‹ã€‚`wrangler.toml` ãƒ•ã‚¡ã‚¤ãƒ«ã® `preview_id` æŒ‡å®šã«ã‚ˆã‚Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ KV ã«æ¥ç¶šã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

```bash
$ wrangler dev
ğŸ’  watching "./"
ğŸ‘‚  Listening on http://127.0.0.1:8787

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ <http://127.0.0.1:8787> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹
Console Log : $[ { "id": 1, "text": "Hello World Preview" } ]
[2021-07-08 12:00:46] GET practice.neos21.workers.dev/ HTTP/1.1 200 OK
```

## å…¬é–‹ã—ã¦å®Ÿéš›ã«å‹•ä½œç¢ºèª (æœ¬ç•ªç”¨ KV ã¨æ¥ç¶š)

ç¶šã„ã¦ `wrangler publish` ã§å…¬é–‹ã™ã‚‹ã€‚

```bash
$ wrangler publish
âœ¨  Basic JavaScript project found. Skipping unnecessary build!
âœ¨  Successfully published your script to
 https://practice.neos21.workers.dev
```

<https://practice.neos21.workers.dev/> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å…ˆç¨‹ã¾ã§ã¯ `Hello World` ã¨ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç­”ãˆã¦ã„ãŸãŒã€ä»Šåº¦ã¯ `[ { "id": 1, "text": "Hello World" } ]` ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã£ãŸã€‚

ã‚³ã‚³ã§æ³¨ç›®ã—ãŸã„ã®ã¯ã€Publish ã™ã‚‹ã¨ã€`kv_preview` ã§ã¯ãªã `kv` ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚‰ã‚Œã¦ã„ã‚‹ç‚¹ã ã€‚

- å‚è€ƒï¼š[Cloudflare Workersã§ã‚µãƒ¼ãƒãƒ¬ã‚¹é–‹ç™º part3 Workers KVã‚’ç„¡æ–™ã§ä½¿ã† â€“ Rest Term](https://rest-term.com/archives/3619/)

## ä»¥ä¸Š

Cloudflare Workers ãŠã‚ˆã³ Cloudflare Workers KV ã®åˆæ­©ã¯ã‚³ã‚³ã¾ã§ã€‚ä»Šå›ä½œæˆã—ãŸ Workers ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆã—ãŸ GitHub ãƒªãƒã‚¸ãƒˆãƒªã¨ã€å®Ÿéš›ã«æœ¬ç•ªå…¬é–‹ã—ã¦ã„ã‚‹ Workers ã® URL ã¯æ¬¡ã®ã¨ãŠã‚Šã€‚æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã¯ã€æ¬¡å›ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªå‘ã‘ã®ãƒ¢ãƒã«ãªã£ã¦ã„ã‚‹ã®ã§ã€éå»ã®ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’é¡ã£ã¦ç¢ºèªã—ã¦ã¿ã¦ã»ã—ã„ã€‚

- [Neos21/practice-cloudflare-workers: Practice Cloudflare Workers](https://github.com/Neos21/practice-cloudflare-workers)
- <https://practice.neos21.workers.dev/>

æ¬¡å›ã¯ _Cloudflare Pages ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã€ã“ã® Cloudflare Workers ã‚’å‘¼ã³å‡ºã—ã¦ KV ã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒª_ã‚’ä½œã£ã¦ã¿ã‚‹ã€‚

- æ¬¡ã®è¨˜äº‹ï¼š[Cloudflare Pages ã¨ Cloudflare Workers KV ã‚’çµ„ã¿åˆã‚ã›ã¦ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ãŸ](/blog/2021/07/17-01.html)

<div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/B08VJ3YZK1?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51+BECAAh-L._SL160_.jpg" width="112" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/B08VJ3YZK1?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">Webé…ä¿¡ã®æŠ€è¡“â€•HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ãƒ»CDNã‚’æ´»ç”¨ã™ã‚‹</a>
    </div>
  </div>
</div>

<div class="ad-rakuten">
  <div class="ad-rakuten-image">
    <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16595756%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F20246424%2F">
      <img src="https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/9256/9784297119256.jpg?_ex=128x128">
    </a>
  </div>
  <div class="ad-rakuten-info">
    <div class="ad-rakuten-title">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16595756%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F20246424%2F">Webé…ä¿¡ã®æŠ€è¡“ãƒ¼HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ãƒ»CDNã‚’æ´»ç”¨ã™ã‚‹ [ ç”°ä¸­ ç¥¥å¹³ ]</a>
    </div>
    <div class="ad-rakuten-shop">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2Fbook%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2F">æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹</a>
    </div>
    <div class="ad-rakuten-price">ä¾¡æ ¼ : 3586å††</div>
  </div>
</div>

## å‚è€ƒæ–‡çŒ®

ãã®ä»–å‚è€ƒã«ã—ãŸãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã€‚

- [cloudflare/kv-asset-handler: Routes requests to KV assets](https://github.com/cloudflare/kv-asset-handler)
  - JS å†…ã§ KV ã®æ“ä½œã‚’ç°¡å˜ã«ã™ã‚‹å…¬å¼ã® npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- [Building a To-Do List with Workers and KV](https://blog.cloudflare.com/building-a-to-do-list-with-workers-and-kv/)
- [signalnerve/cloudflare-workers-todos: A simple todo list application built with Cloudflare Workers and KV](https://github.com/signalnerve/cloudflare-workers-todos)
  - Workers ã§ç°¡å˜ãª ToDo ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã„ã‚‹ä¾‹
  - GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯ HTML ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã€PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯ KV ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹
- [Cloudflare Workersã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ã¦ã¿ãŸ](https://zenn.dev/homura/articles/365c6c9a6ca2f98bb2ca)
