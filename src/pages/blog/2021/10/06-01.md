---
title        : 末尾に改行がないファイルを抽出する Bash スクリプト
created      : 2021-10-06
last-modified: 2021-10-06
header-date  : true
path:
  - /index.html Neo's World
  - /blog/index.html Blog
  - /blog/2021/index.html 2021年
  - /blog/2021/10/index.html 10月
---

ソースコードなど、テキストファイルの末尾には改行を入れている。大元は POSIX の仕様でそう定められているからで、Git でファイルを扱う時も都合が良いので、自分は従っている。

- [なぜファイル末尾に改行を入れるのか - Qiita](https://qiita.com/Aseiide/items/e66be44c4b7972902063)
- [POSIXの仕様では「テキストファイルの末尾は改行(newline)で終わる」のが正しい、を確認してみた。 - msfukuiの日記](https://msfukui.hatenablog.com/entry/2018/12/18/071145)

> 最終行に改行が無かったとします。  
> その次に行を追加したとします。  
> このとき，修正差分を取ると，変更前の最終行は，実質的には何も変更が無いにも関わらず，行末に改行が付加されたことで，変更された行として検出されてしまいます。  
> こういう事態を防ぐためには，すべての行が改行で終わっているほうが都合がいいんです。

最近はほとんど VSCode で物書きをしているので、EditorConfig などの Linter・Formatter を組み合わせて、ファイル保存時に自動修正するようにしても良いのだけど、なんとなく執筆中からオートフォーマットされるのが嫌で避けていたりする。仕事上書くモノについてはガチガチにフォーマッタをかけているが、個人で書く時は、たとえ非効率だろうと*自分の精神的に気持ち良い方*を選ぶことにしている。ｗ

んで、そんなことをしていると末尾の改行を入れ忘れているファイルがところどころ出てくる。

今回はそうしたファイルを抽出するための Bash スクリプトを組んだので紹介する。

```bash
# カレントディレクトリ配下の全てのファイルについて
# ファイル末尾に改行がなければ標準出力する
for file in $(find . -type f); do
  line="$(tail -n1 "${file}" | wc -l)"
  if [ "${line}" -eq 0 ]; then
    echo "${file} : 末尾改行なし"
  fi
done
```

`for` 部分の `$(find)` はダブルクォートで囲っちゃダメ。対象のファイルは適宜、`-name` だとかで指定すること。このままだと `.png` みたいなテキストファイル以外も引っ掛けてしまう。ｗ

`find -exec` とか `xargs` とか使うと Bash っぽいのは分かるのだが、今回は*ファイル末尾に改行がなかった時だけ `echo` したい*ので、可読性も考慮して `for` と `if` を書くことにした。

- 参考：[find -exec でパイプを介した複数コマンドの実行 | 晴耕雨読](https://tex2e.github.io/blog/shell/find-exec)

ファイル末尾に改行があるかどうかを調べる方法は、以下の記事を参考にした。末尾の1行を `tail -n1` で取り出し、その行を `wc -l` でカウントした時、ファイル末尾にちゃんと改行が入っていれば `1` になるのだが、改行をし忘れていると `0` になるので判別可能なのだ。なので `if` 部分を `-eq 0` ではなく *`-eq 1`* にすれば、「ファイル末尾に改行が入っているファイル」だけを抽出できることになる。

- 参考：[ShellScript: テキストファイル末尾が改行かどうか調べる． - Qiita](https://qiita.com/BlackCat_617/items/c0d7f7378bc55b3e07d0)
