<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>このサイトに使われている技術 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/tech/others/tech-of-this-site.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/tech/others/index.html">その他技術情報</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <h1 id="page-title">このサイトに使われている技術</h1>

<p>このサイトをどのように構築しているのか、その裏側を紹介します。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BB%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9">サーバ・インフラ</a>
    <ul>
      <li><a href="#%E3%83%9B%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9--xrea">ホスティングスペース : XREA</a></li>
      <li><a href="#%E7%8B%AC%E8%87%AA%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3--value-domain">独自ドメイン : Value-Domain</a></li>
      <li><a href="#ssl--xrea-%E7%84%A1%E6%96%99-ssl">SSL : XREA 無料 SSL</a></li>
    </ul>
  </li>
  <li><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E7%AE%A1%E7%90%86--github">ソース管理 : GitHub</a></li>
  <li><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E7%AE%A1%E7%90%86--npm">パッケージ管理 : npm</a></li>
  <li><a href="#%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AA%E3%83%B3%E3%82%B0--neos-normalize">スタイリング : Neo's Normalize</a></li>
  <li><a href="#html-%E3%83%93%E3%83%AB%E3%83%89">HTML ビルド</a>
    <ul>
      <li><a href="#front-matter-%E5%85%A5%E3%82%8A-html">Front Matter 入り HTML</a></li>
      <li><a href="#front-matter-%E3%81%AE%E6%8A%BD%E5%87%BA">Front Matter の抽出</a></li>
      <li><a href="#rehype-%E3%81%AB%E3%82%88%E3%82%8B%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E5%8A%A0%E5%B7%A5">Rehype によるドキュメント加工</a></li>
      <li><a href="#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88-html">テンプレート HTML</a></li>
    </ul>
  </li>
  <li><a href="#markdown-%E3%83%93%E3%83%AB%E3%83%89">Markdown ビルド</a>
    <ul>
      <li><a href="#front-matter-%E5%85%A5%E3%82%8A-markdown">Front Matter 入り Markdown</a></li>
      <li><a href="#remark-%E3%81%AB%E3%82%88%E3%82%8B-html-%E5%A4%89%E6%8F%9B">Remark による HTML 変換</a></li>
    </ul>
  </li>
  <li><a href="#%E3%83%96%E3%83%AD%E3%82%B0%E9%83%A8%E5%88%86%E3%81%AE%E5%B7%A5%E5%A4%AB">ブログ部分の工夫</a></li>
  <li><a href="#github-actions-%E3%81%AB%E3%82%88%E3%82%8B%E8%87%AA%E5%8B%95-ftp-%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89">GitHub Actions による自動 FTP アップロード</a></li>
  <li><a href="#%E4%BA%88%E7%B4%84%E6%8A%95%E7%A8%BF%E3%82%92%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B%E4%BB%95%E7%B5%84%E3%81%BF">予約投稿を実現する仕組み</a></li>
  <li><a href="#atom-%E3%83%95%E3%82%A3%E3%83%BC%E3%83%89%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89">Atom フィードのビルド</a></li>
  <li><a href="#%E3%82%B5%E3%82%A4%E3%83%88%E3%83%9E%E3%83%83%E3%83%97%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89">サイトマップのビルド</a></li>
  <li><a href="#%E3%81%9F%E3%81%A0%E3%81%B2%E3%81%9F%E3%81%99%E3%82%89%E3%81%AB-nodejs-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E5%AE%9F%E8%A3%85">ただひたすらに Node.js スクリプトを実装</a></li>
  <li><a href="#%E3%81%A9%E3%81%93%E3%81%8B%E3%82%89%E3%81%A7%E3%82%82%E3%82%B5%E3%82%A4%E3%83%88%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%AA%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%BB%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF">どこからでもサイトを更新できるオンライン・エディタ</a></li>
</ul>
<h2 id="サーバ・インフラ"><a class="header-link" href="#サーバ・インフラ"><span class="header-link-mark"></span></a>サーバ・インフラ</h2>
<h3 id="ホスティングスペース--xrea"><a class="header-link" href="#ホスティングスペース--xrea"><span class="header-link-mark"></span></a>ホスティングスペース : XREA</h3>
<p>このサイトのホスティングスペースは、2002年の開設当初から <a href="https://www.xrea.com/">XREA</a> を使用している。コレまで使ってきた URL は <code>neo.s21.xrea.com</code>。長らく広告付きの無料プランで利用してきたが、2020年11月に独自ドメインを取得したことに伴い、有料プランの XREA Plus を契約して広告を外した。</p>
<p>アカウントを取得した当時の XREA はにユーザフォーラムがあって、内容が優れているサイトだと特別に無料プランのまま広告を外させてもらえる仕組みがあったりしたのだが、GMO グループの傘下に入ってからはそうした仕組みもなくなってしまった…。</p>
<h3 id="独自ドメイン--value-domain"><a class="header-link" href="#独自ドメイン--value-domain"><span class="header-link-mark"></span></a>独自ドメイン : Value-Domain</h3>
<p>このサイトの独自ドメイン <code>neos21.net</code> は、<a href="https://www.value-domain.com/">Value-Domain</a> で2020年11月に取得した。XREA との親和性が高く、設定が楽なので助かっている。</p>
<h3 id="ssl--xrea-無料-ssl"><a class="header-link" href="#ssl--xrea-無料-ssl"><span class="header-link-mark"></span></a>SSL : XREA 無料 SSL</h3>
<p>HTTPS 化に際しては、XREA が提供してくれている無料 SSL 機能を利用している。Let's Encrypt みたいなのだが、更新が自動的に行われるので楽できる。</p>
<h2 id="ソース管理--github"><a class="header-link" href="#ソース管理--github"><span class="header-link-mark"></span></a>ソース管理 : GitHub</h2>
<p>以上でサーバ周りの話は終わり。以降はこのサイトの HTML ソースがどのように出来上がっていくかの説明となる。</p>
<p>ソースコードは全て <a href="https://github.com/Neos21">GitHub</a> で管理している。</p>
<ul>
  <li><a href="https://github.com/Neos21/neos21.net">GitHub - Neos21/neos21.net : Repository of Neo's World</a></li>
</ul>
<h2 id="パッケージ管理--npm"><a class="header-link" href="#パッケージ管理--npm"><span class="header-link-mark"></span></a>パッケージ管理 : npm</h2>
<p>自分は JavaScript が得意なので、サイトをビルドするための実装言語には Node.js を採用している。外部パッケージの利用もあるので、npm (<code>package.json</code>) で管理している。</p>
<h2 id="スタイリング--neos-normalize"><a class="header-link" href="#スタイリング--neos-normalize"><span class="header-link-mark"></span></a>スタイリング : Neo's Normalize</h2>
<p>サイトのスタイリングには、拙作の <a href="https://neos21.github.io/neos-normalize/">Neo's Normalize</a> を利用している。Normalize.css や Bootstrap4 Reboot の思想に影響を受けて作った、オレオレ・ノーマライズだ。CSS 変数を駆使して調整しているので、このサイト用に CSS 変数値を差し替えることで大まかな調整が効くようにしている。</p>
<p>CSS のビルドには <code>clean-css-cli</code> を使用している。SCSS はもう使用していない。</p>
<h2 id="html-ビルド"><a class="header-link" href="#html-ビルド"><span class="header-link-mark"></span></a>HTML ビルド</h2>
<p>このサイトの HTML ページは、独自のビルドシステムによりビルドされて、最終的な HTML ファイルに変換されている。</p>
<h3 id="front-matter-入り-html"><a class="header-link" href="#front-matter-入り-html"><span class="header-link-mark"></span></a>Front Matter 入り HTML</h3>
<p>このサイトの元の HTML ファイルは、次のように書かれている。</p>
<pre class="language-html"><code class="language-html">---
title        : Neo's World
created      : 2002-10-09
last-modified: 2020-11-20
toc          : false
path:
  - /index.html Neo's World
---

<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span>こんにちは世界<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
</code></pre>
<p>ファイル先頭には <a href="https://middlemanapp.com/jp/basics/frontmatter/">Front Matter</a>・つまり YAML の形式で、そのページのタイトルや更新日など、各種メタデータを記述している。ページ本文にあたる部分はその下に書いているが、<code>html</code>・<code>head</code>・<code>body</code> 要素などは書かれていない。</p>
<h3 id="front-matter-の抽出"><a class="header-link" href="#front-matter-の抽出"><span class="header-link-mark"></span></a>Front Matter の抽出</h3>
<p>Front Matter 部分のデータは、正規表現でキャプチャして <code>yaml</code> パッケージで取得している。ココで取得したデータを、後でテンプレート HTML に埋め込んでいる。</p>
<h3 id="rehype-によるドキュメント加工"><a class="header-link" href="#rehype-によるドキュメント加工"><span class="header-link-mark"></span></a>Rehype によるドキュメント加工</h3>
<p>HTML ソースの一部を自動一括処理するために、<a href="https://github.com/rehypejs">Rehype</a> というパッケージ群を利用している。コレは HTML ソースを AST (抽象構文木) に変換できるモノで、抽象構文木に落とし込むことで、色々な処理を行いやすくなるのだ。</p>
<p>コレを使って Front Matter 部分を抽出したり、見出し要素に <code>id</code> 属性を自動付与したりしている。具体的に使用しているパッケージは次のとおり。</p>
<ul>
  <li><code>rehype-parse</code> : HTML ソースファイルを読み込み AST (hast) にする</li>
  <li><code>rehype-slug</code> : 見出しに ID 属性値を付ける</li>
  <li><code>rehype-toc</code> : ページ中の見出しを拾い上げて目次 (Table of Contents) を作成する</li>
  <li><code>rehype-autolink-headlngs</code> : 見出しの前後に、その見出しへのハッシュリンクを追加する
    <ul>
      <li>このサイトだと、見出しの左側に薄い <code>$</code> ドルマークがあると思うが、コレ</li>
    </ul>
  </li>
  <li><code>@neos21/rehype-prism</code> : コードブロックに Prism.js を用いたシンタックスハイライトを効かせる</li>
  <li><code>rehype-stringify</code> : hast を HTML ソースに戻す</li>
  <li><code>rehype-format</code> : HTML ソースを整形出力する</li>
</ul>
<p>こんな感じ。見出しやシンタックスハイライト周りを自動で処理できるのは嬉しい。</p>
<h3 id="テンプレート-html"><a class="header-link" href="#テンプレート-html"><span class="header-link-mark"></span></a>テンプレート HTML</h3>
<p>ページ全体を構成する<em>テンプレート HTML</em> ファイルがあって、コレにはいくつかのプレースホルダ文字列が埋め込まれている。</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&#x3C;!-- テンプレート HTML 抜粋 --></span>

<span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ja<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>{{ page-title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/favicon.ico<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>header</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>site-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/index.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Neo's World<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>header</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>main</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        {{ date }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
{{ contents }}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>main</span><span class="token punctuation">></span></span>
</code></pre>
<p>こんな感じだ。<code>{{ page-title }}</code> とか <code>{{ contents }}</code> とかの部分を抽出して、JavaScript の <code>.replace()</code> 関数を使って各ページ用のデータを入れている。</p>
<p>当初は Fork して作った <a href="https://github.com/Neos21/template-html">@neos21/template-html</a> パッケージを使っていたが、現在は完全に独自で <code>replace()</code> 関数を書いている。</p>
<p>先程抽出した Front Matter の内容や、それ以外の HTML ソース部分をガンガン当てはめて置換している。</p>
<h2 id="markdown-ビルド"><a class="header-link" href="#markdown-ビルド"><span class="header-link-mark"></span></a>Markdown ビルド</h2>
<p>このサイトは上述のような「Front Matter 入り HTML」だけでなく、<strong>Markdown 形式でページを作っても HTML ソースの場合と同じ結果が出力できるように</strong>ビルドシステムを組んでいる。</p>
<p>テンプレート HTML ファイルは前述のモノと同じテンプレートを使っている。</p>
<h3 id="front-matter-入り-markdown"><a class="header-link" href="#front-matter-入り-markdown"><span class="header-link-mark"></span></a>Front Matter 入り Markdown</h3>
<p>Markdown 形式でページを作る場合は、次のような Markdown ファイルを作る。</p>
<pre class="language-markdown"><code class="language-markdown"><span class="token hr punctuation">---</span>
title        : このサイトに使われている技術
created      : 2020-11-23
last-modified: 2020-11-23
path:
  <span class="token list punctuation">-</span> /index.html Neo's World
  <span class="token title important">- /tech/index.html Tech
<span class="token punctuation">---</span></span>

<span class="token title important"><span class="token punctuation">##</span> こんにちは世界</span>
</code></pre>
<p>コチラも HTML の場合と同様、Front Matter が冒頭にあり、コンテンツは Markdown 形式で書いている。</p>
<p>サイト内の相対リンクについては置換処理が入っていないので、<code>example.md</code> ファイルを作ってページをこしらえても、そのページにリンクする時は</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./example.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>リンク<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span>
</code></pre>
<p>ないしは</p>
<pre class="language-markdown"><code class="language-markdown"><span class="token url">[<span class="token content">リンク</span>](./example.html)</span>
</code></pre>
<p>というように、拡張子を <code>.md</code> ではなく <code>.html</code> で実装しておく必要がある。最終的にビルドされた後にどういうリンクになるかを少し想像する必要がある。</p>
<h3 id="remark-による-html-変換"><a class="header-link" href="#remark-による-html-変換"><span class="header-link-mark"></span></a>Remark による HTML 変換</h3>
<p>Markdown から HTML への変換には、<a href="https://github.com/remarkjs">Remark</a> というパッケージ群を利用している。具体的に使用しているのは以下のとおり。</p>
<ul>
  <li><code>remark-parse</code> : Markdown テキストから mdast (AST) に変換する</li>
  <li><code>remark-frontmatter</code> : Front Matter 部分を抽出する</li>
  <li><code>remark-extract-frontmatter</code> : Front Matter 部分の情報を <code>yaml</code> パッケージでパースして連想配列として取得する</li>
  <li><code>remark-slug</code> : 見出しに <code>id</code> 属性を付与する</li>
  <li><code>remark-toc</code> : 目次 (Table of Contents) を作成する</li>
  <li><code>remark-rehype</code> : mdast から hast (HTML AST) に変換する
    <ul>
      <li>以降は先程も登場したプラグイン</li>
    </ul>
  </li>
  <li><code>rehype-autolink-headings</code> : 見出しにハッシュリンクを追加する</li>
  <li><code>@neos21/rehype-prism</code> : シンタックスハイライトを効かせる</li>
  <li><code>rehype-stringify</code> : hast を HTML ソースに戻す</li>
  <li><code>rehype-format</code> : HTML ソースを整形出力する</li>
</ul>
<p><code>remark-parse</code> は v9.0.0 以降は Pedantic モードが廃止されている。Pedantic モードというのは、簡単に言えば「アンダースコアでも強調構文が使える」モードなのだが、バグが多いため廃止されたという。自分は「はてなブログ」で執筆してきた期間が長く、アスタリスクでの強調よりもアンダースコアでの強調の方が馴染みがあるので、あえて <em>Pedantic モードでパースしてくれる v8.0.3</em> という一つ古いバージョンの <code>remark-parse</code> を使っている。</p>
<p>HTML の場合は正規表現で抽出した Front Matter だが、Markdown の場合は <code>remark-extract-frontmatter</code> という専用のプラグインがあるので、コレを使った。</p>
<p>HTML の場合は <code>rehype-slug</code>・<code>rehype-toc</code> を使って見出しと目次を処理したが、Markdown の場合は mdast (HTML に変換する前) の時点で処理するため、<code>remark-slug</code>・<code>remark-toc</code> という別のパッケージを使っている。結果はほぼほぼ同じになる。</p>
<p>HTML に変換した後は、HTML ソースをビルドする場合と同じプラグインを噛ませて処理してやることで、Markdown をベースにビルドしても、ほとんど同じ結果を実現している。</p>
<h2 id="ブログ部分の工夫"><a class="header-link" href="#ブログ部分の工夫"><span class="header-link-mark"></span></a>ブログ部分の工夫</h2>
<p>このサイトの <a href="/blog/index.html">Blog</a> 部分は、前述の「Markdown ビルド」の仕組みで実現している。いわゆる SSG、静的サイトジェネレータによる静的なブログである。</p>
<p>ブログらしい見た目にするために、最新の記事を数件配置したり、指定年月の記事一覧を表示したりする仕組みを作っている。</p>
<p>今度はテンプレート HTML 側でなく、ソースの Markdown ファイル側に、専用のプレースホルダ文字列を用意しておく。コレを見付け次第、Node.js の <code>fs</code> でひたすらディレクトリ配下の Markdown ファイルを取得して、記事一覧のリストやリンクを組み立てている。</p>
<h2 id="github-actions-による自動-ftp-アップロード"><a class="header-link" href="#github-actions-による自動-ftp-アップロード"><span class="header-link-mark"></span></a>GitHub Actions による自動 FTP アップロード</h2>
<p>このサイトをホスティングしている XREA サーバにファイルを配備するには、FTP 転送が必要になる。そこで、<a href="https://github.com/Neos21/neos21.net/actions">GitHub Actions</a> を使って、<code>master</code> ブランチにコミットされたファイルをビルドし、 FTP アップロードするように設定している。</p>
<p>コミットされたファイルを特定するには、<a href="https://github.com/jitterbit/get-changed-files">jitterbit/get-changed-files@v1</a> という Action を使っている。コレで取得したファイルをビルドして、FTP アップロードしている。</p>
<p>FTP アップロードには <a href="https://www.npmjs.com/package/ftp-client">ftp-client</a> というパッケージを使っている。このパッケージの注意点は、新規ディレクトリを自動的には作ってくれないので、<code>new-directory/new-file.html</code> をアップロードしようと思ったら、アップロード対象ファイルの配列にディレクトリ名も入れてやる必要がある。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> uploadFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'new-directory'</span><span class="token punctuation">,</span> <span class="token string">'new-directory/new-file.html'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>こういう感じだ。</p>
<h2 id="予約投稿を実現する仕組み"><a class="header-link" href="#予約投稿を実現する仕組み"><span class="header-link-mark"></span></a>予約投稿を実現する仕組み</h2>
<p>先程、「<code>master</code> ブランチにコミットされたファイルをアップロードしている」と書いたが、ブログの予約投稿を実現するために、一工夫入れている。</p>
<p>各ソースファイルには「初版作成日 (Created)」と「最終更新日 (Last-Modified)」を記す Front Matter を用意している。この情報を参照して、<strong>ビルド処理を実行している日よりも未来日のファイルについては、コミットされてもアップロードの対象外にしている</strong>のだ。</p>
<p>この仕組みは随所に登場している。</p>
<ul>
  <li>ブログの記事一覧を生成する際、その記事の作成日を見て未来日ならリストに含めないよう処理していたり</li>
  <li>トップページの「更新履歴」の内容を管理する YAML ファイルの日付を見て、予約更新しようとしている「更新履歴」の内容を表示しないようにしていたり</li>
</ul>
<p>サイトのソースコードを Git 管理するなら、予約投稿したい内容を別ブランチに分けたらどうか、とも思ったのだが、マージ時にコンフリクトがあると面倒なので、基本は <code>master</code> ブランチに思い立った時に放り込んで、良き時にアップロードするように考えた。</p>
<p>そして、自動的に予約投稿するために、毎日定時に実行される GitHub Actions を用意した。コレは、前述の「初版作成日」や「最終更新日」が当日を迎えたファイルを抽出し、そのファイルをビルド・アップロードするスクリプトだ。</p>
<h2 id="atom-フィードのビルド"><a class="header-link" href="#atom-フィードのビルド"><span class="header-link-mark"></span></a>Atom フィードのビルド</h2>
<p>このサイトでは Atom フィードを配信している。コレも GitHub Actions でビルドし、サイトにアップロードしている。</p>
<p>Atom フィードも当然、前述の「予約投稿を実現する仕組み」を使って、まだ公開するつもりのない未来日の情報は含めないようにしている。</p>
<p>フィードファイルの構築方法は、HTML や Markdown のビルドでもやったように、プレースホルダを用意したテンプレートファイルに、<code>replace()</code> で愚直に置換して挿入している。</p>
<p>毎日実行される GitHub Actions で、更新されるファイルがあればフィードもビルドし、アップロードしている。</p>
<h2 id="サイトマップのビルド"><a class="header-link" href="#サイトマップのビルド"><span class="header-link-mark"></span></a>サイトマップのビルド</h2>
<p>このドメイン配下のページ一覧となる、サイトマップ XML もビルドしている。コチラも、初版作成日が未来日のファイルは除外するようにしている。</p>
<h2 id="ただひたすらに-nodejs-スクリプトを実装"><a class="header-link" href="#ただひたすらに-nodejs-スクリプトを実装"><span class="header-link-mark"></span></a>ただひたすらに Node.js スクリプトを実装</h2>
<p>Markdown のパースなど、一部処理は外部パッケージを利用しているが、基本的には Node.js 組み込みの <code>fs</code> パッケージでファイルを取得・更新しまくっているだけ。どのように変換するかは、独自に定めたプレースホルダを正規表現で特定して <code>replace()</code> 関数でゴリゴリ書き換えているだけ。</p>
<p>元々は <code>replace()</code> 関数の第2引数に指定できる関数が、非同期処理に対応していなかったためなのだが、<code>fs</code> パッケージの同期関数を多用している。<code>fs.readFileSync()</code> だったり、<code>fs.writeFileSync()</code> だったり。</p>
<p>しかし、Node.js や JavaScript はシングルスレッドで動作するので、変に <code>async</code>・<code>await</code> を使って非同期化しようとするとかえって動作が遅くなるらしく、大量ファイルおw同期関数で処理していても、それなりに速く動作している。</p>
<h2 id="どこからでもサイトを更新できるオンライン・エディタ"><a class="header-link" href="#どこからでもサイトを更新できるオンライン・エディタ"><span class="header-link-mark"></span></a>どこからでもサイトを更新できるオンライン・エディタ</h2>
<p>このサイトをビルドするための技術は以上だが、ココからは番外編。</p>
<p>GitHub Actions などで自動アップロードしている都合上、GitHub に Push できる環境でないと、サイト更新が難しい。すなわち、Git リポジトリをクローンして操作できる、PC 環境がほとんど必須なのだ。</p>
<p>そうすると、スマホなんかでササッと記事だけ書いてアップロード、というような、CMS 的なことはできない。</p>
<p>そこで、<a href="https://www.oracle.com/jp/cloud/">Oracle Cloud Infrastructure</a> で借りられる、永久無料の IaaS VM 上に、専用のウェブアプリを配備した。</p>
<p>このウェブアプリは <a href="https://github.com/steveukx/git-js">simple-git</a> という npm パッケージを利用して、このサイトの GitHub リポジトリを OCI VM 上にクローンしてある。そして、指定のファイルの内容を編集し、その内容をコミット・Push できるオンライン・エディタを作ったのだ。</p>
<p>
  <img src="./tech-of-this-site-01.png" alt="エクスプローラとターミナル">
</p>
<p>↑ 実際のウェブアプリ画面。ファイルを選択できるエクスプローラと、下部にターミナルコンソールが用意されている。</p>
<p>ターミナルは、フォームに入力したコマンドがそのまま、Express を経由して <code>child_process.exec()</code> に渡されて、実際にコマンドがサーバ上で動作している。</p>
<p>技術上はこのように可能だが、メチャクチャ危険な行為なので、安易に真似しないように。自分の場合はサイトへのアクセス制限をかけたり、普段はサーバを落としておいたりしている他、<code>child_process.exec()</code> に渡される文字列の中に危険そうな文字列があったら排除するようにしている。ほとんど自分が決めているエイリアスしか動作しなくなっている。</p>
<p>
  <img src="./tech-of-this-site-02.png" alt="エディタ画面">
</p>
<p>↑ コレはエディタ画面。Front Matter 部分を自動挿入するためのボタンとか、Amazon・楽天の広告コードを挿入したりするためのボタンとか、よくある CMS の管理画面的に、必要なショートカットを揃えている。</p>
<p>こうしたちょっとしたウェブアプリを作っておけば、スマホ上でも記事を書いたりできる。GitHub への Push を忘れていても、データは OCI の IaaS 上に保管されているワケなので、PC でエディタを開いて続きを書いて、そこから Push したりしても良い。我ながら、シンプルかつやりたいことが全部できていて、よきよき。</p>
<hr>
<p>以上。2020年時点で、このサイトはこのようにして構築されている。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-11-23</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-11-23</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
