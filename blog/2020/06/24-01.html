<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>nginx のリバースプロキシを Docker-Compose で試してみる - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/06/24-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/06/index.html">06月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-06-24</time></div>
        <h1 id="page-title">nginx のリバースプロキシを Docker-Compose で試してみる</h1>

<p>nginx の<em>リバースプロキシ</em>機能を使って、複数の Node.js サーバへの通信を、単一ドメインで受けてみたい。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%A8%E3%81%AF">リバースプロキシとは</a></li>
  <li><a href="#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%A7%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE">リバースプロキシで何ができるの？</a></li>
  <li><a href="#docker-compose-%E3%81%A7%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B">Docker-Compose で開発環境を作る</a></li>
  <li><a href="#%E3%83%87%E3%83%A2%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A8%E3%82%B3%E3%83%BC%E3%83%89%E5%85%A8%E9%87%8F">デモプロジェクトとコード全量</a></li>
  <li><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A7%8B%E6%88%90">プロジェクト構成</a></li>
  <li><a href="#nginx-%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%81%8F">nginx の設定を書いていく</a></li>
  <li><a href="#nginx-%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%AD%E5%AE%9A">nginx コンテナを立ち上げるための設定</a></li>
  <li><a href="#%E9%81%A9%E5%BD%93%E3%81%AA-nodejs-%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B">適当な Node.js サーバを作る</a></li>
  <li><a href="#%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">動かしてみる</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="リバースプロキシとは"><a class="header-link" href="#リバースプロキシとは"><span class="header-link-mark"></span></a>リバースプロキシとは</h2>
<p>リバースプロキシとは、クライアント側に用意するプロキシと違って、サーバ側に存在してリクエストを仲介するプロキシのこと。</p>
<p>何がリバースなんや？というと、通常クライアント側にいるプロキシは「内々から外へ出ていく」通信を仲介するが、コチラは「外から内々に入っていく」通信を仲介するので、逆だよねってことでリバースらしい。</p>
<ul>
  <li>参考：<a href="https://yyyank.blogspot.com/2018/06/nginx.html">nginxについて調べた(い) その２。リバースプロキシとロードバランシング - プログラマのはしくれダイアリー</a></li>
</ul>
<h2 id="リバースプロキシで何ができるの"><a class="header-link" href="#リバースプロキシで何ができるの"><span class="header-link-mark"></span></a>リバースプロキシで何ができるの？</h2>
<p>リバースプロキシによってどういう通信経路ができるかというと、以下のような感じ。</p>
<p>前提条件として、</p>
<ul>
  <li><code>http://localhost:3001/</code></li>
  <li><code>http://localhost:3002/</code></li>
</ul>
<p>の2つのポートで、それぞれ何らかのサーバを動かしていることとする。Node.js・Express サーバでも、Python・Flask サーバでもなんでも良い。</p>
<p>これらのウェブアプリにアクセスするには、上のようにそれぞれポート番号を指定してアクセスしても良いが、ドメインは1つに集約したい、ポート番号をイチイチ指定したくない、という時に、リバースプロキシが前段に立ってやる。</p>
<p>リバースプロキシサーバ (= 今回は nginx が担う) は</p>
<ul>
  <li><code>http://localhost/</code></li>
</ul>
<p>と80番ポートで待ち構えている。そして、</p>
<ul>
  <li><code>http://localhost/app-1/</code> へのアクセス → <code>http://localhost:3001/</code> に転送</li>
  <li><code>http://localhost/app-2/</code> へのアクセス → <code>http://localhost:3002/</code> に転送</li>
</ul>
<p>という風にリクエストをハンドリングしてくれるようになる。この時、<code>app-1/</code> とか <code>app-2/</code> とかいう階層指定が転送先では削られていることに留意。</p>
<ul>
  <li><code>http://localhost/app-1/examples/test.html</code> へのアクセス → <code>http://localhost:3001/examples/test.html</code> に転送
    <ul>
      <li>(転送先の3001番ポートの方は <code>app-1/</code> という階層が削られている)</li>
      <li>(パスを削らずに転送する設定も可能ではある)</li>
    </ul>
  </li>
</ul>
<h2 id="docker-compose-で開発環境を作る"><a class="header-link" href="#docker-compose-で開発環境を作る"><span class="header-link-mark"></span></a>Docker-Compose で開発環境を作る</h2>
<p>ふむふむなるほど、nginx でリバプロを立てるとこんなことが出来るのね、じゃあやってみよう。</p>
<p>nginx は Homebrew なんかでもインストールできたりするが、裏に用意するアプリケーションサーバ含めて開発環境・実行環境を構築していくのはちょっと面倒だ。そこで今回は、Docker-Compose を利用して、nginx および Node.js 環境をそれぞれ立ち上げることにしたい。</p>
<h2 id="デモプロジェクトとコード全量"><a class="header-link" href="#デモプロジェクトとコード全量"><span class="header-link-mark"></span></a>デモプロジェクトとコード全量</h2>
<p>今回作ったデモプロジェクトは、以下の GitHub リポジトリで公開している。細かなコードはコチラを参考にしてほしい。</p>
<ul>
  <li><a href="https://github.com/Neos21/practice-nginx-nodes-on-docker-compose">Neos21/practice-nginx-nodes-on-docker-compose</a></li>
</ul>
<h2 id="プロジェクト構成"><a class="header-link" href="#プロジェクト構成"><span class="header-link-mark"></span></a>プロジェクト構成</h2>
<p>プロジェクト構成は次のようにする。</p>
<pre><code>【プロジェクトルート】
├ docker-compose.yml
├ nginx/
│ ├ Dockerfile-nginx
│ ├ default.conf
│ └ html/
│    └ index.html
├ app-1/
│ ├ Dockerfile-app-1
│ └ src/
│    ├ index.js
│    └ example.html
└ app-2/
   ├ Dockerfile-app-2
   └ src/
      ├ index.js
      └ example.html
</code></pre>
<p>ルートの <code>docker-compose.yml</code> が、<code>nginx/</code>・<code>app-1/</code>・<code>app-2/</code> それぞれのディレクトリを3つのコンテナとして立ち上げる。</p>
<p><code>nginx/</code> ディレクトリはそのものズバリ、nginx サーバの設定を持っている。<code>Dockerfile-nginx</code> という Dockerfile で、nginx ベースのイメージを用意している。</p>
<p><code>app-1/</code>・<code>app-2/</code> ディレクトリは、それぞれ Node.js サーバというテイ。今回は簡単にするため <code>package.json</code> を省いている。</p>
<ul>
  <li><code>src/index.js</code> は、<code>http</code> モジュールを使って簡易サーバを立てている</li>
  <li>リクエストすると <code>src/example.html</code> の内容をレスポンスする作り</li>
</ul>
<p>実際は <code>package.json</code> があって、Dockerfile で <code>npm install</code> しておいて <code>npm start</code> でサーバを起動するような作りになるだろうか。</p>
<p>それぞれの Dockerfile や <code>docker-compose.yml</code> の設定はひとまず後にして、まずは本命である nginx の設定を作っていこう。</p>
<h2 id="nginx-の設定を書いていく"><a class="header-link" href="#nginx-の設定を書いていく"><span class="header-link-mark"></span></a>nginx の設定を書いていく</h2>
<p>nginx の設定ファイル、<code>default.conf</code> を用意して、リバースプロキシ設定を書いていく。</p>
<pre class="language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
  <span class="token keyword">root</span>         <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token punctuation">;</span>
  
  <span class="token keyword">location</span> <span class="token operator">/</span>app<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_set_header</span>  Host                <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Real<span class="token operator">-</span>IP           <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Host    <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span><span class="token keyword">Server</span>  <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For     <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span>        <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>app<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token operator">/</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">location</span> <span class="token operator">/</span>app<span class="token operator">-</span><span class="token number">2</span><span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_set_header</span>  Host                <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Real<span class="token operator">-</span>IP           <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Host    <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span><span class="token keyword">Server</span>  <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>  X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For     <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span>        <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>app<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3002</span><span class="token operator">/</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>唐突だが、リバプロの設定はこんな感じ。<code>location /app-1/ {}</code> という一つのブロックで、一つのアプリサーバに対するリバプロ設定が書かれている。</p>
<ul>
  <li><code>location</code> のパスはスラッシュ <code>/</code> を末尾に書くこと。でないと <code>//hoge</code> といったようにスラッシュが2重に付いて転送されてしまう</li>
  <li>一連の <code>proxy_set_header</code> はほぼお決まりなのでそのまま書く</li>
  <li><code>proxy_pass</code> が転送先 URL を指定する場所。URL の末尾にスラッシュを書くかどうかで転送のされ方が変わるので注意
    <ul>
      <li><em>URL の末尾に <code>/</code> を付けると、<code>/app-1/hoge</code> へのリクエストは <code>:3001/hoge</code> に転送される</em></li>
      <li><strong>URL の末尾に <code>/</code> を付けないと、<code>/app-1/hoge</code> へのリクエストが <code>:3001/app-1/hoge</code> に転送される</strong></li>
    </ul>
  </li>
</ul>
<p>nginx のルートパスは <code>root</code> プロパティを指定して、<code>/var/www/html/</code> ディレクトリ内のファイルを返すようにしておく。サーバにインストールした nginx の場合、<code>/usr/share/nginx/html/</code> をデフォルトで参照する場合もあったりする。パスだけ知っておくと良いかも。</p>
<p>あと、<code>server_name</code> 部分は、実行環境によっては以下のように書いたりもするかな。</p>
<pre class="language-nginx"><code class="language-nginx"><span class="token keyword">server_name</span>  <span class="token variable">$hostname</span> <span class="token string">''</span> 【グローバル IP を書いたり】<span class="token punctuation">;</span>
</code></pre>
<p>認識してほしいサーバ名を複数書いたり、<code>''</code> と空白を書いたり。</p>
<p>HTTPS に対応する際は、<code>location</code> 内に CORS 設定を書く場合もあるかな。転送先の Node.js サーバ側でヘッダを付与しても良い。どちらかで指定しておけば良いようだ。<code>Allow-Origin</code> がダブらないよう注意。</p>
<pre class="language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>app<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">add_header</span>  Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin       <span class="token string">'*'</span>  always<span class="token punctuation">;</span>
  <span class="token keyword">add_header</span>  Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Methods      <span class="token string">'GET, POST, PUT, DELETE, OPTIONS'</span><span class="token punctuation">;</span>
  <span class="token keyword">add_header</span>  Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Headers      <span class="token string">'*'</span><span class="token punctuation">;</span>
  <span class="token keyword">add_header</span>  Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Credentials  <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Express サーバに書くイメージ。nginx 側とどちらかで指定すれば良い</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span>     <span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span>    <span class="token punctuation">,</span> <span class="token string">'GET, POST, PUT, DELETE, OPTIONS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span>    <span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>CORS 設定をしたとき、なぜかルートパス <code>/app-1/</code> への Ajax リクエストだけ Allow-Origin が効かなくて困ったのだが、直し方が分からず諦めた。普通に遷移するとアクセスはできるので、CORS だけ上手く効かないみたい。よく分からん。</p>
<p>nginx の設定ファイルの書き方はイマイチ分からなくて、それでいて自由度もあって難しいな…。</p>
<ul>
  <li>参考：<a href="https://qiita.com/morrr/items/7c97f0d2e46f7a8ec967">nginxについてまとめ(設定編) - Qiita</a></li>
  <li>参考：<a href="https://qiita.com/schwarz471/items/9b44adfbec006eab60b0">Nginxによるリバースプロキシの設定方法 - Qiita</a></li>
</ul>
<p>今回は Docker で動かすので以下の操作は実際には行わないが、どこかのサーバ上にインストールした nginx を使っている場合は、以下のように nginx を再起動したりして、設定ファイルの変更を反映したりする。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># default.conf ではなく nginx.conf がデフォルトの設定ファイルな場合もある (バージョンによるもの？)</span>
$ <span class="token function">vi</span> /etc/nginx/default.conf

<span class="token comment"># 設定を再読込したり</span>
$ <span class="token function">service</span> nginx reload
<span class="token comment"># nginx を再起動したり</span>
$ <span class="token function">service</span> nginx restart
<span class="token comment"># 稼動状況を確認したり</span>
$ <span class="token function">service</span> nginx status
</code></pre>
<h2 id="nginx-コンテナを立ち上げるための設定"><a class="header-link" href="#nginx-コンテナを立ち上げるための設定"><span class="header-link-mark"></span></a>nginx コンテナを立ち上げるための設定</h2>
<p>設定ファイルができたので、コレを nginx コンテナとして立ち上げるための設定を書いていく。</p>
<ul>
  <li><code>./nginx/Dockerfile-nginx</code></li>
</ul>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>1.17

<span class="token keyword">COPY</span> ./default.conf /etc/nginx/conf.d/default.conf
<span class="token keyword">COPY</span> ./html/        /var/www/html/
</code></pre>
<p>Dockerfile がやることは、ベースイメージの指定と設定ファイルのコピーだけ。</p>
<p><code>html/</code> ディレクトリはサーバルートにアクセスした時に <code>index.html</code> を返せるように、コピーしている。</p>
<p>この Dockerfile により、予めファイルをコピーして Docker イメージをビルドして nginx サーバを起動するので、設定ファイルをココで書き換えても、起動中の Docker コンテナの設定は変わらない点に注意。変更の度に Docker イメージの再ビルド (COPY) と再起動が必要になる。まぁ頻繁にイジらないし良いか。</p>
<ul>
  <li><code>./docker-compose.yml</code></li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token comment"># Dockerfile の保存場所を指定する</span>
      <span class="token key atrule">context</span>   <span class="token punctuation">:</span> ./nginx/
      <span class="token comment"># Dockerfile 名を指定する</span>
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>nginx
    <span class="token comment"># イメージ名</span>
    <span class="token key atrule">image</span>         <span class="token punctuation">:</span> practice<span class="token punctuation">-</span>nginx
    <span class="token comment"># コンテナ名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> practice<span class="token punctuation">-</span>nginx
    <span class="token comment"># ポートフォワード</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
</code></pre>
<p>Docker-Compose の設定ファイルはこんな感じ。<code>build</code> プロパティで <code>./nginx/Dockerfile-nginx</code> を参照できるようにしておく。<code>image</code> と <code>container_name</code> は任意に。最後に <code>ports</code> で80番ポートをホスト側に公開するようにしておく。</p>
<p>コレで <em><code>$ docker-compose up --build</code></em> コマンドを叩けば、nginx サーバが起動し <code>http://localhost/</code> にアクセスすると <code>index.html</code> の内容が返ることが確認できる。まだ <code>/app-1/</code>・<code>/app-2/</code> を用意していないので、リバプロの動作確認はできていない。</p>
<h2 id="適当な-nodejs-サーバを作る"><a class="header-link" href="#適当な-nodejs-サーバを作る"><span class="header-link-mark"></span></a>適当な Node.js サーバを作る</h2>
<p>続いて、リバプロの転送先となる適当な Node.js サーバを作っておく。今回は本筋ではないので、雑にコーディングする。</p>
<ul>
  <li><code>./app-1/src/index.js</code></li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html; charset=utf-8'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./example.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>最後に指定しているように、3001番ポートで公開する設定。<code>app-2</code> の方はこのポート番号だけ変えていて、3002番ポートで公開するようになっている。</p>
<p>レスポンスに使用する <code>example.html</code> は、区別がつくようにサーバ名が書いてあるだけの適当なファイル。なんでも良い。</p>
<ul>
  <li><code>./app-1/Dockerfile-app-1</code></li>
</ul>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14.3

<span class="token keyword">COPY</span> ./src/ /src/
<span class="token keyword">WORKDIR</span> /src/
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"node"</span><span class="token punctuation">,</span> <span class="token string">"/src/index.js"</span><span class="token punctuation">]</span>
</code></pre>
<p>Dockerfile は、Node.js ベースのイメージに資材を配置して起動しているだけ。<code>package.json</code> を用意した場合は <code>npm install</code> などを事前に行っておく感じかな。<code>./app-2/Dockerfile-app-2</code> も全く同じ内容で良い。</p>
<ul>
  <li><code>docker-compose.yml</code></li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token comment"># 前述のとおり・省略</span>
  
  <span class="token comment"># app-1 : ビルド済のコンテナを公開する。ファイルの変更は検知できない</span>
  <span class="token key atrule">app-1</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span>   <span class="token punctuation">:</span> ./app<span class="token punctuation">-</span>1/
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">image</span>         <span class="token punctuation">:</span> practice<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> practice<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">1</span>
  
  <span class="token comment"># app-2 : ボリュームマウントすることで静的ファイルの変更を反映できるようにする</span>
  <span class="token key atrule">app-2</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span>   <span class="token punctuation">:</span> ./app<span class="token punctuation">-</span>2/
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">image</span>         <span class="token punctuation">:</span> practice<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> practice<span class="token punctuation">-</span>app<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token comment"># ボリュームマウントして実行する</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./app<span class="token punctuation">-</span>2/src<span class="token punctuation">:</span>/src
    <span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /src/
    <span class="token comment"># node コマンドのパスを認識させるため sh -c が必要</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>sh<span class="token punctuation">,</span> <span class="token punctuation">-</span>c<span class="token punctuation">,</span> node /src/index.js<span class="token punctuation">]</span>
    <span class="token comment"># 直接公開する場合は以下を書く</span>
    <span class="token comment">#ports:</span>
    <span class="token comment">#  - 3002:3002</span>
</code></pre>
<p>Docker-Compose 設定ファイルには <code>app-1</code> と <code>app-2</code> という <code>services</code> が追加されている。この名前が、nginx の <code>default.conf</code> 内に指定した <em><code>http://app-1:3001/</code></em> などのサーバ名に対応することになる。</p>
<p>シンプルにビルドした Docker イメージを立ち上げるだけなら、<code>app-1</code> の書き方で <code>app-2</code> も書いてやれば良い。</p>
<p><code>app-2</code> の書き方の方は、<code>./app-2/Dockerfile-app-2</code> で指定した COPY・WORKDIR・CMD 設定を上書きしていて、ボリュームマウントして動かしている。コレにより、<code>./app-2/src/example.html</code> の内容を書き換えた時に即座に反映されるようになる。<code>index.js</code> 側は書き換えても反映されないので、完全なライブリロード開発ではないが。</p>
<p>こんな感じでボリュームマウントを使ったり、起動コマンドを</p>
<ul>
  <li><code>command: [sh, -c, npm run dev]</code></li>
</ul>
<p>などと開発用コマンドに変えてやったりすれば、もう少し開発がしやすくなると思われる。</p>
<p>なお、<code>app-1</code> が公開している3001番ポート、<code>app-2</code> が公開している3002番ポートは、ホスト側から直接アクセスはできない。直接アクセスしたい場合は <code>ports</code> プロパティをそれぞれに書いてやり、ポートフォワードしてやること。今回は nginx が転送するので、基本的には3001・3002番ポートをホストに公開する必要はない。</p>
<h2 id="動かしてみる"><a class="header-link" href="#動かしてみる"><span class="header-link-mark"></span></a>動かしてみる</h2>
<p>それでは実際に動かしてみよう。</p>
<pre class="language-bash"><code class="language-bash">$ docker-compose up --build
</code></pre>
<p>常に上のコマンドを使用し、Dockerfile を都度ビルドすることにする。コレにより設定ファイルの変更が反映された状態でコンテナ群が起動する。</p>
<p>起動したら、ホスト側で次の URL にアクセスして動作確認してみよう。</p>
<ol>
  <li><a href="http://localhost/">http://localhost/</a>
    <ul>
      <li><code>./nginx/html/index.html</code> の内容が返ること</li>
      <li><code>default.conf</code> の <code>root</code> プロパティが効いていることが確認できる</li>
    </ul>
  </li>
  <li><a href="http://localhost/app-1/">http://localhost/app-1/</a>
    <ul>
      <li><code>./app-1/src/example.html</code> の内容が返ること</li>
      <li>アプリケーションサーバ <code>app-1</code> が3001番ポートで起動しており、nginx がリバースプロキシしていることが確認できる</li>
    </ul>
  </li>
  <li><a href="http://localhost/app-2/">http://localhost/app-2/</a>
    <ul>
      <li><code>./app-2/src/example.html</code> の内容が返ること</li>
      <li>アプリケーションサーバ <code>app-2</code> が3002番ポートで起動しており、nginx がリバースプロキシしていることが確認できる</li>
    </ul>
  </li>
</ol>
<p>それぞれちゃんと動作すれば OK。</p>
<p>502 Bad Gateway が出た場合は、アプリサーバがリスンしているポートが何になっているか、<code>default.conf</code> で指定しているポート番号が合っているか、などを確認してみよう。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>こんな感じで、nginx によるリバースプロキシの設定方法を確認できた。</p>
<p>Docker を使えばホストマシンへのインストール作業が要らなくなるし、Docker-Compose を使うことで複数のサーバを起動したりする手間が省ける。</p>
<p>仲介する・ラップする要素が増えると理解するのが難しくなるところもあるが、マシンに直接インストールして設定したりしていると、何がどうなっているのか整理が付かなくなる場合もあるので、こうしてクリーンな環境で試せるのは良いことだろう。</p>
<ul>
  <li>参考：<a href="https://qiita.com/ryo-ohnishi/items/3653f7583c8591eef333">docker+Node.js(Express)+nginxの最小構成プロジェクトを作成する - Qiita</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-06-24</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-06-24</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
