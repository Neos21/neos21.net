<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>JavaFX + OpenCV でウェブカメラを扱う GUI アプリを作り Gradle でセットアップした - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/06/04-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script defer src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/06/index.html">06月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-06-04</time></div>
        <h1 id="page-title">JavaFX + OpenCV でウェブカメラを扱う GUI アプリを作り Gradle でセットアップした</h1>

<p>Gradle を使ってセットアップした Java プロジェクトにて、JavaFX と OpenCV を組み合わせた GUI アプリを作ってみた。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AA%E3%81%8B">何ができるアプリか</a></li>
  <li><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89">ソースコード</a></li>
  <li><a href="#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83">動作確認環境</a>
    <ul>
      <li><a href="#jdk-180_65-%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B">JDK <code>1.8.0_65</code> をダウンロードする</a></li>
      <li><a href="#opencv-%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B">OpenCV をセットアップする</a></li>
    </ul>
  </li>
  <li><a href="#%E4%BD%BF%E3%81%84%E6%96%B9">使い方</a></li>
  <li><a href="#%E8%A6%9A%E3%81%88%E3%81%9F%E3%81%93%E3%81%A8">覚えたこと</a>
    <ul>
      <li><a href="#-gradlew-run-%E5%AE%9F%E8%A1%8C%E6%99%82%E3%81%AB-opencv-%E3%81%AE%E3%83%91%E3%82%B9%E3%82%92%E9%80%9A%E3%81%99"><code>$ ./gradlew run</code> 実行時に OpenCV のパスを通す</a></li>
      <li><a href="#%E3%81%93%E3%81%AE%E6%96%87%E5%AD%97%E3%81%AF%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0ms932%E3%81%AB%E3%83%9E%E3%83%83%E3%83%97%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93-%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%92%E5%9B%9E%E9%81%BF%E3%81%99%E3%82%8B"><code>この文字は、エンコーディングMS932にマップできません</code> エラーを回避する</a></li>
      <li><a href="#vscode-%E3%81%A7-opencv-%E3%81%AE%E8%87%AA%E5%8B%95%E8%A3%9C%E5%AE%8C%E3%81%8C%E5%8A%B9%E3%81%8B%E3%81%AA%E3%81%84">VSCode で OpenCV の自動補完が効かない</a></li>
    </ul>
  </li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="何ができるアプリか"><a class="header-link" href="#何ができるアプリか"><span class="header-link-mark"></span></a>何ができるアプリか</h2>
<p>今回作成したアプリは、ウェブカメラのプレビューが確認できるだけのアプリ。</p>
<p><strong>JavaFX</strong> を使用して GUI ウィンドウを開き、PC に接続されているウェブカメラデバイスを特定して OpenCV の機能で映像をキャプチャする。キャプチャした映像からコマ画像を切り取り、JavaFX のウィンドウに描画しているというワケ。</p>
<p>このような Java アプリを <em>Gradle</em> でセットアップしていて、最終的にはアプリを単一 JAR ファイルにビルドしたりもできる。</p>
<h2 id="ソースコード"><a class="header-link" href="#ソースコード"><span class="header-link-mark"></span></a>ソースコード</h2>
<p>ソースコード全量は以下。</p>
<ul>
  <li><a href="https://github.com/Neos21/practice-javafx-opencv">Neos21/practice-javafx-opencv</a></li>
</ul>
<p>コレを見て理解いただけるようなら、以降の説明は要らないかな。</p>
<h2 id="動作確認環境"><a class="header-link" href="#動作確認環境"><span class="header-link-mark"></span></a>動作確認環境</h2>
<p>動作確認を行った環境は以下のとおり。</p>
<ul>
  <li>OS : Windows 10・MacOS Catalina・Ubuntu 18.04</li>
  <li>JDK : <code>v1.8.0_65</code>
    <ul>
      <li>Java8 は JavaFX が同梱されている最後の Oracle JDK なので、簡単にするためコレを採用した</li>
    </ul>
  </li>
  <li>OpenCV : v3.2.0
    <ul>
      <li>OS 別の導入方法は以前の記事でも紹介したので参考にされたし</li>
    </ul>
  </li>
</ul>
<h3 id="jdk-180_65-をダウンロードする"><a class="header-link" href="#jdk-180_65-をダウンロードする"><span class="header-link-mark"></span></a>JDK <code>1.8.0_65</code> をダウンロードする</h3>
<p>動作確認に使用した JDK は以下からダウンロードできる。</p>
<ul>
  <li><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">Java Archive Downloads - Java SE 8</a></li>
</ul>
<p>OS 別に以下のファイルをダウンロードしインストールした。</p>
<ul>
  <li>Windows : <code>jdk-8u65-windows-x64.exe</code></li>
  <li>MacOS : <code>jdk-8u65-macosx-x64.dmg</code></li>
  <li>Ubuntu : <code>jdk-8u65-linux-x64.tar.gz</code></li>
</ul>
<h3 id="opencv-をセットアップする"><a class="header-link" href="#opencv-をセットアップする"><span class="header-link-mark"></span></a>OpenCV をセットアップする</h3>
<ul>
  <li>Windows は公式の <code>opencv-3.2.0-vc14.exe</code> を解凍し任意の場所に配置する</li>
  <li>MacOS・Ubuntu ではソースコードからビルドして入手する</li>
  <li>いずれも、JAR ファイル <code>opencv-320.jar</code> が入手できるはずなので、コレを <code>./lib/</code> ディレクトリ配下にコピーする</li>
  <li>ネイティブライブラリは適宜 PATH を通しておくか、実行時にオプション引数で指定することになる</li>
</ul>
<h2 id="使い方"><a class="header-link" href="#使い方"><span class="header-link-mark"></span></a>使い方</h2>
<p>前述のリポジトリを <code>git clone</code> してもらったら、<code>./lib/</code> ディレクトリ配下に <code>opencv-320.jar</code> を配置してもらう。ファイル名は同じでも OS により内容が若干異なるようなので、自分のマシンにインストールした OpenCV から取得するのが確実。</p>
<ul>
  <li><code>lib-mac/</code></li>
  <li><code>lib-ubuntu/</code></li>
  <li><code>lib-windows/</code></li>
</ul>
<p>配下にある JAR は、手元で動作確認した時のファイルを参考までに格納しただけ。</p>
<p>OpenCV は JAR ファイルだけでなく、ネイティブライブラリも必要になる。ネイティブライブラリは<em>パスを通して</em>やれば動作するので、特にプロジェクトディレクトリ配下にファイルをコピーしたりする必要はない。<em><code>build.gradle</code></em> を確認してもらい、必要に応じて OpenCV ネイティブライブラリへのパスを設定すれば OK。</p>
<p>設定ができたら、</p>
<pre class="language-bash"><code class="language-bash">$ ./gradlew run
</code></pre>
<p>でアプリが起動できる。</p>
<p>JavaFX によるウィンドウが開き、「Start」「Stop」というボタンが見えていれば OK。</p>
<ul>
  <li><strong><code>UnsatisfiedLinkError</code></strong> といったエラーが出てウィンドウが起動できなかった場合は、OpenCV のネイティブライブラリが見つけられなかった場合なので、<code>build.gradle</code> の設定を確認してもらったり、<code>.dll</code> or <code>.dylib</code> or <code>.so</code> ファイルの配置場所などを確認してもらいたい。</li>
</ul>
<p>ウィンドウが開いたら、「Start」ボタンを押す。するとマシンに接続されているウェブカメラがキャプチャされ、プレビューが表示されるはずだ。</p>
<ul>
  <li>ウェブカメラが接続されていなかったり、上手くキャプチャが開始できなかった場合はワーニングが表示されるはず。</li>
  <li><code>RootController.java</code> にて <code>VideoCapture#open(0)</code> と実装している。引数の <code>0</code> はカメラデバイスの ID で、<code>0</code> がマシンに最初に接続されているデフォルトのカメラとなる。Linux なんかだと <code>/dev/video0</code> などで番号が確認できる。</li>
</ul>
<p>内部的には OpenCV の <code>Mat</code> という形式で映像からフレーム (コマ画像) を取得しており、コレを JavaFX で使う <code>Image</code> 形式に変換して描画している。<code>Mat</code> イメージを取得した後、<code>Image</code> に変換するまでの間にアレコレ処理をすれば、キャプチャした画像に文字列や図形を描画してみせたり、画像をグレースケールに加工したりなどができるワケだ。</p>
<p>「Stop」ボタンを押せば、ウェブカメラのプレビューが閉じられる。</p>
<p>JAR ファイルにビルドする時は、</p>
<pre class="language-bash"><code class="language-bash">$ ./gradlew build
</code></pre>
<p>コマンドで <code>./build/libs/</code> 配下に JAR ファイルが生成される。</p>
<p>OpenCV のネイティブライブラリを同梱したりはしていないので、実行時に環境変数なりオプション引数なりで指定してやる必要がある。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Windows の場合の例</span>
$ java -Djava.library.path<span class="token operator">=</span><span class="token string">'C:\PATH\TO\opencv<span class="token entity" title="\b">\b</span>uild\java<span class="token entity" title="\x64">\x64</span>'</span> -jar ./build/libs/practice-javafx-opencv.jar
</code></pre>
<h2 id="覚えたこと"><a class="header-link" href="#覚えたこと"><span class="header-link-mark"></span></a>覚えたこと</h2>
<p>Gradle・JavaFX・OpenCV と、個人的には経験のなかった技術スタックなので、色々と覚えることがあった。</p>
<p>Gradle + JavaFX までのところは以前 Tips 記事を書いたモノが流用できている。</p>
<p>OpenCV を使うにあたって、もしくは Windows で発生したエラー対応のため、調整したことがある。</p>
<h3 id="-gradlew-run-実行時に-opencv-のパスを通す"><a class="header-link" href="#-gradlew-run-実行時に-opencv-のパスを通す"><span class="header-link-mark"></span></a><code>$ ./gradlew run</code> 実行時に OpenCV のパスを通す</h3>
<p>MacOS や Linux の場合はソースコードからビルドするので、PATH の通った場所に OpenCV のネイティブライブラリが格納されるっぽいのだが、Windows では自分で PATH を通さないといけない。</p>
<p>環境変数 <code>PATH</code> で通しても良いが、<code>build.gradle</code> 内で設定する方法があったので書いておいた。以下は <code>./gradlew run</code> 実行時に、Windows OS でのみ、Java 実行オプションを設定するというモノ。</p>
<pre class="language-groovy"><code class="language-groovy">run <span class="token punctuation">{</span>
  <span class="token comment">// For Windows : Set OpenCV Native Library Path</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>gradle<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>OperatingSystem<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    systemProperty <span class="token string gstring">"java.library.path"</span><span class="token punctuation">,</span> <span class="token function">file</span><span class="token punctuation">(</span><span class="token string gstring">"C:\\PATH\\TO\\opencv\\build\\java\\x64"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
  <li>参考 : <a href="https://github.com/cjstehno/coffeaelectronica/wiki/Going-Native-with-Gradle">Going Native with Gradle · cjstehno/coffeaelectronica Wiki · GitHub</a></li>
  <li>参考 : <a href="https://stackoverflow.com/questions/52569724/javafx-11-create-a-jar-file-with-gradle">JavaFX 11 : Create a jar file with Gradle - Stack Overflow</a> … 同様に <code>isLinux()</code>・<code>isMacOsX()</code> なども確認できる</li>
</ul>
<h3 id="この文字はエンコーディングms932にマップできません-エラーを回避する"><a class="header-link" href="#この文字はエンコーディングms932にマップできません-エラーを回避する"><span class="header-link-mark"></span></a><code>この文字は、エンコーディングMS932にマップできません</code> エラーを回避する</h3>
<p>Windows 環境の GitBash で <code>./gradlew run</code> を実行したところ、</p>
<pre><code>この文字は、エンコーディングMS932にマップできません
</code></pre>
<p>とかいうエラーが出た。</p>
<p>個人的には、MacOS などでは</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">_JAVA_OPTIONS</span><span class="token operator">=</span><span class="token string">'-Dfile.encoding=UTF-8'</span>
</code></pre>
<p>などと環境変数で設定しているので、Windows で試すまで気付かなかった。</p>
<p>コレも <code>build.gradle</code> にてエンコーディングを指定してやれば良い。</p>
<pre class="language-groovy"><code class="language-groovy">tasks<span class="token punctuation">.</span><span class="token function">withType</span><span class="token punctuation">(</span>JavaCompile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// For Windows : Set Character Encoding</span>
  options<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'UTF-8'</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
  <li>参考 : <a href="https://m213f.hateblo.jp/entry/2018/10/26/210803">Gradleでコンパイル時の文字コードを指定する - m213f</a></li>
</ul>
<h3 id="vscode-で-opencv-の自動補完が効かない"><a class="header-link" href="#vscode-で-opencv-の自動補完が効かない"><span class="header-link-mark"></span></a>VSCode で OpenCV の自動補完が効かない</h3>
<p>VSCode に導入した Java Extension Pack は、独自に <code>.classpath</code> ファイルを作り、コイツによって自動補完を実現している。Gradle の動作としては <code>.classpath</code> は不要なのだが、VSCode での開発時は <code>.classpath</code> ファイルをうまく設定してやらないと、自動補完が効かない。</p>
<p>OpenCV についても、<code>./lib/opencv-320.jar</code> を格納した後、<code>.classpath</code> ファイルに次のような記述をしてやらないと、<code>import</code> などの自動補完がされなくて手間なので、忘れず設定しておく。</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>classpath</span><span class="token punctuation">></span></span>
  <span class="token comment">&#x3C;!-- …中略… --></span>
  
  <span class="token comment">&#x3C;!-- Enable To Reference OpenCV Library on VSCode --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>classpathentry</span> <span class="token attr-name">kind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lib<span class="token punctuation">"</span></span> <span class="token attr-name">exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lib/opencv-320.jar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>accessrules</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>accessible</span> <span class="token attr-name">kind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>accessible<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>**<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>accessrules</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>classpathentry</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>classpath</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>accessrules</code> が大事。</p>
<ul>
  <li>参考 : <a href="https://github.com/Neos21/practice-javafx-opencv/blob/master/.classpath">practice-javafx-opencv/.classpath at master · Neos21/practice-javafx-opencv · GitHub</a></li>
</ul>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>OpenCV って結構導入のハードル高いなーというのが率直な思い。Gradle も、Eclipse や Maven でチクチクやってた依存解決を別の DSL で覚え直さないといけない感じで、まぁまぁ面倒クセェなーと。npm (Node.js) のパッケージ管理システムが一番気楽だなーと思った。</p>
<p>しかし一方、ウェブカメラのキャプチャを高速に行いたかったりすると、やはりこうしたネイティブライブラリを組み合わせないといけないので、今回やってみた次第。</p>
<p>今回実装した範囲だと、ウェブカメラの映像をキャプチャしてそれをそのまま表示しているだけだが、Mat イメージが拾えているので、ココから映像をあれやこれや加工していく基礎部分が出来たと思うので、もう少し OpenCV を勉強してみる。</p>
<p>JavaFX は FXML での記述の他、独自の CSS も組み合わせられるので、SPA・フロントエンド開発に近い感覚でコンポーネントを作れると思った。FXML を使わず全てを Java 側で実装することもできて、コレをやると jQuery で HTML ソースをブチ込んでいた頃を思い出す。笑</p>
<p>いずれもクセがあるが、まぁまぁやりたいことはできた感。JavaFX なら OS 問わず GUI が構築できるし、裏で使う OpenCV も各 OS で動かせるようになったので、アプリとしては OS を意識せず実装できていてよきよき。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-06-04</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-06-04</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
