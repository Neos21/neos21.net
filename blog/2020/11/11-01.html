<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Remark・Rehype を使って Markdown から HTML に変換する - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/11/11-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-11-11</time></div>
        <h1 id="page-title">Remark・Rehype を使って Markdown から HTML に変換する</h1>

<p>Gatsby.js を使っていて、Markdown ファイルをブログ記事として投稿できる <code>gatsby-transformer-remark</code> というパッケージを使ってみた。</p>
<ul>
  <li><a href="https://www.gatsbyjs.com/plugins/gatsby-transformer-remark/">gatsby-transformer-remark | Gatsby</a></li>
</ul>
<p>プラグインを入れていくと、<strong>Frontmatter</strong> と呼ばれる YAML テンプレート部分を解釈できるようで、同様の仕組みは <em>Hexo</em> という静的サイトジェネレータでも導入されている。</p>
<ul>
  <li><a href="https://middlemanapp.com/jp/basics/frontmatter/">Middleman: Frontmatter</a></li>
</ul>
<p>こうした仕組みが面白そうだったので、内部実装を調べてみると、<strong>Remark</strong> とか <em>Rehype</em> とかいうパッケージが利用されていた。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#remark-%E3%81%A8%E3%81%AF">Remark とは</a></li>
  <li><a href="#rehype-%E3%81%A8%E3%81%AF">Rehype とは</a></li>
  <li><a href="#markdown-%E3%81%A8-html-%E3%81%AE%E7%9B%B8%E4%BA%92%E5%A4%89%E6%8F%9B">Markdown と HTML の相互変換</a></li>
  <li><a href="#%E7%B7%B4%E7%BF%92%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E5%85%AC%E9%96%8B">練習リポジトリ公開</a></li>
  <li><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B">実際にやってみる</a></li>
  <li><a href="#%E4%BB%8A%E5%9B%9E%E3%81%AF%E3%82%B3%E3%82%B3%E3%81%BE%E3%81%A7">今回はココまで</a></li>
</ul>
<h2 id="remark-とは"><a class="header-link" href="#remark-とは"><span class="header-link-mark"></span></a>Remark とは</h2>
<p>はじめに、今回紹介するのは、以下の gnab/remark <strong>ではない</strong>。</p>
<ul>
  <li>参考 : <a href="https://remarkjs.com/">Remark</a></li>
  <li>参考 : <a href="https://github.com/gnab/remark">GitHub - gnab/remark: A simple, in-browser, markdown-driven slideshow tool.</a>
    <ul>
      <li>コチラは Markdown からスライドショーを作成できるツール</li>
    </ul>
  </li>
</ul>
<p>今回紹介するのは、公式サイト <code>remark.js.org</code>、remarkjs/remark だ。</p>
<ul>
  <li><a href="https://remark.js.org/">remark - markdown processor powered by plugins</a></li>
  <li><a href="https://github.com/remarkjs/remark">GitHub - remarkjs/remark: Markdown processor powered by plugins part of the @unifiedjs collective</a></li>
</ul>
<p>Remark は、Unified.js という規格に沿って作られた Markdown のパーサで、様々な機能をプラグインで導入できる。</p>
<ul>
  <li><a href="https://unifiedjs.com/">unified</a></li>
</ul>
<p>Remark に関する代表的なパッケージは以下の2つ。</p>
<ul>
  <li><code>remark-parse</code> : Markdown をパースして <code>mdast</code> という AST (抽象構文木) に変換する</li>
  <li><code>remark-stringify</code> : <code>mdast</code> をパースして Markdown に変換する</li>
</ul>
<p>上の2つだけ見ると、「Markdown → mdast → Markdown」としか扱えず、HTML 化できないんじゃないの？と思われるだろう。そこで登場するのが <strong>Rehype</strong> だ。</p>
<h2 id="rehype-とは"><a class="header-link" href="#rehype-とは"><span class="header-link-mark"></span></a>Rehype とは</h2>
<p>Rehype は、Unified.js の規格に沿って作られた <em>HTML のパーサ</em>だ。コチラにも以下のようなパッケージがある。</p>
<ul>
  <li><code>rehype-parse</code> : HTML をパースして <code>hast</code> という AST に変換する</li>
  <li><code>rehype-stringify</code> : <code>hast</code> をパースして HTML に変換する</li>
</ul>
<p>コチラもコレだけ見ると、「HTML → hast → HTML」としか扱えない。</p>
<h2 id="markdown-と-html-の相互変換"><a class="header-link" href="#markdown-と-html-の相互変換"><span class="header-link-mark"></span></a>Markdown と HTML の相互変換</h2>
<p>じゃあ Markdown から HTML に変換するにはどうしたらいいかというと、変換用のパッケージがある。</p>
<ul>
  <li><strong><code>remark-rehype</code></strong> : mdast から hast に変換する</li>
  <li><code>rehype-remark</code> : hast から mdast に変換する</li>
</ul>
<p>つまり、一度 AST に変換して、それから双方の AST へと変換するワケだ。</p>
<p>ということで Markdown から HTML へと変換するには、</p>
<ol>
  <li><code>remark-parse</code> で Markdown を mdast に変換する</li>
  <li><code>remark-rehype</code> で mdast から hast に変換する</li>
  <li><code>rehype-stringify</code> で hast から HTML に変換する</li>
</ol>
<p>と、3つの手順を踏むことになる。</p>
<h2 id="練習リポジトリ公開"><a class="header-link" href="#練習リポジトリ公開"><span class="header-link-mark"></span></a>練習リポジトリ公開</h2>
<p>以降、色々と解説していくが、先に Remark を触ってみた練習用リポジトリを紹介しておく。</p>
<ul>
  <li><a href="https://github.com/Neos21/practice-remark">Neos21/practice-remark</a></li>
</ul>
<p>コード全量はコチラにあるのでご参考までに。</p>
<h2 id="実際にやってみる"><a class="header-link" href="#実際にやってみる"><span class="header-link-mark"></span></a>実際にやってみる</h2>
<p>それでは実際に変換してみよう。作業用ディレクトリを作り、<code>package.json</code> を作っておく。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> init -y
</code></pre>
<p>そしたら以下のパッケージをインストールする。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -S unified@9.0.2 remark-parse@8.0.3 remark-rehype@8.0.0 rehype-stringify@8.0.0
</code></pre>
<p>パッケージのバージョンを指定しているが、特に重要なのは <strong><code>remark-parse@8.0.3</code></strong>。remark-parse は最近 v9.0.0 にメジャーバージョンアップして、<em>Pedantic</em> という Markdown の仕様が扱えなくなった。</p>
<p>Pedantic Markdown は、CommonMark とは若干仕様が異なり、分かち書きをせずアンダースコア <code>_</code> による強調ができたりする。しかしその挙動にはバグが多く、remark-parse v9 ではオミットされたのだ。</p>
<p>英語圏の人間にとってはバグに近い挙動が多く不要とされたようだが、分かち書きがない日本語に対してはアスタリスクよりもアンダースコアで強調した方が生の Markdown が見やすく、個人的には気に入っている。そのため、ココではあえて旧バージョンである remark-parse v8.0.3 をインストールしている。</p>
<ul>
  <li>参考 : <a href="https://www.infoq.com/jp/news/2014/09/markdown-commonmark/">Standard MarkdownがCommon Markdow、そしてCommonMarkに</a></li>
  <li>参考 : <a href="https://archive.craftz.dog/blog.odoruinu.net/2016/12/09/rendering-markdown-with-remark-react/index.html">remark+ReactでMarkdownをレンダリングする – 踊る犬.netブログ (旧)</a></li>
  <li>参考 : <a href="https://github.com/remarkjs/remark/discussions/547">How to use pedantic mode With remark v13 (remark-parse v9.0.0)? · Discussion #547 · remarkjs/remark · GitHub</a></li>
</ul>
<p>ちなみに、remark-parse v9 からは内部実装が大きく変わっていて、remark-parse は <a href="https://github.com/syntax-tree/mdast">mdast</a> ファミリの<a href="https://github.com/syntax-tree/mdast-util-from-markdown">ユーティリティ</a>にほとんどの処理を横流ししているだけ。mdast のユーティリティは内部で <a href="https://github.com/micromark/micromark">micromark</a> というパーサを使っていて、実体 (実処理) は micromark が持っている。remark 本体は CommonMark のパースにしか対応しておらず、GFM (GitHub Flavored Markdown) や Footnotes などの拡張構文については別途プラグインが存在する。Remark はただのインターフェースでしかないので、調節 Micromark を使う方が柔軟なこともありそうだ…。</p>
<hr>
<p>他のパッケージのバージョンは、自分が検証したバージョン番号。原則、本稿執筆時点の最新版なのでご安心を。</p>
<p>パッケージをインストールしたら、<code>index.js</code> を作って以下のように実装していく。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">promises</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> unified <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'unified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkParse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-parse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkRehype <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-rehype'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeStringify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-stringify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Markdown テキストをファイルから取得する</span>
  <span class="token keyword">const</span> inputMarkdownText <span class="token operator">=</span> <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token string">'./input.md'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 変換するプラグインを、変換したい順に連ねていく</span>
  <span class="token keyword">const</span> processor <span class="token operator">=</span> <span class="token function">unified</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkParse<span class="token punctuation">)</span>       <span class="token comment">// Markdown → mdast</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkRehype<span class="token punctuation">)</span>      <span class="token comment">// mdast → hast</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeStringify<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// hast → HTML</span>
  <span class="token comment">// パーサを実行する</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> processor<span class="token punctuation">.</span><span class="token method function property-access">process</span><span class="token punctuation">(</span>inputMarkdownText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 生成した HTML をファイルに書き出す</span>
  <span class="token keyword">const</span> outputHtmlText <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">writeFile</span><span class="token punctuation">(</span><span class="token string">'./output.html'</span><span class="token punctuation">,</span> outputHtmlText<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>こんな感じで、<code>input.md</code> の内容が <code>output.html</code> に変換されて出力される。</p>
<h2 id="今回はココまで"><a class="header-link" href="#今回はココまで"><span class="header-link-mark"></span></a>今回はココまで</h2>
<p>Remark や Unified.js 関連の npm パッケージは細かく分割されていて、<strong>やりたいことに対して何をどう組み合わせたらいいのかが物凄く分かりづらい</strong>。最近 Remark 周りのメジャーバージョンアップがあったことで、最新版では使えなくなっているパッケージも多かった。そもそも文献が少ないので、メチャクチャググって、トライアル・アンド・エラーを繰り返す他なかった。</p>
<p>marked.js などのようなパーサはその辺サクッととりまとめてくれているものの、利用者からはパーサの内部が見えないので、拡張構文を扱ったり、HTML 変換に向けて AST を扱ったりするのは大変だった。</p>
<p>そういう意味では、Remark は柔軟なカスタマイズが可能で、特に HTML ファイルを生成するためにはかなり有用だと感じた。</p>
<p>次回は Frontmatter などの拡張構文を解釈できるようにし、HTML 出力もカスタマイズしてみようと思う。</p>
<ul>
  <li>参考 : <a href="https://vivliostyle.github.io/vivliostyle_doc/ja/vivliostyle-user-group-vol2/spring-raining/index.html">Remark で広げる Markdown の世界</a>
    <ul>
      <li>独自パーサの作り方が丁寧に紹介されているが、remark-parse v9 以降では通用しない古い方式なのが残念…</li>
    </ul>
  </li>
  <li>参考 : <a href="https://dev.classmethod.jp/articles/2020-04-15-conv-html-use-rehype/">rehypeを使ってHTMLを書き換える | Developers.IO</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-11-11</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-11-11</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
