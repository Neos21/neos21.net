<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する - Neo's World">
    <meta property="og:description" content="Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2020/11/13-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する - Neo's World">
    <meta property="twitter:description" content="Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2020/11/13-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/11/13-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-11-13</time></div>
        <h1 id="page-title">Remark・Rehype プラグインで文書の見出しに自動で ID を振り目次リストを自動生成する</h1>

<p>Markdown や HTML をパースして加工できる Remark・Rehype のプラグイン紹介。今回は見出しに <code>id</code> 属性を自動付与し、目次 (Table of Contents・ToC) を自動生成してくれるプラグインを紹介する。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#markdown-%E3%81%8B%E3%82%89-html-%E3%81%AB%E3%83%91%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AB%E8%A6%8B%E5%87%BA%E3%81%97-id-%E3%81%A8%E7%9B%AE%E6%AC%A1%E3%82%92%E8%87%AA%E5%8B%95%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B">Markdown から HTML にパースする際に見出し ID と目次を自動付与する</a></li>
  <li><a href="#html-%E3%82%92%E3%83%91%E3%83%BC%E3%82%B9%E3%81%97%E3%81%A6%E8%A6%8B%E5%87%BA%E3%81%97-id-%E3%81%A8%E7%9B%AE%E6%AC%A1%E3%82%92%E8%87%AA%E5%8B%95%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B">HTML をパースして見出し ID と目次を自動付与する</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="markdown-から-html-にパースする際に見出し-id-と目次を自動付与する"><a class="header-link" href="#markdown-から-html-にパースする際に見出し-id-と目次を自動付与する"><span class="header-link-mark"></span></a>Markdown から HTML にパースする際に見出し ID と目次を自動付与する</h2>
<p>Markdown から HTML にパースする際に自動付与するには、</p>
<ul>
  <li><a href="https://github.com/remarkjs/remark-slug">remark-slug</a></li>
  <li><a href="https://github.com/remarkjs/remark-toc">remark-toc</a></li>
</ul>
<p>というパッケージを使うのが良いだろう。インストールする npm パッケージは以下のとおり。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Markdown を HTML へと変換するために必要な最低限の Unified・Remark・Rehype 関連パッケージ</span>
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev unified remark-parse remark-rehype rehype-stringify

<span class="token comment"># ID 付与と ToC 付与に必要なパッケージ</span>
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev remark-slug remark-toc
</code></pre>
<p>サンプルの Markdown はこんな感じ。</p>
<pre class="language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> タイトル</span>
文章

<span class="token title important"><span class="token punctuation">##</span> 目次</span>

<span class="token title important"><span class="token punctuation">##</span> はじめに</span>
文章…

<span class="token title important"><span class="token punctuation">##</span> つぎに</span>
文章…

<span class="token title important"><span class="token punctuation">###</span> 補足</span>
文章…

<span class="token title important"><span class="token punctuation">##</span> さらに</span>
文章…
</code></pre>
<p><strong><code>## 目次</code></strong> という、見出しだけの行があることに留意。</p>
<p>以下のようにパースする。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">promises</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> unified <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'unified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkParse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-parse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkSlug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-slug'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkToc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-toc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remarkRehype <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'remark-rehype'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeStringify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-stringify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputMarkdown <span class="token operator">=</span> <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token string">'./example.md'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> processor <span class="token operator">=</span> <span class="token function">unified</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkParse<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkSlug<span class="token punctuation">)</span>  <span class="token comment">// 見出しに ID を自動付与する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkToc<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      heading<span class="token operator">:</span> <span class="token string">'目次'</span><span class="token punctuation">,</span>  <span class="token comment">// Table of Contents を挿入するための見出しを指定する</span>
      tight<span class="token operator">:</span> <span class="token boolean">true</span>       <span class="token comment">// `true` にすると `li` 要素内に `p` 要素を作らないようになる</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>remarkRehype<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeStringify<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> processor<span class="token punctuation">.</span><span class="token method function property-access">process</span><span class="token punctuation">(</span>inputMarkdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> outputHtml <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">writeFile</span><span class="token punctuation">(</span><span class="token string">'./example.html'</span><span class="token punctuation">,</span> outputHtml<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>こうすると、生成される HTML は次のようになる。インデントは少し整形している。</p>
<pre class="language-markdown"><code class="language-markdown"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>タイトル<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>タイトル<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>目次<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>目次<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>はじめに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#%E3%81%A4%E3%81%8E%E3%81%AB<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>つぎに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ul</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#%E8%A3%9C%E8%B6%B3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>補足<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#%E3%81%95%E3%82%89%E3%81%AB<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>さらに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>はじめに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>はじめに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>つぎに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>つぎに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>補足<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>補足<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h3</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>さらに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>さらに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>remark-slug</code> プラグインにより、各見出しに <code>id</code> 属性が自動付与された。<code>id</code> 属性値には日本語が混じっていても HTML 仕様上は問題ない。</p>
<p>海外ではこのような見出し ID のことを <em>Slug</em> と呼ぶらしい。</p>
<p>で、<code>## 目次</code> と書いていた部分には、ネストされた <code>ul</code> 要素が追加されていて、各見出しへのリンクが自動的に追加されている。コチラは <code>remark-toc</code> プラグインが処理するためか、<code>href</code> 属性値がパーセント・エンコーディングされているが、動作上は問題ない。</p>
<h2 id="html-をパースして見出し-id-と目次を自動付与する"><a class="header-link" href="#html-をパースして見出し-id-と目次を自動付与する"><span class="header-link-mark"></span></a>HTML をパースして見出し ID と目次を自動付与する</h2>
<p>次は、Markdown ファイルではなく HTML ファイルがベースの場合。HTML を扱う場合は、Remark ではなく Rehype 関連のプラグインを使うと良い。今回使うのは以下の2つ。</p>
<ul>
  <li><a href="https://github.com/rehypejs/rehype-slug">rehype-slug</a></li>
  <li><a href="https://github.com/JS-DevTools/rehype-toc">rehype-toc</a>
    <ul>
      <li>npm パッケージ名は <code>rehype-toc</code> でも <code>@jsdevtools/rehype-toc</code> でも、どちらでも同じモノが落とせる</li>
    </ul>
  </li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># HTML を扱うために必要な最低限の Unified・Rehype 関連パッケージ</span>
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev unified rehype-parse rehype-stringify

<span class="token comment"># ID 付与と ToC 付与に必要なパッケージ</span>
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev rehype-slug @jsdevtools/rehype-toc
</code></pre>
<p>サンプルの HTML はこんな感じ。「はじめに」の章だけ、<code>id="first"</code> と自前の ID が振られていることに留意。</p>
<pre class="language-markdown"><code class="language-markdown"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>タイトル<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>はじめに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span>つぎに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h3</span><span class="token punctuation">></span></span>補足<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h3</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span>さらに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
</code></pre>
<p>そして以下のようにパースする。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">promises</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> unified <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'unified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeParse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-parse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeSlug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-slug'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeToc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-toc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rehypeStringify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rehype-stringify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputHtml <span class="token operator">=</span> <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token string">'./example-input.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> processor <span class="token operator">=</span> <span class="token function">unified</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeParse<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// `html`・`head`・`body` 要素がない HTML ファイルをそのまま変換する</span>
      <span class="token comment">// (`html`・`head`・`body` 要素を自動付与しない)</span>
      fragment<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeSlug<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeToc<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      headings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'h2'</span><span class="token punctuation">,</span> <span class="token string">'h3'</span><span class="token punctuation">,</span> <span class="token string">'h4'</span><span class="token punctuation">,</span> <span class="token string">'h5'</span><span class="token punctuation">,</span> <span class="token string">'h6'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// `h1` 要素をリストに含めない</span>
      nav<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// `nav` 要素を付与しない (`false`)</span>
      cssClasses<span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 各要素に付与する CSS クラス名。ココでは CSS クラス名を付与しない</span>
        toc<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        list<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        listItem<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// hast という AST 仕様に則り、生成される ToC をカスタマイズできる</span>
      <span class="token comment">// デフォルトでは `ol` 要素で出力されるリストを `ul` 要素に書き換えている (ネストするあため再帰呼び出し)</span>
      <span class="token function-variable function">customizeTOC</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">toc</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">replacer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          children<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token string">'element'</span> <span class="token operator">&#x26;&#x26;</span> child<span class="token punctuation">.</span><span class="token property-access">tagName</span> <span class="token operator">===</span> <span class="token string">'ol'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              child<span class="token punctuation">.</span><span class="token property-access">tagName</span> <span class="token operator">=</span> <span class="token string">'ul'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">replacer</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">replacer</span><span class="token punctuation">(</span><span class="token punctuation">[</span>toc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>rehypeStringify<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> processor<span class="token punctuation">.</span><span class="token method function property-access">process</span><span class="token punctuation">(</span>inputHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> outputHtml <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> fs<span class="token punctuation">.</span><span class="token method function property-access">writeFile</span><span class="token punctuation">(</span><span class="token string">'./example-output.html'</span><span class="token punctuation">,</span> outputHtml<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>生成される HTML は次のようになる。インデントのみ調整してある。</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#first<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>はじめに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#つぎに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>つぎに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ul</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#補足<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>補足<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#さらに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>さらに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ul</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>タイトル<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>タイトル<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>はじめに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>つぎに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>つぎに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>補足<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>補足<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h3</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>さらに<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>さらに<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>文章…<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
</code></pre>
<p>目次を構成する <code>ul</code> 要素が、HTML の先頭に付与されている。<code>remark-toc</code> のように <code>## 目次</code> と書いた場所に挿入するような自由度が欲しいが、残念ながら現時点では実装されていない。</p>
<ul>
  <li>参考 : <a href="https://github.com/JS-DevTools/rehype-toc/issues/2">Possibility to put the TOC in a specific element · Issue #2 · JS-DevTools/rehype-toc · GitHub</a>
    <ul>
      <li>「任意の場所に挿入できるようにしてくれ」という Issue</li>
    </ul>
  </li>
</ul>
<p>挿入位置以外のオプションは豊富で、色々とカスタマイズしてなるべく <code>remark-toc</code> に近い出力結果になるようにしてみた。</p>
<ul>
  <li><code>h1</code> 要素をページタイトルにしている場合、コレが ToC に含まれると違和感があるので、オプションの <code>headings</code> で <code>h1</code> 要素を除外した</li>
  <li><code>nav</code> や <code>cssClasses</code> による加工の他、<code>customizeTOC</code> や <code>customizeTOCItem</code> は hast (HTML AST) を関数で受け取って処理できるので、要素や属性、文言の追加・変更などができる</li>
</ul>
<p>目次要素への ID 付与は <code>rehype-slug</code> が行っているが、<code>&#x3C;h2 id="first"></code> のように、既に ID が付与されている場合はその値がそのまま利用される。<code>rehype-toc</code> との連携も問題なし。<code>rehype-toc</code> は <code>href</code> 属性値をパーセント・エンコーディングしないようだが、動作には特に問題ない。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p><code>remark-slug</code>・<code>remark-toc</code> のコンビと、<code>rehype-slug</code>・<code>rehype-toc</code> のコンビを紹介した。プラグインの作者も違って、微妙に仕様が異なる。特に <code>rehype-toc</code> は目次リストの挿入位置が決められないので、若干使い勝手が悪い気がするが、ココは適宜、パース後に自分で <code>replace()</code> をかけるなど原始的な方法でも調整できそう。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-11-13</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-11-13</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
