<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Ubuntu 18.04 の GNOME に XRDP 接続してみたかった - Neo's World">
    <meta property="og:description" content="Ubuntu 18.04 の GNOME に XRDP 接続してみたかった - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2020/04/09-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Ubuntu 18.04 の GNOME に XRDP 接続してみたかった - Neo's World">
    <meta property="twitter:description" content="Ubuntu 18.04 の GNOME に XRDP 接続してみたかった - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2020/04/09-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Ubuntu 18.04 の GNOME に XRDP 接続してみたかった - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/04/09-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/04/index.html">04月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-04-09</time></div>
        <h1 id="page-title">Ubuntu 18.04 の GNOME に XRDP 接続してみたかった</h1>

<p>最近 Ubuntu 18.04 をイジっている。一般には不人気らしいけど、デフォルトの GNOME デスクトップは個人的には気に入っている。</p>
<p>自分が構築した Ubuntu 環境は以下の3種類がある。</p>
<ol>
  <li>ThinkPad X250 にクリーンインストールした Ubuntu 18.04 日本語 Remix
    <ul>
      <li>最もピュアな Ubuntu 環境として他の環境を構築する際に参考にしている</li>
      <li>コイツに XRDP 接続することはなく、Chrome Remote Desktop で事足りている</li>
    </ul>
  </li>
  <li>Windows Subsystem for Linux (WSL) の Ubuntu 18.04
    <ul>
      <li>GNOME 環境を構築し、VcXsrv で接続することで、「日本語 Remix」と遜色ない使い心地を実現できている</li>
      <li>コイツに対して、VcXsrv ではなく、Windows 標準の「リモートデスクトップ」で接続できたら良いなーと思い、XRDP 接続を試みようとしている</li>
    </ul>
  </li>
  <li>Oracle Cloud Infrastructure の Always Free な Compute Instance に立てた Ubuntu 18.04
    <ul>
      <li>Always Free (VM.Standard.E2.1.Micro シェイプ) な VM に Public IP を割り当てて作成した</li>
      <li>Canonical-Ubuntu-18.04-2020.02.18-0 イメージを使用しており、WSL Ubuntu と同様のパッケージをインストールして GNOME 環境の準備はした</li>
      <li>主にクラウド VM に対して「リモートデスクトップ」で接続できる Ubuntu 環境が構築できたら便利かなーと思い、コイツを本命に XRDP 接続を試みようとしている</li>
      <li>ちなみに、以前 Oracle Linux 7 + Xfce でリモートデスクトップ接続可能な OCI VM を作ったことはあるが、パッケージが少なくて使っていない<br><a href="/blog/2020/02/18-02.html">OCI Always Free Instance に Xfce をインストールして GUI 化する</a></li>
    </ul>
  </li>
</ol>
<p>というワケで、「リモートデスクトップ」からサクッと接続できる Ubuntu デスクトップがあったら便利かなーという軽いノリで XRDP を入れてみたが、<strong>うまく行かず…</strong>。今回はその記録を載せておく。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#wsl-ubuntu-%E3%81%AB-xrdp-%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%8B%E3%81%A3%E3%81%9F">WSL Ubuntu に XRDP 接続したかった</a></li>
  <li><a href="#oci-%E3%81%AE-ubuntu-vm-%E3%81%AB-xrdp-%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%8B%E3%81%A3%E3%81%9F">OCI の Ubuntu VM に XRDP 接続したかった</a></li>
  <li><a href="#x-window-system-%E5%91%A8%E3%82%8A%E3%81%AE%E7%9F%A5%E8%AD%98%E3%81%AA%E3%81%95%E3%81%99%E3%81%8E%E3%82%8B">X Window System 周りの知識なさすぎる…</a></li>
  <li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
<h2 id="wsl-ubuntu-に-xrdp-接続したかった"><a class="header-link" href="#wsl-ubuntu-に-xrdp-接続したかった"><span class="header-link-mark"></span></a>WSL Ubuntu に XRDP 接続したかった</h2>
<p>対象の Windows 環境は以下のとおり。Windows10 Pro 使用、WSL2 基盤の Ubuntu 18.04 を使用。</p>
<pre class="language-batch"><code class="language-batch"><span class="token operator">@</span><span class="token command"><span class="token keyword">Rem</span> コマンドプロンプトでバージョンが確認できる</span>
>ver
<span class="token command"><span class="token keyword">Microsoft</span> Windows [Version <span class="token number">10</span>.<span class="token number">0</span>.<span class="token number">19569</span>.<span class="token number">1000</span>]</span>
</code></pre>
<p>VcXsrv を使った GNOME デスクトップ環境、および日本語入力環境は構築済なので、次のように XRDP をインストールしセットアップしてみた。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> xrdp

<span class="token comment"># port=3389 と書いてあるので 3390 にする</span>
<span class="token comment"># カーソルの背景に黒い枠ができるのを防ぐため new_cursors を false にする</span>
<span class="token comment"># sudo vi /etc/xrdp/xrdp.ini</span>
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/port=3389/port=3390/g'</span>                /etc/xrdp/xrdp.ini
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/new_cursors=true/new_cursors=false/g'</span> /etc/xrdp/xrdp.ini
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/max_bpp=32/max_bpp=128/g'</span>             /etc/xrdp/xrdp.ini
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/xserverbpp=24/xserverbpp=128/g'</span>       /etc/xrdp/xrdp.ini

<span class="token function">sudo</span> <span class="token function">service</span> xrdp restart

<span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span><span class="token string">EOL<span class="token bash punctuation"> <span class="token operator">></span> ~/.xsessionrc</span>
export GNOME_SHELL_SESSION_MODE=ubuntu
export XDG_CURRENT_DESKTOP=ubuntu:GNOME
export XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
EOL</span>
</code></pre>
<p>「リモートデスクトップ」にて、<code>localhost:3390</code> で接続すると、XRDP のログイン画面までは表示される。しかしその後のログインがうまく行かない。</p>
<ul>
  <li>Xorg セッションだとログインしようとしたところで切断される</li>
  <li>X11rdp セッションだとログインのダイアログが消えたまま終わる</li>
  <li>Xvnc セッションだと次のような Connection Log が出て終わる</li>
</ul>
<pre><code>connecting to sesman ip 127.0.0.1 port 3350
sesman connect ok
sending login info to session manager, please wait...
login successful for display 10
VNC started connecting
VNC connecting to 127.0.0.1 5910
VNC error - problem connecting
some problem
</code></pre>
<p>ってな感じで思ったような動きにならず、コレ以上知識もなくて断念。</p>
<h2 id="oci-の-ubuntu-vm-に-xrdp-接続したかった"><a class="header-link" href="#oci-の-ubuntu-vm-に-xrdp-接続したかった"><span class="header-link-mark"></span></a>OCI の Ubuntu VM に XRDP 接続したかった</h2>
<p>OCI の Ubuntu 18.04 イメージを使って Always Free VM を構築した。<code>Out of capacity</code> のエラーメッセージが若干変わってた。</p>
<pre><code>Out of capacity for shape VM.Standard.E2.1.Micro in availability domain JAPC:AP-TOKYO-1-AD-1. Please try a different shape, availability domain, or fault domain. Or wait a few minutes and try again.
</code></pre>
<p>1日置いたら VM が作れるようになっていた。</p>
<p>Ubuntu VM には <code>opc</code> ユーザではなく <code>ubuntu</code> ユーザで SSH 接続する。SSH 接続したら、WSL の GNOME 環境を構築したときと同様に、各種日本語パッケージを入れたりしていった。</p>
<p>その後、次のように XRDP 接続の準備を進めていった。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y xrdp
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/new_cursors=true/new_cursors=false/g'</span> /etc/xrdp/xrdp.ini
<span class="token function">sudo</span> systemctl restart xrdp

<span class="token comment"># PolicyKit 設定</span>
<span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span><span class="token string">EOL<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/polkit-1/localauthority/50-local.d/xrdp-color-manager.pkla</span>
[Netowrkmanager]
Identity=unix-user:*
Action=org.freedesktop.color-manager.create-device
ResultAny=no
ResultInactive=no
ResultActive=yes
EOL</span>
<span class="token function">sudo</span> systemctl restart polkit

<span class="token comment"># XRDP 接続用ユーザを作る (opc や ubuntu ユーザとは別に)</span>
<span class="token function">sudo</span> adduser neo  <span class="token comment"># パスワードを設定する</span>
<span class="token function">sudo</span> gpasswd -a neo root
<span class="token function">sudo</span> gpasswd -a neo <span class="token function">sudo</span>
<span class="token function">sudo</span> gpasswd -a neo admin
<span class="token function">sudo</span> gpasswd -a neo lpadmin

<span class="token function">sudo</span> <span class="token function">su</span> - neo
<span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span><span class="token string">EOL<span class="token bash punctuation"> <span class="token operator">></span> ~/.xsessionrc</span>
export GNOME_SHELL_SESSION_MODE=ubuntu
export XDG_CURRENT_DESKTOP=ubuntu:GNOME
export XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
EOL</span>

<span class="token comment"># ファイアウォールが「状態: 非アクティブ」であることを確認する</span>
<span class="token function">sudo</span> ufw status

<span class="token comment"># XRDP を再起動する</span>
<span class="token function">sudo</span> systemctl restart xrdp
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> xrdp.service
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> xrdp-sesman.service

systemctl list-unit-files -t <span class="token function">service</span> <span class="token operator">|</span> <span class="token function">grep</span> xrdp
xrdp-sesman.service                            enabled
xrdp.service                                   enabled

<span class="token comment"># パスワードを使用して SSH 接続できるようにする</span>
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/PasswordAuthentication no/PasswordAuthentication yes/'</span> /etc/ssh/sshd_config
<span class="token function">sudo</span> /etc/init.d/ssh restart
</code></pre>
<p>こんな風に設定した。</p>
<p>VCN の Security List は、3389 や 3390 ポートなどへの接続を許可しておいた。しかし、「リモートデスクトップ接続」で <code>【Public IP】:3389</code> と入力しても接続できず <code>0x204</code> エラーになってしまった。どうもリモートデスクトップ接続のリクエストが VM にまで到達していないように見受けられる。</p>
<p>他に、VNC 接続を試してみたが、コチラも理解が及ばず、見様見真似では何もできなかった。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y tigervnc-standalone-server tightvncserver

<span class="token comment"># パスワードを決める・質問は n で回答する</span>
vncserver :1

<span class="token comment"># 終了する</span>
vncserver -kill :1

<span class="token builtin class-name">echo</span> <span class="token string">"exec gnome-session &#x26;"</span> <span class="token operator">|</span> <span class="token function">tee</span> ~/.vnc/xstartup
vncserver -localhost no
</code></pre>
<p>こんな風にすると <code>5901</code> ポートで VNC 接続ができるらしいが、何か CPU 使用率が爆上がりして全く動かなくなったりと不調が多く、断念した。</p>
<h2 id="x-window-system-周りの知識なさすぎる"><a class="header-link" href="#x-window-system-周りの知識なさすぎる"><span class="header-link-mark"></span></a>X Window System 周りの知識なさすぎる…</h2>
<p>LPIC Level 1 の勉強してるときも思ってたけど、Linux の GUI 環境構築周りの知識がなさすぎて辛い。何が悪いのか、どこを調べたらどう解決できるのか、全然分からん。</p>
<p>今回はもうやる気も削がれたので断念することにする。サクッとやれるやり方誰か教えてくんろー。</p>
<h2 id="参考文献"><a class="header-link" href="#参考文献"><span class="header-link-mark"></span></a>参考文献</h2>
<ul>
  <li><a href="https://blog.treedown.net/entry/2018/02/23/010000">繋がらないxrdpをとりあえず繋げる - treedown's Report</a></li>
  <li><a href="https://www.tenforums.com/tutorials/144208-windows-subsystem-linux-add-desktop-experience-ubuntu.html">https://www.tenforums.com/tutorials/144208-windows-subsystem-linux-add-desktop-experience-ubuntu.html</a></li>
  <li><a href="https://scratchpad.jp/debian-on-windows10-11/">DebianをWindows10上で動かす その11: GUIを使う (リモートデスクトップ編) | メモ置場のブログ</a></li>
  <li><a href="https://cpoint-lab.co.jp/article/201806/3238/">Ubuntu 18.04に xrdpをインストールしてみる – 株式会社シーポイントラボ ｜ 浜松のシステム・RTK-GNSS開発</a></li>
  <li><a href="https://blog.treedown.net/entry/2018/02/23/010000">繋がらないxrdpをとりあえず繋げる - treedown's Report</a></li>
  <li><a href="https://www.hiroom2.com/2018/04/28/ubuntu-1804-xrdp-gnome-ja/">Ubuntu 18.04: GNOMEデスクトップ環境にXRDPで接続する - Narrow Escape</a></li>
  <li><a href="https://www.hiroom2.com/2017/10/04/ubuntu-1704-xrdp-gnome-ja/">Ubuntu 17.04: GNOMEデスクトップ環境にXRDPで接続する - Narrow Escape</a></li>
  <li><a href="https://dev.to/darksmile92/linux-on-windows-wsl-with-desktop-environment-via-rdp-522g">Linux on Windows: WSL with Desktop Environment via RDP - DEV Community 👩‍💻👨‍💻</a></li>
  <li><a href="https://takjoe.hatenablog.com/entry/20180718/1531874664">Ubuntu 18.04 で GUIモードを無効化/有効化する - 飛光よ、飛光よ</a></li>
  <li><a href="https://linux.just4fun.biz/?Ubuntu/Windows%E3%81%8B%E3%82%89Ubuntu%E3%81%AB%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B">Ubuntu/WindowsからUbuntuにリモートデスクトップ接続する - Linuxと過ごす</a></li>
  <li><a href="https://qiita.com/ryo-endo/items/00f3ec125917acf4cec7">リモートデスクトップ環境をUbuntu 18.04 LTSで作成する - Qiita</a></li>
  <li><a href="https://qiita.com/mikuta0407/items/cc26eca306ff82e1d135">Ubuntu 18.04.2でxrdp(のXorgモード)が使えないので一時的に凌ぐ - Qiita</a></li>
  <li><a href="https://qiita.com/ishida330/items/e63ab64d1f94a9733b4f">小ネタ: IBM Cloudの仮想サーバーでGUIデスクトップを使いたかったのでxrdp試したら、かなり良かったので手順をメモしとく - Qiita</a></li>
  <li><a href="https://qiita.com/osugizmo/items/21578272ae2db05ab001">AWS EC2でデスクトップ環境をつくる ～ Ubuntu Server 18.04 LTS GNOME編～ - Qiita</a></li>
  <li><a href="http://verifiedby.me/adiary/0126">ubuntu 18.04 インストール(10) リモートデスクトップ - kashiの日記</a></li>
  <li><a href="http://imamachi-n.hatenablog.com/entry/2018/04/28/211147">Windows10もしくはMacOSからUbuntu 18.04 LTSにリモート接続（リモートデスクトップ）してみた - いろいろ試してみる</a></li>
  <li><a href="http://kazuhito-m.github.io/tech/2015/10/20/aws-ubuntu-desktop">NBM2 - AWSのUbuntuにVNC経由のデスクトップ環境を最速で立てる方法</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-04-09</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-04-09</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
