<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>WSL2 Ubuntu 18.04 に GNOME + Fcitx-Mozc を導入して日本語デスクトップ環境を構築する最終解 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/03/10-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/03/index.html">03月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-03-10</time></div>
        <h1 id="page-title">WSL2 Ubuntu 18.04 に GNOME + Fcitx-Mozc を導入して日本語デスクトップ環境を構築する最終解</h1>

<p>ようやく Windows Sybsystem for Linux (WSL) の Ubuntu で、安定して日本語入力可能な GUI デスクトップ環境を構築することに成功したので、記録を残す。</p>
<p>Windows10 Home から Windows10 Pro にアップグレードした後の Insider Preview にて、WSL2 が動作したのでメモしておく。</p>
<p>ついでに GNOME GUI デスクトップ環境の構築に再トライしてみた。なんとか <strong>WSL2 Ubuntu 18.04 GNOME 上で Fcitx-Mozc が動作するようになった</strong>のでお知らせ。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%81%93%E3%82%93%E3%81%AA%E7%92%B0%E5%A2%83%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%82%E3%81%8C%E3%82%8B">こんな環境ができあがる</a></li>
  <li><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6">前提条件</a></li>
  <li><a href="#vcxsrv-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F">VcXsrv をインストールしておく</a></li>
  <li><a href="#wsl2-%E3%82%92%E4%BD%BF%E3%81%86%E3%81%BE%E3%81%A7%E3%81%AE%E6%89%8B%E9%A0%86">WSL2 を使うまでの手順</a></li>
  <li><a href="#ubuntu-1804-%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A">Ubuntu 18.04 の初期設定</a></li>
  <li><a href="#gnome-%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B">GNOME 環境を構築する</a>
    <ul>
      <li><a href="#gui-%E8%B5%B7%E5%8B%95%E3%81%AE%E5%BA%A6%E3%81%AB%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B%E8%B5%B7%E5%8B%95%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89">GUI 起動の度に実施する起動コマンド</a></li>
    </ul>
  </li>
  <li><a href="#%E5%88%9D%E5%9B%9E%E3%81%A0%E3%81%91--fcitx-autostart-%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F">初回だけ : <code>fcitx-autostart</code> の設定をしておく</a></li>
  <li><a href="#%E5%88%9D%E5%9B%9E%E3%81%A0%E3%81%91--fcitx-mozc-%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%88%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A4%E3%82%B3%E3%83%B3%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B">初回だけ : Fcitx-Mozc のシステムトレイアイコンを表示する</a></li>
  <li><a href="#%E5%88%9D%E5%9B%9E%E3%81%A0%E3%81%91--fcitx-mozc-%E3%81%AE%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%85%A5%E5%8A%9B%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">初回だけ : Fcitx-Mozc の日本語入力切り替えを設定する</a></li>
  <li><a href="#gnome-%E8%B5%B7%E5%8B%95%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E7%99%BA%E3%81%AB%E3%81%99%E3%82%8Bvcxsrv-%E3%81%A7%E3%83%A1%E3%82%BF%E3%82%AD%E3%83%BC%E9%A1%9E%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B">GNOME 起動をコマンド一発にする・VcXsrv でメタキー類を有効にする</a></li>
  <li><a href="#%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4%E6%99%82%E3%81%AF-wsl-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%A7-ubuntu-%E3%82%92%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B%E3%81%A8%E8%89%AF%E3%81%84">設定変更時は <code>wsl</code> コマンドで Ubuntu を再起動すると良い</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
  <li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
<h2 id="こんな環境ができあがる"><a class="header-link" href="#こんな環境ができあがる"><span class="header-link-mark"></span></a>こんな環境ができあがる</h2>
<p>今回紹介する環境の仕様は以下のとおり。</p>
<ul>
  <li>WSL2 上に構築する</li>
  <li>Microsoft Store からインストールできる「Ubuntu」(現時点では 18.04) をベースに構築する</li>
  <li>GNOME をインストールし、「Ubuntu 日本語 Remix」と同等の日本語 GUI デスクトップ環境を構築する</li>
  <li>Fcitx-Mozc をインストールし、Alt キー空打ちで日本語入力を切り替えられる環境を構築する</li>
  <li>GNOME セッションとは <em>VcXsrv</em> というツールを使用して接続するが、<code>Alt + Tab</code> や <code>Super</code> キー (≒ <code>Win</code> キー) が Ubuntu 内で認識するよう設定する</li>
</ul>
<p>すなわち、WSL2 でほぼ完璧な GUI デスクトップ環境を構築し、自由に日本語入力できる環境とするワケだ。</p>
<p>留意点は以下のとおり。</p>
<ul>
  <li>ウイルスバスター、Avast をインストールしているが、特に誤反応はしなかったので気にしなくて良さそう</li>
  <li>Ubuntu や VcXsrv は管理者権限で起動する必要はなかった</li>
  <li>PowerShell で WSL を操作する際は管理者権限で PowerShell を開いておくと安心かと (管理者権限でなくても特に問題ないかも)</li>
  <li>MacType を使用しているが、念のため Ubuntu や VcXsrv は除外するようにしておいた (特に問題ないかも)</li>
</ul>
<p>まぁ、WSL 自体が Windows OS 標準の範囲内の機能なので、特にサードパーティツールによって邪魔されることはなかった、ということで。</p>
<h2 id="前提条件"><a class="header-link" href="#前提条件"><span class="header-link-mark"></span></a>前提条件</h2>
<p>環境構築を始める前の、前提とする条件は以下のとおり。</p>
<ul>
  <li>Windows10 Pro Insider Preview
    <ul>
      <li>Insider Preview に登録し、WSL2 をインストールできるようにしておく</li>
      <li>Windows10 Home では WSL2 が正常に動作しなかったのだが、Windows10 Pro にアップグレードしたら正常に動作するようになった</li>
      <li>バージョン : 2004、OS ビルド : 19569.1000 環境で検証</li>
    </ul>
  </li>
  <li>US キーボード環境で検証
    <ul>
      <li>日本語キーボードでは検証していないので、Fcitx による入力切替周りは調整が必要になるかも</li>
    </ul>
  </li>
  <li>AutoHotKey スクリプト「Alt-IME-AHK」を使用している環境で検証
    <ul>
      <li>Alt キーの空打ちで IME のオン・オフを切り替えられるツールを入れてある状態で、VcXsrv 経由で WSL2 Ubuntu を操作する前提で説明する</li>
    </ul>
  </li>
</ul>
<p>当方環境では、そもそも Windows10 Home の Insider Preview で WSL2 がうまく動かなかったので、Windows10 Pro をオススメする。</p>
<p>自分は US キーボードを使用している中で日本語入力環境を整備しているので、日本語キーボード利用者は少し設定が異なると思う。その点は未検証なので何かあれば情報ください。</p>
<h2 id="vcxsrv-をインストールしておく"><a class="header-link" href="#vcxsrv-をインストールしておく"><span class="header-link-mark"></span></a>VcXsrv をインストールしておく</h2>
<p>それでは環境構築開始。まずは VcXsrv をインストールしておく。Chocolatey を使えば以下でインストール可能。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">PS</span>> choco install <span class="token operator">-</span>y vcxsrv
</code></pre>
<p>そうでなければ以下からダウンロードしてインストールしておく。</p>
<ul>
  <li><a href="https://sourceforge.net/projects/vcxsrv/">VcXsrv Windows X Server download | SourceForge.net</a></li>
</ul>
<h2 id="wsl2-を使うまでの手順"><a class="header-link" href="#wsl2-を使うまでの手順"><span class="header-link-mark"></span></a>WSL2 を使うまでの手順</h2>
<p>WSL1 の状態で Ubuntu をインストール・初回起動まで済ませ、後で WSL2 にアップデートすることで正常に動作したので、その手順で説明する。</p>
<p>まずは Microsoft Store で Ubuntu をダウンロードし、以下のとおり初回起動の設定を済ませる。以降、初期ユーザは <code>neo</code> のテイで記載する。</p>
<pre class="language-bash"><code class="language-bash">Installing, this may take a few minutes<span class="token punctuation">..</span>.
Please create a default UNIX user account. The username does not need to match your Windows username.
For <span class="token function">more</span> information visit: https://aka.ms/wslusers
Enter new UNIX username: neo
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
Installation successful<span class="token operator">!</span>
To run a <span class="token builtin class-name">command</span> as administrator <span class="token punctuation">(</span>user <span class="token string">"root"</span><span class="token punctuation">)</span>, use <span class="token string">"sudo &#x3C;command>"</span><span class="token builtin class-name">.</span>
See <span class="token string">"man sudo_root"</span> <span class="token keyword">for</span> details.

neo@Neos-Windows:~$ <span class="token builtin class-name">exit</span>
</code></pre>
<p>続いて、<em>管理者権限で起動した PowerShell を使う</em> (<code>Win + X</code> → <code>A</code> での起動が楽)。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">PS</span>> wsl <span class="token operator">-</span>l <span class="token operator">-</span>v
  NAME      STATE           VERSION
<span class="token operator">*</span> Ubuntu    Running         1

<span class="token function">PS</span>> wsl <span class="token operator">--</span><span class="token function">set-version</span> Ubuntu 2
Conversion in progress<span class="token punctuation">,</span> this may take a few minutes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">For</span> information on key differences with WSL 2 please visit https:<span class="token operator">/</span><span class="token operator">/</span>aka<span class="token punctuation">.</span>ms<span class="token operator">/</span>wsl2
Conversion complete<span class="token punctuation">.</span>

<span class="token function">PS</span>> wsl <span class="token operator">-</span>l <span class="token operator">-</span>v
  NAME      STATE           VERSION
<span class="token operator">*</span> Ubuntu    Stopped         2
</code></pre>
<p>こんな感じで WSL2 に切り替えられた。</p>
<h2 id="ubuntu-1804-の初期設定"><a class="header-link" href="#ubuntu-1804-の初期設定"><span class="header-link-mark"></span></a>Ubuntu 18.04 の初期設定</h2>
<p>もう何度か書いているが、少し改良したところもある。次のように打っていく。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># デフォルトのエディタを Vim に変更する</span>
<span class="token comment"># sudo update-alternatives --config editor で設定しても良い</span>
<span class="token function">sudo</span> update-alternatives --set editor /usr/bin/vim.basic

<span class="token comment"># sudo をパスワードなしで実行できるようにする</span>
<span class="token comment"># 「neo  ALL=(ALL)  NOPASSWD:ALL」を追記する</span>
<span class="token function">sudo</span> visudo

<span class="token comment"># 7箇所くらいある「archive.ubuntu.com」を「jp.archive.ubuntu.com」に編集する</span>
<span class="token comment"># sudo vi /etc/apt/sources.list で編集しても良い</span>
<span class="token function">sudo</span> <span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.BAK
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/archive.ubuntu.com/jp.archive.ubuntu.com/g'</span> /etc/apt/sources.list

<span class="token comment"># 日本語 Remix のリポジトリを追加する</span>
<span class="token function">wget</span> -q https://www.ubuntulinux.jp/ubuntu-ja-archive-keyring.gpg -O- <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">wget</span> -q https://www.ubuntulinux.jp/ubuntu-jp-ppa-keyring.gpg -O- <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">sudo</span> <span class="token function">wget</span> https://www.ubuntulinux.jp/sources.list.d/bionic.list -O /etc/apt/sources.list.d/ubuntu-ja.list

<span class="token comment"># アップデートしていく</span>
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> upgrade -y
<span class="token function">sudo</span> <span class="token function">apt</span> dist-upgrade -y
<span class="token function">sudo</span> <span class="token function">apt</span> autoremove -y

<span class="token comment"># 日本語環境にするため必要なパッケージを確認する : fonts-noto-cjk fonts-noto-cjk-extra ibus language-pack-ja あたりが出るだろうか</span>
check-language-support -l ja

<span class="token comment"># 日本語化パッケージを入れる</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y <span class="token variable"><span class="token variable">$(</span>check-language-support -l ja<span class="token variable">)</span></span> language-pack-ja

<span class="token comment"># 日本語 Remix のパッケージを入れる</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y ubuntu-defaults-ja

<span class="token comment"># 日本語に切り替える</span>
<span class="token function">sudo</span> update-locale <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>ja_JP.UTF-8

<span class="token comment"># 一度 Ubuntu を再起動する</span>
<span class="token builtin class-name">exit</span>

<span class="token comment"># 再起動後、日本語 (ja_JP.UTF-8) になっているか確認する</span>
locale

<span class="token comment"># アジア → 東京を選ぶ</span>
<span class="token function">sudo</span> dpkg-reconfigure tzdata

<span class="token comment"># 日本語 man を入れる</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y manpages-ja manpages-ja-dev
</code></pre>
<h2 id="gnome-環境を構築する"><a class="header-link" href="#gnome-環境を構築する"><span class="header-link-mark"></span></a>GNOME 環境を構築する</h2>
<p>ココからは GUI デスクトップ環境を構築するための手順。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 日本語フォントを入れておく : MS 英文フォントは EURA の同意を求められる</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y fonts-noto fonts-ipafont fonts-ipaexfont fonts-vlgothic fonts-takao ttf-mscorefonts-installer

<span class="token comment"># GNOME を入れる</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y ubuntu-desktop gnome-tweak-tool

<span class="token comment"># Ibus を削除する</span>
<span class="token function">sudo</span> <span class="token function">apt</span> purge -y ibus ibus-mozc

<span class="token comment"># Fcitx と Mozc をインストールする</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y fcitx fcitx-mozc fcitx-config-gtk fcitx-frontend-gtk2 fcitx-frontend-gtk3 fcitx-frontend-qt4 fcitx-frontend-qt5 fcitx-ui-classic kde-config-fcitx mozc-utils-gui dbus-x11

<span class="token comment"># 入力メソッドを更新する</span>
im-config -n fcitx

<span class="token comment"># 起動時に使うスクリプトを作成する</span>
<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">'echo "fcitx-autostart &#x26;>/dev/null" > /etc/profile.d/fcitx'</span>

<span class="token comment"># 環境変数を設定するスクリプトを作成する</span>
<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">'cat &#x3C;&#x3C;EOL > /etc/profile.d/fcitx.sh
#!/bin/bash

export QT_IM_MODULE=fcitx
export GTK_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export DefaultIMModule=fcitx
EOL'</span>

<span class="token comment"># 権限設定をしておく</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> -R <span class="token number">777</span> ~/.cache/

<span class="token comment"># PolicyKit 関連のエラーを回避するため、全てのユーザに全ての許可を与える設定ファイルを作成する</span>
<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">'cat &#x3C;&#x3C;EOL > /etc/polkit-1/localauthority/50-local.d/99-all.pkla
[Allow all]
Identity=unix-user:*
Action=*
ResultAny=yes
ResultInactive=yes
ResultActive=yes
EOL'</span>

<span class="token comment"># gnome-software (Ubuntu ソフトウェア) でカテゴリ表示がされないことがある。以下のようにグループに追加しておくと良い</span>
<span class="token function">sudo</span> gpasswd -a neo root
<span class="token function">sudo</span> gpasswd -a neo admin
<span class="token function">sudo</span> gpasswd -a neo lpadmin
</code></pre>
<p>PolicyKit-1 (<code>polkit-1</code>) に関する情報が少なくて苦労したのだが、自分で編み出した設定ファイルを最後に作ってある。コレを入れておくと、「Ubuntu ソフトウェア」などのアプリで以下のような権限エラーが出るのを防げて、<em>GUI 環境で自由にアップデートなどができるようになる。</em></p>
<pre><code>org.freedesktop.PolicyKit.Error.Failed: ('system-bus-name', {'name': ':1.56'}): org.debian.apt.install-or-remove-packages
</code></pre>
<p>
  <img src="10-01-01.png" alt="こんなエラー">
</p>
<p>ココまでで事前準備は OK。</p>
<h3 id="gui-起動の度に実施する起動コマンド"><a class="header-link" href="#gui-起動の度に実施する起動コマンド"><span class="header-link-mark"></span></a>GUI 起動の度に実施する起動コマンド</h3>
<p>以降の手順は、<strong>Ubuntu 起動後、GUI を起動する度に実施する。</strong></p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># UUID を更新する</span>
<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">'dbus-uuidgen > /var/lib/dbus/machine-id'</span>

<span class="token comment"># DBus を再起動する</span>
<span class="token function">sudo</span> <span class="token function">service</span> dbus restart

<span class="token comment"># DISPLAY 環境変数は以下で指定する</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">DISPLAY</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/resolv.conf<span class="token operator">|</span><span class="token function">grep</span> nameserver<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span>:0"</span>

<span class="token comment"># ココまで設定したら、VcXsrv を起動する。</span>
<span class="token comment"># DISPLAY : -1、「Dissable access control」にチェックを入れて、黒いウィンドウを出しておく</span>

<span class="token comment"># VcXsrv を起動してある状態で、以下を実行する</span>
<span class="token assign-left variable"><span class="token environment constant">XDG_CURRENT_DESKTOP</span></span><span class="token operator">=</span>ubuntu:GNOME <span class="token assign-left variable"><span class="token environment constant">XDG_SESSION_TYPE</span></span><span class="token operator">=</span>x11 gnome-session
</code></pre>
<p>これらのコマンドの説明は以下のとおり。</p>
<ul>
  <li><code>dbus-uuidgen</code> と <code>service dbus restart</code> は Ubuntu 起動のたびにやってやらないと安定しないようだった</li>
  <li><code>export DISPLAY</code> のイディオムが特徴的だろうか。<code>export DISPLAY=:0</code> などだとうまくいかなかったのだが、このイディオムだと何度やっても綺麗に繋がるのでオススメ</li>
  <li>VcXsrv は DISPLAY を <code>-1</code> にしておくのと、「Disable access control」にチェックを入れておくのが大事</li>
  <li><code>XDG_CURRENT_DESKTOP=ubuntu:GNOME</code> という環境変数を指定しておくと、Ubuntu Dock などが有効になる
    <ul>
      <li>「Ubuntu 日本語 Remix」などをピュアにインストールした時のデフォルトセッションは、「Ubuntu Session」という、「GNOME Session」の拡張版である。コレに近い動きをさせるためにこの環境変数を入れてある</li>
      <li>この環境変数がないと、「設定 (<code>gnome-control-center</code>)」に「Dock」のメニューが表示されなかったりする</li>
    </ul>
  </li>
</ul>
<p>コレで GNOME が起動するはずだ。</p>
<h2 id="初回だけ--fcitx-autostart-の設定をしておく"><a class="header-link" href="#初回だけ--fcitx-autostart-の設定をしておく"><span class="header-link-mark"></span></a>初回だけ : <code>fcitx-autostart</code> の設定をしておく</h2>
<p>以上の作業で GNOME セッション (厳密には Ubuntu セッションに近いモノ) が起動するが、初回は <code>fcitx-autostart</code> が正常に起動してくれていないので、そのための設定を1回だけ行っておく。</p>
<p>端末 (ターミナル) を開いて <code>$ fcitx-autostart</code> を実行すれば、とりあえずは Fcitx-Mozc が有効になる。</p>
<p>しかし毎回 <code>fcitx-autostart</code> を叩くのは面倒なので、<strong>「自動起動するアプリケーションの設定」を開き、<code>fcitx-autostart</code> を指定</strong>することで対応する。コレで2回目以降の起動時は Fcitx-Mozc がデフォルトで有効になっているはずだ。</p>
<p>なお、コマンドラインで「自動起動するアプリケーションの設定」を追加するなら、以下のように設定ファイルを作ってやれば、同等の結果となる。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 「自動起動するアプリケーション」として fcitx-autostart を登録する</span>
<span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span><span class="token string">EOL<span class="token bash punctuation"> <span class="token operator">></span> ~/.config/autostart/fcitx-autostart.desktop</span>
[Desktop Entry]
Type=Application
Exec=fcitx-autostart
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name[ja_JP]=fcitx-autostart
Name=fcitx-autostart
Comment[ja_JP]=fcitx-autostart
Comment=fcitx-autostart
EOL</span>
</code></pre>
<h2 id="初回だけ--fcitx-mozc-のシステムトレイアイコンを表示する"><a class="header-link" href="#初回だけ--fcitx-mozc-のシステムトレイアイコンを表示する"><span class="header-link-mark"></span></a>初回だけ : Fcitx-Mozc のシステムトレイアイコンを表示する</h2>
<p>デフォルトだと、<em>画面右上に Fcitx-Mozc のアプリインジケータ (システムトレイアイコン)</em> が表示されていないため、以下の設定をしておく。</p>
<ul>
  <li>GNOME Tweaks (<code>gnome-tweaks</code>) を開き、GNOME Shell 拡張機能から「<strong>Ubuntu appindicators</strong>」を有効にする
    <ul>
      <li>同画面で「Ubuntu Dock」を有効にすれば、画面上に Dock が常に表示されるようになる</li>
    </ul>
  </li>
</ul>
<p>「設定 → 地域と言語 → 入力ソース」は英語のみにしておけば、「en」「ja」といった余計な表示が出ないで済む。</p>
<h2 id="初回だけ--fcitx-mozc-の日本語入力切り替えを設定する"><a class="header-link" href="#初回だけ--fcitx-mozc-の日本語入力切り替えを設定する"><span class="header-link-mark"></span></a>初回だけ : Fcitx-Mozc の日本語入力切り替えを設定する</h2>
<p>「Fcitx 設定」(<code>fcitx-configtool</code>) を開き、日本語入力切り替えを設定しておく。</p>
<p>本当は左右の Alt キー空打ちで IME のオン・オフを切り替えたく、Fcitx 自体はそれがすんなり設定できるのだが、Windows ホスト側で Alt-IME-AHK を有効にしていると、「IME をオンに / オフに」の設定がうまくできない。<code>Lalt</code> や <code>Ralt</code> ではなく、<code>Alt + kanaswitch</code> キーの押下とみなされてしまうのだ。</p>
<p>コレで設定しても Alt キーの空打ちによるオン・オフはできるのだが、「左 Alt で必ず IME オフ」「右 ALt で必ず IME オン」みたいな制御はできず、「<em>どちらかの Alt を空打ちするとオン・オフをトグルする</em>」といった動作になってしまう。</p>
<p>コレを解消するには、Alt-IME-AHK のスクリプトを編集して「VcXsrv ウィンドウがアクティブな場合は機能を無効にする」といった実装をしたいところだが、うまく制御できず断念した。</p>
<p>仕方がないので、VcXsrv 使用時は AutoHotKey のタスクトレイアイコンから「Suspend Hotkeys」を選択して一時的に AutoHotKey を無効化して運用するか、<code>Ctrl + Space</code> を使うことにするか、Alt キーのトグル操作で諦めるか、という感じ。</p>
<h2 id="gnome-起動をコマンド一発にするvcxsrv-でメタキー類を有効にする"><a class="header-link" href="#gnome-起動をコマンド一発にするvcxsrv-でメタキー類を有効にする"><span class="header-link-mark"></span></a>GNOME 起動をコマンド一発にする・VcXsrv でメタキー類を有効にする</h2>
<p>ココまでで初期設定は全て完了。以降は GUI 環境の起動を楽にする方法。</p>
<p>予め VcXsrv を起動しておいたり、複数のコマンドを打ったりするのが面倒臭いので、以下のように Bash ファイルにまとめてしまおう。</p>
<ul>
  <li><code>~/bin/startu</code></li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># Prepare</span>
<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">'dbus-uuidgen > /var/lib/dbus/machine-id'</span>
<span class="token function">sudo</span> <span class="token function">service</span> dbus restart
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">DISPLAY</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/resolv.conf<span class="token operator">|</span><span class="token function">grep</span> nameserver<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span>:0"</span>

<span class="token comment"># Launch VcXsrv</span>
/mnt/c/Program<span class="token punctuation">\</span> Files/VcXsrv/vcxsrv.exe :0 -ac -keyhook <span class="token operator">&#x26;</span>

<span class="token comment"># Start GNOME Session</span>
<span class="token assign-left variable"><span class="token environment constant">XDG_CURRENT_DESKTOP</span></span><span class="token operator">=</span>ubuntu:GNOME <span class="token assign-left variable"><span class="token environment constant">XDG_SESSION_TYPE</span></span><span class="token operator">=</span>x11 gnome-session

<span class="token comment"># After End GNOME, Kill VcXsrv</span>
/mnt/c/Windows/System32/taskkill.exe /IM vcxsrv.exe /T /F
</code></pre>
<p>ファイル作成後、<code>$ sudo chmod 777 ~/bin/startu</code> で実行権を付与しておく。</p>
<p><strong>VcXsrv 起動時に指定しているオプションが重要。</strong></p>
<ul>
  <li><code>-ac</code> は <code>Disable access control restrictions</code> オプション。スタートメニューから起動し GUI で設定した時に指定するオプションと同じ</li>
  <li><strong><code>-keyhook</code></strong> オプションがミソ。コレは GUI で起動した時に画面上には現れないオプションで、コレを指定することで <code>Alt + Tab</code> や <code>Win</code> キーのイベントを、Windows ホスト側ではなく VcXsrv 側が認識するようになる
    <ul>
      <li>逆にいうと、VcXsrv のウィンドウがアクティブな状態で <code>Alt + Tab</code> を押しても、Windows ホスト側の他のウィンドウに切り替えられなくなるので、もしコレが嫌なら <code>-keyhook</code> オプションを外しておけば良い</li>
    </ul>
  </li>
</ul>
<p>このファイルによって、「Ubuntu 起動」→「<code>$ startu</code>」と実行するだけで、VcXsrv と GNOME を同時起動できるようになった。</p>
<h2 id="設定変更時は-wsl-コマンドで-ubuntu-を再起動すると良い"><a class="header-link" href="#設定変更時は-wsl-コマンドで-ubuntu-を再起動すると良い"><span class="header-link-mark"></span></a>設定変更時は <code>wsl</code> コマンドで Ubuntu を再起動すると良い</h2>
<p><code>im-config</code> とかをイジった後は、管理者権限で開いた PowerShell にて、次のように WSL を停止し、再度 Ubuntu を開くようにすると確実になる。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">PS</span>> wsl <span class="token operator">--</span>shutdown
<span class="token comment"># もしくは以下 (--terminate)</span>
<span class="token function">PS</span>> wsl <span class="token operator">-</span>t Ubuntu
</code></pre>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<ul>
  <li>WSL2 にアップデートできなかったのは恐らく Windows10 Home の Insider Preview だったからだろうか。Windows10 Pro にしたらすんなりできた</li>
  <li>WSL2 Ubuntu 18.04 で GNOME デスクトップを立ち上げるのは一手間必要だった
    <ul>
      <li>毎度行う <code>dbu-uuidgen</code> や <code>DISPLAY</code> 環境変数の設定などが分かりづらかった</li>
    </ul>
  </li>
  <li>GNOME セッション内の特権不足のために PolicyKit (polkit) を作成する必要があった
    <ul>
      <li>コレに関してはネット上に全然文献がなかったけど、みんなそんなに WSL Ubuntu で GNOME デスクトップ立ち上げてないのだろうか？</li>
    </ul>
  </li>
  <li>Fcitx-Mozc を使うための設定もなかなか骨が折れる
    <ul>
      <li>US キーボード (AutoHotKey) ユーザ特有かもしれないが Alt-IME-AHK との競合が解消しきれない部分もあるが、まぁ妥協か…</li>
    </ul>
  </li>
</ul>
<p>こんなところか。かなり長期に渡って苦戦したが、一旦はコレで環境構築できたということで。</p>
<h2 id="参考文献"><a class="header-link" href="#参考文献"><span class="header-link-mark"></span></a>参考文献</h2>
<ul>
  <li>WSL2
    <ul>
      <li><a href="https://docs.microsoft.com/ja-jp/windows/wsl/wsl2-install">WSL 2 のインストール | Microsoft Docs</a></li>
      <li><a href="https://qiita.com/matarillo/items/ca1eecf8f9a3cd76f9ce">WSL2とHyper-Vの関係 - Qiita</a></li>
    </ul>
  </li>
  <li>日本語化
    <ul>
      <li><a href="https://bbq-all-stars.github.io/2019/04/30/wsl-ubuntu-intellij-develop-environment.html">WSLでIntelliJを動かして、Windowsでも最高の開発環境を手に入れる | あそびば32</a> … <code>mate-session</code> を使っている</li>
    </ul>
  </li>
  <li><code>DISPLAY</code> 環境変数
    <ul>
      <li><a href="https://qiita.com/baibai25/items/5841b0592727893d960f">WSL2のGUI設定でつまずいたところ - Qiita</a></li>
      <li><a href="https://askubuntu.com/questions/1154181/configuration-for-wsl2-for-first-time/1154366#1154366">windows - Configuration for wsl2 for first time - Ask Ubuntu</a></li>
    </ul>
  </li>
  <li>VcXsrv
    <ul>
      <li><a href="https://bbq-all-stars.github.io/2019/04/30/wsl-ubuntu-intellij-develop-environment.html">WSLでIntelliJを動かして、Windowsでも最高の開発環境を手に入れる | あそびば32</a></li>
      <li><a href="https://royalwin.blog.ss-blog.jp/2019-01-13">Windows 10 WSL で Ubuntu 18.04 Gnome 3 デスクトップ環境：Royal Windows：So-net blog</a></li>
      <li><a href="https://royalwin.blog.ss-blog.jp/2019-01-19">Windows 10 WSL で Ubuntu 18.04 デスクトップを１発で起動：Royal Windows：So-net blog</a></li>
    </ul>
  </li>
  <li>Fcitx
    <ul>
      <li><a href="https://gist.github.com/sirredbeard/5257a23096dedeaf7ae01257b925ba82">fcitx.sh · GitHub</a> … コレが役に立った</li>
      <li><a href="https://blog.jnsk.info/post/175198789882/wslubuntu1804%E3%81%A7fcitx-mozc%E3%81%A7%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%85%A5%E5%8A%9B%E3%81%9D%E3%81%AE%E4%BB%96%E9%9B%91%E8%A8%98/amp">じんすけのWeblog — WSL(Ubuntu18.04)でfcitx+mozcで日本語入力、その他雑記</a> … コレも参考になった</li>
      <li><a href="https://cloud-work.net/linux/fcitx-mozc/">Debian系の日本語入力をFcitx &#x26; Mozcにする | Cloud-Work.net</a></li>
      <li><a href="https://wiki.manjaro.org/index.php?title=%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%AE%E8%A8%AD%E5%AE%9A">日本語の設定 - Manjaro Linux</a></li>
      <li><a href="http://uramocha02.blogspot.com/2017/06/x-fcitx.html">うらもちゃのブログ: X から日本語入力(fcitx の起動)</a></li>
      <li><a href="https://qiita.com/jacob_327/items/bb89222686b165599f7f">Ubuntu (KDE)で日本語入力 fcitx mozc - Qiita</a></li>
      <li><a href="https://obel.hatenablog.jp/entry/20170803/1501770003">Mozc の設定ツールが表示されないとき（Linux Mint） - 約束の地</a></li>
    </ul>
  </li>
  <li><code>fcitx-autostart</code>
    <ul>
      <li><a href="https://qiita.com/tacchi/items/cd2fdf36081277aa57b5">Android でもとりあえず Ubuntu のデスクトップ環境を使いたい（Termux 版 - デスクトップ環境で日本語入力） - Qiita</a></li>
      <li><a href="https://qiita.com/maromaro3721/items/be8ce6e3cec4cbcdac00">Ubuntu 18.04 な WSL 上に日本語入力環境を構築する - Qiita</a></li>
      <li><a href="https://kazblog.hateblo.jp/entry/2018/05/28/221242">Ubuntu18.04+WSLでfcitx-mozcを使って日本語入力出来るようにする - もやし日誌</a></li>
      <li><a href="https://vogel.at.webry.info/201905/article_6.html">WSL の Ubuntu18.04 で日本語入力: パソコン鳥のブログ</a></li>
      <li><a href="https://sites.google.com/site/teyasn001/home/policykit">Policykit - なんなんなん行く？</a></li>
      <li><a href="http://lost-in-forest.hatenablog.com/entry/a00b">【第11回】目指せLinuxマスター(3) polkitの設定 - エンリュの迷い森</a></li>
      <li><a href="https://www.clear-code.com/blog/2016/12/27.html">PolicyKitを用いて適切に権限管理するには - ククログ(2016-12-27)</a></li>
      <li><a href="https://qiita.com/dozo/items/97ac6c80f4cd13b84558">fcitxで作るWSL日本語開発環境 - Qiita</a></li>
    </ul>
  </li>
  <li>PolicyKit
    <ul>
      <li><a href="https://tmtms.hatenablog.com/entry/201812/wsl-ubuntu">WSL で Ubuntu デスクトップ環境を作ってみる - @tmtms のメモ</a></li>
      <li><a href="https://forums.ubuntulinux.jp/viewtopic.php?id=9810">Ubuntu日本語フォーラム / 「時刻と日付の設定」画面で「クリックして変更可能に」のボタンが機能しない</a></li>
      <li><a href="https://tutorialmore.com/questions-418975.htm">permissions - polkit：グループホイールのユーザーを除くすべてのユーザーを無効にしますか？ - 初心者向けチュートリアル</a></li>
    </ul>
  </li>
  <li>その他
    <ul>
      <li><a href="https://kledgeb.blogspot.com/2017/08/ubuntu-1710-53-ubuntugnome.html">Ubuntu 17.10 その53 - UbuntuセッションとGNOMEセッション - kledgeb</a></li>
      <li><a href="https://askubuntu.com/questions/967118/ubuntu-dock-settings-not-accessible-in-gnome-control-center-by-default">17.10 - ubuntu-dock settings not accessible in gnome-control-center by default - Ask Ubuntu</a> … Ubuntu Dock について</li>
      <li><a href="https://re-unknown.premirea.jp/article/wsl-ubuntu-gnome-desktop/">【2018年版】WSLに最短でデスクトップを入れる方法 | Re.unknownの鳥かご</a></li>
      <li><a href="https://qiita.com/aki4000/items/c26e3076c8cec9677415">Windows10 HomeとWSL2でdocker-composeができるようにする - Qiita</a></li>
      <li><a href="https://qiita.com/matarillo/items/f036a9561a4839275e5f">WSL2でSystemdを使うハック - Qiita</a></li>
    </ul>
  </li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2020-03-10</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2020-03-10</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
