<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Gulp 3 から 4 に変えたら Browser-Sync が動かなくなったので全面的に修正した・変更点をおさらい - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/03/03-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/03/index.html">03月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-03-03</time></div>
        <h1 id="page-title">Gulp 3 から 4 に変えたら Browser-Sync が動かなくなったので全面的に修正した・変更点をおさらい</h1>

<p>久々に Gulp の話。</p>
<p>Node.js v12 にアップデートすると、Gulp v3 で <code>graceful-fs</code> 関連のエラーが出るので、Gulp v4 にアップデートすることにした。メジャーバージョンアップが変わり、色々とお作法が変わっているので、v3 のコードと v4 のコードを比較しながら、変更点をおさらいする。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E5%A4%89%E6%9B%B4%E5%89%8D%E5%BE%8C%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E5%85%A8%E9%87%8F">変更前後のコード全量</a></li>
  <li><a href="#%E5%86%92%E9%A0%AD">冒頭</a></li>
  <li><a href="#html-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89-html-all-%E3%82%BF%E3%82%B9%E3%82%AF">HTML のビルド (<code>html-all</code> タスク)</a></li>
  <li><a href="#html-%E3%81%AE%E5%B7%AE%E5%88%86%E3%83%93%E3%83%AB%E3%83%89-html-%E3%82%BF%E3%82%B9%E3%82%AF">HTML の差分ビルド (<code>html</code> タスク)</a></li>
  <li><a href="#scss-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89-css-%E3%82%BF%E3%82%B9%E3%82%AF--%E5%A4%A7%E3%81%8D%E3%81%AA%E5%B7%AE%E7%95%B0%E3%81%AA%E3%81%97">SCSS のビルド (<code>css</code> タスク) : 大きな差異なし</a></li>
  <li><a href="#es2015-%E3%81%AE%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B9%E3%83%91%E3%82%A4%E3%83%AB-js-%E3%82%BF%E3%82%B9%E3%82%AF--%E5%A4%A7%E3%81%8D%E3%81%AA%E5%B7%AE%E7%95%B0%E3%81%AA%E3%81%97">ES2015 のトランスパイル (<code>js</code> タスク) : 大きな差異なし</a></li>
  <li><a href="#%E7%94%BB%E5%83%8F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AA%E3%81%A9%E3%81%AE%E3%82%B3%E3%83%94%E3%83%BC-assets-all-%E3%82%BF%E3%82%B9%E3%82%AF--%E5%A4%A7%E3%81%8D%E3%81%AA%E5%B7%AE%E7%95%B0%E3%81%AA%E3%81%97">画像ファイルなどのコピー (<code>assets-all</code> タスク) : 大きな差異なし</a></li>
  <li><a href="#%E7%94%BB%E5%83%8F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AA%E3%81%A9%E3%81%AE%E5%B7%AE%E5%88%86%E3%82%B3%E3%83%94%E3%83%BC-assets-%E3%82%BF%E3%82%B9%E3%82%AF--%E5%A4%A7%E3%81%8D%E3%81%AA%E5%B7%AE%E7%95%B0%E3%81%AA%E3%81%97">画像ファイルなどの差分コピー (<code>assets</code> タスク) : 大きな差異なし</a></li>
  <li><a href="#%E5%85%A8%E9%87%8F%E3%83%93%E3%83%AB%E3%83%89-build-%E3%82%BF%E3%82%B9%E3%82%AF">全量ビルド (<code>build</code> タスク)</a></li>
  <li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%A4%89%E6%9B%B4%E3%82%92%E6%A4%9C%E7%9F%A5%E3%81%99%E3%82%8B%E3%83%A9%E3%82%A4%E3%83%96%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89-dev-%E3%82%BF%E3%82%B9%E3%82%AF">ファイルの変更を検知するライブリロード (<code>dev</code> タスク)</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
  <li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
<h2 id="変更前後のコード全量"><a class="header-link" href="#変更前後のコード全量"><span class="header-link-mark"></span></a>変更前後のコード全量</h2>
<p>今回修正したコードの全量は以下で確認できる。</p>
<ul>
  <li><a href="https://github.com/Neos21/neos21.net/blob/24b84cc33b2319d382e8d080e8dda69dbfb5cc12/gulpfile.js">gulpfile.js at 24b84cc33b2319d382e8d080e8dda69dbfb5cc12</a>
    <ul>
      <li>Gulp 3 版</li>
    </ul>
  </li>
  <li><a href="https://github.com/Neos21/neos21.net/blob/666eeaf8e76905f1c4419187543423242a9ce28a/gulpfile.js">gulpfile.js at 666eeaf8e76905f1c4419187543423242a9ce28a</a>
    <ul>
      <li>Gulp 4 版</li>
    </ul>
  </li>
</ul>
<p>Gulp v3 版を基に、ほぼほぼ同じ動作をするよう修正している。以降はタスクごとに解説していく。</p>
<h2 id="冒頭"><a class="header-link" href="#冒頭"><span class="header-link-mark"></span></a>冒頭</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  pattern<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'browser-sync'</span><span class="token punctuation">,</span> <span class="token string">'browserify'</span><span class="token punctuation">,</span> <span class="token string">'del'</span><span class="token punctuation">,</span> <span class="token string">'run-sequence'</span><span class="token punctuation">,</span> <span class="token string">'vinyl-buffer'</span><span class="token punctuation">,</span> <span class="token string">'vinyl-source-stream'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  overridePattern<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// デフォルトのパターン ('gulp-*', 'gulp.*', '@*/gulp{-,.}*') を残す</span>
  maintainScope<span class="token operator">:</span> <span class="token boolean">false</span>     <span class="token comment">// スコープパッケージを階層化しない</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  pattern<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'browser-sync'</span><span class="token punctuation">,</span> <span class="token string">'browserify'</span><span class="token punctuation">,</span> <span class="token string">'del'</span><span class="token punctuation">,</span> <span class="token string">'vinyl-buffer'</span><span class="token punctuation">,</span> <span class="token string">'vinyl-source-stream'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  overridePattern<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// デフォルトのパターン ('gulp-*', 'gulp.*', '@*/gulp{-,.}*') を残す</span>
  maintainScope<span class="token operator">:</span> <span class="token boolean">false</span>     <span class="token comment">// スコープパッケージを階層化しない</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>大きな違いはないが、Gulp v4 で以下のパッケージが不要になった。</p>
<ul>
  <li><code>run-sequence</code> → <code>gulp.serial()</code> と <code>gulp.parallel()</code></li>
  <li><code>gulp-watch</code> → <code>gulp.watch()</code></li>
  <li><code>gulp-changed</code> → <code>gulp.lastRun()</code></li>
</ul>
<p>主にこれらの使い方の解説がメインになる。</p>
<h2 id="html-のビルド-html-all-タスク"><a class="header-link" href="#html-のビルド-html-all-タスク"><span class="header-link-mark"></span></a>HTML のビルド (<code>html-all</code> タスク)</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * テンプレート HTML を適用して全ファイルを出力する
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'html-all'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">templateHtml</span><span class="token punctuation">(</span><span class="token string">'./src/templates/template.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * テンプレート HTML を適用して全ファイルを出力する (追加・変更のみ、削除には非対応)
 */</span>
<span class="token keyword">function</span> <span class="token function">htmlAll</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">templateHtml</span><span class="token punctuation">(</span><span class="token string">'./src/templates/template.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'html-all'</span><span class="token punctuation">,</span> htmlAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Gulp v4 では、生の JavaScript Function を宣言しておくと使い回しが効くので、<code>function hoge()</code> で単体の関数を宣言しておくと良い。ココで作成した <code>htmlAll()</code> 関数も後で使用している。</p>
<p>関数は <code>return gulp...</code> とするのではなく、第1引数に <code>done</code> を取り、<code>done()</code> を呼んで終了することで、タスクの直列実行などをハンドリングできるようになる。この書き方に統一しておこう。</p>
<h2 id="html-の差分ビルド-html-タスク"><a class="header-link" href="#html-の差分ビルド-html-タスク"><span class="header-link-mark"></span></a>HTML の差分ビルド (<code>html</code> タスク)</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * テンプレート HTML を適用して出力する (差分のみ)
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">changed</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">templateHtml</span><span class="token punctuation">(</span><span class="token string">'./src/templates/template.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * テンプレート HTML を適用して出力する (追加・変更のみ、削除には非対応)
 */</span>
<span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      since<span class="token operator">:</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">lastRun</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">templateHtml</span><span class="token punctuation">(</span><span class="token string">'./src/templates/template.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>gulp.src()</code> で指定したファイル群の内、変更があったファイルだけを特定してビルド処理を呼ぶタスク。v3 では <code>gulp-changed</code> パッケージを使って差分特定をしていたが、v4 では <code>gulp.src()</code> の <code>since</code> オプションに、<code>gulp.lastRun()</code> 関数を組み合わせることで実現できるようになった。ココで、<code>gulp.lastRun(html)</code> と、自分自身の関数を引数に設定しているので、関数宣言が必須となる。</p>
<p>不思議なのだが、ターミナルで <code>$ npm run gulp html</code> と複数回手動で実行した際も、ファイルの差分が検知できる。どこか隠しファイルでタスクの実行履歴とかを管理しているのだろうか。</p>
<h2 id="scss-のビルド-css-タスク--大きな差異なし"><a class="header-link" href="#scss-のビルド-css-タスク--大きな差異なし"><span class="header-link-mark"></span></a>SCSS のビルド (<code>css</code> タスク) : 大きな差異なし</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * SCSS をトランスパイルして CSS を出力する
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'css'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./src/styles/index.scss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// エントリポイント</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">plumber</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>
      $<span class="token punctuation">.</span><span class="token method function property-access">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        outputStyle<span class="token operator">:</span> <span class="token string">'compressed'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token property-access">sass</span><span class="token punctuation">.</span><span class="token property-access">logError</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">// import('.css') をインライン化して全体を圧縮・ついでに UTF-8 BOM を除去する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">rename</span><span class="token punctuation">(</span><span class="token string">'./styles.css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// リネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// ./docs/styles.css を出力する</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * SCSS をトランスパイルして CSS を出力する
 */</span>
<span class="token keyword">function</span> <span class="token function">css</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./src/styles/index.scss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// エントリポイント</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">plumber</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>
      $<span class="token punctuation">.</span><span class="token method function property-access">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        outputStyle<span class="token operator">:</span> <span class="token string">'compressed'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token property-access">sass</span><span class="token punctuation">.</span><span class="token property-access">logError</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">// import('.css') をインライン化して全体を圧縮・ついでに UTF-8 BOM を除去する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">rename</span><span class="token punctuation">(</span><span class="token string">'./styles.css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// リネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// ./docs/styles.css を出力する</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'css'</span><span class="token punctuation">,</span> css<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ほぼ違いなし。<code>function</code> に切り出したのと、<code>return gulp...</code> ではなく <code>done()</code> で終了するようにしただけ。</p>
<h2 id="es2015-のトランスパイル-js-タスク--大きな差異なし"><a class="header-link" href="#es2015-のトランスパイル-js-タスク--大きな差異なし"><span class="header-link-mark"></span></a>ES2015 のトランスパイル (<code>js</code> タスク) : 大きな差異なし</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * ES2015 をトランスパイルして JS を出力する
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">browserify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/scripts/index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// エントリポイント</span>
    transform<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">'babelify'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// Do Browserify!</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Browserify Error : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylSourceStream</span><span class="token punctuation">(</span><span class="token string">'scripts.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// Vinyl に変換しリネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">// Uglify できるように変換する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token comment">// Uglify する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// ./docs/scripts.js を出力する</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * ES2015 をトランスパイルして JS を出力する
 */</span>
<span class="token keyword">function</span> <span class="token function">js</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">browserify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/scripts/index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// エントリポイント</span>
    transform<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">'babelify'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// Do Browserify!</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Browserify Error : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylSourceStream</span><span class="token punctuation">(</span><span class="token string">'scripts.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// Vinyl に変換しリネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">// Uglify できるように変換する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token comment">// Uglify する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// ./docs/scripts.js を出力する</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> js<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>コチラも大きな違いなし。</p>
<h2 id="画像ファイルなどのコピー-assets-all-タスク--大きな差異なし"><a class="header-link" href="#画像ファイルなどのコピー-assets-all-タスク--大きな差異なし"><span class="header-link-mark"></span></a>画像ファイルなどのコピー (<code>assets-all</code> タスク) : 大きな差異なし</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * HTML・CSS・JS 以外の画像ファイルなどを全てコピーする
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'assets-all'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src/pages'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * HTML・CSS・JS 以外の画像ファイルなどを全てコピーする (追加・変更のみ、削除には非対応)
 */</span>
<span class="token keyword">function</span> <span class="token function">assetsAll</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src/pages'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'assets-all'</span><span class="token punctuation">,</span> assetsAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>コレも大きな差異なし。</p>
<h2 id="画像ファイルなどの差分コピー-assets-タスク--大きな差異なし"><a class="header-link" href="#画像ファイルなどの差分コピー-assets-タスク--大きな差異なし"><span class="header-link-mark"></span></a>画像ファイルなどの差分コピー (<code>assets</code> タスク) : 大きな差異なし</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * HTML・CSS・JS 以外の画像ファイルなどをコピーする (差分のみ)
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src/pages'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">changed</span><span class="token punctuation">(</span><span class="token string">'./docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * HTML・CSS・JS 以外の画像ファイルなどをコピーする (追加・変更のみ、削除には非対応)
 */</span>
<span class="token keyword">function</span> <span class="token function">assets</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      base<span class="token operator">:</span> <span class="token string">'src/pages'</span><span class="token punctuation">,</span>
      since<span class="token operator">:</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">lastRun</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">,</span> assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>コレも大きな差異なし。<code>gulp.lastRun()</code> を使うように変えた。前回実行時から削除されたファイルの検知は上手くできないので要注意。</p>
<h2 id="全量ビルド-build-タスク"><a class="header-link" href="#全量ビルド-build-タスク"><span class="header-link-mark"></span></a>全量ビルド (<code>build</code> タスク)</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * docs ディレクトリ配下のファイルを削除する
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'clean'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./docs/**/*'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 全ファイルをビルドする
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">runSequence</span><span class="token punctuation">(</span>
    <span class="token string">'clean'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'html-all'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'assets-all'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    callback
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * docs ディレクトリ配下のファイルを削除する
 */</span>
<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./docs/**/*'</span><span class="token punctuation">,</span> <span class="token string">'./docs/.htaccess'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'clean'</span><span class="token punctuation">,</span> clean<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 全ファイルをビルドする : コレだけ関数で囲まない
 */</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>
  clean<span class="token punctuation">,</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">parallel</span><span class="token punctuation">(</span>htmlAll<span class="token punctuation">,</span> css<span class="token punctuation">,</span> js<span class="token punctuation">,</span> assetsAll<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> build<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>clean</code> タスクは、消したいファイルが上手く消せていなかったための微修正が入っている。それ以外は <code>done()</code> を呼んで終わる形に直しただけ。</p>
<p>メインは <code>build</code> タスク。<strong><code>run-sequence</code> を使っていたところを <code>gulp.series()</code> と <code>gulp.parallel()</code> だけで再現する</strong>ように変更している。関数を直接引数に指定している。どうも定義済の Gulp タスク名を文字列で指定しても大丈夫みたいだが、とりあえずこうしておいた。</p>
<p><code>gulp.series()</code> で束ねた内容を <code>gulp.task()</code> で定義する際は、<code>gulp.task()</code> の第2引数に直接 <code>gulp.series()</code> を渡してやる必要がある。だから <em><code>function build()</code> という関数の形式ではなく、<code>const build</code> とあくまで変数として定義している</em>ワケ。コレをミスると何のタスクも実行されないので注意。</p>
<h2 id="ファイルの変更を検知するライブリロード-dev-タスク"><a class="header-link" href="#ファイルの変更を検知するライブリロード-dev-タスク"><span class="header-link-mark"></span></a>ファイルの変更を検知するライブリロード (<code>dev</code> タスク)</h2>
<ul>
  <li>Gulp v3</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * ライブリロード開発用に Browser-Sync サーバを起動する
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token property-access">browserSync</span><span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">"docs"</span><span class="token punctuation">,</span>
      index<span class="token operator">:</span> <span class="token string">"index.html"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * リロードする
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'reload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token property-access">browserSync</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * ファイルを監視してライブリロード開発を行う
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'browser-sync'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// src ファイルを監視して処理する</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/styles/**/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'css'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/scripts/**/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ファイルが削除された時は docs ディレクトリからも削除する</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token property-access">event</span> <span class="token operator">===</span> <span class="token string">'unlink'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\\pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\/pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'html'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// テンプレート変更時は全ファイルに再適用する</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/templates/**/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'html-all'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ファイルが削除された時は docs ディレクトリからも削除する</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token property-access">event</span> <span class="token operator">===</span> <span class="token string">'unlink'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\\pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\/pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'assets'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// docs ファイルを監視してライブリロードする</span>
  $<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./docs/**/*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'reload'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>Gulp v4</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/**
 * ライブリロード開発用に Browser-Sync サーバを起動する
 */</span>
<span class="token keyword">function</span> <span class="token function">initBrowserSync</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span><span class="token property-access">browserSync</span><span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'docs'</span><span class="token punctuation">,</span>
      index<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** 監視する */</span>
<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/** リロードする */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">reload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token property-access">browserSync</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token doc-comment comment">/** ファイルを削除する */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">removeFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\\pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\/pages</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// src ファイルを監視して処理する</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/styles/**/*.scss'</span>   <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>css    <span class="token punctuation">,</span> reload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/scripts/**/*.js'</span>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>js     <span class="token punctuation">,</span> reload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/templates/**/*.html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>htmlAll<span class="token punctuation">,</span> reload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// テンプレート HTML 変更時は全 HTML ファイルに再適用する</span>
  <span class="token comment">// 各 HTML</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token string">'./src/pages/**/*.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'add'</span>   <span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> reload<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> reload<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> removeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// アセットファイル</span>
  gulp<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span>assetFileNames<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'add'</span>   <span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> removeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * ファイルを監視してライブリロード開発を行う
 */</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token method function property-access">series</span><span class="token punctuation">(</span>initBrowserSync<span class="token punctuation">,</span> watch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ココが一番大きな変更だった。</p>
<p>v3 における <code>browser-sync</code> タスクは、v4 では <code>initBrowserSync()</code> 関数として定義し、最後に登場する<code>gulp.task('dev')</code> にて指定している。<code>gulp.series()</code> で <code>initBrowserSync()</code> → <code>watch()</code> の順に直列実行するよう記述しているので、Browser-Sync が起動してからファイル監視が始まるワケ。</p>
<p>v3 の <code>reload</code> タスクは、v4 では <code>watch()</code> 関数内に記述した。<code>watch()</code> 関数内でしか使用しないので、このような書き方ができる。</p>
<p>v3 の <code>dev</code> タスク内に書いていた一連の処理は、v4 では <code>watch()</code> 関数に切り出している。<code>gulp-watch</code> パッケージを使っていたところ、<em>Gulp 本体に組み込みの <code>gulp.watch()</code> 関数</em>を使うよう変更している。</p>
<p><code>gulp.watch()</code> 関数の実体は <code>chokidar</code> というファイルの変更監視ライブラリで、<code>.on('change')</code> (変更) や <code>.on('add')</code> (追加)、<code>.on('unlink')</code> (削除) といった指定は <code>chokidar</code> と同じ。</p>
<p>監視するファイルに合わせて、追加・変更時はビルドタスクを呼び、その後ブラウザをリロードするよう、<code>gulp.series()</code> で指定している。v4 のコードの方が、何をしているのか推測しやすく・読みやすくなったと思う。</p>
<p><code>gulp.watch().on('unlink')</code> 時に対象ファイルを削除する処理を、<code>removeFile()</code> 関数に切り出した。<code>.on()</code> の第2引数に指定したコールバック関数には、仮引数 <code>path</code> が渡るので、削除されたファイルのパスが分かる。コレを使用して削除処理を行っている。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>というワケで、Gulp v3 から Gulp v4 へのマイグレーションが完了した。</p>
<p>コレまで使用していた外部プラグインが不要になり、Gulp 単体でできることが増えたので、パッケージ管理が容易になったと思う。</p>
<h2 id="参考文献"><a class="header-link" href="#参考文献"><span class="header-link-mark"></span></a>参考文献</h2>
<ul>
  <li><a href="https://stackoverflow.com/questions/57366063/why-is-browser-sync-with-gulp-not-working">javascript - Why is browser-sync with gulp not working - Stack Overflow</a></li>
  <li><a href="https://qiita.com/hibikikudo/items/493fbfbbea183c94b38b">Gulp4がリリースされたのでgulpfile.jsをアップデートした - Qiita</a></li>
  <li><a href="https://dara-blog.com/browser-auto-reload">gulp4とbrowser-syncを使用したブラウザ自動更新機能作成 | Darablog</a></li>
  <li><a href="https://gulpjs.com/docs/en/api/watch">watch() · gulp.js</a></li>
  <li><a href="https://qiita.com/tatsuo-iriyama/items/08ba4bd621b7fdedcc4e">gulp3→4の変更点に気をつけよう！ - Qiita</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-03-03</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-03-03</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
