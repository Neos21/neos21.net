<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>WSL2 上で起動した Selenium Webdriver や Puppeteer から Windows 側の Chrome ウィンドウを操作したかったが無理 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/10/13-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/10/index.html">10月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-10-13</time></div>
        <h1 id="page-title">WSL2 上で起動した Selenium Webdriver や Puppeteer から Windows 側の Chrome ウィンドウを操作したかったが無理</h1>

<p>出来たって人もいるみたいだけど、自分は無理だった。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8">やりたいこと</a></li>
  <li><a href="#selenium-webdriver-%E3%81%AF%E5%87%BA%E6%9D%A5%E3%81%9D%E3%81%86%E3%81%A7%E5%87%BA%E6%9D%A5%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F">Selenium Webdriver は出来そうで出来なかった</a></li>
  <li><a href="#selenium-server-%E3%82%92-windows-%E5%81%B4%E3%81%AB%E7%AB%8B%E3%81%A6%E3%81%A6%E3%81%BF%E3%81%9F%E3%81%8C%E3%83%80%E3%83%A1%E3%81%A0%E3%81%A3%E3%81%9F">Selenium Server を Windows 側に立ててみたがダメだった</a></li>
  <li><a href="#selenium-webdriver-%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F-puppeteer-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E3%81%8C%E3%83%80%E3%83%A1%E3%81%A0%E3%81%A3%E3%81%9F">Selenium Webdriver ではなく Puppeteer を使ってみたがダメだった</a></li>
  <li><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82-wsl-%E3%81%A8-windows-%E9%96%93%E3%81%AE-localhost-%E3%81%AF%E3%81%A9%E3%81%86%E9%96%A2%E4%BF%82%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B">そもそも WSL と Windows 間の <code>localhost</code> はどう関係しているのか</a></li>
  <li><a href="#%E6%9C%AA%E6%A4%9C%E8%A8%BC%E3%81%AE%E5%86%85%E5%AE%B9">未検証の内容</a></li>
</ul>
<h2 id="やりたいこと"><a class="header-link" href="#やりたいこと"><span class="header-link-mark"></span></a>やりたいこと</h2>
<ol>
  <li>Windows 側で常用している Chrome ブラウザのプロファイルを利用して、Selenium 的なツールでブラウザの自動操作を行いたい
    <ul>
      <li>サイトへのログイン情報とかを流用したかったので、既存のプロファイルを使い回したかった</li>
    </ul>
  </li>
  <li>ツールが Chrome を自動操作している様子をリアルタイムに確認したかった
    <ul>
      <li>つまりヘッドレスで動くのではなく、ヘッドありで動かしたかった</li>
    </ul>
  </li>
</ol>
<p>それでいて、</p>
<ul>
  <li>Windows 側には Java・Node.js などがインストールされていない</li>
  <li>WSL 側にのみ、Java や Node.js がインストールされている</li>
</ul>
<p>という環境だった。最近は開発環境を WSL に移しているので、Windows 側には余計なモノをインストールしたくなかった。</p>
<p>こんな環境で、果たして WSL から Windows へと世界を飛び越えられるのか、試してみた次第。</p>
<h2 id="selenium-webdriver-は出来そうで出来なかった"><a class="header-link" href="#selenium-webdriver-は出来そうで出来なかった"><span class="header-link-mark"></span></a>Selenium Webdriver は出来そうで出来なかった</h2>
<p>まずは過去にも使ったことのある、Ndoe.js 製の <code>selenium-webdriver</code> を使ってみた。</p>
<ul>
  <li><a href="/blog/2019/01/14-02.html">Node.js で selenium-webdriver と chromedriver を使って Chrome ブラウザを自動操作してみる</a></li>
  <li>WSL 側に Node.js プロジェクトを作って、selenium-webdriver をインストールする</li>
  <li>Windows 側で、Windows 用の <code>chromedriver.exe</code> をダウンロードして適当なところに置いておく</li>
  <li>selenium-webdriver で <code>chromedriver.exe</code> へのパスを <code>/mnt/c/</code> で指定する</li>
</ul>
<p>…というだけで動かせるらしかったが、<strong>動かなかった。</strong>Builder のインスタンスを生成するところでタイムアウトになった。</p>
<ul>
  <li>参考：<a href="https://github.com/lackovic/notes/tree/master/Windows/Windows%20Subsystem%20for%20Linux#use-chromedriver-on-wsl">notes/Windows/Windows Subsystem for Linux at master · lackovic/notes · GitHub</a>
    <ul>
      <li>この方式を説明している</li>
    </ul>
  </li>
  <li>参考：<a href="https://laboradian.com/operate-browser-on-win-by-python-of-wsl-via-selenium/">WSL (Ubuntu16.04.4 LTS) 上の Python から、Selenium を利用して Windows側のウェブブラウザを操作する | ラボラジアン</a>
    <ul>
      <li>Python 版。<code>executable_path</code> なるオプションで <code>/mnt/c/</code> 配下の <code>driver.exe</code> を指定している</li>
    </ul>
  </li>
  <li>参考：<a href="https://rooter.jp/web-crawling/wsl-selenium/">WSL環境でのseleniumクローラーをブラウザを立ち上げて開発する – 株式会社ルーター</a>
    <ul>
      <li>Ruby 版。<code>driver_path</code> というオプションで同様に <code>/mnt/c/</code> 配下の <code>chromedriver.exe</code> を指定している</li>
    </ul>
  </li>
  <li>参考：<a href="https://qiita.com/clustfe/items/937bd3a5ab988c8ea908">Selenium-webdriverでブラウザ用ドライバーを指定して動かすよ - Qiita</a>
    <ul>
      <li>Node.js 版において <code>chromedriver.exe</code> のパスを指定するには、<em><code>new require('selenium-webdriver/chrome').ServiceBuilder('/PATH/TO/chromedriver.exe')</code></em> でインスタンスを生成し、<code>Builder#setChromeService(service)</code> と指定する</li>
    </ul>
  </li>
  <li>参考：<a href="https://github.com/microsoft/WSL/issues/1169#issuecomment-439374158">Using BashOnWindows with Selenium? · Issue #1169 · microsoft/WSL · GitHub</a>
    <ul>
      <li>以下のような <code>chromedriver</code> シェルスクリプトを書き、selenium-webdriver を実行する Node.js スクリプトと同じ階層に置いておくと、ServiceBuilder での指定が要らなくなるっぽい</li>
    </ul>
  </li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
/mnt/c/<span class="token environment constant">PATH</span>/TO/chromedriver.exe <span class="token string">"<span class="token variable">$@</span>"</span>
</code></pre>
<ul>
  <li>参考：<a href="https://stackoverflow.com/questions/40288651/how-to-use-selenium-chromedriver-without-being-forced-to-update">node.js - How to use Selenium chromedriver without being forced to update? - Stack Overflow</a>
    <ul>
      <li><code>chrome.ServiceBuilder(path)</code>、<code>options.setChromeBinaryPath()</code>、<code>usingServer()</code> などの API を知った</li>
    </ul>
  </li>
  <li>参考：<a href="https://qiita.com/mima_ita/items/32265ea071d291c750ed">Electronで作った画面の自動操作 - Qiita</a></li>
  <li>参考：<a href="https://qiita.com/Hidenatsu/items/e43ba04b4b5f710784e6">SeleniumでChromeのユーザープロファイルを指定しつつ同時に自分もChromeを使う方法 - Qiita</a>
    <ul>
      <li><code>--user-data-dir</code> は使えた。コチラでプロファイル名のディレクトリまでのパスを指定する。<code>--profile-directory</code> オプションは上手く行かなかった</li>
    </ul>
  </li>
</ul>
<p>あとはパスの指定方法を</p>
<ul>
  <li><code>'/mnt/c/Users/…'</code></li>
  <li><code>'C:\\Users\\…'</code> (JS の文字列なのでバックスラッシュはエスケープする)</li>
  <li><code>'C:/Users/…'</code></li>
</ul>
<p>などの表記パターンでそれぞれ試したが、うまく行かず。コード片残しとく。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> webdriver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'selenium-webdriver'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chrome <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'selenium-webdriver/chrome'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">chrome<span class="token punctuation">.</span>ServiceBuilder</span><span class="token punctuation">(</span><span class="token constant">CHROME_DRIVER_PATH</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  chrome<span class="token punctuation">.</span><span class="token method function property-access">setDefaultService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">chrome<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">setChromeBinaryPath</span><span class="token punctuation">(</span><span class="token constant">CHROME_BROWSER_PATH</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">addArguments</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--user-data-dir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHROME_USER_DATA_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> capabilities <span class="token operator">=</span> webdriver<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Capabilities</span></span><span class="token punctuation">.</span><span class="token method function property-access">chrome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'chromeOptions'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    args<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'--no-sandbox'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> driver <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">webdriver<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">forBrowser</span><span class="token punctuation">(</span><span class="token string">'chrome'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">setChromeOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">withCapabilities</span><span class="token punctuation">(</span>capabilities<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ココでエラーが出て続行不可能</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="selenium-server-を-windows-側に立ててみたがダメだった"><a class="header-link" href="#selenium-server-を-windows-側に立ててみたがダメだった"><span class="header-link-mark"></span></a>Selenium Server を Windows 側に立ててみたがダメだった</h2>
<ul>
  <li>参考：<a href="https://gist.github.com/danwhitston/5cea26ae0861ce1520695cff3c2c3315#implemented-solution---windows-selenium-server">Browser testing for Ruby from within Windows Subsystem for Linux · GitHub</a></li>
</ul>
<p>上の記事によると、Windows 側に Java をインストールし、</p>
<ul>
  <li>参考：<a href="https://www.selenium.dev/downloads/">Downloads</a></li>
</ul>
<p>↑ から Selenium Server (Grid) の JAR ファイル <code>selenium-server-standalone-3.141.59.jar</code> を落としてきて、コレに接続するようにしたら動く、とか書いてあった。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment"># PowerShell にて。Chocolatey で JRE 8 を入れておく</span>
PS1> choco install jreruntime

<span class="token comment"># PowerShell で Selenium Server を動かしてみる</span>
PS1> java <span class="token operator">-</span>jar <span class="token punctuation">.</span>\selenium<span class="token operator">-</span>server<span class="token operator">-</span>standalone<span class="token operator">-</span>3<span class="token punctuation">.</span>141<span class="token punctuation">.</span>59<span class="token punctuation">.</span>jar <span class="token operator">-</span>port 4445
</code></pre>
<p>ココまでやると、</p>
<ul>
  <li><code>http://localhost:4445/wd/hub/static/resource/hub.html</code></li>
</ul>
<p>なんかにアクセスして Selenium Server が動いているのを確認できる。</p>
<p>そしたら WSL 側に戻る。先程見ていた文献で <code>usingServer()</code> メソッドの存在走っていたので、Builder 部分を次のようにしてみる。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> driver <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">webdriver<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">forBrowser</span><span class="token punctuation">(</span><span class="token string">'chrome'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">usingServer</span><span class="token punctuation">(</span><span class="token string">'http://172.xx.xx.xx:4445/wd/hub'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">setChromeOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">withCapabilities</span><span class="token punctuation">(</span>capabilities<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>localhost</code> ではなく <code>172.xx.xx.xx</code> なる IP を指定しているのは、後で詳しく説明するが、Windows ホスト側の <code>localhost</code> を参照するため。<code>/etc/resolv.conf</code> 内に記載の <code>nameserver</code> の IP アドレスを書いてある。</p>
<p>コレを実行すると、<em>PowerShell 上で動く Selenium Server がエラーログを出力していて、通信が届いていることは確認できた。</em>でもそのエラーを解消しきれず断念。なんか実行パスかドライバーのパスが違うぐらいのエラーな感じがするんだけど、どうやってもダメだった。</p>
<h2 id="selenium-webdriver-ではなく-puppeteer-を使ってみたがダメだった"><a class="header-link" href="#selenium-webdriver-ではなく-puppeteer-を使ってみたがダメだった"><span class="header-link-mark"></span></a>Selenium Webdriver ではなく Puppeteer を使ってみたがダメだった</h2>
<p>Selenium Webdriver を諦めて、<em>Puppeteer</em> を使ってみることにした。コイツは Selenium よりもブラウザ周りが扱いやすいっぽい。</p>
<ul>
  <li>参考：<a href="https://ktkr3d.github.io/2020/01/27/Puppeteer-on-WSL/">Puppeteer on WSL | Memorandum!</a>
    <ul>
      <li>Windows 側の <code>chrome.exe</code> へのパスを指定してうまく動いていそう</li>
    </ul>
  </li>
  <li>参考：<a href="https://github.com/dev100kg/puppeteer-sample-wsl">GitHub - dev100kg/puppeteer-sample-wsl: Puppeteer を WSL で実行するサンプル</a>
    <ul>
      <li>puppeteer-core と chrome-launcher を使用しているサンプルプロジェクト。動かず</li>
    </ul>
  </li>
  <li>参考：<a href="https://qiita.com/yhatt/items/874d5bfa919c32728403">Puppeteer &#x26; Carlo を Markdown スライド作成 CLI ツール (Marp CLI) で活用する - Qiita</a>
    <ul>
      <li>上のサンプルプロジェクトとほぼ同じ</li>
    </ul>
  </li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword control-flow">await</span> puppeteer<span class="token punctuation">.</span><span class="token method function property-access">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  executablePath<span class="token operator">:</span> <span class="token string">'/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe'</span><span class="token punctuation">,</span>
  userDataDir<span class="token operator">:</span> <span class="token constant">USER_DATA_DIR</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>こんな感じになるのだが、結局は<strong>上手く動かなかった。</strong></p>
<p><em><code>launch()</code> メソッドが Windows 側に Chrome ウィンドウを開くところまでは行く</em>のだが、その直後に</p>
<pre><code>connect ECONNREFUSED 127.0.0.1:60081
</code></pre>
<p>というようなエラーメッセージで異常終了してしまい、<code>launch()</code> メソッドが完了しない。</p>
<ul>
  <li>参考：<a href="https://github.com/puppeteer/puppeteer/issues/1837">Puppeteer doesn't run under WSL (Windows subsystem for Linux) · Issue #1837 · puppeteer/puppeteer · GitHub</a>
    <ul>
      <li>Puppeteer における WSL 連携で一番盛んに議論されている Issues</li>
      <li>なんかもう最後は WSL に GUI 作って VcXsrv で開いたら？ってなってる</li>
    </ul>
  </li>
</ul>
<h2 id="そもそも-wsl-と-windows-間の-localhost-はどう関係しているのか"><a class="header-link" href="#そもそも-wsl-と-windows-間の-localhost-はどう関係しているのか"><span class="header-link-mark"></span></a>そもそも WSL と Windows 間の <code>localhost</code> はどう関係しているのか</h2>
<p>Puppeteer のエラーメッセージの中に、</p>
<ul>
  <li><code>ws://127.0.0.1:50887/devtools/browser/</code></li>
</ul>
<p>とかいう URL が見えて、ふと「この <code>127.0.0.1</code> は、WSL Ubuntu の世界における <code>localhost</code> だよな…」と思った。</p>
<p>ネットワークの基礎知識として、<code>localhost</code> が<em>自機</em>を表すホスト名なのは分かっている。で、WSL の世界でいう localhost と、Windows の世界の localhost は別物だろうな、という認識もある。例えば Docker コンテナ内の <code>localhost</code> は Windows ホスト側の <code>localhost</code> とは違うから、Windows 側から Docker コンテナ内で動く Web サーバを見たければポートフォワードが必要だったりするので、その辺が分かっていないワケではない。</p>
<p>でも、WSL 上で <code>$ node server.js</code> のように起動した <code>http://localhost:8080/</code> な開発サーバなんかは、Windows 側から <code>http://localhost:8080/</code> で繋げられてるよな？</p>
<p>調べてみると、どうやら WSL 上の <code>localhost</code> は、Windows 側からも <code>localhost</code> として見えるように調整されているが、<strong>その逆は透過されない</strong>ようなのだ。</p>
<ul>
  <li>参考：<a href="https://docs.microsoft.com/en-us/windows/wsl/compare-versions#accessing-windows-networking-apps-from-linux-host-ip">Comparing WSL 2 and WSL 1 | Microsoft Docs</a>
    <ul>
      <li>Windows 公式の説明。Windows → WSL の参照は <code>localhost</code> が透過しているが、WSL → Windows への参照は <code>/etc/resolv.conf</code> に記載の IP を使う必要がある</li>
      <li>
        <blockquote>
          <p>Accessing Windows networking apps from Linux (host IP)</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>参考：<a href="https://github.com/microsoft/WSL/issues/4619">WSL 2 WSL 2 cannot access windows service via localhost:port · Issue #4619 · microsoft/WSL · GitHub</a></li>
  <li>参考：<a href="https://github.com/microsoft/WSL/issues/4793#issuecomment-577232999">Unable to accessing Windows applications from WSL · Issue #4793 · microsoft/WSL · GitHub</a>
    <ul>
      <li>WSL 側から Windows 側を覗くには、<code>localhost</code> ではダメで、<code>/etc/resolv.conf</code> に記載の <code>172.xx.xx.xx</code> な IP を使うか、PowerShell で <code>ipconfig</code> で確認した <code>192.168.xx.xx</code> な IP を指定する必要がある</li>
    </ul>
  </li>
  <li>参考：<a href="https://github.com/microsoft/WSL/issues/1032#issuecomment-677727024">How to access host ip and port? · Issue #1032 · microsoft/WSL · GitHub</a>
    <ul>
      <li><code>/etc/resolv.conf</code> から IP を拾ってくるワンライナー</li>
    </ul>
  </li>
</ul>
<p>Windows 側の <code>localhost</code> に、WSL からアクセスしたい場合は、<code>/etc/resolv.conf</code> に記載の IP を使ったりするワケである。</p>
<p>そうすると、Puppeteer のエラーメッセージ中に出てきた <code>127.0.0.1</code> は、WSL 内の localhost を見てしまっていて、Windows 側の localhost は覗けていないことになる。Windows 側の Chrome を触りたいのに、WSL 内の localhost に閉じていたら上手く動かないやろな、と…。</p>
<h2 id="未検証の内容"><a class="header-link" href="#未検証の内容"><span class="header-link-mark"></span></a>未検証の内容</h2>
<p>なんだか段々諦めてきてしまって、以降の検証をやる前にこの記事を書いてしまった。WSL2 はまだまだアップデートが盛んで、仕様変更も多いので、過去のやり方が通用しなくなっているのだろうし、それがまたいつか別の方法で出来るようになっているかもしれない。</p>
<ul>
  <li>参考：<a href="https://github.com/Microsoft/WinAppDriver">GitHub - microsoft/WinAppDriver: Windows Application Driver</a>
    <ul>
      <li>WinAppDriver という Selenium ライクなツールが WSL に対応しているらしいが未検証</li>
    </ul>
  </li>
</ul>
<p>Puppeteer に関しては、<strong>起動済みの Chrome ブラウザに後から接続しにいく</strong>という方法があるらしい。</p>
<ul>
  <li>参考：<a href="https://github.com/puppeteer/puppeteer/issues/5957#issuecomment-637321228">WSL2 refusing to connect to chrome.exe · Issue #5957 · puppeteer/puppeteer · GitHub</a>
    <ul>
      <li><code>--remote-debugging-address</code> オプションを付けて Chrome を起動する</li>
    </ul>
  </li>
  <li>参考：<a href="https://stackoverflow.com/a/55100293">javascript - Connecting Browsers in Puppeteer - Stack Overflow</a>
    <ul>
      <li><code>--remote-debugging-port</code> オプションでポートを指定して Chrome を起動しておく</li>
      <li><code>launch()</code> ではなく <code>connect()</code> で接続できるらしい</li>
    </ul>
  </li>
  <li>参考：<a href="https://hiroqn.hatenablog.com/entry/2018/12/12/235919">puppeteer.connectを試す - hiroqn's Data.ByteString.Lazy.ByteString</a>
    <ul>
      <li><code>--remote-debugging-port=0</code> とするとポートがランダムに決まり、エンドポイント URL がコンソールで確認できるらしい</li>
      <li><code>connect()</code> メソッドの <code>browserWSEndpoint</code> オプションでそのエンドポイント URL を指定すれば良いらしい</li>
    </ul>
  </li>
</ul>
<p>なんか原理的に考えるとコレが上手く行きそう感あるな…。</p>
<p>あとはヘッドありで動かすのを諦めて、Docker に閉じ込めてしまうとか。</p>
<ul>
  <li>参考：<a href="https://qiita.com/takayuki-miura0203/items/4fa4cdc9ef0c07a857a9">Docker + docker-compose + puppeteer でスクレイピングしてみた - Qiita</a>
    <ul>
      <li>Docker 内にフォントを入れたりしないといけないみたいで、コレも面倒っちゃ面倒</li>
    </ul>
  </li>
</ul>
<p>やりたいことをとにかく実現したいなら、環境を汚しまくれば不可能ではない。</p>
<ul>
  <li>WSL に GUI デスクトップ環境を作り、Ubuntu 版の Chrome を動かす (= 完全に WSL 内で完結させる。Windows 側の要素は一切使わない。デスクトップを見るのは VcXsrv で)</li>
  <li>今まで Windows GitBash を使っていたんだし、Windows 側に Java でも Node.js でも入れて環境構築したらええ。そしたら <code>localhost</code> で Chrome を触れる (= WSL を一切使わない)</li>
</ul>
<p>こうなるともうクソダルゲンナリマンで、「それならブラウザの自動化なんか実現しなくていい」って気持ちになってしまうので、もうやらないことにする。ｗ</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-10-13</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-10-13</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
