<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>あえて確認をしないようにする輩 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/10/26-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/10/index.html">10月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-10-26</time></div>
        <h1 id="page-title">あえて確認をしないようにする輩</h1>

<p>ある開発案件で、CI/CD のルールを検討していて、</p>
<ol>
  <li>feature ブランチからのプルリク作成時にユニットテストを実行する
    <ul>
      <li>プルリク作成後はコミットがあるたびにユニットテストが再実行される</li>
      <li>ユニットテストが成功していない状態では、管理者でもマージはできない</li>
    </ul>
  </li>
  <li><strong>プルリクをマージする時に再度ユニットテストを実行する</strong></li>
</ol>
<p>というようなルールを考えていたら、</p>
<ul>
  <li>「プルリク作成時と、マージ後とで、ソースコードは全く同じはずですよね？<em>何でマージ後にもユニットテストを行う必要があるんですか？</em>」</li>
</ul>
<p>とツッコミが入った。コレに対して理解が得られなかったので愚痴る。</p>
<hr>
<p>確かに、上の条件なら、<strong>ほぼ確実に</strong>「全く同じユニットテストを2回行う」ことになるだろう。</p>
<p>だが自分は、「いざマージしてみたらアプリがビルドできなくなっていた」という障害を経験したことがある。それは複数ブランチのプルリクをほぼ同時にオートマージしたことで発生したものだった。それぞれのプルリクがマージ可能な状態で、2窓開いて同時に「マージ」ボタンを押せば、それは容易に再現できる内容だった。</p>
<p>つまり、マージの前後で、ソースコードが<em>全く同じではなかった</em>のだ。ツールがうまいこと制御してくれているつもりでも、なんらかの抜け道が出来てしまったら、問題が起こるワケだ。</p>
<p>このようなバグの再発を防ぐには、「マージ後に改めてユニットテストが通るかチェックし、通らなければ何かおかしいのだから通知する」という対策が思いつくのは自然なことだろう。</p>
<hr>
<p>それに、もし仮に、今回選定したツールではそうした「複数ブランチで同時にマージ処理」みたいなことをしても、問題が起こらないように制御しきっているとしよう。</p>
<p>それでも、だ。</p>
<p>それでも、<strong>「もしそこで問題が起きていたらすぐに知りたい」ことがあるなら、いつ・何度でも再確認したらいいんじゃない？</strong>と思うワケだ。</p>
<p>今回なら、「マージ先のデフォルトブランチ」は、常にユニットテストが通る状態であることを担保したい要件があるので、だったらマージ後であっても、ユニットテストが通るかチェックするべきなのである。</p>
<p>なんなら、<strong>プルリクやマージがなくても、毎日1回必ずユニットテストを行う</strong>という定期処理を組んだって、全く問題ないし、望ましいことだとすら思う。</p>
<p>これは契約プログラミングでいうところの<em>「不変条件」</em>に近い話なのだから、事前・事後の両方で同じチェックを行って、「事後チェックの意味があまりない気がする」状態で正しいのだ。</p>
<ul>
  <li><a href="/blog/2019/10/05-01.html">契約による設計・契約プログラミングが少しワカッタ</a></li>
</ul>
<hr>
<p>しかし指摘者の考えは違った。</p>
<p>「毎回同じ結果になる<strong>『はず』</strong>だと<em>『想定』</em>できているから、そんな無駄なことやる必要はない」</p>
<p>そう思っているのだった。</p>
<p>ツールが 100% 確実に割り込み処理をハンドリングしてくれる、ヒューマンエラーが起こらないようツールで制限している、それなら<em>想定外の事態は起こり得ないはずだ</em>、と考えているのだ。</p>
<p>言いたいことは分かる。自分だって、大抵の場合はそう思う。でも、<strong>想定外の事態は事前に想定できていなかったから起こるモノなのだ。</strong>今の時点で、問題が起こるパターンが見えないから、何の対策もしなくていい、というのは、いささか思慮が甘いと言わざるを得ない。</p>
<hr>
<p>「コードを変えていない状態で、毎日1回ユニットテストを行う？そんなの結果が変わるワケないじゃん、無駄じゃね？」</p>
<p>本当にそうだろうか。</p>
<p>(今回の話の中では「ユニットテスト」と表現しているが、もう少し大規模なテストを CI/CD で定期実行したら、また違ったことになる。例えば、実行日に依存するテストをやってみたら月末だけ起こるバグに気が付いたとか、テストの失敗からネットワーク連携している相手システムの仕様変更に気付いたとか)</p>
<p>本当に結果が変わるワケないのだと思うなら、それを証明するために、毎日テストをやって確認してもいいよね？<strong>あえてやらないことにする</strong>ことでのメリットって、なんかある？</p>
<p>無料で使える CI/CD ツールが毎日1回テストを実行したところで、コスト的な問題はないのだし、どうしてその確認を怠っていて自信が持てるのだろうか。</p>
<hr>
<p>自分は今日一日外出していないから、家の鍵は閉まっているはずだ、といって、就寝前に戸締まりをチェックしない人がいるだろうか。もしかしてそういう人は、戸締まりを確認しないモノなのだろうか。僕はエンジニア職になるよりはるか前から、戸締まりは毎日必ず確認する人間だった。</p>
<p>正しさが重要な画面なら、何度だって確認したらいい。</p>
<p>結局今回の場面では、「『僕の提言を上長が確認して却下した』という記録を文面を残しておいてもらえるなら、マージ後にテストをやらないルールで良いですよ」と決着を付けた。あとでトラブルが起きた時に、設計担当の僕は正しく、レビュアーである上長が間違っていた、と客観的に明らかにするためだ。自衛は大事。</p>
<ul>
  <li><a href="/blog/2018/07/23-01.html">「間違っていないことの確認」を怠る人</a></li>
  <li><a href="/blog/2019/04/08-01.html">「～～なはず」と言った数だけトラブルは起こる</a></li>
</ul>
<p>過去にも似たようなこと言ってるからさ、もうみんないい加減にしようよ。成長して。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-10-26</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-10-26</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
