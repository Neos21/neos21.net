<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Electron を使って Windows タスクトレイ・Mac メニューバーに常駐するアプリを作る - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/12/04-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/12/index.html">12月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-12-04</time></div>
        <h1 id="page-title">Electron を使って Windows タスクトレイ・Mac メニューバーに常駐するアプリを作る</h1>

<p>以前少しイジったきりの Electron を使って、Windows のタスクトレイや、Mac のメニューバーに常駐するアプリを作ってみる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89">ソースコード</a></li>
  <li><a href="#%E4%BD%9C%E6%A5%AD%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B">作業ディレクトリを準備する</a></li>
  <li><a href="#packagejson-%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B"><code>package.json</code> を編集する</a></li>
  <li><a href="#%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%88%E3%83%AC%E3%82%A4%E7%94%A8%E3%81%AE-ico%E3%80%81%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%83%90%E3%83%BC%E7%94%A8%E3%81%AE-png-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B">タスクトレイ用の <code>.ico</code>、メニューバー用の <code>.png</code> ファイルを用意する</a></li>
  <li><a href="#indexjs-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><code>index.js</code> を実装する</a></li>
  <li><a href="#%E3%83%93%E3%83%AB%E3%83%89%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">ビルドしてみる</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="ソースコード"><a class="header-link" href="#ソースコード"><span class="header-link-mark"></span></a>ソースコード</h2>
<p>先に、今回実装したソースコードの全量を紹介する。以下の GitHub リポジトリより確認いただける。</p>
<ul>
  <li><a href="https://github.com/Neos21/practice-electron-tray-app">Neos21/practice-electron-tray-app: Practice Electron Tray App</a></li>
</ul>
<h2 id="作業ディレクトリを準備する"><a class="header-link" href="#作業ディレクトリを準備する"><span class="header-link-mark"></span></a>作業ディレクトリを準備する</h2>
<p>適当な作業ディレクトリを作り、Electron と、各プラットフォーム向けにビルドしてくれる Electron-Builder をインストールする。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> init -y
$ <span class="token function">npm</span> <span class="token function">install</span> -D electron electron-builder
</code></pre>
<h2 id="packagejson-を編集する"><a class="header-link" href="#packagejson-を編集する"><span class="header-link-mark"></span></a><code>package.json</code> を編集する</h2>
<p>Electron-Builder の設定は <code>package.json</code> に書けるので、<code>package.json</code> を直していく。適宜コメントを入れているが、実際はコメント行があると不正な JSON ファイルになってしまうので、コメントは削除すること。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"practice-electron-tray-app"</span><span class="token punctuation">,</span>
  <span class="token comment">// バージョン番号がビルド時に必要になる</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Practice Electron Tray App"</span><span class="token punctuation">,</span>
  <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// エントリポイントのファイルを指定する。この記述がないと main.js を自動的に探してくれる</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 開発用のビルド</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"electron ./"</span><span class="token punctuation">,</span>
    <span class="token comment">// 資材が出力されるディレクトリを空にする。適宜 rimraf など使うと良い</span>
    <span class="token property">"clear"</span><span class="token operator">:</span> <span class="token string">"rm -rf ./dist"</span><span class="token punctuation">,</span>
    <span class="token comment">// Windows と Mac 向け両方にビルドする</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"electron-builder -mw"</span><span class="token punctuation">,</span>
    <span class="token comment">// Windows 向けにビルドする</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"electron-builder -w"</span><span class="token punctuation">,</span>
    <span class="token comment">// Mac 向けにビルドする</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"electron-builder -m"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Author 情報がビルド時に必要になる</span>
  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Neo &#x3C;neos21@gmail.com> (https://neos21.net/)"</span><span class="token punctuation">,</span>
  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"electron"</span><span class="token operator">:</span> <span class="token string">"11.0.3"</span><span class="token punctuation">,</span>
    <span class="token property">"electron-builder"</span><span class="token operator">:</span> <span class="token string">"22.9.1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 以下、ビルド用の設定</span>
  <span class="token property">"build"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"productName"</span><span class="token operator">:</span> <span class="token string">"Practice Electron Tray App"</span><span class="token punctuation">,</span>
    <span class="token property">"appId"</span><span class="token operator">:</span> <span class="token string">"com.example.practice.electron.tray.app"</span><span class="token punctuation">,</span>
    <span class="token property">"mac"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"dir"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"win"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"dir"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="タスクトレイ用の-ico、メニューバー用の-png-ファイルを用意する"><a class="header-link" href="#タスクトレイ用の-ico、メニューバー用の-png-ファイルを用意する"><span class="header-link-mark"></span></a>タスクトレイ用の <code>.ico</code>、メニューバー用の <code>.png</code> ファイルを用意する</h2>
<p>Windows のタスクトレイに表示できるアイコンファイルは <code>.ico</code> 形式で用意する。</p>
<p>一方、メニューバー用のアイコンファイルは <code>.png</code> 形式で用意する。</p>
<p>いずれも 16×16px で用意しておけばとりあえず動く。ココでは <code>icon-16.ico</code>・<code>icon-16.png</code> というファイル名で用意したことにする。</p>
<p>どうも <code>icon.png</code> などのファイル名でファイルを置いておくと、アプリアイコン用のアセットファイルと勘違いされてビルド時にエラーになるので、単純な <code>icon</code> というファイル名だけ避けておく。</p>
<h2 id="indexjs-を実装する"><a class="header-link" href="#indexjs-を実装する"><span class="header-link-mark"></span></a><code>index.js</code> を実装する</h2>
<p><code>package.json</code> の <code>main</code> プロパティで指定した、エントリポイントとなる <code>index.js</code> を実装する。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> electron <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> tray <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>  <span class="token comment">// GC でトレイアイコンが消えないようにする</span>

electron<span class="token punctuation">.</span><span class="token property-access">app</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Mac のみ Dock は非表示にする</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token property-access">platform</span> <span class="token operator">===</span> <span class="token string">'darwin'</span><span class="token punctuation">)</span> electron<span class="token punctuation">.</span><span class="token property-access">app</span><span class="token punctuation">.</span><span class="token property-access">dock</span><span class="token punctuation">.</span><span class="token method function property-access">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ビルド後にパスが狂わないよう `__dirname` を使う</span>
  tray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">electron<span class="token punctuation">.</span>Tray</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/icon-16.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">platform</span> <span class="token operator">===</span> <span class="token string">'win32'</span> <span class="token operator">?</span> <span class="token string">'ico'</span> <span class="token operator">:</span> <span class="token string">'png'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tray<span class="token punctuation">.</span><span class="token method function property-access">setContextMenu</span><span class="token punctuation">(</span>electron<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Menu</span></span><span class="token punctuation">.</span><span class="token method function property-access">buildFromTemplate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        electron<span class="token punctuation">.</span><span class="token property-access">dialog</span><span class="token punctuation">.</span><span class="token method function property-access">showMessageBoxSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'Neo\'s Electron Tray App'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
          detail<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This Is Neo's Electron Tray App. [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">platform</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'separator'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'Exit'</span><span class="token punctuation">,</span>
      role<span class="token operator">:</span> <span class="token string">'quit'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>今回はアイコンを右クリックするとちょっとしたメニューが出てきて、選択するとアラートダイアログが表示されるだけの簡単なコードだ。</p>
<p>Electron は <code>process.platform</code> で OS を判断して条件分岐する箇所が多い。今回のような最小構成でも、Dock アイコンを非表示にする時と、トレイアイコンのファイルを指定する時に使用している。</p>
<h2 id="ビルドしてみる"><a class="header-link" href="#ビルドしてみる"><span class="header-link-mark"></span></a>ビルドしてみる</h2>
<p>とりあえず手元で動かしてみるだけなら、<code>$ npm start</code> で試せる。</p>
<p>Windows・Mac 向けの両方の形式でビルドするなら、<code>$ npm run build</code> を実行する。実行環境が Windows でも Mac でも問題ない。<code>.exe</code> と <code>.app</code> ファイルがちゃんと出来上がる。</p>
<p>ビルドした <code>.exe</code> や <code>.app</code> を実行すれば、タスクトレイやメニューバーにアイコンが追加され、動作していることが分かるだろう。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>Electron を使って、比較的簡単にマルチプラットフォーム対応なネイティブアプリが作れた。</p>
<p>OS 判定が点在しそうなので、いかに整理されたコードが書けるかがポイントになりそうだ。</p>
<ul>
  <li>参考：<a href="https://www.electronjs.org/docs/tutorial/quick-start">Quick Start Guide | Electron</a></li>
  <li>参考：<a href="https://www.electron.build/multi-platform-build">Multi Platform Build - electron-builder</a></li>
  <li>参考：<a href="https://qiita.com/narikei/items/aaee2c7e7e1a5ae61015">MacBook Proの充電器の情報をメニューバーに表示するElectronアプリをつくった - Qiita</a></li>
  <li>参考：<a href="https://qiita.com/hibara/items/4a3c26817e5449ebf722">Electron で Tray を使う（macOS, Windows） - Qiita</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-12-04</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-12-04</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
