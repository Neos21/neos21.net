<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>DeepFaceLab で DeepFake 動画を作ってみる - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2020/12/30-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2020/index.html">2020年</a></li>
            <li><a href="/blog/2020/12/index.html">12月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2020-12-30</time></div>
        <h1 id="page-title">DeepFaceLab で DeepFake 動画を作ってみる</h1>

<p>ディープフェイク動画が自分でも作れると聞いて、<strong>DeepFaceLab</strong> というツールを試してみた。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83">検証環境</a></li>
  <li><a href="#deepfacelab-%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B">DeepFaceLab をダウンロードする</a></li>
  <li><a href="#%E5%8B%95%E7%94%BB%E3%81%8B%E3%82%89%E9%9D%99%E6%AD%A2%E7%94%BB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%88%87%E3%82%8A%E5%87%BA%E3%81%99">動画から静止画ファイルに切り出す</a></li>
  <li><a href="#%E9%9D%99%E6%AD%A2%E7%94%BB%E3%81%8B%E3%82%89%E4%BA%BA%E3%81%AE%E9%A1%94%E3%82%92%E5%88%87%E3%82%8A%E5%87%BA%E3%81%99">静止画から人の顔を切り出す</a></li>
  <li><a href="#ai-%E3%82%92%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B">AI をトレーニングする</a></li>
  <li><a href="#%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E7%B5%90%E6%9E%9C%E3%82%92%E5%90%88%E6%88%90%E3%81%97%E3%81%A6%E5%8B%95%E7%94%BB%E3%82%92%E4%BD%9C%E3%82%8B">トレーニング結果を合成して動画を作る</a></li>
  <li><a href="#mp4-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E6%9B%B8%E3%81%8D%E5%87%BA%E3%81%97%E3%81%A6%E5%AE%8C%E6%88%90">MP4 ファイルに書き出して完成</a></li>
  <li><a href="#%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%92%E3%82%AD%E3%83%AC%E3%82%A4%E3%81%AB%E3%81%99%E3%82%8B">ワークスペースをキレイにする</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="検証環境"><a class="header-link" href="#検証環境"><span class="header-link-mark"></span></a>検証環境</h2>
<p>検証に使用したのは、自分のメインマシンである Galleria XG。</p>
<ul>
  <li>Core i7-7700K</li>
  <li>32GB RAM</li>
  <li>GTX 1080 (8GB)</li>
</ul>
<p>といったスペックのマシンである。GPU がそれなりに良いヤツなので、処理が速く進みそうで期待している。</p>
<h2 id="deepfacelab-をダウンロードする"><a class="header-link" href="#deepfacelab-をダウンロードする"><span class="header-link-mark"></span></a>DeepFaceLab をダウンロードする</h2>
<ul>
  <li><a href="https://github.com/iperov/DeepFaceLab">GitHub - iperov/DeepFaceLab: DeepFaceLab is the leading software for creating deepfakes.</a></li>
</ul>
<p>上の公式 GitHub より、以下の Magnet Link が紹介されている。コレを BitTorrent クライアントでダウンロードする。</p>
<ul>
  <li><a href="https://tinyurl.com/y6npm2su">https://tinyurl.com/y6npm2su</a>
    <ul>
      <li><code>DeepFaceLab_NVIDIA_build_08_02_2020.exe</code> が落とせた</li>
      <li>ファイルサイズは約 2.9GB</li>
    </ul>
  </li>
</ul>
<p><code>.exe</code> 形式なのでその場で解凍する。すると <code>DeepFaceLab_NVIDIA</code> というフォルダができる。配下のファイル・フォルダ構成は以下のとおり。</p>
<pre><code>DeepFaceLab_NVIDIA/
├ .bat ファイルがいっぱい
├ _internal/
│ └ 特に気にしなくて良い
└ workspace/
   ├ data_src.mp4
   ├ data_dst.mp4
   ├ data_src/
   │ └ aligned/
   │    └ 中身は空
   ├ data_dst/
   │ └ aligned/
   │    └ 中身は空
   └ model/
      └ 中身は空
</code></pre>
<p>この中で重要なのは <code>workspace/</code> フォルダ配下にあるサンプルの動画ファイル2つ。</p>
<p>サンプルで用意されている <em><code>data_src.mp4</code></em> は、映画「アイアンマン」からロバート・ダウニー・Jr. の動画 (1920x1080px)。<strong><code>data_dst.mp4</code></strong> は、イーロン・マスクの動画 (1280x720px) だ。</p>
<p><em><code>data_src.mp4</code></em> に映る人物の顔を、<strong><code>data_dst.mp4</code></strong> に合成することになる。つまり、イーロン・マスクの身体にロバート・ダウニー・Jr. の顔が合成された動画が生成されることになる。コレを任意の動画ファイルに差し替えれば好きな動画が作れるワケだが、ファイル名はこの規則を守っておく必要がある。今回はこのサンプル動画ファイルで試してみる。</p>
<h2 id="動画から静止画ファイルに切り出す"><a class="header-link" href="#動画から静止画ファイルに切り出す"><span class="header-link-mark"></span></a>動画から静止画ファイルに切り出す</h2>
<p>それでは早速ディープフェイク動画の作成に入ろう。多くのバッチファイルが手順に沿って用意されているので、基本はコレを叩いていくだけで良い。まずは動画ファイルから静止画ファイルを切り出すバッチを動かす。</p>
<ul>
  <li><code>2) extract images from video data_src.bat</code></li>
</ul>
<p>上のファイル名のバッチファイルを実行する。インタラクティブに質問されるが、<em>何も入力せず Enter で進めるだけで良い。</em></p>
<pre class="language-batch"><code class="language-batch">[0] Enter FPS <span class="token punctuation">(</span> ?:help <span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">0</span></span>
[png] Output image format <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">png</span><span class="token parameter attr-name">/jpg</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">png</span></span>

<span class="token comment">Rem …FFmpeg のコンソール出力。30秒くらい処理される…</span>

<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>すると、<code>workspace/data_src/</code> 配下に連番の PNG ファイルができる。アイアンマンの動画から画像ファイルが切り出された。</p>
<p>同様の処理をイーロン・マスクの動画でも行う。次は以下のバッチファイルを実行する。</p>
<ul>
  <li><code>3) extract images from video data_dst FULL FPS.bat</code></li>
</ul>
<pre class="language-batch"><code class="language-batch">[png] Output image format <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">png</span><span class="token parameter attr-name">/jpg</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">png</span></span>

<span class="token comment">Rem …FFmpeg のコンソール出力。1分くらい処理される…</span>

<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>今度は <code>workspace/data_dst/</code> 配下に連番の PNG ができた。</p>
<h2 id="静止画から人の顔を切り出す"><a class="header-link" href="#静止画から人の顔を切り出す"><span class="header-link-mark"></span></a>静止画から人の顔を切り出す</h2>
<p>以上のバッチは動画のコマを画像に切り出しただけ。次はこの画像ファイルから人の顔を自動的に特定してもらう。</p>
<ul>
  <li><code>4) data_src faceset extract.bat</code></li>
</ul>
<p>↑このバッチファイルを叩くと、アイアンマンの画像ファイルからロバート・ダウニー・Jr. の顔を切り出す。コレも Enter で進めていくだけで良い。デフォルトの選択肢が最適なモノになっている。</p>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Choose</span> one or several GPU idxs (separated by comma</span><span class="token punctuation">)</span>.

[CPU] : CPU
  [0] : GeForce GTX 1080

[0] Which GPU indexes to choose? :
<span class="token command"><span class="token keyword">0</span></span>

[wf] Face type <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">f</span>/wf<span class="token parameter attr-name">/head</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">wf</span></span>
[0] Max number of faces from image <span class="token punctuation">(</span> ?:help <span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">0</span></span>
[512] Image size <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">256</span><span class="token number">-2048</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">512</span></span>
[90] Jpeg quality <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">1</span><span class="token number">-100</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">90</span></span>
[n] Write debug images to aligned_debug? <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">y</span><span class="token parameter attr-name">/n</span> </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">n</span></span>
<span class="token command"><span class="token keyword">Extracting</span> faces...</span>
<span class="token command"><span class="token keyword">Caching</span> GPU kernels...</span>
<span class="token command"><span class="token keyword">Running</span> on GeForce GTX <span class="token number">1080</span></span>

<span class="token comment">Rem …処理開始。4分くらい処理される…</span>

<span class="token command"><span class="token keyword">100</span>%|#############################################################################| <span class="token number">655</span>/<span class="token number">655</span> [<span class="token number">03</span>:<span class="token number">53</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>,  <span class="token number">2</span>.81it/s]</span>
-------------------------
<span class="token command"><span class="token keyword">Images</span> found:        <span class="token number">655</span></span>
<span class="token command"><span class="token keyword">Faces</span> detected:      <span class="token number">654</span></span>
-------------------------
<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>4分ほどで処理が完了。<code>workspace/data_src/aligned/</code> 配下に連番の JPG ファイルができる。アイアンマンの動画から画像ファイルが切り出された。顔だけが切り出されている。</p>
<p>続いてイーロン・マスクの画像でも同様の作業を行う。</p>
<ul>
  <li><code>5) data_dst faceset extract.bat</code></li>
</ul>
<p>このバッチファイルを起動する。</p>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Choose</span> one or several GPU idxs (separated by comma</span><span class="token punctuation">)</span>.

[CPU] : CPU
  [0] : GeForce GTX 1080

[0] Which GPU indexes to choose? :
<span class="token command"><span class="token keyword">0</span></span>

[wf] Face type <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">f</span>/wf<span class="token parameter attr-name">/head</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">wf</span></span>
[512] Image size <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">256</span><span class="token number">-2048</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">512</span></span>
[90] Jpeg quality <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">1</span><span class="token number">-100</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">90</span></span>
<span class="token command"><span class="token keyword">Extracting</span> faces...</span>
<span class="token command"><span class="token keyword">Running</span> on GeForce GTX <span class="token number">1080</span></span>

<span class="token comment">Rem …10分くらい処理される…</span>

<span class="token command"><span class="token keyword">100</span>%|###########################################################################| <span class="token number">1619</span>/<span class="token number">1619</span> [<span class="token number">10</span>:<span class="token number">21</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>,  <span class="token number">2</span>.60it/s]</span>
-------------------------
<span class="token command"><span class="token keyword">Images</span> found:        <span class="token number">1619</span></span>
<span class="token command"><span class="token keyword">Faces</span> detected:      <span class="token number">1619</span></span>
-------------------------
<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>コマ数なのか、解像度なのか分からないが、適用先であるイーロン・マスクの動画の方が若干時間がかかった。</p>
<h2 id="ai-をトレーニングする"><a class="header-link" href="#ai-をトレーニングする"><span class="header-link-mark"></span></a>AI をトレーニングする</h2>
<p>下準備ができたので、いよいよ AI のトレーニングに入る。以下のバッチを起動しよう。</p>
<ul>
  <li><code>6) train Quick96.bat</code></li>
</ul>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Running</span> trainer.</span>

[new] No saved models found. Enter a name of a new model :
<span class="token command"><span class="token keyword">new</span></span>

<span class="token command"><span class="token keyword">Model</span> first run.</span>

<span class="token command"><span class="token keyword">Choose</span> one or several GPU idxs (separated by comma</span><span class="token punctuation">)</span>.

[CPU] : CPU
  [0] : GeForce GTX 1080

[0] Which GPU indexes to choose? :
<span class="token command"><span class="token keyword">0</span></span>

<span class="token command"><span class="token keyword">Initializing</span> models: <span class="token number">100</span>%|############################################################| <span class="token number">5</span>/<span class="token number">5</span> [<span class="token number">00</span>:<span class="token number">03</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>,  <span class="token number">1</span>.53it/s]</span>
<span class="token command"><span class="token keyword">Loading</span> samples: <span class="token number">100</span>%|###########################################################| <span class="token number">654</span>/<span class="token number">654</span> [<span class="token number">00</span>:<span class="token number">02</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>, <span class="token number">243</span>.64it/s]</span>
<span class="token command"><span class="token keyword">Loading</span> samples: <span class="token number">100</span>%|#########################################################| <span class="token number">1619</span>/<span class="token number">1619</span> [<span class="token number">00</span>:<span class="token number">06</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>, <span class="token number">259</span>.98it/s]</span>
============= Model Summary =============
==                                     ==
==        Model name: new_Quick96      ==
==                                     ==
== Current iteration: 0                ==
==                                     ==
==----------- Model Options -----------==
==                                     ==
==        batch_size: 4                ==
==                                     ==
==------------ Running On -------------==
==                                     ==
==      Device index: 0                ==
==              Name: GeForce GTX 1080 ==
==              VRAM: 8.00GB           ==
==                                     ==
=========================================
<span class="token command"><span class="token keyword">Starting</span>. Press <span class="token string">"Enter"</span> to stop training and save model.</span>

<span class="token command"><span class="token keyword">Trying</span> to do the first iteration. If an error occurs, reduce the model parameters.</span>

[17:12:02][#000002][0122ms][3.7310][3.1721]
[17:14:20][#001213][0107ms][0.7664][0.4422]
</code></pre>
<p>このようなコンソール出力まで辿り着くと、「Training Preview」という別ウィンドウが開き、AI トレーニングが開始される。コマンドプロンプトの窓は放置して、「Training Preview」ウィンドウをアクティブにして、<code>P</code> キーを押し続けてみよう。プレビューが更新され、トレーニング状況が分かる。</p>
<p>
  <img src="30-02-01.png" alt="トレーニング開始間もない">
</p>
<p>↑コレはトレーニング開始から1分後、500回ほどトレーニングしたところ。黄色と青のグラフが、学習の精度を表しているようだ。グラフが低い位置に達しているほど精度が上がっている。</p>
<p>5列×4行の顔面のサムネイルが見えているが、コレの一番右の列が、合成したところのプレビューだ。この右端の画像の出来栄えを見て、トレーニングを続けるか止めるか判断する。</p>
<p>
  <img src="30-02-02.png" alt="だいぶトレーニングした">
</p>
<p>↑コレはトレーニングを始めて10分ほど放置したところ。5,300回以上のイテレーションが行われており、先程のプレビューよりも輪郭のシャープさが上がっていることが分かるかと思う。</p>
<p>トレーニングを保存して終了するには、「Training Preview」ウィンドウで <code>Enter</code> を押下すれば良い。トレーニングは後で再開することもできる。</p>
<pre class="language-batch"><code class="language-batch"><span class="token comment">Rem … Enter でトレーニングを保存して終了する…</span>

<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>今回は10分強・約5,500回のイテレーションでトレーニングを終了させた。コレでどの程度のモノが出来上がるのだろうか…？</p>
<h2 id="トレーニング結果を合成して動画を作る"><a class="header-link" href="#トレーニング結果を合成して動画を作る"><span class="header-link-mark"></span></a>トレーニング結果を合成して動画を作る</h2>
<p>それでは、トレーニング結果を実際に反映して、動画を書き出してもらおう。</p>
<ul>
  <li><code>7) merge Quick96.bat</code></li>
</ul>
<p>↑このバッチファイルを実行する。</p>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Running</span> merger.</span>

<span class="token command"><span class="token keyword">Choose</span> one of saved models, or enter a name to create a new model.</span>
[r] : rename
[d] : delete

[0] : new - latest
 :
<span class="token command"><span class="token keyword">0</span></span>
<span class="token command"><span class="token keyword">Loading</span> new_Quick96 model...</span>

<span class="token command"><span class="token keyword">Choose</span> one or several GPU idxs (separated by comma</span><span class="token punctuation">)</span>.

[CPU] : CPU
  [0] : GeForce GTX 1080

[0] Which GPU indexes to choose? :
<span class="token command"><span class="token keyword">0</span></span>

<span class="token command"><span class="token keyword">Initializing</span> models: <span class="token number">100</span>%|############################################################| <span class="token number">4</span>/<span class="token number">4</span> [<span class="token number">00</span>:<span class="token number">00</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>,  <span class="token number">8</span>.62it/s]</span>
============= Model Summary =============
==                                     ==
==        Model name: new_Quick96      ==
==                                     ==
== Current iteration: 5490             ==
==                                     ==
==----------- Model Options -----------==
==                                     ==
==        batch_size: 4                ==
==                                     ==
==------------ Running On -------------==
==                                     ==
==      Device index: 0                ==
==              Name: GeForce GTX 1080 ==
==              VRAM: 8.00GB           ==
==                                     ==
=========================================
[y] Use interactive merger? <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">y</span><span class="token parameter attr-name">/n</span> </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">y</span></span>
[8] Number of workers? <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">1</span><span class="token number">-8</span> ?:help </span><span class="token punctuation">)</span> :
<span class="token command"><span class="token keyword">8</span></span>
<span class="token command"><span class="token keyword">Collecting</span> alignments: <span class="token number">100</span>%|###################################################| <span class="token number">1619</span>/<span class="token number">1619</span> [<span class="token number">00</span>:<span class="token number">03</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>, <span class="token number">538</span>.31it/s]</span>
<span class="token command"><span class="token keyword">Computing</span> motion vectors: <span class="token number">100</span>%|###############################################| <span class="token number">1619</span>/<span class="token number">1619</span> [<span class="token number">00</span>:<span class="token number">01</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>, <span class="token number">1474</span>.86it/s]</span>
<span class="token command"><span class="token keyword">Running</span> on CPU0.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU1.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU2.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU4.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU3.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU5.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU6.</span>
<span class="token command"><span class="token keyword">Running</span> on CPU7.</span>
<span class="token command"><span class="token keyword">Merging</span>:   <span class="token number">0</span>%|                                                                             | <span class="token number">0</span>/<span class="token number">1619</span> [<span class="token number">00</span>:<span class="token number">00</span>&#x3C;?, ?it/s]</span>

<span class="token command"><span class="token keyword">MergerConfig</span> <span class="token number">00001</span>.png:</span>
<span class="token command"><span class="token keyword">Mode</span>: overlay</span>
<span class="token command"><span class="token keyword">mask_mode</span>: learned-prd*learned-dst</span>
<span class="token command"><span class="token keyword">erode_mask_modifier</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">blur_mask_modifier</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">motion_blur_power</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">output_face_scale</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">color_transfer_mode</span>: rct</span>
<span class="token command"><span class="token keyword">sharpen_mode</span> : None</span>
<span class="token command"><span class="token keyword">blursharpen_amount</span> : <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">super_resolution_power</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">image_denoise_power</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">bicubic_degrade_power</span>: <span class="token number">0</span></span>
<span class="token command"><span class="token keyword">color_degrade_power</span>: <span class="token number">0</span></span>
================
</code></pre>
<p>このようなコンソール出力まで辿り着くと、<em>「Merger」</em>という別ウィンドウが立ち上がる。合成の塩梅を手動で調整するためのツールだ。</p>
<p>
  <img src="30-02-03.png" alt="合成ツール">
</p>
<p>キーボードで操作していくので、操作方法を確認する。恐らく US 配列前提で書かれているので、JIS 配列の人は適宜キーを読み替えること。</p>
<p>まずは <code>Tab</code> キーを押下すると、プレビュー画面が表示される。以降はコマンドプロンプトの出力も参考に、パラメータを調整していく。</p>
<p>
  <img src="30-02-04.png" alt="デフォルトだと顔が浮いている">
</p>
<p>↑デフォルトの1コマ目。まだ顔が「浮いて」しまっている。</p>
<p>このプレビューの状態で、<em><code>W</code> か <code>S</code></em> を押下していく。するとコマンドプロンプトでは <code>erode_mask_modifier:</code> の値が変わるはずだ。コレで合成する輪郭の度合いを調整する。大体 <code>20</code> くらいにすると良いだろう。</p>
<p>次に、<strong><code>E</code> か <code>D</code></strong> キーを押下していく。今度は <code>blur_mask_modifier:</code> の値が変わる。輪郭をどの程度ボカすかの値なのだが、コレは <code>100</code> くらいにすると自然に馴染む。</p>
<p>この辺は様子を見ながら自分の塩梅で調整していけば良い。他のキーも試してみよう。</p>
<p>
  <img src="30-02-05.png" alt="お好みで調整していく">
</p>
<p>次のコマを確認する場合は <code>.</code> (<code>></code>) キーを押下する。以降のコマ全てに同じ設定を適用するなら、<code>Shift + . (>)</code> キーを押す。</p>
<pre class="language-batch"><code class="language-batch"><span class="token comment">Rem …「Shift + .」キーでボカし度合いなどを後続の全フレームに反映する…</span>

================
<span class="token command"><span class="token keyword">Merging</span>: <span class="token number">100</span>%|##################################################################| <span class="token number">1619</span>/<span class="token number">1619</span> [<span class="token number">04</span>:<span class="token number">45</span>&#x3C;<span class="token number">00</span>:<span class="token number">00</span>,  <span class="token number">5</span>.67it/s]</span>

<span class="token comment">Rem …5分弱で全処理が終わった…</span>
</code></pre>
<p>このバッチだけ、最後に何も表示されないが、<code>Merging: 100%</code> まで行ったら、「Merger」ウィンドウとこのコマンドプロンプトを閉じて良い。</p>
<h2 id="mp4-ファイルに書き出して完成"><a class="header-link" href="#mp4-ファイルに書き出して完成"><span class="header-link-mark"></span></a>MP4 ファイルに書き出して完成</h2>
<p>コレで合成作業は完了。<code>data_dst/</code> フォルダの配下に、<code>aligned_debug/</code>・<code>merged/</code>・<code>merged_mask/</code> フォルダができている。</p>
<p>見てみると分かるが、合成済みのコマ画像が大量にできていたり、マスクの白黒画像が出力されていたりする。<code>merged_mask</code> は、動画編集ソフトで細かい調整を行う時なんかに使えるだろう。</p>
<p>あとはこのコマ画像を MP4 動画に書き出してもらおう。以下のバッチファイルを起動する。</p>
<ul>
  <li><code>8) merged to mp4.bat</code></li>
</ul>
<p>コレも Enter 押下で進めていけば良い。</p>
<pre class="language-batch"><code class="language-batch">[16] Bitrate of output file in MB/s :
<span class="token command"><span class="token keyword">16</span></span>
<span class="token command"><span class="token keyword">ffmpeg</span> version <span class="token number">4</span>.<span class="token number">2</span>.<span class="token number">1</span> Copyright (c</span><span class="token punctuation">)</span> 2000-2019 the FFmpeg developers

<span class="token command"><span class="token keyword">Done</span>.</span>
続行するには何かキーを押してください . . .
</code></pre>
<p>数分で動画の書き出しが終わった。<code>workspace/result.mp4</code> が合成されたファイルだ。<code>result_mask.mp4</code> はマスクの動画。</p>
<p>出来上がった動画の1コマをスクショしてみたのが以下。</p>
<p>
  <img src="30-02-06.jpg" alt="出来上がり">
</p>
<p>うーん、どうだろう。輪郭がボケていて、いかにも「ディープフェイク動画を素人が作りました」感がある…。</p>
<p>ただ、<strong>この程度の品質であれば、初見の人間が1時間ちょうどで作成できる</strong>ことが証明できた。</p>
<h2 id="ワークスペースをキレイにする"><a class="header-link" href="#ワークスペースをキレイにする"><span class="header-link-mark"></span></a>ワークスペースをキレイにする</h2>
<ul>
  <li><code>1) clear workspace.bat</code></li>
</ul>
<p>というバッチファイルを起動して、<em>Space キー</em> を押下すると、<code>workspace/</code> フォルダ配下のファイルが削除される。別の動画を作る時はコレでワークスペースをキレイにしてやると良いだろう。</p>
<p><code>data_src.mp4</code>・<code>data_dst.mp4</code>・<code>result.mp4</code>・<code>result_mask.mp4</code> の動画ファイルだけは残されるので、適宜移動する。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>マグネットリンクで DeepFaceLab のファイルをダウンロードし始めてから、最終的な動画ファイルを書き出したところまでで、ちょうど1時間で検証できた。</p>
<p>より品質をあげようと思うと、ソースとする動画の品質や量だったり、適用先の動画が合成しやすいシンプルなモノだったり、といった素材のチョイスが問われそうだ。そして当然、トレーニング量をもっと増やしてやらないといけないし、今回使用しなかったその他のバッチファイル等を駆使して、パラメータチューニングをしていかないと高画質な動画は作れないだろう。</p>
<ul>
  <li>参考：<a href="https://seesaawiki.jp/dfl/d/DFL%20train%C6%FE%CE%CF%C0%DF%C4%EA">DFL train入力設定 - 顔入替ソフト使用例</a>
    <ul>
      <li>トレーニングのノウハウなど</li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>通常、120k回の反復で明確になります</p>
</blockquote>
<p>と記載があり、反復を<em>12万回</em>くらいやらないとシャープにならないようだ。GTX1080 では1分間に大体500回反復できたので、12万回というと4時間くらいか。4時間くらいトレーニングをブン回せば多少は画質が上がるんだろうか…。大変だ…。</p>
<p>自動で任せられるところが多いので簡単に始められる一方、高品質なモノを作り出すには、やはり AI を<strong>使いこなす人間側のスキル</strong>が必要になる。AI をコントロールできる人間でいたい…。</p>
<ul>
  <li>参考：<a href="https://topten.ai/ja/how-to-make-deepfake-videos-with-deepfacelab-ja/">DeepFaceLabでDeepfake動画を作る方法｜2020最新 - TopTen.ai</a></li>
  <li>参考：<a href="https://mmm-ssss.com/2020/04/14/deepfacelab2-0%E3%81%AEinstall-%E4%BD%BF%E3%81%84%E6%96%B9%E3%83%95%E3%82%A7%E3%82%A4%E3%82%AF%E5%8B%95%E7%94%BB%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B/">DeepFaceLab 2.0のインストール/使い方【フェイク動画をつくる】 | 趣味ブログ</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2020-12-30</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2020-12-30</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
