<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>遅ればせながら Stable Diffusion を触ってみました・コピペで動かせるコマンド・コード紹介 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2023/02/27-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2023/index.html">2023年</a></li>
            <li><a href="/blog/2023/02/index.html">02月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2023-02-27</time></div>
        <h1 id="page-title">遅ればせながら Stable Diffusion を触ってみました・コピペで動かせるコマンド・コード紹介</h1>

<p>プロンプト (呪文) テキストを入力すると画像を生成してくれる AI、<strong>Stable Diffusion</strong>。セットアップすればローカルマシン上でも動かせるのが特徴なので、今回は自分のマシンで Stable Diffusion による画像生成までを試してみた。<strong>今回紹介するコマンド・コードをコピペして真似していけばアナタのマシンでも Stable Diffusion が動かせるヨ！</strong></p><div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/B0BJTVNYNR?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51GUPZw6JbL._SL160_.jpg" width="113" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/B0BJTVNYNR?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">AIとコラボして神絵師になる　論文から読み解くStable Diffusion (技術の泉シリーズ（NextPublishing）)</a>
    </div>
  </div>
</div>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li>
    <ul>
      <li><a href="#pc-%E7%92%B0%E5%A2%83">PC 環境</a></li>
      <li><a href="#python-39-%E7%B3%BB%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">Python 3.9 系をインストールする</a></li>
      <li><a href="#%E4%B8%80%E5%BF%9C-pyenv-win-%E3%82%92%E5%85%A5%E3%82%8C%E3%81%A6%E3%81%8A%E3%81%8F">一応 pyenv-win を入れておく</a></li>
      <li><a href="#cuda-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">CUDA をインストールする</a></li>
    </ul>
  </li>
  <li><a href="#pytorch-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">PyTorch をインストールする</a>
    <ul>
      <li><a href="#transformers-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">Transformers をインストールする</a></li>
      <li><a href="#diffusers-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">Diffusers をインストールする</a></li>
      <li><a href="#accelerate-%E3%82%92%E5%85%A5%E3%82%8C%E3%82%8B%E3%81%A8%E8%89%AF%E3%81%84%E3%82%88%E3%81%A8%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%8C%E5%87%BA%E3%81%A6%E3%81%8D%E3%81%9F%E3%81%AE%E3%81%A7%E5%85%A5%E3%82%8C%E3%82%8B">Accelerate を入れると良いよとメッセージが出てきたので入れる</a></li>
      <li><a href="#hugging-face-%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%A6-api-key-%E3%82%92%E7%99%BA%E8%A1%8C%E3%81%99%E3%82%8B">Hugging Face に登録して API Key を発行する</a></li>
      <li><a href="#waifu-diffusion-%E3%82%82%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">Waifu Diffusion も試してみる</a></li>
      <li><a href="#%E4%BB%8A%E5%9B%9E%E3%81%AF%E3%82%B3%E3%82%B3%E3%81%BE%E3%81%A7">今回はココまで！</a></li>
    </ul>
  </li>
</ul>
<h2 id="pc-環境"><a class="header-link" href="#pc-環境"><span class="header-link-mark"></span></a>PC 環境</h2>
<p>今回検証した PC 環境は次のとおり。</p>
<ul>
  <li>OS : Windows 10</li>
  <li>CPU : Intel Core i7-7700K</li>
  <li>GPU : NVIDIA GeForce GTX1080</li>
</ul>
<p>GTX1080 搭載の PC で、GPU を使って画像生成する。結果的に、1枚の画像は2分程度で生成できた。</p>
<h2 id="python-39-系をインストールする"><a class="header-link" href="#python-39-系をインストールする"><span class="header-link-mark"></span></a>Python 3.9 系をインストールする</h2>
<p>今回は <em>WSL を使わず</em>、Windows 環境の PowerShell を使って、直接 Python をインストールしていくことにする。</p>
<p>Stable Diffusion を動作させるにあたって、<em>PyTorch</em> という機械学習ライブラリをインストールする必要がある。コレは Facebook が開発しているモノらしいが、動作する Python のバージョンが v3.9 系までで、v3.10 や v3.11 系ではうまくインストールができなかった。</p>
<p>自分の環境では Microsoft Store でインストールした v3.10 と v3.11 が微妙に併存していたので、一旦全部アンインストールし、Python.org から v3.9.13 をダウンロードしてインストールした。</p>
<ul>
  <li>参考 : <a href="https://self-development.info/pytorch%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AB%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%81%B9/">PyTorchのインストール失敗時にチェックすべきこと | ジコログ</a></li>
</ul>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Python v3.11 で PyTorch をインストールしようとすると次のようなエラーが出る</span>
<span class="token function">PS</span>> pip install torch torchvision torchaudio <span class="token operator">--</span>extra<span class="token operator">-</span>index<span class="token operator">-</span>url https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>pytorch<span class="token punctuation">.</span>org<span class="token operator">/</span>whl<span class="token operator">/</span>cu117
Looking in indexes: https:<span class="token operator">/</span><span class="token operator">/</span>pypi<span class="token punctuation">.</span>org<span class="token operator">/</span>simple<span class="token punctuation">,</span> https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>pytorch<span class="token punctuation">.</span>org<span class="token operator">/</span>whl<span class="token operator">/</span>cu117
ERROR: Could not find a version that satisfies the requirement torch <span class="token punctuation">(</span><span class="token keyword">from</span> versions: none<span class="token punctuation">)</span>
ERROR: No matching distribution found <span class="token keyword">for</span> torch
</code></pre>
<ul>
  <li>参考 : <a href="https://www.python.org/downloads/release/python-3913/">Python Release Python 3.9.13 | Python.org</a>
    <ul>
      <li><code>python-3.9.13-amd64.exe</code> をダウンロードしインストールする</li>
    </ul>
  </li>
</ul>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token operator">-</span>V
Python 3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>13

> pip list
Package    Version
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span> <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>
pip        22<span class="token punctuation">.</span>0<span class="token punctuation">.</span>4
setuptools 58<span class="token punctuation">.</span>1<span class="token punctuation">.</span>0

<span class="token comment"># pip を最新版にアップグレードする</span>
> python <span class="token operator">-</span>m pip install <span class="token operator">--</span>upgrade pip setuptools
</code></pre>
<p>ココまで準備できたら Python 本体の準備は完了。</p>
<h2 id="一応-pyenv-win-を入れておく"><a class="header-link" href="#一応-pyenv-win-を入れておく"><span class="header-link-mark"></span></a>一応 pyenv-win を入れておく</h2>
<p>ホスト環境に直接 Python 3.9.13 をインストールしたので、今後 Python のバージョンを切り替えたりできるように、<code>pyenv-win</code> をインストールして、同じ v3.9.13 を使用する設定にしておく。</p>
<ul>
  <li>参考 : <a href="https://www.3ryu-engineer.work/windows-pyenv/">★2022年最新★入門！Windowsでpyenvを使う方法 - ３流なSEのメモ帳</a></li>
</ul>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment"># pyenv-win をインストールする</span>
> pip install pyenv<span class="token operator">-</span>win <span class="token operator">--</span>target <span class="token punctuation">.</span>pyenv
<span class="token comment"># `~/.pyenv/` (`C:\Users\【ユーザ名】\.pyenv\`) フォルダにインストールされる</span>
</code></pre>
<p>「システム環境変数」に <code>PYENV</code> を設定し、<code>PATH</code> を通す。</p>
<ul>
  <li><code>PYENV</code> : <code>C:\Users\【ユーザ名】\.pyenv\pyenv-win</code></li>
  <li><code>PATH</code> : <code>%PYENV%\bin</code> を最優先にしておく</li>
</ul>
<p>再起動後、以下のように <code>pyenv</code> コマンドが動作したらグローバルに v3.9.13 を設定しておく。</p>
<pre class="language-powershell"><code class="language-powershell">> pyenv <span class="token operator">--</span>version
pyenv 3<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1

> pyenv install 3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>13
> pyenv versions
> pyenv global 3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>13
</code></pre>
<h2 id="cuda-をインストールする"><a class="header-link" href="#cuda-をインストールする"><span class="header-link-mark"></span></a>CUDA をインストールする</h2>
<p>PyTorch ライブラリが GPU を利用できるようにするため、NVIDIA の CUDA というツールキットをインストールしておく。</p>
<ul>
  <li>参考 : <a href="https://self-development.info/tensorflow-1%e7%b3%bbgpu%e7%89%88%e3%81%ae%e3%81%9f%e3%82%81%e3%81%abcuda-10-0%e3%82%92%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/">TensorFlow 1系(GPU版)のためにCUDA 10.0をインストール | ジコログ</a></li>
  <li><a href="https://developer.nvidia.com/cuda-toolkit-archive">CUDA Toolkit Archive | NVIDIA Developer</a>
    <ul>
      <li>CUDA Toolkit 11.7.0 : <code>cuda_11.7.0_516.01_windows.exe</code> をダウンロード、インストールする</li>
    </ul>
  </li>
</ul>
<p>インストール後、環境変数 <code>CUDA_PATH</code> が設定されていることを確認したら、PowerShell で <code>nvcc</code> コマンドを使ってインストールが成功していることを確認する。</p>
<pre class="language-powershell"><code class="language-powershell">> nvcc <span class="token operator">-</span>V
nvcc: NVIDIA <span class="token punctuation">(</span>R<span class="token punctuation">)</span> Cuda compiler driver
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2005<span class="token operator">-</span>2022 NVIDIA Corporation
Built on Tue_May__3_19:00:59_Pacific_Daylight_Time_2022
Cuda compilation tools<span class="token punctuation">,</span> release 11<span class="token punctuation">.</span>7<span class="token punctuation">,</span> V11<span class="token punctuation">.</span>7<span class="token punctuation">.</span>64
Build cuda_11<span class="token punctuation">.</span>7<span class="token punctuation">.</span>r11<span class="token punctuation">.</span>7<span class="token operator">/</span>compiler<span class="token punctuation">.</span>31294372_0
</code></pre>
<h1 id="pytorch-をインストールする"><a class="header-link" href="#pytorch-をインストールする"><span class="header-link-mark"></span></a>PyTorch をインストールする</h1>
<p>Python 本体・pyenv-win・CUDA のインストールが終わったので、ようやく PyTorch をインストールできる。</p>
<ul>
  <li>参考 : <a href="https://self-development.info/%e3%80%90windows%e3%80%91gpu%e7%89%88pytorch-1-12%e7%b3%bb%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/">【Windows】GPU版PyTorch 1.12系のインストール | ジコログ</a></li>
  <li>参考 : <a href="https://pytorch.org/get-started/locally/">Start Locally | PyTorch</a>
    <ul>
      <li>このサイトでインストールコマンドを組み立てられる</li>
    </ul>
  </li>
</ul>
<pre class="language-powershell"><code class="language-powershell">> pip install torch torchvision torchaudio <span class="token operator">--</span>extra<span class="token operator">-</span>index<span class="token operator">-</span>url https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>pytorch<span class="token punctuation">.</span>org<span class="token operator">/</span>whl<span class="token operator">/</span>cu117
Installing collected packages: charset<span class="token operator">-</span>normalizer<span class="token punctuation">,</span> urllib3<span class="token punctuation">,</span> typing<span class="token operator">-</span>extensions<span class="token punctuation">,</span> pillow<span class="token punctuation">,</span> numpy<span class="token punctuation">,</span> idna<span class="token punctuation">,</span> certifi<span class="token punctuation">,</span> torch<span class="token punctuation">,</span> requests<span class="token punctuation">,</span> torchvision<span class="token punctuation">,</span> torchaudio
Successfully installed certifi<span class="token operator">-</span>2022<span class="token punctuation">.</span>12<span class="token punctuation">.</span>7 charset<span class="token operator">-</span>normalizer<span class="token operator">-</span>3<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 idna<span class="token operator">-</span>3<span class="token punctuation">.</span>4 numpy<span class="token operator">-</span>1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>2 pillow<span class="token operator">-</span>9<span class="token punctuation">.</span>4<span class="token punctuation">.</span>0 requests<span class="token operator">-</span>2<span class="token punctuation">.</span>28<span class="token punctuation">.</span>2 torch<span class="token operator">-</span>1<span class="token punctuation">.</span>13<span class="token punctuation">.</span>1<span class="token operator">+</span>cu117 torchaudio<span class="token operator">-</span>0<span class="token punctuation">.</span>13<span class="token punctuation">.</span>1<span class="token operator">+</span>cu117 torchvision<span class="token operator">-</span>0<span class="token punctuation">.</span>14<span class="token punctuation">.</span>1<span class="token operator">+</span>cu117 typing<span class="token operator">-</span>extensions<span class="token operator">-</span>4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0 urllib3<span class="token operator">-</span>1<span class="token punctuation">.</span>26<span class="token punctuation">.</span>14
</code></pre>
<p>PyTorch の動作確認用に、次のような Python スクリプトを書いてみる。</p>
<ul>
  <li><code>check-pytorch.py</code></li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>PowerShell で実行してみる。</p>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token punctuation">.</span>\check<span class="token operator">-</span>pytorch<span class="token punctuation">.</span>py
1<span class="token punctuation">.</span>13<span class="token punctuation">.</span>1<span class="token operator">+</span>cu117
True
</code></pre>
<p>このように表示されたら、PyTorch がインストールされており、GPU を利用できる (<code>True</code>) 状態と分かる。</p>
<h2 id="transformers-をインストールする"><a class="header-link" href="#transformers-をインストールする"><span class="header-link-mark"></span></a>Transformers をインストールする</h2>
<p>Stable Diffusion は、Hugging Face が開発する自然言語処理ライブラリの <em>Transformers</em> も使用するので、コイツもインストールしておく。</p>
<ul>
  <li>参考 : <a href="https://self-development.info/huggingface%e3%81%aetransformers%e3%82%92%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab%e3%81%99%e3%82%8b/">HuggingfaceのTransformersをインストールする | ジコログ</a></li>
</ul>
<pre class="language-powershell"><code class="language-powershell">> pip install transformers
Installing collected packages: tokenizers<span class="token punctuation">,</span> regex<span class="token punctuation">,</span> pyyaml<span class="token punctuation">,</span> packaging<span class="token punctuation">,</span> filelock<span class="token punctuation">,</span> colorama<span class="token punctuation">,</span> tqdm<span class="token punctuation">,</span> huggingface<span class="token operator">-</span>hub<span class="token punctuation">,</span> transformers
Successfully installed colorama<span class="token operator">-</span>0<span class="token punctuation">.</span>4<span class="token punctuation">.</span>6 filelock<span class="token operator">-</span>3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>0 huggingface<span class="token operator">-</span>hub<span class="token operator">-</span>0<span class="token punctuation">.</span>12<span class="token punctuation">.</span>1 packaging<span class="token operator">-</span>23<span class="token punctuation">.</span>0 pyyaml<span class="token operator">-</span>6<span class="token punctuation">.</span>0 regex<span class="token operator">-</span>2022<span class="token punctuation">.</span>10<span class="token punctuation">.</span>31 tokenizers<span class="token operator">-</span>0<span class="token punctuation">.</span>13<span class="token punctuation">.</span>2 tqdm<span class="token operator">-</span>4<span class="token punctuation">.</span>64<span class="token punctuation">.</span>1 transformers<span class="token operator">-</span>4<span class="token punctuation">.</span>26<span class="token punctuation">.</span>1
</code></pre>
<p>コチラも Transformers の動作確認スクリプトを作って確認してやろう。</p>
<ul>
  <li><code>check-transformers.py</code></li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline
classifier <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">'sentiment-analysis'</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> classifier<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"We are very happy to show you the 🤗 Transformers library."</span><span class="token punctuation">,</span> <span class="token string">"We hope you don't hate it."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"label: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, with score: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
<p>次のように実行してやると、感情分析がされていることが分かる。</p>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token punctuation">.</span>\check<span class="token operator">-</span>transformers<span class="token punctuation">.</span>py
No model was supplied<span class="token punctuation">,</span> defaulted to distilbert<span class="token operator">-</span>base<span class="token operator">-</span>uncased<span class="token operator">-</span>finetuned<span class="token operator">-</span>sst<span class="token operator">-</span>2<span class="token operator">-</span>english and revision af0f99b <span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>huggingface<span class="token punctuation">.</span>co<span class="token operator">/</span>distilbert<span class="token operator">-</span>base<span class="token operator">-</span>uncased<span class="token operator">-</span>finetuned<span class="token operator">-</span>sst<span class="token operator">-</span>2<span class="token operator">-</span>english<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token keyword">Using</span> a pipeline without specifying a model name and revision in production is not recommended<span class="token punctuation">.</span>
label: POSITIVE<span class="token punctuation">,</span> with score: 0<span class="token punctuation">.</span>9998
label: NEGATIVE<span class="token punctuation">,</span> with score: 0<span class="token punctuation">.</span>5309
</code></pre>
<h2 id="diffusers-をインストールする"><a class="header-link" href="#diffusers-をインストールする"><span class="header-link-mark"></span></a>Diffusers をインストールする</h2>
<p>Stable Diffusion を素のまま使おうとすると、インストールが色々と手間取るので、実行時に必要に応じてモデルをダウンロードしたりしてくれる <strong>Diffusers</strong> というツールをインストールする。</p>
<ul>
  <li>参考 : <a href="https://self-development.info/%e6%9c%80%e5%85%88%e7%ab%af%e3%81%ae%e6%a9%9f%e6%a2%b0%e5%ad%a6%e7%bf%92%e3%83%a2%e3%83%87%e3%83%ab%e3%82%92%e5%88%a9%e7%94%a8%e3%81%a7%e3%81%8d%e3%82%8bdiffusers%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9/">最先端の機械学習モデルを利用できるDiffusersのインストール | ジコログ</a></li>
</ul>
<pre class="language-powershell"><code class="language-powershell">> pip install diffusers
Installing collected packages: zipp<span class="token punctuation">,</span> importlib<span class="token operator">-</span>metadata<span class="token punctuation">,</span> diffusers
Successfully installed diffusers<span class="token operator">-</span>0<span class="token punctuation">.</span>13<span class="token punctuation">.</span>1 importlib<span class="token operator">-</span>metadata<span class="token operator">-</span>6<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 zipp<span class="token operator">-</span>3<span class="token punctuation">.</span>14<span class="token punctuation">.</span>0
</code></pre>
<p>コチラも Diffusers の動作確認スクリプトを書いてみる。後述するが<strong>現在のバージョンでは <code>["sample"]</code> 部分を <code>["images"]</code> と修正しないと正常に動作しない。</strong></p>
<ul>
  <li><code>check-diffusers.py</code></li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> diffusers <span class="token keyword">import</span> DiffusionPipeline
model_id <span class="token operator">=</span> <span class="token string">"CompVis/ldm-text2im-large-256"</span>
<span class="token comment"># load model and scheduler</span>
ldm <span class="token operator">=</span> DiffusionPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_id<span class="token punctuation">)</span>
<span class="token comment"># run pipeline in inference (sample random noise and denoise)</span>
prompt <span class="token operator">=</span> <span class="token string">"A painting of a squirrel eating a burger"</span>
images <span class="token operator">=</span> ldm<span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> eta<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> guidance_scale<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"sample"</span><span class="token punctuation">]</span>  <span class="token comment"># ← `["images"]` としないといけない</span>
<span class="token comment"># save images</span>
<span class="token keyword">for</span> idx<span class="token punctuation">,</span> image <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">:</span>
  image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"squirrel-</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span>
</code></pre>
<p>実行してみると次のようなエラーが出た。</p>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token punctuation">.</span>\check<span class="token operator">-</span>diffusers<span class="token punctuation">.</span>py
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"C:\Dev\practice-stable-diffusion\check-diffusers.py"</span><span class="token punctuation">,</span> line 7<span class="token punctuation">,</span> in &#x3C;module>
    images = ldm<span class="token punctuation">(</span><span class="token namespace">[prompt]</span><span class="token punctuation">,</span> num_inference_steps=50<span class="token punctuation">,</span> eta=0<span class="token punctuation">.</span>3<span class="token punctuation">,</span> guidance_scale=6<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"sample"</span><span class="token punctuation">]</span>
  File <span class="token string">"C:\Users\Neo\AppData\Local\Programs\Python\Python39\lib\site-packages\diffusers\utils\outputs.py"</span><span class="token punctuation">,</span> line 88<span class="token punctuation">,</span> in __getitem__
    <span class="token keyword">return</span> inner_dict<span class="token namespace">[k]</span>
KeyError: <span class="token string">'sample'</span>
</code></pre>
<ul>
  <li>参考 : <a href="https://qiita.com/cress_cc/items/6012ecfabb33411a3d9b#keyerror-sample">Waifu DiffusionのOpen in Colabが動かない場合の対処方法 - Qiita</a></li>
</ul>
<p>どうもバージョンアップにより、<code>["sample"]</code> 部分が <code>["images"]</code> に変更されているらしいので、修正するとうまく動いてくれた。</p>
<h2 id="accelerate-を入れると良いよとメッセージが出てきたので入れる"><a class="header-link" href="#accelerate-を入れると良いよとメッセージが出てきたので入れる"><span class="header-link-mark"></span></a>Accelerate を入れると良いよとメッセージが出てきたので入れる</h2>
<p>先程の <code>check-diffusers.py</code> を実行したときに、<code>pip install accelerate</code> しろというようなメッセージが出てきていたので入れておく。PyTorch を CPU・GPU をまたいで色々な環境でうまく動かすためのライブラリらしい。</p>
<pre class="language-powershell"><code class="language-powershell">> pip install accelerate
Installing collected packages: psutil<span class="token punctuation">,</span> accelerate
Successfully installed accelerate<span class="token operator">-</span>0<span class="token punctuation">.</span>16<span class="token punctuation">.</span>0 psutil<span class="token operator">-</span>5<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
</code></pre>
<ul>
  <li>参考 : <a href="https://self-development.info/%E3%80%90pytorch%E3%80%91accelerate%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%A8%E8%A8%AD%E5%AE%9A/">【PyTorch】Accelerateのインストールと設定 | ジコログ</a></li>
</ul>
<h2 id="hugging-face-に登録して-api-key-を発行する"><a class="header-link" href="#hugging-face-に登録して-api-key-を発行する"><span class="header-link-mark"></span></a>Hugging Face に登録して API Key を発行する</h2>
<p>Stable Diffusion のモデルは Hugging Face というサイトが公開しており、モデルの利用には API Key の発行が必要になる。</p>
<ul>
  <li>参考 : <a href="https://huggingface.co/CompVis/stable-diffusion-v1-4">CompVis/stable-diffusion-v1-4 · Hugging Face</a>
    <ul>
      <li>モデルのページ</li>
    </ul>
  </li>
  <li>参考 : <a href="https://huggingface.co/join">Hugging Face – The AI community building the future.</a>
    <ul>
      <li>Hugging Face の登録ページ。登録してログインする</li>
    </ul>
  </li>
  <li><a href="https://huggingface.co/settings/tokens">Hugging Face – The AI community building the future.</a>
    <ul>
      <li>ログイン後、画面右上のユーザアイコン → Settings → Access Token と進み、<em>Read 権限の API Key を発行する</em></li>
    </ul>
  </li>
</ul>
<p>今回はついでに、*NSFW フィルターを回避するコードを混ぜ込んで、Stable Diffusion を動かしてみる。</p>
<ul>
  <li><code>check-stable-diffusion.py</code></li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> diffusers <span class="token keyword">import</span> StableDiffusionPipeline
<span class="token keyword">from</span> torch <span class="token keyword">import</span> autocast

prompt <span class="token operator">=</span> <span class="token string">"a cat"</span>  <span class="token comment"># ココにプロンプトを入れる</span>
YOUR_TOKEN <span class="token operator">=</span> <span class="token string">"【Hugging Face の API Key】"</span>
MODEL_ID <span class="token operator">=</span> <span class="token string">"CompVis/stable-diffusion-v1-4"</span>
DEVICE <span class="token operator">=</span> <span class="token string">"cuda"</span>

pipe <span class="token operator">=</span> StableDiffusionPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>MODEL_ID<span class="token punctuation">,</span> revision<span class="token operator">=</span><span class="token string">"fp16"</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">,</span> use_auth_token<span class="token operator">=</span>YOUR_TOKEN<span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>

<span class="token comment"># Avoid Safety Checker : Start</span>
<span class="token keyword">def</span> <span class="token function">null_safety</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> images<span class="token punctuation">,</span> <span class="token boolean">False</span>
pipe<span class="token punctuation">.</span>safety_checker <span class="token operator">=</span> null_safety
<span class="token comment"># Avoid Safety Checker : End</span>

<span class="token keyword">with</span> autocast<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span><span class="token punctuation">:</span>
  image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> guidance_scale<span class="token operator">=</span><span class="token number">7.5</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"images"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"test.png"</span><span class="token punctuation">)</span>
</code></pre>
<p><code>pipe.safety_checker</code> を誤魔化すことで、Stable Diffusion の NSFW フィルターを回避できる。決してイヤらしい目的ではなくて、誤解釈されて画像生成がうまくされないことを回避するために入れている。ｗ</p>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token punctuation">.</span>\check<span class="token operator">-</span>stable<span class="token operator">-</span>diffusion<span class="token punctuation">.</span>py
</code></pre>
<p>初回はモデルのダウンロードが発生するが、2回目以降は省略される。1枚の画像は2・3分程度で生成される。出力された <code>test.png</code> を見てみよう。</p>
<p><strong>コレで Stable Diffusion をローカルマシンで動かせるようになった。あとはプロンプトを色々と変更してみて、好きな画像を生成してみよう。</strong></p>
<ul>
  <li>参考 : <a href="https://self-development.info/%e3%80%90%e7%b0%a1%e5%8d%98%e3%80%91%e3%83%ad%e3%83%bc%e3%82%ab%e3%83%ab%e7%92%b0%e5%a2%83%e3%81%a7stable-diffusion%e3%81%a7%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e6%96%b9%e6%b3%95/">【簡単】ローカル環境でStable Diffusionを実行する方法 | ジコログ</a></li>
  <li>参考 : <a href="https://self-development.info/stable-diffusion%e3%81%a7nsfw%e3%83%95%e3%82%a3%e3%83%ab%e3%82%bf%e3%83%bc%e3%82%92%e3%82%b9%e3%83%9e%e3%83%bc%e3%83%88%e3%81%ab%e5%9b%9e%e9%81%bf%e3%81%99%e3%82%8b%e6%96%b9%e6%b3%95/">Stable DiffusionでNSFWフィルターをスマートに回避する方法 | ジコログ</a></li>
</ul><div class="ad-rakuten">
  <div class="ad-rakuten-image">
    <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Frakutenkobo-ebooks%2Fe7c65c56cfe531249a5fe2241d78c476%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2Fi%2F21662691%2F">
      <img src="https://thumbnail.image.rakuten.co.jp/@0_mall/rakutenkobo-ebooks/cabinet/3265/2000012063265.jpg?_ex=128x128">
    </a>
  </div>
  <div class="ad-rakuten-info">
    <div class="ad-rakuten-title">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Frakutenkobo-ebooks%2Fe7c65c56cfe531249a5fe2241d78c476%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2Fi%2F21662691%2F">AIとコラボして神絵師になる 論文から読み解くStable Diffusion【電子書籍】[ 白井 暁彦 ]</a>
    </div>
    <div class="ad-rakuten-shop">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2Frakutenkobo-ebooks%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2F">楽天Kobo電子書籍ストア</a>
    </div>
    <div class="ad-rakuten-price">価格 : 1760円</div>
  </div>
</div>
<h2 id="waifu-diffusion-も試してみる"><a class="header-link" href="#waifu-diffusion-も試してみる"><span class="header-link-mark"></span></a>Waifu Diffusion も試してみる</h2>
<p>アニメ絵をキレイに生成できる、<em>Waifu Diffusion</em> という別のモデルもあったので、公式のスクリプトだけ動かしてみる。</p>
<ul>
  <li>
    <p>参考 : <a href="https://huggingface.co/hakurei/waifu-diffusion">hakurei/waifu-diffusion · Hugging Face</a></p>
    <ul>
      <li>モデルのページ</li>
    </ul>
  </li>
  <li>
    <p>参考 : <a href="https://qiita.com/azukissy/items/03f9ca67e2ef72b07b02">Waifu-DiffusionをWindowsローカル環境で試す - Qiita</a></p>
  </li>
  <li>
    <p><code>practice-waifu-diffusion.py</code></p>
  </li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> autocast
<span class="token keyword">from</span> diffusers <span class="token keyword">import</span> StableDiffusionPipeline

pipe <span class="token operator">=</span> StableDiffusionPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">'hakurei/waifu-diffusion'</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
prompt <span class="token operator">=</span> <span class="token string">"1girl, aqua eyes, baseball cap, blonde hair, closed mouth, earrings, green background, hat, hoop earrings, jewelry, looking at viewer, shirt, short hair, simple background, solo, upper body, yellow shirt"</span>
<span class="token keyword">with</span> autocast<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> guidance_scale<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"images"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"waifu.png"</span><span class="token punctuation">)</span>
</code></pre>
<p>モデルのページにあるスクリプトでは、<code>torch_dtype</code> 部分が <code>torch.float32</code> だったのだが、コレだと以下のように Out Of Memory エラーが出てしまったので、<code>torch.float16</code> に変更している。コレだとうまく行った。</p>
<pre class="language-powershell"><code class="language-powershell">> python <span class="token punctuation">.</span>\practice<span class="token operator">-</span>waifu<span class="token operator">-</span>diffusion<span class="token punctuation">.</span>py
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>OutOfMemoryError: CUDA out of memory<span class="token punctuation">.</span> Tried to allocate 640<span class="token punctuation">.</span>00 MiB <span class="token punctuation">(</span>GPU 0<span class="token punctuation">;</span> 8<span class="token punctuation">.</span>00 GiB total capacity<span class="token punctuation">;</span> 7<span class="token punctuation">.</span>18 GiB already allocated<span class="token punctuation">;</span> 0 bytes free<span class="token punctuation">;</span> 7<span class="token punctuation">.</span>23 GiB reserved in total by PyTorch<span class="token punctuation">)</span> <span class="token keyword">If</span> reserved memory is >> allocated memory <span class="token keyword">try</span> setting max_split_size_mb to avoid fragmentation<span class="token punctuation">.</span>  See documentation <span class="token keyword">for</span> Memory Management and PYTORCH_CUDA_ALLOC_CONF

<span class="token comment"># GPU メモリの仕様状況は以下で確認できる</span>
> nvidia<span class="token operator">-</span>smi
</code></pre>
<h2 id="今回はココまで"><a class="header-link" href="#今回はココまで"><span class="header-link-mark"></span></a>今回はココまで！</h2>
<p>今回は PowerShell 上で Python スクリプトを実行する形で、Diffusers を経由しての Stable Diffusion・Waifu Diffusion モデルを利用した画像生成が実現できた。</p>
<p>解像度などのパラメータ類はまだまだ触れていないし、プロンプトも人力で作ろうとするとかなり大変なので、本気で画像生成をしていこうと思ったらもっと研究が必要そうだ。</p>
<p>今回紹介した Python スクリプトは以下の GitHub リポジトリにも置いてあるのでドウゾ。</p>
<ul>
  <li><a href="https://github.com/Neos21/practice-stable-diffusion">Neos21/practice-stable-diffusion: Practice Stable Diffusion</a></li>
</ul><div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/B0BG2JX7TL?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51Uz4HMFPWL._SL160_.jpg" width="112" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/B0BG2JX7TL?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">Artificial Images　Midjourney / Stable DiffusionによるAIアートコレクション (NextPublishing)</a>
    </div>
  </div>
</div>
<div class="ad-rakuten">
  <div class="ad-rakuten-image">
    <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Frakutenkobo-ebooks%2F8ecae243f311312790aa4f154cd94485%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2Fi%2F21573787%2F">
      <img src="https://thumbnail.image.rakuten.co.jp/@0_mall/rakutenkobo-ebooks/cabinet/4273/2000011934273.jpg?_ex=128x128">
    </a>
  </div>
  <div class="ad-rakuten-info">
    <div class="ad-rakuten-title">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Frakutenkobo-ebooks%2F8ecae243f311312790aa4f154cd94485%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2Fi%2F21573787%2F">Artificial Images Midjourney / Stable DiffusionによるAIアートコレクション【電子書籍】[ 852話 ]</a>
    </div>
    <div class="ad-rakuten-shop">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00reb42.waxycf23.g00reb42.waxyd080/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2Frakutenkobo-ebooks%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Frakutenkobo-ebooks%2F">楽天Kobo電子書籍ストア</a>
    </div>
    <div class="ad-rakuten-price">価格 : 1980円</div>
  </div>
</div>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2023-02-27</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2023-02-27</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
