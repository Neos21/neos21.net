<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Excel ドキュメントの納品時に毎回やっていることを一括自動処理する Excel VBA マクロを作った - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/01/24-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/01/index.html">01月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-01-24</time></div>
        <h1 id="page-title">Excel ドキュメントの納品時に毎回やっていることを一括自動処理する Excel VBA マクロを作った</h1>

<p>Excel で作った設計書などを納品する際にやっていることを一括で自動処理する Excel VBA マクロを作った。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%81%BE%E3%81%9A%E3%81%AF%E3%82%B3%E3%83%BC%E3%83%89%E7%B4%B9%E4%BB%8B">まずはコード紹介</a></li>
  <li><a href="#%E3%81%93%E3%81%AE%E3%83%9E%E3%82%AF%E3%83%AD%E3%81%8C%E3%82%84%E3%82%8C%E3%82%8B%E3%81%93%E3%81%A8">このマクロがやれること</a></li>
  <li><a href="#windowsmacos-%E3%81%A8%E3%82%82%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%99%E3%82%8B%E3%82%AF%E3%83%AD%E3%82%B9%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%82%92%E5%AE%9F%E7%8F%BE">Windows・MacOS ともに動作するクロスプラットフォームを実現</a></li>
  <li><a href="#%E4%BB%96%E3%81%AB%E8%AA%B2%E9%A1%8C%E3%81%A8%E3%81%8B">他に課題とか</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="まずはコード紹介"><a class="header-link" href="#まずはコード紹介"><span class="header-link-mark"></span></a>まずはコード紹介</h2>
<p>先にマクロを紹介する。以下のコードを「標準モジュール」として取り込んでおき、適当な Excel マクロブックから <code>exec()</code> サブプロシージャを呼び出してあげれば OK。</p>
<ul>
  <li><code>module.bas</code></li>
</ul>
<pre class="language-vb"><code class="language-vb"><span class="token keyword">Option</span> Explicit

<span class="token comment">' ================================================================================</span>
<span class="token comment">' Format Excel Workbooks</span>
<span class="token comment">'</span>
<span class="token comment">' - Delete unnecessary names</span>
<span class="token comment">' - Delete unnecessary styles</span>
<span class="token comment">' - Zoom to 100%</span>
<span class="token comment">' - Select A1 cell with scrolling</span>
<span class="token comment">' - Select the first worksheet</span>
<span class="token comment">' - Save it to './Modified/' directory (If the file exists in './Modified/' directory, it will be overwritten)</span>
<span class="token comment">' ================================================================================</span>
<span class="token comment">' CAUTIONS On MacOS</span>
<span class="token comment">'</span>
<span class="token comment">' - You can't use Japanese in VBA codes (Including comments)</span>
<span class="token comment">' - Dir() function doesn't working in Mac Excel, So We use AppleScript instead</span>
<span class="token comment">' - Path splitter is Slash (MacOS POSIX) or Colon (MacOS), not Backslash (Windows)</span>
<span class="token comment">' - Backslash characters are removed when save the workbook on MacOS. So use Chr(92) instead</span>
<span class="token comment">' ================================================================================</span>



<span class="token comment">' The name of 'Modified' directory</span>
<span class="token keyword">Const</span> modifiedDirectoryName <span class="token keyword">As</span> <span class="token keyword">String</span> <span class="token operator">=</span> <span class="token string">"Modified"</span>

<span class="token comment">' Execute</span>
<span class="token comment">'</span>
<span class="token comment">' @param targetDirectoryPath Full path string of the target directory</span>
<span class="token keyword">Sub</span> exec<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">' Detect target directory path</span>
  <span class="token keyword">Dim</span> targetDirectoryPath <span class="token keyword">As</span> <span class="token keyword">String</span>
  targetDirectoryPath <span class="token operator">=</span> detectTargetDirectoryPath
  
  <span class="token keyword">If</span> targetDirectoryPath <span class="token operator">=</span> <span class="token string">""</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Target directory path is empty"</span>
    MsgBox <span class="token string">"ディレクトリが正しく選択されませんでした。処理を中断します"</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
  
  <span class="token comment">' List file paths</span>
  <span class="token keyword">Dim</span> filePaths<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
  filePaths <span class="token operator">=</span> listFilePaths<span class="token punctuation">(</span>targetDirectoryPath<span class="token punctuation">)</span>  <span class="token comment">' ex. "/path/to/directory" or "/path/to/directory/"</span>
  
  <span class="token keyword">If</span> UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span><span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Excel files not exist"</span>
    MsgBox <span class="token string">"指定のディレクトリ配下に Excel ファイルがありませんでした。パスを確認してください"</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
  
  Application<span class="token punctuation">.</span>ScreenUpdating <span class="token operator">=</span> <span class="token boolean">False</span>
  Application<span class="token punctuation">.</span>DisplayAlerts <span class="token operator">=</span> <span class="token boolean">False</span>
  
  <span class="token comment">' Detect path splitter</span>
  <span class="token keyword">Dim</span> pathSplitter <span class="token keyword">As</span> <span class="token keyword">String</span>
  pathSplitter <span class="token operator">=</span> detectPathSplitter
  
  <span class="token comment">' Make './Modified/' directory</span>
  makeModifiedDirectory targetDirectoryPath<span class="token punctuation">,</span> pathSplitter
  
  <span class="token keyword">Dim</span> filePath <span class="token keyword">As</span> <span class="token keyword">Variant</span>  <span class="token comment">' For Each needs Variant</span>
  <span class="token keyword">For</span> <span class="token keyword">Each</span> filePath <span class="token keyword">In</span> filePaths<span class="token punctuation">(</span><span class="token punctuation">)</span>
    formatWorkbook filePath<span class="token punctuation">,</span> pathSplitter
  <span class="token keyword">Next</span> filePath
   
  Application<span class="token punctuation">.</span>DisplayAlerts <span class="token operator">=</span> <span class="token boolean">True</span>
  Application<span class="token punctuation">.</span>ScreenUpdating <span class="token operator">=</span> <span class="token boolean">True</span>
  
  MsgBox <span class="token string">"完了"</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token comment">' Detect target directory path</span>
<span class="token comment">'</span>
<span class="token comment">' @return Target directory path</span>
<span class="token keyword">Private</span> <span class="token keyword">Function</span> detectTargetDirectoryPath<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
  <span class="token keyword">Dim</span> targetDirectoryPath <span class="token keyword">As</span> <span class="token keyword">String</span>
  
  <span class="token keyword">If</span> Application<span class="token punctuation">.</span>OperatingSystem <span class="token keyword">Like</span> <span class="token string">"*Mac*"</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"MacOS : Detect target directory path"</span>
    
    <span class="token comment">' Ignore AppleScript runtime error</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
    
    <span class="token comment">' For allowing access to the directory</span>
    targetDirectoryPath <span class="token operator">=</span> MacScript<span class="token punctuation">(</span><span class="token string">"choose folder as string"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">If</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&#x3C;</span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">Then</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Cancelled or runtime error : "</span> <span class="token operator">&#x26;</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&#x26;</span> <span class="token string">" : "</span> <span class="token operator">&#x26;</span> Err<span class="token punctuation">.</span>Description
      <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    <span class="token keyword">If</span> targetDirectoryPath <span class="token operator">=</span> <span class="token string">""</span> <span class="token keyword">Then</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Cancelled or invalid path"</span>
      <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    <span class="token comment">' Replace to POSIX path with single quote</span>
    targetDirectoryPath <span class="token operator">=</span> MacScript<span class="token punctuation">(</span><span class="token string">"tell text 1 thru -2 of "</span> <span class="token operator">&#x26;</span> Chr<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span> <span class="token operator">&#x26;</span> targetDirectoryPath <span class="token operator">&#x26;</span> Chr<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span> <span class="token operator">&#x26;</span> <span class="token string">" to return quoted form of it's POSIX Path"</span><span class="token punctuation">)</span>
    <span class="token comment">' Remove single quote</span>
    targetDirectoryPath <span class="token operator">=</span> Replace<span class="token punctuation">(</span>targetDirectoryPath<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
    Debug<span class="token punctuation">.</span>Print targetDirectoryPath
    detectTargetDirectoryPath <span class="token operator">=</span> targetDirectoryPath
  <span class="token keyword">Else</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Windows : Detect target directory path"</span>
    
     <span class="token comment">' Application.FileDialog(msoFileDialogFolderPicker) can't use when exec on MacOS</span>
    targetDirectoryPath <span class="token operator">=</span> Application<span class="token punctuation">.</span>InputBox<span class="token punctuation">(</span>Prompt<span class="token punctuation">:</span><span class="token operator">=</span><span class="token string">"対象ディレクトリへのフルパスを指定してください"</span><span class="token punctuation">,</span> Title<span class="token punctuation">:</span><span class="token operator">=</span><span class="token string">"対象ディレクトリへのフルパスを指定してください"</span><span class="token punctuation">,</span> <span class="token keyword">Type</span><span class="token punctuation">:</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token keyword">If</span> targetDirectoryPath <span class="token operator">=</span> <span class="token string">"False"</span> <span class="token keyword">Or</span> targetDirectoryPath <span class="token operator">=</span> <span class="token string">""</span> <span class="token keyword">Then</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Cancelled or invalid path"</span>
      <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    Debug<span class="token punctuation">.</span>Print targetDirectoryPath
    detectTargetDirectoryPath <span class="token operator">=</span> targetDirectoryPath
  <span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Function</span>

<span class="token comment">' List file paths</span>
<span class="token comment">'</span>
<span class="token comment">' @param targetDirectoryPath Full path string of the target directory</span>
<span class="token comment">' @return Array of full path string of the files under the target directory</span>
<span class="token keyword">Private</span> <span class="token keyword">Function</span> listFilePaths<span class="token punctuation">(</span><span class="token keyword">ByVal</span> targetDirectoryPath <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">Dim</span> filePaths<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
  
  <span class="token keyword">If</span> Application<span class="token punctuation">.</span>OperatingSystem <span class="token keyword">Like</span> <span class="token string">"*Mac*"</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"MacOS : List file paths"</span>
    
    <span class="token comment">' Ignore AppleScript runtime error</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
    
    <span class="token comment">' Find Excel files : do shell script "find -E '/path/to/directory' -type f -iregex '.*.[xls|xlsx|xlsm]' -maxdepth 1"</span>
    <span class="token keyword">Dim</span> appleScript <span class="token keyword">As</span> <span class="token keyword">String</span>
    appleScript <span class="token operator">=</span> <span class="token string">"do shell script "</span> <span class="token operator">&#x26;</span> Chr<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span> <span class="token operator">&#x26;</span> <span class="token string">"find -E '"</span> <span class="token operator">&#x26;</span> targetDirectoryPath <span class="token operator">&#x26;</span> <span class="token string">"' -type f -iregex '.*.[xls|xlsx|xlsm]' -maxdepth 1"</span> <span class="token operator">&#x26;</span> Chr<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span>
    Debug<span class="token punctuation">.</span>Print appleScript
    
    <span class="token comment">' Execute AppleScript</span>
    <span class="token keyword">Dim</span> result <span class="token keyword">As</span> <span class="token keyword">String</span>
    result <span class="token operator">=</span> MacScript<span class="token punctuation">(</span>appleScript<span class="token punctuation">)</span>
    
    <span class="token keyword">If</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&#x3C;</span><span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">Then</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Abort : Failure to find files"</span>
      MsgBox <span class="token string">"ファイル一覧の取得に失敗しました。処理を中断します："</span> <span class="token operator">&#x26;</span> vbCrLf <span class="token operator">&#x26;</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&#x26;</span> <span class="token string">" : "</span> <span class="token operator">&#x26;</span> Err<span class="token punctuation">.</span>Description
      <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    Debug<span class="token punctuation">.</span>Print result
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
    
    <span class="token comment">' Split by CR</span>
    filePaths <span class="token operator">=</span> Split<span class="token punctuation">(</span>result<span class="token punctuation">,</span> vbCr<span class="token punctuation">)</span>
    
    <span class="token comment">' When result is empty, UBound(filePaths) is -1</span>
    <span class="token keyword">If</span> UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token keyword">Then</span>
      <span class="token keyword">ReDim</span> filePaths<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    Debug<span class="token punctuation">.</span>Print UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">&#x26;</span> <span class="token string">" files"</span>
    listFilePaths <span class="token operator">=</span> filePaths
    <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
  <span class="token keyword">Else</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Windows : List file paths"</span>
    
    <span class="token keyword">Dim</span> pathSplitter <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">:</span> pathSplitter <span class="token operator">=</span> Chr<span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">)</span>  <span class="token comment">' Backslash (Because of MacOS removing backslash characters)</span>
    <span class="token keyword">ReDim</span> filePaths<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token comment">' Find files</span>
    <span class="token keyword">Dim</span> fileName <span class="token keyword">As</span> <span class="token keyword">String</span>
    fileName <span class="token operator">=</span> Dir<span class="token punctuation">(</span>targetDirectoryPath <span class="token operator">&#x26;</span> pathSplitter <span class="token operator">&#x26;</span> <span class="token string">"*.*"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">Do</span> <span class="token keyword">While</span> fileName <span class="token operator">&#x3C;</span><span class="token operator">></span> <span class="token string">""</span>
      <span class="token comment">' Find only Excel files</span>
      <span class="token keyword">If</span> Right<span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xls"</span> <span class="token keyword">Or</span> Right<span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xlsx"</span> <span class="token keyword">Or</span> Right<span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xlsm"</span> <span class="token keyword">Then</span>
        <span class="token keyword">Dim</span> filePath <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">:</span> filePath <span class="token operator">=</span> targetDirectoryPath <span class="token operator">&#x26;</span> pathSplitter <span class="token operator">&#x26;</span> fileName
        <span class="token comment">' Push (and extend)</span>
        filePaths<span class="token punctuation">(</span>UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> filePath
        <span class="token keyword">ReDim</span> Preserve filePaths<span class="token punctuation">(</span>UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">End</span> <span class="token keyword">If</span>
      <span class="token comment">' Next file</span>
      fileName <span class="token operator">=</span> Dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">Loop</span>
    
    <span class="token comment">' Adjust length</span>
    <span class="token keyword">If</span> UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">Then</span>
      <span class="token keyword">ReDim</span> Preserve filePaths<span class="token punctuation">(</span>UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
    Debug<span class="token punctuation">.</span>Print UBound<span class="token punctuation">(</span>filePaths<span class="token punctuation">)</span> <span class="token operator">&#x26;</span> <span class="token string">" files"</span>
    listFilePaths <span class="token operator">=</span> filePaths
    <span class="token keyword">Exit</span> <span class="token keyword">Function</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Function</span>

<span class="token comment">' Detect path splitter</span>
<span class="token comment">'</span>
<span class="token comment">' @return Slash (MacOS) or Backslash (Windows)</span>
<span class="token keyword">Private</span> <span class="token keyword">Function</span> detectPathSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
  <span class="token keyword">If</span> Application<span class="token punctuation">.</span>OperatingSystem <span class="token keyword">Like</span> <span class="token string">"*Mac*"</span> <span class="token keyword">Then</span>
    detectPathSplitter <span class="token operator">=</span> <span class="token string">"/"</span>
  <span class="token keyword">Else</span>
    detectPathSplitter <span class="token operator">=</span> Chr<span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">)</span>  <span class="token comment">' Backslash (Because of MacOS removing backslash characters)</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Function</span>

<span class="token comment">' Make './Modified/' directory if it doesn't exist</span>
<span class="token comment">'</span>
<span class="token comment">' @param targetDirectory Path Full path string of the target directory</span>
<span class="token comment">' @param pathSplitter Character of path splitter. Slash (MacOS) or Backslash (Windows)</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> makeModifiedDirectory<span class="token punctuation">(</span><span class="token keyword">ByVal</span> targetDirectoryPath <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> pathSplitter <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span>
  <span class="token keyword">Dim</span> modifiedDirectoryPath <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">:</span> modifiedDirectoryPath <span class="token operator">=</span> targetDirectoryPath <span class="token operator">&#x26;</span> pathSplitter <span class="token operator">&#x26;</span> modifiedDirectoryName
  
  <span class="token keyword">Dim</span> pathExists <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">:</span> pathExists <span class="token operator">=</span> Dir<span class="token punctuation">(</span>modifiedDirectoryPath<span class="token punctuation">,</span> vbDirectory<span class="token punctuation">)</span>
  <span class="token keyword">If</span> pathExists <span class="token operator">=</span> <span class="token string">""</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Modified directory does not exist. Make it"</span>
    MkDir modifiedDirectoryPath
  <span class="token keyword">Else</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Modified directory already exists"</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
 
<span class="token comment">' Format the workbook</span>
<span class="token comment">'</span>
<span class="token comment">' @param filePath Full path string of the target workbook</span>
<span class="token comment">' @param pathSplitter Character of path splitter. Slash (MacOS) or Backslash (Windows)</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> formatWorkbook<span class="token punctuation">(</span><span class="token keyword">ByVal</span> filePath <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> pathSplitter <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span>
  Debug<span class="token punctuation">.</span>Print <span class="token string">"Exec format : "</span> <span class="token operator">&#x26;</span> filePath
  
  <span class="token keyword">Dim</span> targetWorkbook <span class="token keyword">As</span> Workbook
  
  <span class="token comment">' Open the workbook</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> failureOpen
  <span class="token keyword">Set</span> targetWorkbook <span class="token operator">=</span> Workbooks<span class="token punctuation">.</span>Open<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
  
  <span class="token comment">' Execute Subs</span>
  deleteNames
  deleteStyles
  setHomePosition
  
   <span class="token comment">' Save as './Modified/' directory</span>
  saveWorkbook pathSplitter
  <span class="token comment">' Close</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
  targetWorkbook<span class="token punctuation">.</span>Close
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
  <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
failureOpen<span class="token punctuation">:</span>
  Debug<span class="token punctuation">.</span>Print <span class="token string">"Failure to open the workbook : "</span> <span class="token operator">&#x26;</span> filePath
  MsgBox <span class="token string">"ブックを開けませんでした"</span> <span class="token operator">&#x26;</span> vbCrLf <span class="token operator">&#x26;</span> filePath
  <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token comment">' Delete Names</span>
<span class="token comment">'</span>
<span class="token comment">' This Sub uses ActiveWorkbook</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> deleteNames<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
  <span class="token keyword">Dim</span> name <span class="token keyword">As</span> <span class="token keyword">Variant</span>
  <span class="token keyword">For</span> <span class="token keyword">Each</span> name <span class="token keyword">In</span> ActiveWorkbook<span class="token punctuation">.</span>Names
    <span class="token keyword">If</span> InStr<span class="token punctuation">(</span>name<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"Print_Area"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">And</span> InStr<span class="token punctuation">(</span>name<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"Print_Titles"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">And</span> <span class="token keyword">Not</span> name<span class="token punctuation">.</span>BuiltIn <span class="token keyword">Then</span>
      name<span class="token punctuation">.</span>Delete
    <span class="token keyword">End</span> <span class="token keyword">If</span>
  <span class="token keyword">Next</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token comment">' Delete Styles</span>
<span class="token comment">'</span>
<span class="token comment">' This Sub uses ActiveWorkbook</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> deleteStyles<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
  <span class="token keyword">Dim</span> style <span class="token keyword">As</span> <span class="token keyword">Variant</span>
  <span class="token keyword">For</span> <span class="token keyword">Each</span> style <span class="token keyword">In</span> ActiveWorkbook<span class="token punctuation">.</span>Styles
    <span class="token keyword">If</span> <span class="token keyword">Not</span> style<span class="token punctuation">.</span>BuiltIn <span class="token keyword">Then</span>
      style<span class="token punctuation">.</span>Delete
    <span class="token keyword">End</span> <span class="token keyword">If</span>
  <span class="token keyword">Next</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token comment">' Set Home Position</span>
<span class="token comment">'</span>
<span class="token comment">' This Sub uses ActiveWorkbook</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> setHomePosition<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">Dim</span> ws <span class="token keyword">As</span> <span class="token keyword">Variant</span>
  <span class="token keyword">For</span> <span class="token keyword">Each</span> ws <span class="token keyword">In</span> ActiveWorkbook<span class="token punctuation">.</span>Worksheets
    <span class="token keyword">If</span> Worksheets<span class="token punctuation">(</span>ws<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">Then</span>
      Worksheets<span class="token punctuation">(</span>ws<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">Select</span>
      <span class="token comment">' Zoom to 100%</span>
      ActiveWindow<span class="token punctuation">.</span>Zoom <span class="token operator">=</span> <span class="token number">100</span>
      <span class="token comment">' Select A1 cell with scrolling</span>
      Application<span class="token punctuation">.</span><span class="token keyword">Goto</span> Reference<span class="token punctuation">:</span><span class="token operator">=</span>ActiveWindow<span class="token punctuation">.</span>ActiveSheet<span class="token punctuation">.</span>Range<span class="token punctuation">(</span><span class="token string">"A1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Scroll<span class="token punctuation">:</span><span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
  <span class="token keyword">Next</span>
  
  <span class="token comment">' Select the first worksheet</span>
  <span class="token keyword">For</span> <span class="token keyword">Each</span> ws <span class="token keyword">In</span> ActiveWorkbook<span class="token punctuation">.</span>Worksheets
    <span class="token keyword">If</span> Worksheets<span class="token punctuation">(</span>ws<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">Then</span>
      Worksheets<span class="token punctuation">(</span>ws<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">Select</span>
      <span class="token keyword">Exit</span> <span class="token keyword">For</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
  <span class="token keyword">Next</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token comment">' Save Workbook</span>
<span class="token comment">'</span>
<span class="token comment">' This Sub uses ActiveWorkbook</span>
<span class="token comment">'</span>
<span class="token comment">' @param pathSplitter Character of path splitter. Slash (MacOS) or Backslash (Windows)</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> saveWorkbook<span class="token punctuation">(</span><span class="token keyword">ByVal</span> pathSplitter <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span>
  <span class="token comment">' Create file name : ex. '/path/to/directory/Modified/Book.xls'</span>
  <span class="token keyword">Dim</span> fileName <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">:</span> fileName <span class="token operator">=</span> ActiveWorkbook<span class="token punctuation">.</span>path <span class="token operator">&#x26;</span> pathSplitter <span class="token operator">&#x26;</span> modifiedDirectoryName <span class="token operator">&#x26;</span> pathSplitter <span class="token operator">&#x26;</span> ActiveWorkbook<span class="token punctuation">.</span>name
  
  <span class="token keyword">If</span> Right<span class="token punctuation">(</span>ActiveWorkbook<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xlsx"</span> <span class="token keyword">Or</span> Right<span class="token punctuation">(</span>ActiveWorkbook<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xlsm"</span> <span class="token keyword">Then</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Save it to same extension (.xlsx or .xlsm)"</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
    ActiveWorkbook<span class="token punctuation">.</span>SaveAs fileName<span class="token punctuation">:</span><span class="token operator">=</span>fileName
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
  <span class="token keyword">ElseIf</span> Right<span class="token punctuation">(</span>ActiveWorkbook<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".xls"</span> <span class="token keyword">Then</span>
    <span class="token comment">' Convert '.xls' to '.xlsx' or '.xlsm'</span>
    <span class="token keyword">If</span> ActiveWorkbook<span class="token punctuation">.</span>HasVBProject <span class="token keyword">Then</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Save as '.xlsm'"</span>
      <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
      ActiveWorkbook<span class="token punctuation">.</span>SaveAs fileName<span class="token punctuation">:</span><span class="token operator">=</span>fileName <span class="token operator">&#x26;</span> <span class="token string">"m"</span><span class="token punctuation">,</span> FileFormat<span class="token punctuation">:</span><span class="token operator">=</span>xlOpenXMLWorkbookMacroEnabled
      <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
      <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    <span class="token keyword">Else</span>
      Debug<span class="token punctuation">.</span>Print <span class="token string">"Save as '.xlsx'"</span>
      <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
      ActiveWorkbook<span class="token punctuation">.</span>SaveAs fileName<span class="token punctuation">:</span><span class="token operator">=</span>fileName <span class="token operator">&#x26;</span> <span class="token string">"x"</span><span class="token punctuation">,</span> FileFormat<span class="token punctuation">:</span><span class="token operator">=</span>xlOpenXMLWorkbook
      <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>
      <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
  <span class="token keyword">Else</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">"Unspported file format : "</span> <span class="token operator">&#x26;</span> ActiveWorkbook<span class="token punctuation">.</span>name
  <span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre>
<p>コードコメントが英語なのは、Mac の VBEditor で日本語入力できないため。英文法メチャクチャで恥ずかしいから、なるべく個々の関数を簡素に作って、簡単な単語で伝わるようにした…。</p>
<p>以降、説明。</p>
<h2 id="このマクロがやれること"><a class="header-link" href="#このマクロがやれること"><span class="header-link-mark"></span></a>このマクロがやれること</h2>
<p>このマクロがやってくれることは以下のとおり。</p>
<ul>
  <li>指定のディレクトリ配下にある Excel ファイル群について、次の操作を行う
    <ul>
      <li>全てのシートで A1 セルにカーソルを合わせ、シート最上部にスクロールする</li>
      <li>全てのシートで拡大倍率を 100% にする</li>
      <li>未使用の「名前定義」を削除し、ファイルサイズを削減する</li>
      <li>未使用の「スタイル定義」を削除し、ファイルサイズを削減する</li>
    </ul>
  </li>
  <li>編集したファイルは指定のディレクトリ配下に <code>Modified</code> ディレクトリを作り、そこに保存するので、元ファイルは汚さない
    <ul>
      <li><code>.xls</code> ファイルはマクロの有無を確かめた上で、<code>.xlsx</code> もしくは <code>.xlsm</code> 形式で保存し直し、ファイルサイズを削減する</li>
    </ul>
  </li>
</ul>
<p>実は個々の処理は、以前色々な記事で紹介している。</p>
<ul>
  <li><a href="/blog/2017/03/28-01.html">Excel でシートを開いた時に全シート A1 セルにカーソルを合わせ、必ず1シート目を開かせるマクロ</a></li>
</ul>
<p>今回はこれらの処理を一つの「標準モジュール」として統合し、ディレクトリを指定するだけで、配下のエクセルファイルを一気に修正してしまうコードにした。</p>
<h2 id="windowsmacos-ともに動作するクロスプラットフォームを実現"><a class="header-link" href="#windowsmacos-ともに動作するクロスプラットフォームを実現"><span class="header-link-mark"></span></a>Windows・MacOS ともに動作するクロスプラットフォームを実現</h2>
<p>キモとなる整形処理は上述のとおりほとんどコードを用意してあったのだが、<em>「複数ファイルを取得する」</em>ために使用していた <strong><code>Dir()</code> 関数が Excel for Mac では動作しない</strong>ため、MacOS でも動作するよう、対象ファイルの取得方法を OS 別に用意した。</p>
<p>OS の判定は <code>If Application.OperatingSystem Like "*Mac*" Then</code> で行える。Mac の場合は AppleScript を利用してディレクトリ選択ダイアログを表示し、続いて AppleScript 経由でシェルスクリプトの <code>find</code> コマンドを実行し、Excel ファイルのフルパスを取得した。</p>
<p>Windows の場合は通常どおり <code>Dir()</code> で取得。Mac 側で、Excel ファイルのフルパスを配列で返していたので、戻り値の型を合わせるため、<code>Dir()</code> 関数の結果をフルパスに変換し、配列で返すようにした。本当は <code>Application.FileDialog(msoFileDialogFolderPicker)</code> とかを使って、Windows でもディレクトリ選択ダイアログを表示させたかったのだが、Mac で実行すると <code>msoFileDialogFolderPicker</code> の参照を解決するための参照設定が追加できず断念。Windows の場合は <code>Application.InputBox</code> を表示させて、対象ディレクトリへのフルパスを入力してもらうようにした。ちょっと使い勝手悪いかな。</p>
<p>他にも、パスの区切り文字が違ったりとなかなか難儀だったのだが、Excel ファイルを開くところまで行ければ後は問題なし。コレで Windows でも Mac でも使える Excel VBA マクロになった。</p>
<h2 id="他に課題とか"><a class="header-link" href="#他に課題とか"><span class="header-link-mark"></span></a>他に課題とか</h2>
<p>とりあえずやりたいことはやれたのだが、他に課題というか、直せそうなところでいうと、以下のとおり。</p>
<ul>
  <li>拡張子を <code>.XLSX</code> など、大文字で書いている場合は上手く扱えない件。<code>LCase()</code> とかで小文字にして判定したりすれば良いかな。</li>
  <li>「改ページプレビュー」表示などではなく、「標準ビュー」に戻したい、とかいう需要があるかも？シートごとに <code>ActiveWindow.View = xlNormalView</code> を実行すれば良いだけなので、よしなに。
    <ul>
      <li>参考：<a href="http://office.chienetsu.com/archives/2015/07/windowview-309/">Excel VBA 改ページプレビュー、ノーマルビュー(標準)、ページレイアウト表示を切り替える -Window.Viewプロパティ-</a></li>
    </ul>
  </li>
  <li>サブディレクトリまで再帰的に掘り下げる作りにはしていない。Mac 側は <code>find</code> コマンドの <code>-maxdepth</code> オプションを渡さないように変えるとか、Windows 側は <code>Dir()</code> 関数の再帰呼び出しが必要とか、面倒なのでやめた。</li>
  <li>実行結果を新規 Excel ブックに書き出すとか？</li>
  <li>非表示のシートは整形処理を無視している件
    <ul>
      <li>いじった方がいいのかな。</li>
    </ul>
  </li>
  <li>あらゆる Excel ファイルの状態での検証ができていない
    <ul>
      <li>シートの保護があったらどうなるかな、とか、そういうところ。</li>
    </ul>
  </li>
  <li><code>.xlb</code>・<code>.xlsb</code> ファイルは無視している
    <ul>
      <li>今どきバイナリブックにするヤツいるのか？と思って無視した。</li>
    </ul>
  </li>
  <li>ファイルの作成日時・更新日時もいじりたいって？
    <ul>
      <li>Mac なら <code>setfile</code> と <code>touch</code> コマンド、Windows なら PowerShell で <code>Set-ItemProperty</code> を使って <code>CreationTime</code> と <code>LastWriteTime</code> を変更してください</li>
      <li>(リリース後に神 Excel を書き直して日付を過去日にズラして納品とかブラックかよ…笑)</li>
    </ul>
  </li>
</ul>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>操作対象のファイル一覧を特定するための処理部分が、クロスプラットフォーム対応のためになかなか苦戦した。</p>
<p>明らかなバグや追加要望等が挙がれば、上述の Gist を GitHub リポジトリに移して、もう少し開発してみようかなと思う所存。アドバイスなんかもあったらぜひください。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-01-24</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-01-24</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
