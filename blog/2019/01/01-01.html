<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Node.js スクリプトをコマンドのように使えるようにする方法 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/01/01-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/01/index.html">01月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-01-01</time></div>
        <h1 id="page-title">Node.js スクリプトをコマンドのように使えるようにする方法</h1>

<p>2019年、あけましておめでとうございます。今年も宜しくお願い致します。</p>
<hr>
<p>今日は、Node.js で書いたちょっとしたスクリプトを、コマンドとして使えるようにする手順をまとめる。大きく2種類のやり方があるのでそれぞれ紹介する。</p>
<p>試した環境は macOS Mojave・Node.js v10.7.0・npm v6.1.0。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E5%A4%96%E9%83%A8%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AB%E4%BE%9D%E5%AD%98%E3%81%9B%E3%81%9A%E5%8D%98%E4%B8%80%E3%81%AE-js-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A7%E6%B8%88%E3%82%80%E5%A0%B4%E5%90%88">外部パッケージに依存せず単一の JS ファイルで済む場合</a>
    <ul>
      <li><a href="#%E5%85%88%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E5%85%A8%E9%87%8F">先にコード全量</a></li>
      <li><a href="#path-%E3%81%8C%E9%80%9A%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%A8%E3%81%93%E3%82%8D%E3%81%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%BD%AE%E3%81%8F">PATH が通っているところにスクリプトファイルを置く</a></li>
      <li><a href="#nodejs-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A8%E3%81%97%E3%81%A6%E5%8B%95%E4%BD%9C%E3%81%95%E3%81%9B%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE-shebang-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">Node.js スクリプトとして動作させるための Shebang を設定する</a></li>
      <li><a href="#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E6%9B%B8%E3%81%8F">スクリプトを書く</a></li>
      <li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%AE%9F%E8%A1%8C%E6%A8%A9%E3%82%92%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B">ファイルに実行権を付与する</a></li>
    </ul>
  </li>
  <li><a href="#%E5%A4%96%E9%83%A8%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E4%BE%9D%E5%AD%98%E3%81%99%E3%82%8B-nodejs-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E5%8C%96%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">外部モジュールに依存する Node.js スクリプトをコマンド化する場合</a></li>
</ul>
<h2 id="外部パッケージに依存せず単一の-js-ファイルで済む場合"><a class="header-link" href="#外部パッケージに依存せず単一の-js-ファイルで済む場合"><span class="header-link-mark"></span></a>外部パッケージに依存せず単一の JS ファイルで済む場合</h2>
<p>依存モジュールがなく、単一の JS ファイルで済むようなコードであれば、そのファイルを PATH が通っているところに置くだけでコマンド化できる。</p>
<h3 id="先にコード全量"><a class="header-link" href="#先にコード全量"><span class="header-link-mark"></span></a>先にコード全量</h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># PATH が通っているところならどこでも</span>
$ <span class="token builtin class-name">cd</span> /usr/local/bin/

<span class="token comment"># サンプルスクリプトを作る。Shebang 重要</span>
$ <span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span> EOF <span class="token operator">></span> my_node_command
<span class="token operator">></span> <span class="token comment">#!/usr/bin/env node</span>
<span class="token operator">></span> console.log<span class="token punctuation">(</span>process.cwd<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
<span class="token operator">></span> EOF
  <span class="token comment"># コマンドを実行したカレントディレクトリを表示するだけのコード</span>

<span class="token comment"># 実行権を付与する</span>
$ <span class="token function">chmod</span> +x my_node_command

<span class="token comment"># 好きなところに移動して使う</span>
$ <span class="token builtin class-name">cd</span> ~/work/
<span class="token comment"># 実行</span>
$ my_node_command
/Users/Neos21/work
  <span class="token comment"># コマンドを実行したカレントディレクトリが表示される</span>
</code></pre>
<p>以下、もう少し個別に詳細を説明する。</p>
<ul>
  <li>参考：<a href="https://qiita.com/take4s5i/items/e207cee4fb04385a9952">bashのヒアドキュメントを活用する - Qiita</a> … 毎回 <code>$ cat &#x3C;&#x3C; EOF > output.txt</code> な書き方忘れる</li>
</ul>
<h3 id="path-が通っているところにスクリプトファイルを置く"><a class="header-link" href="#path-が通っているところにスクリプトファイルを置く"><span class="header-link-mark"></span></a>PATH が通っているところにスクリプトファイルを置く</h3>
<p>コマンドとして実行するには、環境変数 <code>PATH</code> が通っているディレクトリに、拡張子なしのファイルとしてスクリプトを置く必要がある。</p>
<p>上述の例では <code>/usr/local/bin/</code> という、大抵 <code>PATH</code> に設定されているディレクトリを選択したが、その他にインストールしたファイル群と混ざりそうなので、僕はユーザホーム直下に <code>~/bin/</code> というディレクトリを作り、コレを <code>~/.bash_profile</code> にて環境変数 <code>PATH</code> に追加して利用している。</p>
<h3 id="nodejs-スクリプトとして動作させるための-shebang-を設定する"><a class="header-link" href="#nodejs-スクリプトとして動作させるための-shebang-を設定する"><span class="header-link-mark"></span></a>Node.js スクリプトとして動作させるための Shebang を設定する</h3>
<p>Node.js スクリプトの Shebang は以下のとおり。</p>
<pre class="language-javascript"><code class="language-javascript">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
</code></pre>
<p>コレがないと Node.js 製のスクリプトとして解釈してもらえない。</p>
<ul>
  <li>参考：<a href="https://stackoverflow.com/questions/24253027/node-and-shebang-help-executing-via-command-line/24253067#24253067">node.js - node and shebang : help executing via command line - Stack Overflow</a></li>
</ul>
<h3 id="スクリプトを書く"><a class="header-link" href="#スクリプトを書く"><span class="header-link-mark"></span></a>スクリプトを書く</h3>
<p>スクリプトファイルの1行目に Shebang を書いたら、後はスクリプトを書くだけ。</p>
<p>外部モジュールは、<code>fs</code> や <code>path</code> など、Node.js 本体に組み込みのモジュールであれば <code>require()</code> して利用できた。それ以外の <code>npm install</code> して使えるようなパッケージは、グローバルインストールしてあっても使うことはできない。外部 npm パッケージを使いたい場合は、後述する方法で実現できる。</p>
<p>さて、一例だが、こんなコードならスクリプトファイル単体で動かせた。</p>
<pre class="language-javascript"><code class="language-javascript">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">const</span> fs   <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// fs.readFile() を Promise 化する</span>
<span class="token keyword">const</span> readFile  <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token method function property-access">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token property-access">readFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'カレントディレクトリに package.json があったらその中身を出力する'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">packageJson</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>Util.promisify()</code> なる便利なヤーツが Node.js に組み込まれていたので、<code>fs.readFile()</code> をコレで Promise 化した。</p>
<ul>
  <li>参考：<a href="https://yosuke-furukawa.hatenablog.com/entry/2017/05/10/101752">util.promisify が追加された - from scratch</a></li>
</ul>
<p><code>__dirname</code> だと、スクリプトファイルの格納場所が返されてしまうので、<strong>スクリプトファイルを呼び出したカレントディレクトリを取得するには、<code>process.cwd()</code> を使っている。</strong></p>
<h3 id="ファイルに実行権を付与する"><a class="header-link" href="#ファイルに実行権を付与する"><span class="header-link-mark"></span></a>ファイルに実行権を付与する</h3>
<p>先程のようなスクリプトを <code>my_node_command</code> というファイル名で保存したとして、コレをコマンドのように実行できるようにするには、<code>chmod</code> コマンドによるファイルのアクセス権限の変更が必要。実行権限を付けないといけない。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">chmod</span> +x my_node_command
</code></pre>
<p>コレで OK。Node.js スクリプトとして JS ファイル単体で済ませられるモノなら、このようなやり方でコマンド化できた。</p>
<h2 id="外部モジュールに依存する-nodejs-スクリプトをコマンド化する場合"><a class="header-link" href="#外部モジュールに依存する-nodejs-スクリプトをコマンド化する場合"><span class="header-link-mark"></span></a>外部モジュールに依存する Node.js スクリプトをコマンド化する場合</h2>
<p>外部モジュールに依存する Node.js スクリプトをコマンド化したい場合は、npm パッケージをローカルで作り、それをグローバルインストールすることで実現できる。</p>
<p>まずは適当な作業ディレクトリを作り <code>$ npm init</code>。<code>package.json</code> が生成されるので、<code>$ npm install --save</code> で好きなライブラリをインストールし、それを使用したスクリプトを作っていく。</p>
<p>最近のトレンドだと、CLI ベースで動作するスクリプトは、プロジェクトルートに <code>cli.js</code> というファイル名で置き、<code>package.json</code> からは以下のようにコマンド名を定義してやるのが多い。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"neo"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Neo's Commands"</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"./lib/index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"neo"</span><span class="token operator">:</span> <span class="token string">"./cli.js"</span>  <span class="token comment">// 「neo」コマンドで動作するようにする</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依存パッケージ…</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>cli.js</code> の1行目は <code>#!/usr/bin/env node</code> という Shebang で始めること。</p>
<p>で、こんな風に作ったスクリプトを <code>$ neo</code> コマンドで実行できるようにするには、<strong>この作業ディレクトリで <code>$ npm install -g</code> する。</strong></p>
<p><code>package.json</code> があるディレクトリで <code>npm i -g</code> とすると、そのディレクトリ配下の資材がグローバルインストールされる。MacOS で試した限りは、資材がコピーされるのではなく<em>このディレクトリへのエイリアスが貼られる</em>ので、一度グローバルインストールさせた後にスクリプトを書き換えたり、別のライブラリをローカルインストールしたりしても、<code>npm install -g</code> で登録し直す必要はなく、即座に変更が反映される。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># こんな作業ディレクトリだとする</span>
$ <span class="token builtin class-name">pwd</span>
/Users/Neos21/work/neo

<span class="token comment"># グローバルインストールすると</span>
$ <span class="token function">npm</span> <span class="token function">install</span> -g
/usr/local/bin/neo -<span class="token operator">></span> /usr/local/lib/node_modules/neo/bin/neo
+ neo@1.0.0
updated <span class="token number">1</span> package <span class="token keyword">in</span> <span class="token number">0</span>.225s

<span class="token comment"># 確かにエイリアスが貼られていることが分かる</span>
$ <span class="token function">ls</span> -l /usr/local/lib/node_modules/
total <span class="token number">0</span>
lrwxr-xr-x   <span class="token number">1</span> Neos21  admin   <span class="token number">45</span> <span class="token number">11</span> <span class="token number">30</span> <span class="token number">11</span>:03 neo -<span class="token operator">></span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/Users/Neos21/work/neo
drwxr-xr-x  <span class="token number">25</span> Neos21  admin  <span class="token number">800</span>  <span class="token number">7</span> <span class="token number">23</span> <span class="token number">16</span>:21 <span class="token function">npm</span>
</code></pre>
<p>エイリアスになるので、「作業ディレクトリ」とは言いながらも、ファイルを消したりやたらと移動させたりしないよう注意。</p>
<p>この作業ディレクトリを Git 管理しておいて、PC 環境が変わった時は <code>git clone</code> → <code>npm install</code> → <code>npm install -g</code> としてやれば、元の環境が復元できそうだ。</p>
<ul>
  <li>参考：<a href="https://x-team.com/blog/a-guide-to-creating-a-nodejs-command/">A Guide to Creating a NodeJS Command-Line Package</a>
    <ul>
      <li><code>npm link</code> でも良いのかしら</li>
    </ul>
  </li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-01-01</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-01-01</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
