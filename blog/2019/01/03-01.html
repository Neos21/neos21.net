<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>iOS アプリのプロビジョニングプロファイルの有効期限をアプリ内で取得・表示する Swift コード - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/01/03-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/01/index.html">01月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-01-03</time></div>
        <h1 id="page-title">iOS アプリのプロビジョニングプロファイルの有効期限をアプリ内で取得・表示する Swift コード</h1>

<p>無料の Apple Developers Program アカウントを使っている場合、iOS にインストールした開発用アプリの有効期限は<strong>7日間</strong>で切れてしまう。</p>
<ul>
  <li><a href="/blog/2018/04/17-01.html">無料の開発者アカウントで iPhone にインストールしたアプリの有効期限を更新する方法</a></li>
</ul>
<p>この有効期限までの残日数を、アプリ内で取得・表示させられないか調べてみた。</p>
<h2 id="検証環境"><a class="header-link" href="#検証環境"><span class="header-link-mark"></span></a>検証環境</h2>
<ul>
  <li>macOS Mojave</li>
  <li>Xcode v10.1</li>
  <li>Swift v4.2.1
    <ul>
      <li>参考：<a href="https://qiita.com/s_emoto/items/30d5203db641857a1f75">【Swift】Swiftのversionを確認しよう - Qiita</a> … <code>$ /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift --version</code> で確認</li>
    </ul>
  </li>
  <li>iOS v12.0.1</li>
</ul>
<h2 id="アプリ内でプロビジョニングプロファイルの有効期限を知る方法"><a class="header-link" href="#アプリ内でプロビジョニングプロファイルの有効期限を知る方法"><span class="header-link-mark"></span></a>アプリ内でプロビジョニングプロファイルの有効期限を知る方法</h2>
<p>早速だが、以下のようなコードで、プロビジョニングプロファイルの有効期限を取得できる。</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token builtin">UIKit</span>

<span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token builtin">UIViewController</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ココでは画面上に置いたボタンをタップした時に実行するよう設定した</span>
  <span class="token atrule">@IBAction</span> <span class="token keyword">func</span> <span class="token function">onTapBtn</span><span class="token punctuation">(</span><span class="token number">_</span> sender<span class="token punctuation">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// embedded.mobileprovision ファイルを取得する</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token builtin">Bundle</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>forResource<span class="token punctuation">:</span> <span class="token string">"embedded"</span><span class="token punctuation">,</span> withExtension<span class="token punctuation">:</span> <span class="token string">"mobileprovision"</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"ファイル取得失敗"</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// plist としてパースする際にゴミになる箇所をちぎるための処理</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">?</span> <span class="token function">Data</span><span class="token punctuation">(</span>contentsOf<span class="token punctuation">:</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token string">"&#x3C;?xml"</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token string">"&#x3C;/plist>"</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> startRange <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> endRange <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> end<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"ファイル準備失敗"</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 余計な場所をちぎり plist から「ExpirationDate」キーの値を抜き出す</span>
    <span class="token keyword">let</span> range <span class="token operator">=</span> <span class="token function">Range</span><span class="token punctuation">(</span>uncheckedBounds<span class="token punctuation">:</span> <span class="token punctuation">(</span>lower<span class="token punctuation">:</span> startRange<span class="token punctuation">.</span>lowerBound<span class="token punctuation">,</span> upper<span class="token punctuation">:</span> endRange<span class="token punctuation">.</span>upperBound<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">subdata</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> range<span class="token punctuation">)</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> dictionary <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">?</span> <span class="token builtin">PropertyListSerialization</span><span class="token punctuation">.</span><span class="token function">propertyList</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> body<span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> <span class="token constant">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> plist <span class="token operator">=</span> dictionary <span class="token keyword">as</span><span class="token operator">?</span> <span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">:</span> <span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> expireDate <span class="token operator">=</span> plist<span class="token punctuation">[</span><span class="token string">"ExpirationDate"</span><span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token builtin">Date</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"plist 変換失敗"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ExpirationDate の値を日付形式に整形する</span>
    <span class="token keyword">let</span> dateFormat <span class="token operator">=</span> <span class="token function">DateFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    dateFormat<span class="token punctuation">.</span>locale <span class="token operator">=</span> <span class="token builtin">Locale</span><span class="token punctuation">.</span>current
    dateFormat<span class="token punctuation">.</span>timeZone <span class="token operator">=</span> <span class="token builtin">TimeZone</span><span class="token punctuation">.</span>current
    dateFormat<span class="token punctuation">.</span>dateFormat <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd"</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"期限日 (YYYY-MM-DD)"</span><span class="token punctuation">,</span> dateFormat<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> expireDate<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 「2019-01-07」などが取れる</span>
    
    <span class="token comment">// 現在日と比較して有効期限切れまでの残日数を計算する</span>
    <span class="token keyword">let</span> calendar <span class="token operator">=</span> <span class="token builtin">NSCalendar</span><span class="token punctuation">.</span>current
    <span class="token keyword">let</span> fromDate <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">startOfDay</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> toDate <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">startOfDay</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> expireDate<span class="token punctuation">)</span>
    <span class="token keyword">let</span> components <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">dateComponents</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>day<span class="token punctuation">]</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> fromDate<span class="token punctuation">,</span> to<span class="token punctuation">:</span> toDate<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"残日数"</span><span class="token punctuation">,</span> components<span class="token punctuation">.</span>day<span class="token operator">!</span><span class="token punctuation">)</span>  <span class="token comment">// 「7」などが取れる</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>このコードの大部分の元ネタは以下より。</p>
<ul>
  <li>参考：<a href="https://mike-neko.github.io/blog/provisioning/">Provisioning Profileの有効期限をアプリ内で取得 · M.Ike</a></li>
  <li>参考：<a href="https://gist.github.com/mike-neko/bdbedbb280883dff96b6a5a7062c67bd">provisioning.swift · GitHub</a></li>
</ul>
<p>Objective-C な以下のコードも参考になるかも。</p>
<ul>
  <li>参考：<a href="https://gist.github.com/steipete/7668246">Detect if you're currently running a development version or an App Store/Ad Hoc version. · GitHub</a></li>
</ul>
<p>やっていることは、</p>
<ol>
  <li>アプリに同梱されているプロビジョニングプロファイル <code>embedded.mobileprovision</code> を取得する</li>
  <li>その中から plist (XML) 部分を抜き出す</li>
  <li>その中から <code>ExpirationDate</code> プロパティの値 (<code>Date</code> ≒ <code>NSDate</code>) を取得する</li>
</ol>
<p>というのが主なモノ。</p>
<p>あとは表示用に整形したり、現在日との比較で有効期限切れまでの残日数を計算したりしている。</p>
<ul>
  <li>参考：<a href="https://stackoverflow.com/a/28163560/10092546">ios - Swift days between two NSDates - Stack Overflow</a> … 2つの日付間の日数を調べる方法</li>
</ul>
<p>iOS シミュレータで動かした場合はプロビジョニングプロファイルが要らないので、<code>print("ファイル取得失敗")</code> 部分の <code>return</code> で抜けてしまう。</p>
<h2 id="2つの日付を比較して日数を調べる方法"><a class="header-link" href="#2つの日付を比較して日数を調べる方法"><span class="header-link-mark"></span></a>2つの日付を比較して日数を調べる方法</h2>
<p>残日数の比較は、もう少し簡素なやり方もある。結果が小数になることに留意。</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> span <span class="token operator">=</span> expireDate<span class="token punctuation">.</span>timeIntervalSinceNow
<span class="token keyword">let</span> daySpan <span class="token operator">=</span> span <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">24</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"残日数"</span><span class="token punctuation">,</span> daySpan<span class="token punctuation">)</span>    <span class="token comment">// 6.99... などになる</span>
</code></pre>
<ul>
  <li>参考：<a href="http://swift.tecc0.com/?p=180">Swiftで日時を加算したり差を取得する方法 | Swift4 Web入門書</a></li>
</ul>
<p>他にも、人間が読みやすい形式に変換してくれるモノもあった。</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> dateComponentsFormatter <span class="token operator">=</span> <span class="token function">DateComponentsFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
dateComponentsFormatter<span class="token punctuation">.</span>allowedUnits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>day<span class="token punctuation">]</span>
dateComponentsFormatter<span class="token punctuation">.</span>maximumUnitCount <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"残日数"</span><span class="token punctuation">,</span> dateComponentsFormatter<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> expireDate<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span>  <span class="token comment">// "6d" などになる</span>
</code></pre>
<ul>
  <li>参考：<a href="https://egg-is-world.com/2018/05/15/date-components-formatter/">【iOS】X日やX時間などの文字列表現を簡単に作れる DateComponentsFormatter</a></li>
  <li>参考：<a href="https://code.i-harness.com/ja/q/19ec3c7">ios 2つのNSDateの差を（月/日/時/分/秒）で取得する swift macos - CODE Q&#x26;A 問題解決</a></li>
</ul>
<h2 id="有効期限の期間自体を知る方法"><a class="header-link" href="#有効期限の期間自体を知る方法"><span class="header-link-mark"></span></a>有効期限の期間自体を知る方法</h2>
<p>ちなみに、プロビジョニングプロファイルの有効期限の期間自体を知るには、<code>ExpirationDate</code> プロパティと同様に存在する、<code>TimeToLive</code> というプロパティを取得すれば良い。</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">let</span> timeToLive <span class="token operator">=</span> plist<span class="token punctuation">[</span><span class="token string">"TimeToLive"</span><span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">!</span> <span class="token builtin">Int</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"有効期間"</span><span class="token punctuation">,</span> timeToLive<span class="token punctuation">)</span>  <span class="token comment">// 「7」が取れる</span>
</code></pre>
<ul>
  <li>参考：<a href="http://kimagureneet.hatenablog.com/entry/2018/03/14/102526">【iOS】AdHoc版アプリが起動しなくなったときに調べたこと - とりあえずphpとか</a></li>
  <li>参考：<a href="https://potato.5ch.net/test/read.cgi/mac/1460975101/510">SDK iPhoneアプリ開発初心者質問箱46</a></li>
</ul>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>今回のサンプルコードでは <code>print()</code> しているだけだが、結果を画面に置いたテキストボックスなどに表示するようにすれば、アプリ上でも確認できるようになる。</p>
<p>コレで開発中のアプリを入れっぱなしにしていて「あっ期限切れてた」ということがなくなるだろう。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2019-01-03</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2019-01-03</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
