<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>踏み台サーバ経由で SSH ポートフォワーディングする手順 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/08/26-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-08-26</time></div>
        <h1 id="page-title">踏み台サーバ経由で SSH ポートフォワーディングする手順</h1>

<ul>
  <li><em>手元のパソコン</em>から</li>
  <li>パブリック IP を持っている<strong>踏み台サーバ</strong>を経由して</li>
  <li>プライベート IP しか持たない<em>目的のサーバ</em>に</li>
</ul>
<p>アクセスしたい。</p>
<p>そして、<strong>「手元の PC ⇔ 踏み台サーバ ⇔ 目的のサーバ」</strong>という経路で<em>ポートフォワーディング</em>して、「目的のサーバ」が <code>8080</code> ポートで公開している Web サーバを、「手元の PC」の <code>18080</code> ポートで受け取って閲覧してみる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%81%BE%E3%81%9A%E3%81%AF%E7%B5%8C%E8%B7%AF%E7%A2%BA%E8%AA%8D">まずは経路確認</a></li>
  <li><a href="#ssh-%E6%8E%A5%E7%B6%9A%E3%82%92%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">SSH 接続をポートフォワーディングしてみる</a></li>
  <li><a href="#%E3%81%93%E3%81%AE%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A%E3%82%92-sshconfig-%E3%81%AB%E6%9B%B8%E3%81%8F">このポートフォワード設定を <code>~/.ssh/config</code> に書く</a></li>
  <li><a href="#%E7%9B%AE%E7%9A%84%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE-web-%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B">「目的のサーバ」の Web サーバのポートをローカルにポートフォワードする</a></li>
  <li><a href="#%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%891%E7%99%BA%E3%81%A7%E3%83%90%E3%83%83%E3%82%AF%E3%82%B0%E3%83%A9%E3%82%A6%E3%83%B3%E3%83%89%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B">ポートフォワードをコマンド1発でバックグラウンド実行する</a></li>
</ul>
<h2 id="まずは経路確認"><a class="header-link" href="#まずは経路確認"><span class="header-link-mark"></span></a>まずは経路確認</h2>
<p>まずは、各サーバに入れることを確認する。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 手元の PC から踏み台サーバに SSH 接続する</span>
$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">22</span> bastion_user@129.000.0.00

<span class="token comment">## 踏み台サーバに接続できた</span>

<span class="token comment">## 踏み台サーバから目的のサーバに SSH 接続する</span>
<span class="token variable">$$</span> <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">22</span> target_user@target-host

<span class="token comment">### 目的のサーバに接続できた。目的のサーバの 8080 ポートには Web サーバが立っているテイ</span>
<span class="token variable">$$</span>$ <span class="token function">curl</span> http://localhost:8080/
Hello World, This server is TARGET-HOST.
</code></pre>
<p>ココが上手くいかない場合は、クラウド側のファイアウォール設定で22番ポートを封じている可能性がある。</p>
<p>このやり方の場合、「踏み台サーバ」から「目的のサーバ」に接続する際の鍵ファイル (<code>~/.ssh/id_rsa</code>) は、「踏み台サーバ」内に置いておく必要がある。</p>
<h2 id="ssh-接続をポートフォワーディングしてみる"><a class="header-link" href="#ssh-接続をポートフォワーディングしてみる"><span class="header-link-mark"></span></a>SSH 接続をポートフォワーディングしてみる</h2>
<p>続いて、SSH 接続をポートフォワードしてみる。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 手元の PC から踏み台サーバに接続し、「踏み台サーバから目的のサーバ」への接続経路を、ローカルの 10022 ポートに転送する</span>
$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">22</span> bastion_user@129.000.0.00 -L <span class="token number">10022</span>:target-host:22
</code></pre>
<p>このコマンドを実行すると、踏み台サーバに SSH ログインした状態になるので、<em>このターミナルタブはそのまま</em>にして、別のターミナルタブで、次のようにアクセスする。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">10022</span> target_user@localhost
</code></pre>
<p>このようにすると、「手元の PC の 10022 ポート」を指定しているが、ポートフォワード設定によって「目的のサーバ」に SSH ログインできる。</p>
<p>この際、「目的のサーバ」に接続するために使っている鍵ファイルは、「手元の PC」にある <code>~/.ssh/id_rsa</code> になるので、「踏み台サーバ」には秘密鍵ファイルを置いておく必要がなくなる。</p>
<h2 id="このポートフォワード設定を-sshconfig-に書く"><a class="header-link" href="#このポートフォワード設定を-sshconfig-に書く"><span class="header-link-mark"></span></a>このポートフォワード設定を <code>~/.ssh/config</code> に書く</h2>
<p>以上の2つのコマンドを <code>~/.ssh/config</code> に起こしてみると、以下のようになる。</p>
<pre><code>Host forward1
  HostName      129.000.0.00
  User          bastion_user
  Port          22
  IdentityFile  ~/.ssh/id_rsa
  LocalForward  10022 target-host:22

Host forward2
  HostName      localhost
  User          target_user
  Port          10022
  IdentityFile  ~/.ssh/id_rsa
</code></pre>
<p>ファイルを設定したら、<em><code>$ ssh -fN forward1</code></em> を実行したあと、別タブで <strong><code>$ ssh forward2</code></strong> と実行すると、目的のサーバに接続できる。</p>
<p><strong>どこに「踏み台サーバ (<code>bastion</code>)」の情報を書くか、「目的のサーバ (<code>target</code>)」の情報を書くか、どこでフォワードするポート番号を指定するのか</strong>を整理して理解しておこう。</p>
<h2 id="目的のサーバの-web-サーバのポートをローカルにポートフォワードする"><a class="header-link" href="#目的のサーバの-web-サーバのポートをローカルにポートフォワードする"><span class="header-link-mark"></span></a>「目的のサーバ」の Web サーバのポートをローカルにポートフォワードする</h2>
<p>ココまででポートフォワーディングのやり方が分かったと思うので、「目的のサーバ」が <code>8080</code> ポートで公開している Web サーバを、「手元の PC」の <code>18080</code> ポートで受け取って閲覧してみる。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">22</span> bastion_user@129.000.0.00 -L <span class="token number">18080</span>:target-host:8080
</code></pre>
<p>このように叩くと踏み台サーバにログインした状態になるので、<em>このターミナルタブはこのまま</em>に、ブラウザで次の URL にアクセスする。</p>
<ul>
  <li><code>http://localhost:18080/</code></li>
</ul>
<p>ローカルの <code>18080</code> ポートにアクセスすると、踏み台サーバを経由して、「目的のサーバ」の <code>8080</code> ポートの内容が閲覧できる。最初に書いた例で行くと「<code>Hello World, This server is TARGET-HOST.</code>」なんていうメッセージが見えている、というワケだ。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># curl で見てみても良い</span>
$ <span class="token function">curl</span> http://localhost:18080/
Hello World, This server is TARGET-HOST.
</code></pre>
<h2 id="ポートフォワードをコマンド1発でバックグラウンド実行する"><a class="header-link" href="#ポートフォワードをコマンド1発でバックグラウンド実行する"><span class="header-link-mark"></span></a>ポートフォワードをコマンド1発でバックグラウンド実行する</h2>
<p>先程のやり方だと、踏み台サーバにログインした状態のターミナルタブが残ってしまう。コレではタブが邪魔臭いので、コマンド1発で実行したら、バックグラウンド実行してくれるようにしてみる。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa -p <span class="token number">22</span> bastion_user@129.000.0.00 -L <span class="token number">18080</span>:target-host:8080 -N -f -o <span class="token assign-left variable">ServerAliveInterval</span><span class="token operator">=</span><span class="token number">60</span>
</code></pre>
<p>前半の <code>-i</code>・<code>-p</code>・踏み台サーバ情報、<code>-L</code> オプションによるポートフォワード指定までは全く同じ。違いは <code>-N</code> 以降のオプション群だ。</p>
<p>コレを指定して実行すると、SSH 接続後にプロンプトが元に戻り、SSH 接続のプロセスがバックグランド実行される。MacOS の場合は「ターミナル.app」自体を終了させても、<code>http://localhost:18080/</code> にアクセスできる。</p>
<p>裏側ではずっとポートフォワードした状態になるので、ポートフォワードを終了する場合は、<code>$ ps x | grep ssh</code> でプロセス ID を調べ、<code>kill</code> してやる。</p>
<hr>
<p>以上だ。</p>
<ul>
  <li>参考：<a href="https://qiita.com/hkak03key/items/3b0c4752bfbcc52e676d">踏み台サーバを飛び越えて一発で目的のサーバへsshする方法 - Qiita</a></li>
  <li>参考：<a href="http://www.koikikukan.com/archives/2016/09/15-000300.php">SSHポートフォワーディング（トンネリング）とは: 小粋空間</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2019-08-26</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2019-08-26</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
