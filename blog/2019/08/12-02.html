<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>XREA のサーバに SSH 接続する - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/08/12-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-08-12</time></div>
        <h1 id="page-title">XREA のサーバに SSH 接続する</h1>

<p>メインサイト Neo's World は、<em>XREA</em> というウェブホスティングサービスのかなり初期の頃に取得したアカウントだ。コレ以前に <code>s15</code> サーバも取得していたし、別サイトで <code>s38</code>・<code>s41</code>・<code>s58</code> サーバなどをレンタルしたことがある。さらに最近、Yahoo! Geocities の閉鎖に伴う移行キャンペーンを利用して、<code>g3</code> サーバを借りられた。</p>
<p>そんな XREA だが、どうやらサーバに SSH 接続できるようなので、試してみた。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E6%8E%A5%E7%B6%9A%E5%85%83-ip-%E8%A8%B1%E5%8F%AF%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A1%8C%E3%81%86">接続元 IP 許可設定を行う</a></li>
  <li><a href="#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6-ssh-%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B">パスワードを使って SSH 接続する</a></li>
  <li><a href="#%E5%85%AC%E9%96%8B%E9%8D%B5%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">公開鍵ファイルを設定する</a></li>
  <li><a href="#xrea-api-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E6%AF%8E%E5%BA%A6%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%82%92%E6%A5%BD%E3%81%AB%E3%81%99%E3%82%8B">XREA API を利用して毎度の接続を楽にする</a>
    <ul>
      <li><a href="#api-key-%E3%81%AE%E7%99%BA%E8%A1%8C">API Key の発行</a></li>
      <li><a href="#%E6%8E%A5%E7%B6%9A%E5%85%83-ip-%E8%A8%B1%E5%8F%AF-api-%E3%82%92-curl-%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">接続元 IP 許可 API を <code>curl</code> でコールする</a></li>
      <li><a href="#%E3%81%82%E3%81%A8%E3%81%AF-ssh-%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%AE%E3%81%BF">あとは SSH 接続するのみ</a></li>
    </ul>
  </li>
  <li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>
<h2 id="接続元-ip-許可設定を行う"><a class="header-link" href="#接続元-ip-許可設定を行う"><span class="header-link-mark"></span></a>接続元 IP 許可設定を行う</h2>
<p>まず、SSH 接続したいマシンにて、XREA の管理画面にログインする。左メニューの「サイト設定」→「ツール/セキュリティー」と進み、「SSH 接続 IP 許可」セクションで<em>「SSH 接続 IP 許可」</em>ボタンを押下する。</p>
<p>コレで、このマシンの IP アドレスから SSH 接続できるようになる。ポケット Wi-Fi を使っていたりして <strong>IP が変動する場合は、SSH 接続の前に都度コレを行う必要がある。</strong></p>
<h2 id="パスワードを使って-ssh-接続する"><a class="header-link" href="#パスワードを使って-ssh-接続する"><span class="header-link-mark"></span></a>パスワードを使って SSH 接続する</h2>
<p>続いて、アカウントのパスワードを使って SSH 接続を行う。ココで入力するパスワードは、「サイト設定」→「サイト一覧」→「FTP/SFTP 接続情報」欄で確認できるパスワードだ。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">ssh</span> -l 【ID】 【Server】.xrea.com

<span class="token comment"># この後パスワードを聞かれるので入力する</span>
</code></pre>
<p>すると SSH 接続できるはずだ。</p>
<h2 id="公開鍵ファイルを設定する"><a class="header-link" href="#公開鍵ファイルを設定する"><span class="header-link-mark"></span></a>公開鍵ファイルを設定する</h2>
<p>SSH 接続後は、<code>sudo</code> などは出来ないものの、一般的な Linux サーバとして利用できるので、公開鍵認証による SSH 接続のための手順を取れば、SSH 鍵でアクセスできるようになる。いわゆる <code>authorized_keys</code> ファイルの準備、ということだ。</p>
<p>まずは接続元のローカルマシンで、SSH 鍵ペアを発行しておこう。</p>
<pre class="language-bash"><code class="language-bash">$ ssh-keygen -t rsa -b <span class="token number">4096</span> -N <span class="token string">''</span> -C <span class="token string">'NeosXreaKey'</span>
</code></pre>
<p>ファイルは <code>~/.ssh/id_rsa</code> (秘密鍵)、<code>~/.ssh/id_rsa.pub</code> (公開鍵) の2ファイルが出力できたものとする。</p>
<p>続いて、先程パスワードを使って SSH 接続した XREA サーバ側で、以下のように作業する。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># ~/.ssh/ ディレクトリを作り権限を設定する</span>
<span class="token variable">$$</span> <span class="token function">mkdir</span> .ssh
<span class="token variable">$$</span> <span class="token function">chmod</span> <span class="token number">700</span> .ssh
<span class="token variable">$$</span> <span class="token builtin class-name">cd</span> .ssh

<span class="token comment"># ~/.ssh/authorized_keys ファイルを作成する</span>
<span class="token variable">$$</span> <span class="token function">touch</span> authorized_keys
<span class="token variable">$$</span> <span class="token function">chmod</span> <span class="token number">600</span> authorized_keys

<span class="token comment"># このファイルの中に、先程発行した公開鍵ファイルの内容をコピペする</span>
<span class="token variable">$$</span> <span class="token function">vi</span> authorized_keys
</code></pre>
<p>設定ができたら、このターミナルは一旦接続したままにしておいて、別のターミナルウィンドウから、公開鍵認証による SSH 接続ができるか試してみる。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 秘密鍵ファイルを使ってアクセスできるか試す</span>
$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa 【ID】@【Server】.xrea.com
</code></pre>
<p>接続できるようなら問題なし。</p>
<h2 id="xrea-api-を利用して毎度の接続を楽にする"><a class="header-link" href="#xrea-api-を利用して毎度の接続を楽にする"><span class="header-link-mark"></span></a>XREA API を利用して毎度の接続を楽にする</h2>
<p>コレで XREA サーバに SSH 接続できるようにはなったが、IP が変動する場合、XREA 管理画面から「接続元 IP 許可」を毎回行わないといけないのは面倒だ。</p>
<p>そこで、XREA が公開している API を利用して、この許可設定をコマンドラインから行ってしまおうと思う。</p>
<h3 id="api-key-の発行"><a class="header-link" href="#api-key-の発行"><span class="header-link-mark"></span></a>API Key の発行</h3>
<p>先に、API コールに使用する API Key を発行する。</p>
<p>XREA 管理画面の右上、ユーザアイコンから「契約情報」を選び、最下部の「API KEY」セクションに移動する。「API KEY 発行」ボタンを押下すると、API Key 文字列が取得できるので、コレをコピーしておく。</p>
<h3 id="接続元-ip-許可-api-を-curl-でコールする"><a class="header-link" href="#接続元-ip-許可-api-を-curl-でコールする"><span class="header-link-mark"></span></a>接続元 IP 許可 API を <code>curl</code> でコールする</h3>
<p>接続元 IP 許可の API リファレンスは以下。</p>
<ul>
  <li>参考：<a href="https://apidoc.xrea.com/#/tool/2017/07/19/tool-ssh-add.html">Xrea Coreserver API Document</a></li>
</ul>
<p>XREA API のちょっと独特な点として、リクエストパラメータは JSON 形式ではなく、<em>Key・Value 形式</em>で送れ、とのことである。この書き方がイマイチ分からなかったので試行錯誤したが、<code>curl</code> コマンドの場合は</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">curl</span>  -d <span class="token string">'Key1=Value1'</span>  -d <span class="token string">'Key2=Value2'</span>
</code></pre>
<p>といった形で、1項目ずつ指定していけば良いと分かった。</p>
<p><code>param.addr</code> のように、ネスト構造になっている Key については、</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">curl</span>  -d <span class="token string">'Key[SubKey]=Value1'</span>  -d <span class="token string">'param[addr]=Value2'</span>
</code></pre>
<p>というように書けば良い。</p>
<p>まずは試しに、ユーザ情報を取得するだけの API をコールしてみよう。<code>\</code> 記号で1コマンドを改行してみせたが、1行にまとめても良い。API Key、アカウントの ID、サーバ番号を代入する。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> -X POST https://api.xrea.com/v1/user/info <span class="token punctuation">\</span>
      -d <span class="token string">'api_secret_key=【API Key】'</span> <span class="token punctuation">\</span>
      -d <span class="token string">'account=【ID】'</span> <span class="token punctuation">\</span>
      -d <span class="token string">'server_name=【Server】.xrea.com'</span>
</code></pre>
<p>うまくユーザ情報の JSON が取得できたら OK。</p>
<p><em>接続元 IP を許可するための API</em> は、以下のように叩くと良いだろう。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> -X POST https://api.xrea.com/v1/tool/ssh_ip_allow <span class="token punctuation">\</span>
      -d <span class="token string">'api_secret_key=【API Key】'</span> <span class="token punctuation">\</span>
      -d <span class="token string">'account=【ID】'</span> <span class="token punctuation">\</span>
      -d <span class="token string">'server_name=【Server】.xrea.com'</span> <span class="token punctuation">\</span>
      -d <span class="token string">"param[addr]=<span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> -sS ifconfig.me<span class="token variable">`</span></span>"</span>
</code></pre>
<p><code>param[addr]</code> に与える値として、<code>$ curl -sS ifconfig.me</code> というコマンドで取得した自身の IP アドレスを設定している。このコマンドを単体で叩くと分かるが、<code>ifconfig.me</code> というサイトがアクセス元の Public IP アドレスを返してくれるので、それを設定しているというワケ。</p>
<h3 id="あとは-ssh-接続するのみ"><a class="header-link" href="#あとは-ssh-接続するのみ"><span class="header-link-mark"></span></a>あとは SSH 接続するのみ</h3>
<p>接続元 IP を許可できたら、あとは SSH 接続するのみ。パスワード入力でも、公開鍵認証でも、どちらでも変わらない。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># パスワード入力式</span>
$ <span class="token function">ssh</span> -l 【ID】 【Server】.xrea.com

<span class="token comment"># 鍵認証式</span>
$ <span class="token function">ssh</span> -i ~/.ssh/id_rsa 【ID】@【Server】.xrea.com
</code></pre>
<p>パスワード認証の方は、対話式プロンプトになるのが避けられないので、以前紹介した <em><code>expect</code>・<code>spawn</code>・<code>send</code> コマンドの複合技でパスワード入力を自動化</em>すると楽になるだろう。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">expect</span> -c <span class="token string">"
set timeout 5
spawn ssh -l 【ID】 【Server】.xrea.com
expect <span class="token entity" title="\&#x22;">\"</span>【ID】@【Server】.xrea.com's password:<span class="token entity" title="\&#x22;">\"</span>
send <span class="token entity" title="\&#x22;">\"</span>【Password】<span class="token entity" title="\n">\n</span><span class="token entity" title="\&#x22;">\"</span>
interact
"</span>
</code></pre>
<ul>
  <li><a href="/blog/2018/09/19-01.html">SSH 接続のパスワード入力を自動化するシェルスクリプトを作ってコマンド化した</a></li>
</ul>
<hr>
<p>以上。</p>
<p>XREA サーバに SSH 接続できると、色々と夢がひろがりんぐだ。</p>
<h2 id="参考"><a class="header-link" href="#参考"><span class="header-link-mark"></span></a>参考</h2>
<ul>
  <li>XREA サーバへの SSH 接続について
    <ul>
      <li><a href="http://mage8.com/websitetips/ssh.html">xreaにSSHでシェルログイン</a></li>
      <li><a href="http://d.hatena.ne.jp/kbi_webmaster/20101229">2010-12-29</a></li>
      <li><a href="http://masarap.club/archives/1243">xreaやcoreサーバーのssh接続が、公開鍵認証に対応していた | 暗中模索</a></li>
    </ul>
  </li>
  <li><code>curl</code> の書き方について
    <ul>
      <li><a href="https://blog.kyanny.me/entry/20110427/1303838381">curl(1) で POST する際の --data と --form の違いについて - @kyanny's blog</a></li>
      <li><a href="http://komaji504.hateblo.jp/entry/2016/03/26/202724">curl のオプション小まとめ - ドン・エンジニーア</a></li>
    </ul>
  </li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-08-12</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-08-12</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
