<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>永久無料枠で Google Compute Engine (GCE) インスタンスを立ち上げる : その1 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/08/01-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script defer src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-08-01</time></div>
        <h1 id="page-title">永久無料枠で Google Compute Engine (GCE) インスタンスを立ち上げる : その1</h1>

<p>どういうワケか、Heroku で PaaS を触ったあと、Oracle Cloud Infrastructure (OCI) で IaaS 入門してしまった。せっかくなので <em>Google Cloud Platform (GCP)</em> も始めてみよう、と思い、GCP の中の「<strong>Google Compute Engine (GCE)</strong>」という仮想マシン (VM) を借りられるサービスを使ってみることにした。OCI でいうところの「Compute Instance」を借りるのと同じ領域だ。</p>
<p>ただ、GCE の凄いところは、<strong>低スペックな VM を1台だけなら完全無料で借りられる</strong>、というところだ。いわゆる「永久無料枠」というヤツなので、お金をかけずにお試しするにはもってこいだ。</p>
<p>今回は、GCP の初回登録から、GCE のインスタンス作成、そしてとりあえず SSH 接続するところまでを試してみる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#gcp-%E3%81%AE%E7%84%A1%E6%96%99%E6%9E%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">GCP の無料枠について</a></li>
  <li><a href="#gce-%E3%81%AE-always-free-%E6%B0%B8%E4%B9%85%E7%84%A1%E6%96%99%E6%9E%A0-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">GCE の Always Free (永久無料枠) について</a></li>
  <li><a href="#google-cloud-platform-%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B">Google Cloud Platform に登録する</a></li>
  <li><a href="#gce-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">GCE インスタンスを作成する</a></li>
  <li><a href="#ssh-%E9%8D%B5%E3%83%9A%E3%82%A2%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">SSH 鍵ペアを作成する</a></li>
  <li><a href="#ssh-%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92-vm-%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">SSH 公開鍵を VM に設定する</a></li>
  <li><a href="#ssh-%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B">SSH 接続する</a></li>
  <li><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E4%B8%8A%E3%82%84%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%8D%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%AF%E6%AC%A1%E5%9B%9E">セキュリティ上やっておきたいことは次回</a></li>
</ul>
<h2 id="gcp-の無料枠について"><a class="header-link" href="#gcp-の無料枠について"><span class="header-link-mark"></span></a>GCP の無料枠について</h2>
<p>GCP の無料枠については、GCE 以外にもいくつかのサービスがある。詳しくは以下より。</p>
<ul>
  <li><a href="https://cloud.google.com/free/">GCP Free Tier - Free Extended Trials and Always Free  |  Google Cloud</a></li>
</ul>
<p>GCP に登録すると、登録から1年間だけ使える、300ドル分のクレジットが無料でもらえる。つまり最初の1年間のうちは、300ドル分の有料サービスを使っても課金されない、ということだ。</p>
<p>また、この300ドルを超過したり、1年を超えて無料トライアル期間が終了しても、動かしていたサービスが止められるだけで、いきなり課金されることはない。最初にクレジットカード情報を登録するものの、手動で有料アカウントに設定しない限りは課金されないので安心だ。</p>
<h2 id="gce-の-always-free-永久無料枠-について"><a class="header-link" href="#gce-の-always-free-永久無料枠-について"><span class="header-link-mark"></span></a>GCE の Always Free (永久無料枠) について</h2>
<p>GCP の中の、VM を借りられる GCE については、以下の条件下であればずっと無料で使える。</p>
<ol>
  <li>f1-micro インスタンスが1台だけ借りられる
    <ul>
      <li>インスタンスは北バージニア (us-east4) 以外の米国リージョンで借りる必要がある。日本リージョンなどで借りると有料になってしまうので注意</li>
      <li>米国リージョンなので、通信のレイテンシがある他、f1-micro というインスタンス種別は一番スペックが低い VM なので、スペックには期待できない</li>
    </ul>
  </li>
  <li>30GB 分の HDD まで
    <ul>
      <li>f1-micro インスタンスにアタッチできる記憶媒体は、30GB 分までの HDD のみ。それ以上の HDD を指定すると有料になる</li>
    </ul>
  </li>
  <li>北米から全リージョン宛の下りネットワーク通信が1ヶ月あたり 1GB まで。中国とオーストラリアへの通信は最初から有料
    <ul>
      <li>VM から外にアクセスするネットワーク通信は、月に 1GB までが無料。大量にファイルをダウンロードするような通信をすると、通信部分が課金されるということだ</li>
    </ul>
  </li>
</ol>
<p>というワケで、VM を起動させっぱなしでも課金はされないが、アウトバウンド通信が多いと課金されるし、マシンスペックや HDD のサイズが必要な場合は無料枠では厳しいということになる。</p>
<h2 id="google-cloud-platform-に登録する"><a class="header-link" href="#google-cloud-platform-に登録する"><span class="header-link-mark"></span></a>Google Cloud Platform に登録する</h2>
<p>それではいよいよ GCP を始めよう。</p>
<p>まずは GCP に登録する。以下のページが無料枠の紹介ページも兼ねているので、ココで無料枠の内容を確認してから、「登録を開始」ボタンで登録していこう。</p>
<ul>
  <li><a href="https://cloud.google.com/free/">GCP Free Tier - Free Extended Trials and Always Free  |  Google Cloud</a></li>
</ul>
<p>自分は Google AdSense を利用していて、クレジットカード情報を登録してあるアカウントがあったので、それを利用して GCP に登録することにした。</p>
<p>
  <img src="01-01-07.png" alt="ようこそ">
</p>
<h2 id="gce-インスタンスを作成する"><a class="header-link" href="#gce-インスタンスを作成する"><span class="header-link-mark"></span></a>GCE インスタンスを作成する</h2>
<p>GCP に登録できたら、VM を作っていこう。GCP 管理コンソール画面左上のハンバーガーメニューから「Compute Engine」→「VM インスタンス」を選択する。</p>
<p>
  <img src="01-01-05.png" alt="VM インスタンス">
</p>
<p>初回は1・2分待たされるが、「作成」ボタンを押下して次に進む。</p>
<p>
  <img src="01-01-04.png" alt="少し待つ">
</p>
<p>「インスタンスの作成」画面に移動したら、次のように設定していく。</p>
<ul>
  <li>名前 : 半角英数字で任意。コレが VM のユーザ名になる</li>
  <li>リージョン : US リージョンを選ぶこと。日本から近いのは <code>us-west-1</code> など、西海岸のリージョン</li>
  <li>ゾーン : 選択した US リージョン内でお好きに</li>
  <li>マシンタイプ : micro (コレが f1-micro インスタンスのこと)</li>
  <li>イメージ : OS を選べる。デフォルトは Debian だと思うが、CentOS なども使える
    <ul>
      <li>ココでプリセット以外のイメージを選ぶと課金されてしまうので注意。Debian か CentOS のどちらかぐらいにしておこう</li>
    </ul>
  </li>
  <li>ブートディスク : 上限の 30GB に設定しておく</li>
  <li>ファイアウォール : チェックボックスにより 80 (HTTP) ポートや 443 (HTTPS) ポートを簡単に開放できるが、今は開放しないでおく</li>
</ul>
<p>
  <img src="01-01-03.png" alt="赤枠部分に注意">
</p>
<p>
  <img src="01-01-02.png" alt="OS を選択">
</p>
<p>
  <img src="01-01-01.png" alt="確認">
</p>
<p>設定した内容で本当に課金されないか確認するには、右ペインの費用計算を見てみれば良い。問題なければインスタンスを作成する。</p>
<p>作成が完了したら、VM の一覧で<strong>パブリック IP (= 外部 IP)</strong> が確認できるようになるはずなので、コレを控えておく。</p>
<p>
  <img src="01-01-06.png" alt="IP が分かる">
</p>
<p>この Public IP はインスタンスの終了ごとに変わってしまうもので、設定次第で固定 Public IP にもできるので、次回紹介する。今回はこの変動 Public IP をメモしておこう。</p>
<h2 id="ssh-鍵ペアを作成する"><a class="header-link" href="#ssh-鍵ペアを作成する"><span class="header-link-mark"></span></a>SSH 鍵ペアを作成する</h2>
<p>VM が作れたら、SSH 接続するための鍵ペアを作成する。</p>
<p>Windows GitBash や MacOS 標準ターミナルなどを開き、以下のようにコマンドを入力する。</p>
<pre class="language-bash"><code class="language-bash">$ ssh-keygen -t rsa -b <span class="token number">4096</span> -f ~/.ssh/my_gce_vm -N <span class="token string">''</span> -C <span class="token string">'【VM 作成時に入力した「名前」】'</span>
</code></pre>
<p>VM 作成時に「名前」欄に入力した文字列を、<code>-C</code> (コメント) オプションに書くのが特徴。GCE の場合は、この <code>-C</code> オプションによるコメントが任意のコメントではなく、ユーザ名を特定するために使われているようなのだ。</p>
<p>コレで、<code>~/.ssh/</code> 配下に、<code>my_gce_vm</code> (秘密鍵) と <code>my_gce_vm.pub</code> (公開鍵) の2ファイルが生成されるはずだ。次の手順で使うので、公開鍵ファイルの中身をコピーしておく。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">cat</span> ~/.ssh/my_gce_vm.pub

<span class="token comment"># 以下のような文字列が表示されるはずなので全部コピーしておく</span>
ssh-rsa xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 【VM 名】
</code></pre>
<h2 id="ssh-公開鍵を-vm-に設定する"><a class="header-link" href="#ssh-公開鍵を-vm-に設定する"><span class="header-link-mark"></span></a>SSH 公開鍵を VM に設定する</h2>
<p>GCP 管理コンソールで、作成した VM インスタンスを選び、編集画面に移動する。</p>
<p>「SSH 認証鍵」セクションに移動すると、SSH キーを入力できるテキストエリアが表示される。ココに、先程確認した公開鍵ファイル (<code>my_gce_vm.pub</code>) の内容を全量貼り付けて保存する。</p>
<p>
  <img src="01-01-08.png" alt="編集">
</p>
<h2 id="ssh-接続する"><a class="header-link" href="#ssh-接続する"><span class="header-link-mark"></span></a>SSH 接続する</h2>
<p>公開鍵設定が終わったので、いよいよ VM にアクセスしてみる。</p>
<p>以下の要領で SSH 接続できるはずだ。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 秘密鍵ファイルを指定する</span>
$ <span class="token function">ssh</span> -i ~/.ssh/my_gce_vm 【VM 名】@【Public IP】

<span class="token comment"># VM の名前が「neosvm」、パブリック IP が「38.154.10.0」だったとしたら、こんな風になる</span>
$ <span class="token function">ssh</span> -i ~/.ssh/my_gce_vm neosvm@38.154.10.0
</code></pre>
<p>VM 名のユーザで SSH 接続できただろうか。このユーザは <code>$ sudo su -</code> で root 権限を利用できるので、VM 内でほとんど好きなようにできる。</p>
<h2 id="セキュリティ上やっておきたいことは次回"><a class="header-link" href="#セキュリティ上やっておきたいことは次回"><span class="header-link-mark"></span></a>セキュリティ上やっておきたいことは次回</h2>
<p>ココまでで、GCP に登録し、永久無料枠の GCE インスタンスを立て、そこに SSH 接続できた。</p>
<p>しかし、このままでは、セキュリティ上の問題や、使い勝手の悪い部分がある。例えば以下のような点だ。</p>
<ul>
  <li>万が一課金が発生した時に気が付きにくい</li>
  <li>SSH 接続用に22番ポートが開いており、侵入の危険性がある</li>
  <li>Public IP が VM の終了に応じて変動してしまう</li>
</ul>
<p>それぞれ、「予算アラートを設定する」「22番ポートを閉じて別のポートで SSH 接続できるようにする」「固定 Public IP を割り当てる」といった作業で対処できるので、次回の記事も合わせて確認し、安全に利用できるよう設定をしてほしい。</p>
<p>今日のところはココまで。</p>
<ul>
  <li>参考 : <a href="https://qiita.com/Brutus/items/22dfd31a681b67837a74">これから始めるGCP（GCE） 安全に無料枠を使い倒せ - Qiita</a></li>
  <li>参考 : <a href="https://qiita.com/ndxbn/items/7ef0a96e409a5b5837bd">GCE の無料枠のサーバを立るときに、初見でハマりそうなところ - Qiita</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-08-01</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-08-01</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
