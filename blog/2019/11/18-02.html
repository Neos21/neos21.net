<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>SSH Config の管理を捗らせる Include と、ホストを一覧表示するワンライナー - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/11/18-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-11-18</time></div>
        <h1 id="page-title">SSH Config の管理を捗らせる Include と、ホストを一覧表示するワンライナー</h1>

<p><code>~/.ssh/config</code> (SSH Config) というファイルに、SSH 接続情報を記載しておける。当然、コマンドをイチイチ打つより便利なので多用しているのだが、最近そろそろ登録ホスト数が増えてきて、1ファイルに書いておくのが大変になってきた。</p>
<p>そこで調べてみると、どうやら <code>Include</code> という命令文を使うと SSH Config の内容を別ファイルに切り出せるようだ。</p>
<ul>
  <li><code>~/.ssh/config</code></li>
</ul>
<pre><code>Include config-something.conf

Include config-other.conf
</code></pre>
<p>こんな感じ。<code>config-something.conf</code> と <code>config-other.conf</code> というファイルは、<code>~/.ssh/</code> ディレクトリ配下、<code>config</code> ファイルと同階層に置いておく。</p>
<p>ファイル名や拡張子は自由だが、自分は <code>~/.ssh/</code> ディレクトリ配下が煩雑にならないように、<strong><code>config-【任意文字列】.conf</code> という名前で統一</strong>することにした。</p>
<h2 id="host-でアスタリスク--を使える"><a class="header-link" href="#host-でアスタリスク--を使える"><span class="header-link-mark"></span></a>Host でアスタリスク <code>*</code> を使える</h2>
<p>ついでに、SSH Config の Host 定義では、アスタリスク <code>*</code> を使った一括指定ができたりするので、コレで記述量を少なくしたりもできる。</p>
<pre><code># Foo システムの踏み台サーバ
Host foo-system-bastion
  HostName        10.120.0.1
  User            bastion
  Port            22
  IdentityFile    ~/.ssh/key-foo-system-bastion

# Foo システムの AP サーバ・開発機
Host foo-system-ap-dev
  HostName        10.120.10.1

# Foo システムの AP サーバ・ステージング機
Host foo-system-ap-staging
  HostName        10.120.20.1

# Foo システムの AP サーバ 開発機・ステージング機に共通する設定
Host foo-system-ap-*
  User            admin
  IdentityFile    ~/.ssh/key-foo-system-ap
  Port            22
  ProxyCommand    ssh foo-system-bastion -W %h:%p
</code></pre>
<p>本来は <code>Host foo-system-bastion</code> のように、HostName、User、IdentityFile などを全部書かないといけないが、<em><code>foo-system-ap-dev</code> と <code>foo-system-ap-staging</code> の2つは、HostName しか書いていない。</em></p>
<p>じゃあユーザ名や SSH 鍵はどこで指定しているの？というと、<code>Host foo-system-ap-*</code> という宣言部分。ココは HostName 以外の情報を指定して、アスタリスクを使い、「<code>foo-system-ap-</code> で始まる Host」に対する共通の指定を記述している。</p>
<p>SSH Config は記述した順に優先的に値が使用されるので、こうした共通的な内容は最後の方に書いておくと、同じ項目の指定が被った時に、個別に指定した方を優先できる。</p>
<h2 id="ssh-config-で宣言したホスト一覧を出力する"><a class="header-link" href="#ssh-config-で宣言したホスト一覧を出力する"><span class="header-link-mark"></span></a>SSH Config で宣言したホスト一覧を出力する</h2>
<p>さて、<code>Include</code> によるファイル分割や、アスタリスクを使った共通事項の切り出しができて、たくさんのホスト情報を管理しやすくなった。</p>
<p>最後に、こうして記述した SSH Config のファイル群から、ホスト名の一覧を出力するためのワンライナーを紹介する。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">grep</span> -rh <span class="token string">'^Host '</span> <span class="token string">"<span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.ssh/"</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token string">'*'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/Host /ssh /'</span> <span class="token operator">|</span> <span class="token function">sort</span>
</code></pre>
<p><code>~/.ssh/</code> ディレクトリ内の全ファイルから、行頭に <code>Host</code> と書いてある行を <code>grep</code> している。</p>
<p>コレだけだと、先程のようにアスタリスク指定した共通部分の情報も取得されてしまうので、<code>grep -v</code> でアスタリスクを含む行を除外している。</p>
<p>こうすると <code>Host hoge</code> とか <code>Host fuga</code> といった宣言部分の行が羅列される。ココまででも良いのだが、<code>Host</code> 部分の文字列を <code>ssh</code> と変えてやれば、そのままコピペして SSH 接続するためのコマンドになるので、<code>sed</code> で置換し、<code>sort</code> してある。</p>
<p><code>~/.bashrc</code> などでエイリアスにするならこんな感じ。</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">sshls</span><span class="token operator">=</span><span class="token string">'grep -rh '</span><span class="token punctuation">\</span>'<span class="token string">'^Host '</span><span class="token punctuation">\</span>'<span class="token string">' "<span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.ssh/" | grep -v '</span><span class="token punctuation">\</span>'<span class="token string">'*'</span><span class="token punctuation">\</span>'<span class="token string">' | sed '</span><span class="token punctuation">\</span>'<span class="token string">'s/Host /ssh /'</span><span class="token punctuation">\</span>'<span class="token string">' | sort'</span>
</code></pre>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>SSH Config には、他にも <code>exec</code> で実行したコマンドの戻り値に応じて Host 定義を設定できる <code>Match</code> 機能などがあったりする。条件分岐みたいなこともできるワケなので、今後もどんどんその機能を活用していきたい。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2019-11-18</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2019-11-18</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
