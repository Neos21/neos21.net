<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ) - Neo's World">
    <meta property="og:description" content="LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ) - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2019/02/28-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ) - Neo's World">
    <meta property="twitter:description" content="LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ) - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2019/02/28-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ) - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/02/28-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MZCGD23');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MZCGD23" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/02/index.html">02月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-02-28</time></div>
        <h1 id="page-title">LINE Messaging API : Reply API におけるリプライトークンの有効期限は30秒 (独自調べ)</h1>

<p>前回、<em>LINE Messaging API</em> を利用してユーザにオウム返しするチャットボットを作成したが、その際「<strong>Reply API</strong>」という API を利用してユーザへの返信を行った。</p>
<ul>
  <li><a href="/blog/2019/02/27-01.html">LINE Messaging API を使ってオウム返しする Node.js 製チャットボットを作ってみる</a></li>
</ul>
<p>今回は、この Reply API に関する仕様について。</p>
<h2 id="reply-api-とは"><a class="header-link" href="#reply-api-とは"><span class="header-link-mark"></span></a>Reply API とは</h2>
<p>Reply API は、リクエストに付与されている「<em>リプライトークン</em>」というモノをキーにして返信処理が行える仕組みだ。開発者はユーザ ID などを知らなくても返信ができ、Messaging API において最も利用される API であろう。</p>
<h2 id="リプライトークンに有効期限がある"><a class="header-link" href="#リプライトークンに有効期限がある"><span class="header-link-mark"></span></a>リプライトークンに有効期限がある</h2>
<p>この「リプライトークン」には有効期限があるので、メッセージを受信したらできるだけ素早く返信しないといけない。</p>
<blockquote>
  <p>応答トークンは一定の期間が経過すると無効になるため、メッセージを受信したらすぐに応答を返す必要があります。応答トークンは1回のみ使用できます。</p>
  <ul>
    <li>参考 : <a href="https://developers.line.biz/ja/reference/messaging-api/#send-reply-message">Messaging APIリファレンス</a></li>
  </ul>
</blockquote>
<p>このとおり、公式の API リファレンスでも「<strong>一定の期間</strong>」と記載があるのは分かったが、具体的にどのくらい経過すると無効になるのかが分からなかった。</p>
<p>たまたまコネがあって、LINE の人に直接問い合わせたことがあったのだが、<em>リプライトークンの有効期限は公表していない</em>、というのが回答だった (LINE はわりかしサポートが不親切な印象)。</p>
<h2 id="自分で調べてみた"><a class="header-link" href="#自分で調べてみた"><span class="header-link-mark"></span></a>自分で調べてみた</h2>
<p>そこで、自分で検証することにした。</p>
<p>前回のオウム返し Bot のソースコードをちょっと加工して、「ユーザが発言した秒数だけレスポンスを待つ」というコードを作った。<code>event.message.text</code> を数値に変換して、<code>setTimeout()</code> の第2引数に与えるようにしただけ。こうすれば、ソースコードの変更は1回こっきりで、Reply API のコールを遅延させるタイミングを自在に変えられる。あとはリクエストの受信直後と、Reply API のコール前後で時刻を出力し、経過時間をチェックできるようにした。</p>
<p>それで色々検証した結果、Webhook サーバがメッセージを受信してから<strong>30秒以内</strong>に Reply API をコールしないと <code>400 Bad Request</code> が返ってきてしまい、返信できなかった。ユーザからのメッセージを LINE API サーバが受信し、<em>LINE API サーバがリプライトークンを生成した時点から30秒間以内</em>、というのが、恐らくは正確な秒数だろうか。</p>
<p>ネット上で調べた感じでも、「数十秒」とか「30秒」と表現している人が何名かいたので、現時点では「<strong>30秒以内に返信しないとダメ</strong>」というのが、リプライトークンの仕様だといえるだろう。</p>
<ul>
  <li>参考 : <a href="https://uzulla.hateblo.jp/entry/2016/10/06/230309">LINEのMessaging APIを使うメモ : 事前知識と登録編 - uzullaがブログ</a>
    <ul>
      <li>
        <blockquote>
          <p>ReplyはPushと違って無料でつかえますが、ユーザーアクションから30秒以内に1度だけなので、サービス設計としてなかなか考えないといけないですね。</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>参考 : <a href="https://qiita.com/ebijun1007/items/363e5e4d989e919ad997">GAS + LINE Messaging API でポモドーロタイマーを作る - Qiita</a>
    <ul>
      <li>
        <blockquote>
          <p>Messenger APIはこちらから送るメッセージ内のreplyトークンを利用して返事するようで、そのトークンの有効時間が３０秒らしいです。</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>参考 : <a href="http://jumperson.hatenablog.com/entry/2016/09/29/121117">LINE DEVELOPER DAY 2016 午前 参加レポート - Programmer Mixin Conductor's Blog</a>
    <ul>
      <li>
        <blockquote>
          <p>ReplyTokenの有効期限は数十秒。</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>
<h2 id="30秒以上経った後に返信したい場合は--push-api-を使う"><a class="header-link" href="#30秒以上経った後に返信したい場合は--push-api-を使う"><span class="header-link-mark"></span></a>30秒以上経った後に返信したい場合は？ → Push API を使う</h2>
<p>前回、Heroku サーバを利用したが、Heroku は30分間アクセスがないと、Dyno (サーバ) が Sleep 状態になってしまう。再度アクセスがあれば、Dyno が起動後、レスポンスを返してくれるものの、Dyno の起動には30秒くらいかかることもある。</p>
<p>本番利用で無料枠の Heroku を使うこともないと思うし、普通に考えて30秒以上ユーザを待たせるような LINE Bot は使い物にならないが、それはそうとして、30秒以上経過した場合に返信する方法はないのか気になる。</p>
<p>結論からいえば、<em>Push API</em> という別の API を利用すれば、返信できる。コチラはユーザ ID を指定してユーザにメッセージを投稿する API で、本来は定期的な広告配信とか、ユーザ単位にカスタマイズしたメッセージを通知したりする時に使用するモノだ。</p>
<p>Push API は、「Developer Trial」プランか、有償プランでないと利用できない。チャネル作成時に「フリー」プランを選んでしまった場合は残念ながら利用できないので、チャネルから作り直しだ。</p>
<h2 id="line-api-サーバへのレスポンスは1分以内に"><a class="header-link" href="#line-api-サーバへのレスポンスは1分以内に"><span class="header-link-mark"></span></a>LINE API サーバへのレスポンスは1分以内に</h2>
<p>ちなみにだが、<code>/callback</code> パスで LINE API サーバからのリクエストを受け取った時に、このリクエストに対するレスポンスは何秒以内に行えば良いのか。</p>
<p>コチラは、LINE 公式から「<em>1分以内を推奨</em>」と云われた。レスポンスにそれ以上かかると、Webhook サーバとの通信エラーとみなされるようだ (だからといって特にペナルティ等はなさそう)。</p>
<p>もっと大量のリクエストを処理するようなチャネルに成長した場合は、<em><code>/callback</code> パスでリクエストを分解して Reply API をコールして、その結果を待ってからレスポンスする</em>、といった作りは、時間がかかりすぎるので NG だ。</p>
<ul>
  <li>参考 : <a href="https://qiita.com/yoichiro6642/items/6d4c7309210af20a5c8f">大量メッセージが来ても安心なLINE BOTサーバのアーキテクチャ - Qiita</a> … この記事に書かれている「多くの人がやっちゃう間違い」にドンズバ当てはまる実装をしていた</li>
</ul>
<p>じゃあどうするの、というと、LINE からリクエストを受け取った <code>/callback</code> パスでは、メッセージを DB 等に登録するだけして、さっさと 200 をレスポンスしてしまうのだ。そして、DB に入ったメッセージ情報を処理するのは、別のサーバに任せてしまう、というワケだ。返信は Webhook サーバ自身が行わないといけない、という決まりはないのだ。</p>
<p>DB に入れたメッセージをどうやって処理サーバが検知するかとか、並列処理させて問題ないような作りにするとか、色々と考えないといけないことも増えてくるので、規模に応じて、必要になったら作り変えるのが良いと思う。YAGNI。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-02-28</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-02-28</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
