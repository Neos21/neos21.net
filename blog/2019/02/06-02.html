<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Git For Windows・Git SDK の起動を爆速にする - Neo's World">
    <meta property="og:description" content="Git For Windows・Git SDK の起動を爆速にする - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2019/02/06-02.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Git For Windows・Git SDK の起動を爆速にする - Neo's World">
    <meta property="twitter:description" content="Git For Windows・Git SDK の起動を爆速にする - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2019/02/06-02.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Git For Windows・Git SDK の起動を爆速にする - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/02/06-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MZCGD23');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MZCGD23" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/02/index.html">02月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-02-06</time></div>
        <h1 id="page-title">Git For Windows・Git SDK の起動を爆速にする</h1>

<p><em>Git For Windows</em> やその上位互換である <em>Git SDK</em> (以降「<strong>GitBash</strong>」で総称する) の起動時のトロさといったら。Mac のターミナルくらい爆速で起動して使い始めたいのに、<code>git-bash.exe</code> を起動して最初のプロンプトが表示されるまで2・3秒待たないといけない。</p>
<p>今回はそんな Windows GitBash の起動を爆速にするための取り組みをまとめる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#windows-gitbash-%E3%81%8C%E9%81%85%E3%81%84%E7%90%86%E7%94%B1">Windows GitBash が遅い理由</a></li>
  <li><a href="#%E3%81%98%E3%82%83%E3%81%82%E9%80%9F%E3%81%8F%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%97%E3%81%9F%E3%82%89%E3%81%84%E3%81%84%E3%81%AE%E3%81%8B">じゃあ、速くするにはどうしたらいいのか？</a></li>
  <li><a href="#git-sdk-%E3%81%AE%E5%89%8D%E6%8F%90%E7%92%B0%E5%A2%83">Git SDK の前提環境</a></li>
  <li><a href="#gitbash-%E8%B5%B7%E5%8B%95%E6%99%82%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%87%A6%E7%90%86%E5%86%85%E5%AE%B9%E3%82%92%E7%9F%A5%E3%82%8B">GitBash 起動時に読み込まれているファイル・処理内容を知る</a></li>
  <li><a href="#git-sdk-%E3%81%AE%E8%B5%B7%E5%8B%95%E3%82%92%E7%88%86%E9%80%9F%E3%81%AB%E3%81%99%E3%82%8B-etcprofile">Git SDK の起動を爆速にする <code>/etc/profile</code></a></li>
  <li><a href="#git-for-windows-%E3%82%82%E9%AB%98%E9%80%9F%E5%8C%96%E3%81%99%E3%82%8B">Git For Windows も高速化する</a></li>
  <li><a href="#git-for-windows-%E3%81%AE%E8%B5%B7%E5%8B%95%E3%82%92%E7%88%86%E9%80%9F%E3%81%AB%E3%81%99%E3%82%8B-etcprofile">Git For Windows の起動を爆速にする <code>/etc/profile</code></a></li>
  <li><a href="#%E3%81%A9%E3%81%AE%E3%81%8F%E3%82%89%E3%81%84%E9%80%9F%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%AE%E3%81%8B%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B">どのくらい速くなったのか検証する</a>
    <ul>
      <li><a href="#%E5%85%83%E3%80%85%E3%81%AE-etcprofile-%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C">元々の <code>/etc/profile</code> の実行結果</a></li>
      <li><a href="#%E5%A4%89%E6%9B%B4%E5%BE%8C%E3%81%AE-etcprofile-%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C">変更後の <code>/etc/profile</code> の実行結果</a></li>
    </ul>
  </li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
  <li><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E5%8F%82%E8%80%83">その他参考</a></li>
</ul>
<h2 id="windows-gitbash-が遅い理由"><a class="header-link" href="#windows-gitbash-が遅い理由"><span class="header-link-mark"></span></a>Windows GitBash が遅い理由</h2>
<p>そもそも何で GitBash は起動や動作が遅いのだろう。</p>
<p>最近気付いたのだが、MacOS 上で、VirtualBox で Windows 環境を作り (Modern.IE とかでいい)、その上で Git For Windows をインストールすると、仮想環境とは思えない速度でターミナルが起動するのだ。ということは、「MacOS の SSD が速くて、Windows マシンの SSD は遅いのかしら？」と、ハードウェアの性能差すら疑ってしまった。</p>
<p>で、そんな疑問を調べていたら、Twitter で素晴らしいリプライをいただいた。</p>
<blockquote>
  <p>Windowsのファイルアクセスとプロセス起動がUNIX系に比べて相当遅い傾向があるせいじゃないでしょうか。<br>ファイルアクセスが遅い問題はSSD使うとそれなりには緩和されると思います。<br>あとVirtualBoxのストレージコントローラには「ホストのI/Oキャッシュを使う」設定があり、これでも速くなりそうです</p>
  <p>— SODA Noriyuki (<code>@n_soda</code>) <a href="https://twitter.com/n_soda/status/1075299197337755649?ref_src=twsrc%5Etfw">2018年12月19日</a></p>
  <p>Windowsのファイルアクセスとプロセス起動がUNIX系に比べて相当遅い傾向があるせいじゃないでしょうか。<br>ファイルアクセスが遅い問題はSSD使うとそれなりには緩和されると思います。<br>あとVirtualBoxのストレージコントローラには「ホストのI/Oキャッシュを使う」設定があり、これでも速くなりそうです</p>
  <ul>
    <li><a href="https://twitter.com/n_soda/status/1075299197337755649">SODA Noriyuki on Twitter: "Windowsのファイルアクセスとプロセス起動がUNIX系に比べて相当遅い傾向があるせいじゃないでしょうか。 ファイルアクセスが遅い問題はSSD使うとそれなりには緩和されると思います。 あとVirtualBoxのストレージコントローラには「ホストのI/Oキャッシュを使う」設定があり、これでも速くなりそうです… https://t.co/r2Imf7a2Ay"</a></li>
  </ul>
</blockquote>
<p>薄々勘付いてはいたが、<em>そもそも Windows OS 自体が、ファイルアクセスとプロセス起動が遅い</em>傾向にあるようだ。</p>
<p>ファイルアクセスというと、<code>test</code> コマンドなどでファイルの存在チェックを行って、<code>source</code> コマンドで読み込んだり、といったことが起動時に行われている。原理的には、OS を問わず、ファイルアクセスの回数や量に比例して動作が遅くなっていくが、Windows OS ではそれを MacOS や Linux OS よりも顕著に感じる、ということだろう。</p>
<p>GitBash の中身はほぼ MSYS2 で、Bash コマンドを Windows 向けに移植して <code>.exe</code> 化して取り揃えている。Bash の言語仕様上の細かなところを知らないので推測にはなるが、平たく考えると、Bash コマンドを実行する度に、コマンドの実体である <code>.exe</code> ファイルを読みに行き (ファイルアクセス)、そのプロセスを起動して、処理しているワケだ。起動時に使用するコマンド ≒ 処理が多ければ多いほど、Windows ではより顕著に速度性能を体感してしまう、というワケだ。</p>
<p>あと、コレは体感的な話ではあるが、<code>echo</code> によるターミナルへの出力自体も、もっさりしているように感じる。Git SDK はターミナル起動時に「Welcome」とかなんちゃら <code>echo</code> してきやがるので、コンソール出力も止めよう。</p>
<p>そうそう、Mac の VirtualBox 上で動作する Windows だとそのような遅さを感じなかった理由についても判明した。ホスト OS の I/O キャッシュが利用されているので、MacOS のファイルアクセスの性能が活かされているということのようだ。</p>
<ul>
  <li>参考 : <a href="https://twitter.com/n_soda/status/905041519756828672">SODA Noriyuki on Twitter: "でもって、MSYS2のランタイムを見ると、cygwinからもらってきたと思われるforkエミュレーションのコードがあるみたいです: https://t.co/k6EyNXGy8G とはいえ、fork()なしのCreateProcess()だけでもやはり遅い可能性はあるわけですが…… https://t.co/jQg9TcCcsV"</a></li>
</ul>
<h2 id="じゃあ速くするにはどうしたらいいのか"><a class="header-link" href="#じゃあ速くするにはどうしたらいいのか"><span class="header-link-mark"></span></a>じゃあ、速くするにはどうしたらいいのか？</h2>
<p>Windows は「ファイルアクセス」と「プロセス起動」に時間がかかることが、GitBash の起動の遅さの原因と考えられることが分かった。</p>
<p>ということは、この裏を返せば、起動を速くする方法に繋がるだろう。</p>
<ul>
  <li><em>ファイルアクセスを減らす</em>
    <ul>
      <li><code>test</code> コマンドなどによるファイルの存在チェックを省けるだけ省く</li>
      <li><code>source</code> コマンドで外部ファイルを読み込んでいる箇所を省く : <strong>呼び出し元のスクリプトファイルにインラインでベタ書きしてやれば同じ結果が得られる</strong>ので、インライン化してしまう</li>
      <li><code>mkdir</code>・<code>chmod</code> などファイルを操作するコマンドを調整する</li>
    </ul>
  </li>
  <li><em>プロセス起動を減らす</em>
    <ul>
      <li><code>exec</code> や、存在チェックなどの条件分岐や関数呼び出し、変数展開や置換など、考えられる「無駄な処理」は削れるだけ削り、<strong>使うコマンドの数を減らす</strong></li>
    </ul>
  </li>
</ul>
<p>とりあえず、起動時に読み込まれたり、参照・操作されるファイル数を減らし、余計な処理をガンガン削ったら、原理的には速くなりそうだ。</p>
<p>しかし、起動時に読み込まれているファイルって何なのだろう？</p>
<p>一つずつ調べていくことにした。</p>
<h2 id="git-sdk-の前提環境"><a class="header-link" href="#git-sdk-の前提環境"><span class="header-link-mark"></span></a>Git SDK の前提環境</h2>
<p>まずは Git SDK の起動を速くしていこうと思う。前提となる環境は以下のとおり。</p>
<ul>
  <li><code>git-sdk-installer-1.0.7-64.7z.exe</code> (Git SDK v1.0.7) を <code>C:\git-sdk-64\</code> にインストール後、1回以上普通に起動したことがある (初期設定が完了している)</li>
  <li><code>C:\git-sdk-64\</code> ディレクトリの <code>git log</code> は以下のとおり
    <ul>
      <li><code>74eb921e 2018-12-18 Update 20181218-031256 [Git for Windows Build Agent] (grafted, HEAD -> master, origin/master)</code></li>
    </ul>
  </li>
  <li><code>C:\git-sdk-64\.git\</code> ディレクトリを消しておく。そうしないと、<code>/</code> が Git 管理されているテイになっているので、Git 管理外のディレクトリでも <code>__git_ps1</code> が表示されてしまう</li>
</ul>
<p>このような状態で、調査を開始した。</p>
<h2 id="gitbash-起動時に読み込まれているファイル処理内容を知る"><a class="header-link" href="#gitbash-起動時に読み込まれているファイル処理内容を知る"><span class="header-link-mark"></span></a>GitBash 起動時に読み込まれているファイル・処理内容を知る</h2>
<p>Git SDK (<code>git-bash.exe</code>) を起動すると、現状は3秒くらい時間がかかっている。</p>
<p>まずは起動時にどのようなファイルが読み込まれているか調べるため、<code>/usr/bin/bash.exe</code> の動作ログを出力してみる。やり方は以前別の記事で紹介した。</p>
<ul>
  <li><a href="/blog/2018/10/03-01.html">Bash 環境変数がどのファイルで定義されたか調べたい</a></li>
</ul>
<pre class="language-bash"><code class="language-bash">$ <span class="token assign-left variable"><span class="token environment constant">PS4</span></span><span class="token operator">=</span><span class="token string">'+<span class="token environment constant">$BASH_SOURCE</span>> '</span> <span class="token assign-left variable">BASH_XTRACEFD</span><span class="token operator">=</span><span class="token number">7</span> <span class="token function">bash</span> -xl <span class="token operator"><span class="token file-descriptor important">7</span>></span><span class="token file-descriptor important">&#x26;2</span>
</code></pre>
<p><code>bash.exe</code> が立ち上がると、<code>C:\git-sdk-64\etc\profile</code> (= <strong><code>/etc/profile</code></strong>) が読み込まれ、このファイルから次のファイル群が <code>source</code> されていた。</p>
<ul>
  <li><code>/etc/msystem</code> : <code>MSYSTEM_PREFIX</code> など環境変数を設定する</li>
  <li><code>/etc/post-install/</code> 配下の全ファイル : インストール直後の初期設定がメイン。設定ができていたら結果的に何もしないのだが、Git SDK を起動するたびに <code>source</code> するので遅くなっているようだった
    <ul>
      <li><code>/etc/post-install/01-devices.post</code> : <code>/dev/</code> 配下のシンボリックリンクを作成する</li>
      <li><code>/etc/post-install/03-mtab.post</code> : <code>/proc/mounts</code> の再現</li>
      <li><code>/etc/post-install/06-windows-files.post</code> : <code>C:\Windows\System32\drivers\etc\</code> との設定</li>
      <li><code>/etc/post-install/07-pacman-key.post</code> : <code>pacman-key</code> の設定</li>
      <li><code>/etc/post-install/08-xml-catalog.post</code> : <code>xmlcatalog</code> の用意</li>
      <li><code>/etc/post-install/99-post-install-cleanup.post</code> : 不要なファイルの削除</li>
    </ul>
  </li>
  <li><code>/etc/profile.d/</code> 配下のファイル : <code>perlbin.csh</code> 以外が呼ばれる
    <ul>
      <li><code>/etc/profile.d/aliases.sh</code> : <code>alias</code> 設定</li>
      <li><code>/etc/profile.d/bash_completion.sh</code> : Bash の複雑なタブ補完用ファイル <code>/usr/share/bash-completion/bash_completion</code> を読み込む</li>
      <li><code>/etc/profile.d/bash_profile.sh</code> : <code>~/.bash_profile</code>・<code>~/.bashrc</code> などのファイルの存在チェック・なければ新規生成する</li>
      <li><code>/etc/profile.d/env.sh</code> : 環境変数 <code>PATH</code> の設定</li>
      <li><code>/etc/profile.d/git-prompt.sh</code> : 環境変数 <code>PS1</code> (プロンプト) の設定</li>
      <li><code>/etc/profile.d/git-sdk.sh</code> : <code>sdk</code> 関数の用意。<code>Welcome to the Git for Windows SDK!</code> のメッセージはこのスクリプトが出力している</li>
      <li><code>/etc/profile.d/lang.sh</code> : 環境変数 <code>LANG</code> (言語) の設定</li>
      <li><code>/etc/profile.d/perlbin.sh</code> : Perl に関する環境変数 <code>PATH</code> の設定</li>
      <li><code>/etc/profile.d/tzset.sh</code> : 環境変数 <code>TZ</code> (タイムゾーン) の設定</li>
    </ul>
  </li>
  <li><code>/etc/bash.bashrc</code> : プロンプトの設定など</li>
  <li>あとは <code>~/.bash_profile</code> および <code>~/.bashrc</code>。普段ユーザ定義する部分だが、ココのカスタマイズは今回対象外とする</li>
</ul>
<p>この <em><code>/etc/profile</code> と、そこから読み込まれる外部ファイル群から「無駄」を省いていけば速くなるかも</em>しれない。</p>
<ul>
  <li>これらのファイル群は、MSYS2 系の様々な環境で汎用的に動作するように書かれているので、32 bit 版向けの条件分岐や処理が含まれていたりする</li>
  <li>SSH 接続時の調整など、自分の用途ではまず使わない場合向けの設定が含まれている</li>
</ul>
<p>今回、起動を速くするためなら<strong>自分が使う環境に強く依存する</strong>ようなカスタマイズでもいとわないことにした。</p>
<p>まずは <code>source</code> しているファイルの中身を <code>/etc/profile</code> 内にコピペし、外部ファイルの読み込みを全てなくした。その状態で、条件分岐や変数の設定内容などを細かく見ていき、通っていない処理、通っていても実質的に何も変更していない無駄な処理をコメントアウトした。ココは地道に変数の定義前・定義直後で変数を <code>echo</code> したりして調べていった。</p>
<p>この細かな調査記録は以下にコメント込みで記述したファイル全量があるので、気になる人は参照されたし。</p>
<ul>
  <li><del>optimize-git-for-windows/profile v1 外部ファイルをインライン化・不要箇所をコメントアウト at master · Neos21/optimize-git-for-windows · GitHub</del>
    <ul>
      <li>現在は削除</li>
    </ul>
  </li>
</ul>
<h2 id="git-sdk-の起動を爆速にする-etcprofile"><a class="header-link" href="#git-sdk-の起動を爆速にする-etcprofile"><span class="header-link-mark"></span></a>Git SDK の起動を爆速にする <code>/etc/profile</code></h2>
<p>こうして極限まで無駄を省いた結果、<code>/etc/profile</code> の内容は以下のように収めることができた。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Git SDK 向け /etc/profile 超削減版</span>

<span class="token assign-left variable">MSYS2_PATH</span><span class="token operator">=</span>/usr/local/bin:/usr/bin:/bin
<span class="token assign-left variable">MANPATH</span><span class="token operator">=</span>/usr/local/man:/usr/share/man:/usr/man:/share/man
<span class="token assign-left variable">INFOPATH</span><span class="token operator">=</span>/usr/local/info:/usr/share/info:/usr/info:/share/info
<span class="token assign-left variable">ORIGINAL_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$PATH</span>"</span>  <span class="token comment"># 元のソースでは変数の内容チェックなどがあったが省いた</span>

<span class="token comment"># 後述するが Git For Windows とは設定内容が違うので注意</span>
<span class="token assign-left variable">MSYSTEM</span><span class="token operator">=</span>MSYS
<span class="token assign-left variable">MSYSTEM_PREFIX</span><span class="token operator">=</span>/usr
<span class="token assign-left variable">MSYSTEM_CARCH</span><span class="token operator">=</span>x86_64
<span class="token assign-left variable">MSYSTEM_CHOST</span><span class="token operator">=</span>x86_64-pc-msys
<span class="token assign-left variable">CONFIG_SITE</span><span class="token operator">=</span>/etc/config.site

<span class="token assign-left variable">PKG_CONFIG_PATH</span><span class="token operator">=</span>/usr/lib/pkgconfig:/usr/share/pkgconfig:/lib/pkgconfig

<span class="token comment"># 元のソースは /tmp ディレクトリの特定に色々処理していたが、全てベタ書きにした</span>
<span class="token assign-left variable">ORIGINAL_TMP</span><span class="token operator">=</span>/tmp
<span class="token assign-left variable">ORIGINAL_TEMP</span><span class="token operator">=</span>/tmp
<span class="token assign-left variable">TMPDIR</span><span class="token operator">=</span>/tmp

<span class="token comment"># 本来は "$(exec /usr/bin/hostname)" で代入していたところなのだが、ベタ書きにしてしまった。export する必要性がイマイチ分かっていない変数</span>
<span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>Neos-Windows
<span class="token comment"># プロンプトは最小構成にしておく。自分は ~/.bash_profile で設定しているのでココでは余計なことはせずにシンプルにしておく</span>
<span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">'<span class="token entity" title="\n">\n</span>$ '</span>
<span class="token comment"># locale コマンドの結果だけ書いてしまう</span>
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>ja_JP.UTF-8
<span class="token comment"># tzset コマンドの結果だけ書いてしまう</span>
<span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Tokyo
<span class="token comment"># 環境変数 PATH への代入は数箇所に登場していたので、1箇所でまとめてやるようにした</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/bin:<span class="token variable">$MSYS2_PATH</span>:/opt/bin:<span class="token variable">$ORIGINAL_PATH</span>:/usr/bin/vendor_perl:/usr/bin/core_perl"</span>

<span class="token comment"># export コマンドの実行は1回だけにする</span>
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span> MANPATH INFOPATH PKG_CONFIG_PATH <span class="token environment constant">LANG</span> TZ TMP TEMP TMPDIR <span class="token environment constant">HOSTNAME</span> <span class="token environment constant">PS1</span> <span class="token environment constant">SHELL</span> ORIGINAL_TMP ORIGINAL_TEMP ORIGINAL_PATH MSYSTEM MSYSTEM_PREFIX MSYSTEM_CARCH MSYSTEM_CHOST CONFIG_SITE
</code></pre>
<p><strong>コメント・空行を省いて19行</strong>になった。コレ以外は、条件分岐に合致せず呼び出されていないコードだったり、実行されても何も変化がないコードだったりしたので、全て削った。</p>
<p>変数展開のコストがどれだけかかるのか分からないが、余計な処理コストがかかるのを避けるため、原則的に<em>ベタ書き</em>に変更してしまった。</p>
<p>一応処理として通ってはいたので残したものの、起動後の使用箇所が分からずまだ削れそうな変数もある。</p>
<ul>
  <li><code>$ORIGINAL_TMP</code>・<code>$ORIGINAL_TEMP</code> : 中身は <code>/tmp</code> になっていたので、結局 <code>$TMP</code> や <code>$TEMP</code> と同じじゃん、と。<code>$TMPDIR</code> ももしかしたら要らなさそう</li>
  <li><code>$HOSTNAME</code> : プロンプトに使用する <code>\h</code> では参照していないので、もしかしたらコレも要らないかも</li>
  <li><code>$PS1</code> : <code>~/.bash_profile</code> で独自に設定しているし、別にココで用意してあげなくても良いかも</li>
</ul>
<p>とはいえ、基本は変数への固定値代入で、コマンドらしいコマンドは <code>export</code> 1回だけに押さえられた。</p>
<p><strong><code>C:\git-sdk-64\etc\profile</code> = <code>/etc/profile</code> のファイルの内容を、上述の内容に差し替えれば高速化できる。</strong></p>
<h2 id="git-for-windows-も高速化する"><a class="header-link" href="#git-for-windows-も高速化する"><span class="header-link-mark"></span></a>Git For Windows も高速化する</h2>
<p>同じ要領で、通常の GitBash である Git For Windows も高速化してみよう。</p>
<ul>
  <li><code>C:\Program Files\Git\</code> に v2.20.1 をインストール後、1回以上普通に起動した状態から調査・改良を開始した</li>
  <li><em><code>/etc/profile</code> の内容は Git SDK のモノと全く同一だった</em>ので、<code>$MSYSTEM</code> の初期値が <code>'MSYS'</code> ではなく <code>'MINGW64'</code> であることによる、一部の条件分岐の違い程度と推測した</li>
  <li>が、念のため全体の動きを調べ直し、設定する環境変数の違いなどをまとめた</li>
</ul>
<h2 id="git-for-windows-の起動を爆速にする-etcprofile"><a class="header-link" href="#git-for-windows-の起動を爆速にする-etcprofile"><span class="header-link-mark"></span></a>Git For Windows の起動を爆速にする <code>/etc/profile</code></h2>
<p>ということで出来上がった <code>/etc/profile</code> は以下のとおり。</p>
<pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">MSYS2_PATH</span><span class="token operator">=</span>/usr/local/bin:/usr/bin:/bin
<span class="token assign-left variable">MANPATH</span><span class="token operator">=</span>/usr/local/man:/usr/share/man:/usr/man:/share/man
<span class="token assign-left variable">INFOPATH</span><span class="token operator">=</span>/usr/local/info:/usr/share/info:/usr/info:/share/info
<span class="token assign-left variable">ORIGINAL_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$PATH</span>"</span>

<span class="token comment"># 以下の内容が Git SDK と異なる</span>
<span class="token assign-left variable">MSYSTEM</span><span class="token operator">=</span>MINGW64
<span class="token assign-left variable">MSYSTEM_PREFIX</span><span class="token operator">=</span>/mingw64
<span class="token assign-left variable">MSYSTEM_CARCH</span><span class="token operator">=</span>x86_64
<span class="token assign-left variable">MSYSTEM_CHOST</span><span class="token operator">=</span>x86_64-w64-mingw32
<span class="token assign-left variable">MINGW_CHOST</span><span class="token operator">=</span>x86_64-w64-mingw32
<span class="token assign-left variable">MINGW_PREFIX</span><span class="token operator">=</span>/mingw64
<span class="token assign-left variable">MINGW_PACKAGE_PREFIX</span><span class="token operator">=</span>mingw-w64-x86_64
<span class="token assign-left variable">CONFIG_SITE</span><span class="token operator">=</span>/mingw64/etc/config.site

<span class="token assign-left variable">PKG_CONFIG_PATH</span><span class="token operator">=</span>/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig

<span class="token assign-left variable">ORIGINAL_TMP</span><span class="token operator">=</span>/tmp
<span class="token assign-left variable">ORIGINAL_TEMP</span><span class="token operator">=</span>/tmp
<span class="token assign-left variable">TMPDIR</span><span class="token operator">=</span>/tmp

<span class="token comment"># やりすぎず "$(exec /usr/bin/hostname)" とした方が良いかも。もしくは不要？</span>
<span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>Neos-Windows

<span class="token comment"># env.sh より以下を追加した</span>
<span class="token assign-left variable"><span class="token environment constant">DISPLAY</span></span><span class="token operator">=</span>needs-to-be-defined
<span class="token assign-left variable">SSH_ASKPASS</span><span class="token operator">=</span>/mingw64/libexec/git-core/git-gui--askpass

<span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">'<span class="token entity" title="\n">\n</span>$ '</span>
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>ja_JP.UTF-8

<span class="token comment"># Git For Windows には tzset.sh がなかったので本来は以下の変数が設定されないが、Git SDK と同じ内容を設定しておく</span>
<span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Tokyo

<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/bin:<span class="token variable">$MSYS2_PATH</span>:/opt/bin:<span class="token variable">$ORIGINAL_PATH</span>:/usr/bin/vendor_perl:/usr/bin/core_perl"</span>

<span class="token comment"># ACLOCAL_PATH にも値が最初から入っていたので export 対象に入れた</span>
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span> MANPATH INFOPATH PKG_CONFIG_PATH <span class="token environment constant">LANG</span> TZ TMP TEMP TMPDIR <span class="token environment constant">HOSTNAME</span> <span class="token environment constant">PS1</span> <span class="token environment constant">SHELL</span> ORIGINAL_TMP ORIGINAL_TEMP ORIGINAL_PATH MSYSTEM MSYSTEM_PREFIX MSYSTEM_CARCH MSYSTEM_CHOST CONFIG_SITE ACLOCAL_PATH <span class="token environment constant">DISPLAY</span> SSH_ASKPASS
</code></pre>
<p><strong>コメント行、空行を除くと24行になった。</strong></p>
<p>環境変数 <code>$MSYSTEM</code> のデフォルト値が Git SDK と Git For Windows とで異なっていたので、その違いによる環境変数の差分を取り込んだ。32bit 版の Git For Windows を使っている人はまたちょっと変わってくるはず。</p>
<ul>
  <li>参考 : <a href="http://arithmeticoverflow.blog.fc2.com/blog-entry-34.html">MSYS2でMinGW環境整備(3)</a></li>
</ul>
<h2 id="どのくらい速くなったのか検証する"><a class="header-link" href="#どのくらい速くなったのか検証する"><span class="header-link-mark"></span></a>どのくらい速くなったのか検証する</h2>
<p>さて、当初の体感では2・3秒起動時に待たされていたのが、上述の改修後は、起動して2秒後にはプロンプトが表示されているくらいに高速化された。</p>
<p>数値としてどのくらい高速化したのか、Git SDK 側の変更前後で違いを見てみる。</p>
<p><code>/etc/profile</code> の1行目と最終行、および <code>~/.bash_profile</code> の最終行 (<code>~/.bashrc</code> の読込後) の3箇所に、以下のコマンドを仕掛けた。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">date</span> <span class="token string">'+%F %T %N'</span>
<span class="token comment"># 'YYYY-MM-DD HH:mm:ss ナノ秒' が出力される</span>
</code></pre>
<p>この状態で <code>git-bash.exe</code> を起動し、変更前の <code>/etc/profile</code> と変更後の <code>/etc/profile</code> とで比較してみた。</p>
<h3 id="元々の-etcprofile-の実行結果"><a class="header-link" href="#元々の-etcprofile-の実行結果"><span class="header-link-mark"></span></a>元々の <code>/etc/profile</code> の実行結果</h3>
<pre class="language-bash"><code class="language-bash"><span class="token number">2018</span>-12-20 <span class="token number">22</span>:04:54 <span class="token number">425751900</span>  <span class="token comment"># /etc/profile 開始</span>
Welcome to the Git <span class="token keyword">for</span> Windows SDK<span class="token operator">!</span>

The common tasks are automated via the <span class="token variable"><span class="token variable">`</span>sdk<span class="token variable">`</span></span> <span class="token keyword">function</span><span class="token punctuation">;</span>
See <span class="token variable"><span class="token variable">`</span>sdk <span class="token builtin class-name">help</span><span class="token variable">`</span></span> <span class="token keyword">for</span> details.
<span class="token number">2018</span>-12-20 <span class="token number">22</span>:04:56 071816800  <span class="token comment"># /etc/profile 終了</span>
<span class="token number">2018</span>-12-20 <span class="token number">22</span>:04:56 <span class="token number">648292200</span>  <span class="token comment"># ~/.bash_profile 終了</span>
</code></pre>
<p><code>sdk()</code> 関数の <code>welcome</code> の内容が出力されているので少し分かりづらいが、<code>/etc/profile</code> の終了まで2秒近くかかっていることが分かる。</p>
<p><code>~/.bash_profile</code> の終了にも0.6秒程度かかっているが、コレはこのファイルから <code>~/.bashrc</code> や <code>git-completion.bash</code> などを <code>source</code> していたりするため。ユーザ定義の場所なので参考程度に見て欲しい。</p>
<h3 id="変更後の-etcprofile-の実行結果"><a class="header-link" href="#変更後の-etcprofile-の実行結果"><span class="header-link-mark"></span></a>変更後の <code>/etc/profile</code> の実行結果</h3>
<pre class="language-bash"><code class="language-bash"><span class="token number">2018</span>-12-20 <span class="token number">22</span>:32:09 <span class="token number">508269500</span>  <span class="token comment"># /etc/profile 開始</span>
<span class="token number">2018</span>-12-20 <span class="token number">22</span>:32:09 <span class="token number">548539700</span>  <span class="token comment"># /etc/profile 終了</span>
<span class="token number">2018</span>-12-20 <span class="token number">22</span>:32:09 <span class="token number">983198600</span>  <span class="token comment"># ~/.bash_profile 終了</span>
</code></pre>
<p>2秒ほどかかっていた <code>/etc/profile</code> の読み込みは、なんと<strong>0.04秒程度</strong>で完了するようになった。コメントアウトや空行の有無は実行速度に影響なかった。</p>
<p>こうなると <code>~/.bash_profile</code>・<code>~/.bashrc</code> の読み込み速度の方が気になってくるレベル。それでも全体では0.5秒程度で起動スクリプトの実行が終わっているのは驚異的。</p>
<p>Git For Windows の方も同様だった。Git For Windows の方は <code>/etc/post-install/</code> ディレクトリ自体が元々存在しなかったので、変更前から Git SDK よりも少し速かったのだが、それよりも格段に速くなった。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>体感できているとおり、GitBash の起動を爆速にすることができた。</p>
<p><code>/etc/profile</code> の変更内容を見てもらえば分かるとおり、自分の環境で <code>git-bash.exe</code> を起動した時に上手く動きさえすれば良い、というノリで滅茶苦茶にコードを削っている。<code>/etc/profile</code> の内容は別環境には共用できないし、まだ遭遇していないだけで思いもよらぬ不具合が起こるかもしれない。ご利用は計画的に。</p>
<p>今回の改修および調査結果は、全て以下のリポジトリに置いているので、GitBash の起動を爆速化してみたい人は、参考にしてほしい。</p>
<ul>
  <li><a href="https://github.com/Neos21/shell-scripts/tree/master/git-bash">GitHub - Neos21/optimize-git-for-windows: Git For Windows・Git SDK の起動や動作を軽くするための研究資料</a></li>
</ul>
<h2 id="その他参考"><a class="header-link" href="#その他参考"><span class="header-link-mark"></span></a>その他参考</h2>
<ul>
  <li>参考 : <a href="http://nukino.github.io/blog/2012/02/02/cygwinmintty/">cygwin(mintty)のシェル設定ファイル読み込み順 - Nukino's memorandum</a></li>
  <li>参考 : <a href="https://www.x68k.org/2017/11/git-for-windows/">Git for Windows | 秋刀魚と大根</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-02-06</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-02-06</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
