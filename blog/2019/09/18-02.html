<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="リポジトリごとの GitHub Pages でルート相対パスを使うには - Neo's World">
    <meta property="og:description" content="リポジトリごとの GitHub Pages でルート相対パスを使うには - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2019/09/18-02.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="リポジトリごとの GitHub Pages でルート相対パスを使うには - Neo's World">
    <meta property="twitter:description" content="リポジトリごとの GitHub Pages でルート相対パスを使うには - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2019/09/18-02.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>リポジトリごとの GitHub Pages でルート相対パスを使うには - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2019/09/18-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2019/index.html">2019年</a></li>
            <li><a href="/blog/2019/09/index.html">09月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2019-09-18</time></div>
        <h1 id="page-title">リポジトリごとの GitHub Pages でルート相対パスを使うには</h1>

<p>GitHub Pages でルート相対パスを使う時の<strong>荒業</strong>。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%83%AB%E3%83%BC%E3%83%88%E7%9B%B8%E5%AF%BE%E3%83%91%E3%82%B9%E3%81%A8%E3%81%AF">ルート相対パスとは？</a></li>
  <li><a href="#github-pages-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%88%E7%9B%B8%E5%AF%BE%E3%83%91%E3%82%B9">GitHub Pages におけるルート相対パス</a>
    <ul>
      <li><a href="#user-site-%E3%81%AE%E5%A0%B4%E5%90%88">User Site の場合</a></li>
      <li><a href="#project-site-%E3%81%AE%E5%A0%B4%E5%90%88">Project Site の場合</a></li>
    </ul>
  </li>
  <li><a href="#base-%E8%A6%81%E7%B4%A0%E3%81%A7%E3%82%82%E7%9B%B4%E3%81%9B%E3%81%AA%E3%81%84"><code>base</code> 要素でも直せない</a></li>
  <li><a href="#javascript-%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B%E3%81%97%E3%81%A6%E3%82%84%E3%82%8D%E3%81%86">JavaScript でなんとかしてやろう…</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="ルート相対パスとは"><a class="header-link" href="#ルート相対パスとは"><span class="header-link-mark"></span></a>ルート相対パスとは？</h2>
<p>HTML から画像やスタイルシートなどの外部ファイルを指定する時のパスの書き方は、以下の3つがある。</p>
<ol>
  <li><em>絶対パス</em> : <code>https://USER-NAME.github.io/SUB-REPO/style.css</code>・<code>https://USER-NAME.github.io/scripts.js</code>
    <ul>
      <li><code>http://</code> などのプロトコルから表記する。呼び出し元の HTML がどこに配置されようと、目的の外部ファイルを取得できる</li>
    </ul>
  </li>
  <li><em>相対パス</em> : <code>style.css</code> (= <code>./style.css</code>)・<code>../scripts.js</code>
    <ul>
      <li>呼び出し元の HTML のパスから見て相対的な位置を <code>./</code> (同階層) ないしは <code>../</code> (一階層上) で指定する</li>
    </ul>
  </li>
  <li><strong>ルート相対パス (Root Relative Path)</strong> : <code>/SUB-REPO/style.css</code>・<code>/scripts.js</code>
    <ul>
      <li>呼び出し元の HTML から見たルート <code>/</code> を起点としてパスを指定する (ドメイン部分を省略した絶対パスといえる)</li>
      <li>呼び方は「ルートパス」「サイトルートパス (Site-Root Relative Path)」などとも</li>
    </ul>
  </li>
</ol>
<p>今回対象にするのは、3つ目のルート相対パス。</p>
<p>ローカルで直接 HTML ファイルを開いてしまうと、ルート相対パスの「ルート」が特定できないため上手く開けないが、何らかのサーバ上で動作させれば、<code>http://localhost:8080/</code> などをルートとみなして解釈できるようになる、というモノだ。</p>
<h2 id="github-pages-におけるルート相対パス"><a class="header-link" href="#github-pages-におけるルート相対パス"><span class="header-link-mark"></span></a>GitHub Pages におけるルート相対パス</h2>
<p>GitHub Pages にデプロイした HTML ファイルに関しても、ルート相対パスが使える。</p>
<h3 id="user-site-の場合"><a class="header-link" href="#user-site-の場合"><span class="header-link-mark"></span></a>User Site の場合</h3>
<p><code>USER-NAME.github.io</code> の名前で作ったリポジトリで GitHub Pages を公開する場合、ルートは <code>https://USER-NAME.github.io/</code> とみなされる。</p>
<p>よって、<code>/index.html</code> から、同階層の <code>styles.css</code> を参照したい場合は、以下のように <code>link</code> 要素が書ける。</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
<p>コレは違和感ないだろう。</p>
<h3 id="project-site-の場合"><a class="header-link" href="#project-site-の場合"><span class="header-link-mark"></span></a>Project Site の場合</h3>
<p>任意のリポジトリで、よく <code>docs/</code> ディレクトリを作るか <code>gh-pages</code> ブランチを作るかして公開する GitHub Pages。</p>
<p>URL としては <code>https://USER-NAME.github.io/SUB-REPO/</code> 配下が当該リポジトリの GitHub Pages となるが、この時の<strong>ルートは <code>https://USER-NAME.github.io/</code> とみなされてしまう</strong>。</p>
<p>コレはどういうことかというと、任意のリポジトリ <code>SUB-REPO</code> の直下に <code>index.html</code> と <code>scripts.js</code> を配置し、<code>index.html</code> から以下のようにルート相対パスで参照させようとした場合、</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/scripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>
<p>当該リポジトリ直下から探して、</p>
<ul>
  <li><code>https://USER-NAME.github.io/SUB-REPO/scripts.js</code></li>
</ul>
<p>を参照して欲しいところだが、<em>実際は一階層上の</em></p>
<ul>
  <li><code>https://USER-NAME.github.io/scripts.js</code></li>
</ul>
<p><em>を探しに行ってしまうのだ。</em></p>
<p>プロジェクト・サイトでルート相対パスを使いたい場合は、</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/SUB-REPO/scripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>
<p>このようにルート相対パスに当該リポジトリ名を含めてやらないといけない、というワケだ。</p>
<p>…お察しかと思うが、<strong>この挙動は大変不便だ。</strong></p>
<h2 id="base-要素でも直せない"><a class="header-link" href="#base-要素でも直せない"><span class="header-link-mark"></span></a><code>base</code> 要素でも直せない</h2>
<p>「ルート」とみなされるパスを変更する方法はないかと思い、<code>base</code> 要素を用意してみた。</p>
<p><code>SUB-REPO</code> リポジトリ内で、以下のようなバリエーションで <code>base</code> 要素を記述して検証してみた。</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&#x3C;!-- 絶対パスで SUB-REPO リポジトリまで指定・末尾スラッシュなし --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://USER-NAME.github.io/SUB-REPO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token comment">&#x3C;!-- 絶対パスで SUB-REPO リポジトリまで指定・末尾スラッシュあり --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://USER-NAME.github.io/SUB-REPO/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!-- 相対パスで何かを指定してみる・リポジトリ名を含めるのは嫌だけど… --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SUB-REPO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SUB-REPO/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./SUB-REPO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./SUB-REPO/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!-- ルート相対パスで指定してみる・リポジトリ名を含めるのは嫌だけど… --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/SUB-REPO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/SUB-REPO/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
<p>また、検証のため、次のようなリンクを用意した。いずれも、<code>https://USER-NAME.github.io/SUB-REPO/test.html</code> に遷移できれば良いな…と思って書いているモノ。</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&#x3C;!-- 相対パス。挙動を確認するため設置 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./test.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!-- ルート相対パス、こう書いて動作させたい… --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/test.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!-- ルート相対パス、リポジトリ名を含むのが嫌… --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/SUB-REPO/test.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
<p>結果から行くと、絶対パスで SUB-REPO リポジトリまで記述した場合しか、上手く行かなかった。<strong>どれも思った効果は得られなかった。</strong></p>
<p>まず、<strong><code>base</code> 要素にどのようなパスを書いても、ルート相対パスを書いた <code>a</code> 要素に対しては効果がなかった。</strong></p>
<p><em><code>base</code> 要素が影響を及ぼすのは相対パス記述のみ</em>で、末尾のスラッシュの有無は関係ない。</p>
<p>概念的には、相対パスの記述に対し、手前に <code>base</code> 要素の値を付与している、というモノのようだ。以下の結果表を見れば少しは想像が付くかもしれない。</p>
<table>
  <thead>
    <tr>
      <th><code>base</code> 要素の値</th>
      <th>+</th>
      <th><code>a</code> 要素などの相対パス値</th>
      <th>最終的なパス</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>https://USER-NAME.github.io</code></td>
      <td><code>/</code></td>
      <td><code>./test.html</code></td>
      <td><code>https://USER-NAME.github.io/test.html</code></td>
    </tr>
    <tr>
      <td><code>../</code> (= <code>https://USER-NAME.github.io/</code>)</td>
      <td>(<code>/</code>)</td>
      <td><code>test.html</code></td>
      <td><code>https://USER-NAME.github.io/test.html</code></td>
    </tr>
    <tr>
      <td><code>https://USER-NAME.github.io/SUB-REPO/</code></td>
      <td>(<code>/</code>)</td>
      <td><code>./test.html</code></td>
      <td><code>https://USER-NAME.github.io/SUB-REPO/test.html</code></td>
    </tr>
    <tr>
      <td><code>https://USER-NAME.github.io/SUB-REPO/</code></td>
      <td>(<code>/</code>)</td>
      <td><code>../test.html</code></td>
      <td><code>https://USER-NAME.github.io/test.html</code></td>
    </tr>
  </tbody>
</table>
<p><code>base</code> 要素の値に <code>../</code> のような相対パスが指定された場合は、その HTML ファイルのパスを起点に、ベースとするフルパスが導かれる。</p>
<p>Node.js を触った人なら、<code>path.join()</code> や <code>path.resolve()</code> のように単に結合しているだけ、と思えば分かりやすいか。</p>
<p>で、<em>ルート相対パスが書かれた場合は、<code>base</code> 要素の値は無視</em>して、サイトルート、この場合は <code>https://USER-NAME.github.io/</code> をルートと見なす、という動きのようだ。</p>
<ul>
  <li>参考 : <a href="https://stackoverflow.com/questions/51619597/html5-base-tag-with-root-relative-url">html - HTML5 base Tag with root relative url - Stack Overflow</a></li>
  <li>参考 : <a href="https://stackoverflow.com/questions/11521011/why-base-tag-does-not-work-for-relative-paths">html - why base tag does not work for relative paths? - Stack Overflow</a></li>
  <li>参考 : <a href="http://w-d-l.net/html__tags__head__base/">http://w-d-l.net/html__tags__head__base/</a></li>
</ul>
<h2 id="javascript-でなんとかしてやろう"><a class="header-link" href="#javascript-でなんとかしてやろう"><span class="header-link-mark"></span></a>JavaScript でなんとかしてやろう…</h2>
<p>それでも、どうしてもプロジェクトサイトでルート相対パスを使いたい、<code>https://USER-NAME.github.io/SUB-REPO/</code> のようなドメイン以下の任意のパス以下をルートと見なしたい、ということで、JavaScript で制御する方法を編み出した。</p>
<p>今回はたまたま、<em><code>SUB-REPO</code> 以下の全ての HTML ファイルが <code>/scripts.js</code> を参照する仕様</em>にしてあった。</p>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ja<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/scripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>  <span class="token comment">&#x3C;!-- ← コレ --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/test.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/image.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p>ルート相対パス <code>/scripts.js</code> は、</p>
<ul>
  <li><strong><code>https://USER-NAME.github.io/scripts.js</code></strong></li>
</ul>
<p>と解釈される。プロジェクトサイトではなく、ユーザサイトの領域にある <code>scripts.js</code> を探しに行ってしまうワケだ。</p>
<p>そこで、だ。</p>
<p><strong>ユーザサイトに <code>scripts.js</code> を作成しておき、<code>SUB-REPO</code> の HTML からこの JavaScript ファイルを読み込ませ、そこでルート相対パスを置換することにする</strong>。コードの全量は以下。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token doc-comment comment">/** ルート相対パス置換処理 */</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/** 定数 : 本ファイルの名前 */</span>
  <span class="token keyword">var</span> thisFileName <span class="token operator">=</span> <span class="token string">'scripts.js'</span><span class="token punctuation">;</span>  <span class="token comment">// ← ファイル名が異なる場合は変更する</span>
  <span class="token doc-comment comment">/** 定数 : 当該 GitHub Pages のルートパス URL を用意する・末尾にスラッシュを付けない */</span>
  <span class="token keyword">var</span> rootPath <span class="token operator">=</span> <span class="token string">'https://USER-NAME.github.io/SUB-REPO'</span><span class="token punctuation">;</span>  <span class="token comment">// ← ココをリポジトリごとに変更する</span>
  
  <span class="token comment">// 対象の GitHub Pages から呼び出されていなければ、何も処理せず終了する</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">href</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token doc-comment comment">/**
   * 指定の要素の属性値をチェックし、ルート相対パス (スラッシュ `/` から始まる値) だった場合、
   * 定数 rootPath を先頭に付与した絶対パスに変換する
   * 
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">elementName</span> 要素名
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">attributeName</span> 属性名
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">replaceAttribute</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elementName<span class="token punctuation">,</span> attributeName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(elementName, attributeName, '置換処理開始');</span>
    <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelectorAll</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> attribute <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token method function property-access">getAttribute</span><span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 属性値がない場合、スラッシュ2つで始まるプロトコル省略の絶対パスの場合、ルート相対パスでない場合は処理しない</span>
      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>attribute <span class="token operator">||</span> attribute<span class="token punctuation">.</span><span class="token method function property-access">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'//'</span> <span class="token operator">||</span> attribute<span class="token punctuation">.</span><span class="token method function property-access">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>elementName <span class="token operator">===</span> <span class="token string">'script'</span> <span class="token operator">&#x26;&#x26;</span> attribute <span class="token operator">===</span> thisFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本ファイル自体は読み込まれているため element は操作しないでおく</span>
        <span class="token comment">// 代わりに、当該リポジトリ配下にあるはずの同名ファイルを読み込ませるため別要素を作って追加する</span>
        <span class="token keyword">var</span> theScript <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        theScript<span class="token punctuation">.</span><span class="token property-access">src</span> <span class="token operator">=</span> rootPath <span class="token operator">+</span> attribute<span class="token punctuation">;</span>
        element<span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>theScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// a 要素・img 要素は属性値変更のみで正しく読み込まれる</span>
        element<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span>attributeName<span class="token punctuation">,</span> rootPath <span class="token operator">+</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// link 要素・script 要素は Node の再挿入を行わないと読込が開始されない</span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>elementName <span class="token operator">===</span> <span class="token string">'link'</span> <span class="token operator">||</span> elementName <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> clone <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token method function property-access">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          element<span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">replaceChild</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 画面のチラつきが発生するため、link 要素のみ本ファイルが読み込まれたタイミングで即処理する</span>
  <span class="token comment">// (本スクリプトの読み込みは head 要素に書いておくとチラつきが発生しにくくなる)</span>
  <span class="token function">replaceAttribute</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token doc-comment comment">/** 初期処理定義 */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">replaceAttribute</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 上の即処理で漏れた CSS ファイルのみ改めて処理する</span>
    <span class="token function">replaceAttribute</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">replaceAttribute</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">replaceAttribute</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 読み込みタイミングに関わらず確実に実行されるよう制御する</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">readyState</span> <span class="token operator">||</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">readyState</span> <span class="token operator">===</span> <span class="token string">'interactive'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">readyState</span> <span class="token operator">===</span> <span class="token string">'loading'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>少々長いので順を追って解説する。</p>
<ul>
  <li>IE11 でもトランスパイルせず動作するよう書いてある (そのため <code>const</code> は未使用)</li>
  <li>最初に2つ定数を定義してある。ルート相対パスの置換処理で必要となる、「本スクリプトファイルの名前」と「ルートと見なしたいパス」の定義だ</li>
  <li>このスクリプトが「ルートと見なしたいパス」配下の HTML から読み込まれていない場合は、何も処理せず終了する</li>
  <li><code>replaceAttribute</code> 関数を定義。ページ中の全ての <code>link</code>・<code>script</code>・<code>a</code>・<code>img</code> 要素に対応して、ルート相対パスの記述があれば、<strong>「ルートと見なしたいパス」を結合して絶対パスに置換する</strong>、という処理を定義している</li>
  <li><code>a</code> 要素と <code>img</code> 要素については、<code>setAttribute()</code> で値を置換してやれば、すぐに画面上にも反映される。<br>しかし、<code>link</code> 要素と <code>script</code> 要素についてはそれだけでは外部ファイルを読み込んでくれず、<code>replaceChild()</code> で DOM を再挿入する必要があった</li>
  <li>本来は <code>https://USER-NAME.github.io/SUB-REPO/scripts.js</code> を読み込みたかったのに、ルート相対パスのせいで、この <code>https://USER-NAME.github.io/scripts.js</code> ファイルが読み込まれて、この処理が実行されている。<br>ということは、<code>&#x3C;script src="/scripts.js"></code> の部分だけは、コレとは別に <code>&#x3C;script src="https://USER-NAME.github.io/SUB-REPO/scripts.js"></code> を読み込んで、本来の処理を行わせてあげる必要がある。<br>そこで、「本スクリプトファイル名」の <code>script</code> 要素が登場した時だけ、別に <code>script</code> 要素を生成して <code>appendChild()</code> している</li>
  <li>CSS ファイル (<code>link</code> 要素) は <code>head</code> 要素内で読み込まれるため、本スクリプトが <code>DOMContentLoaded</code> 以降に動作すると、「ページの内容は表示されているのにスタイルが適用されていない」状態が一瞬発生してしまう。その後、本スクリプトによって <code>link</code> 要素のパスが修正され、CSS ファイルが適用されると、結果的に「画面のチラつき」が発生する。<br>本スクリプトファイルを <code>head</code> 要素内で読み込んでいれば、その場で <code>link</code> 要素のパスだけ修正してしまい、チラつきを可能な限りなくそうしている</li>
  <li>その他の要素に関しては、どこでどう呼ばれても実行できるよう、<code>DOMContentLoaded</code> か <code>window.onload</code> に <code>init()</code> 関数を予約して処理している。<br>このやり方は、読み込みタイミングが本来のタイミングより遅くなる <code>&#x3C;script src="https://USER-NAME.github.io/SUB-REPO/scripts.js"></code> にも組み込んでおくと安全だろう</li>
</ul>
<p>こんな感じ。<strong>ハッキリ言ってメチャクチャ強引。</strong></p>
<p>自分が必要なかったので、<code>iframe</code>・<code>embed</code>・<code>object</code> 要素などには対応させていないが、<code>replaceAttribute()</code> 関数を拡張すれば対応できると思う。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>今回のスクリプトは、自分のメインサイト Neo's World のミラーサイトを GitHub Pages で公開するにあたって編み出した。</p>
<ul>
  <li>正規の？方法で、ルート相対パスの起点を変更する方法はなかった (<code>base</code> 要素は効かなかった)</li>
  <li>スクリプトを読み込むような HTML になっていれば、ユーザサイトの方に同名のスクリプトファイルを置いて、ソイツから「ルート相対パス」を「絶対パス」に置換する処理を行ってやれば、なんとか直せなくもない…</li>
</ul>
<p>という話でした。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2019-09-18</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2019-09-18</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
