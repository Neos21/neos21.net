<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Windows7 で Oracle 12c を使う (環境構築) - Neo's World">
    <meta property="og:description" content="Windows7 で Oracle 12c を使う (環境構築) - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2016/04/14-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Windows7 で Oracle 12c を使う (環境構築) - Neo's World">
    <meta property="twitter:description" content="Windows7 で Oracle 12c を使う (環境構築) - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2016/04/14-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Windows7 で Oracle 12c を使う (環境構築) - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2016/04/14-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2016/index.html">2016年</a></li>
            <li><a href="/blog/2016/04/index.html">04月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2016-04-14</time></div>
        <h1 id="page-title">Windows7 で Oracle 12c を使う (環境構築)</h1>

<p>前回の記事で Windows7 に Oracle12c をインストールした。</p>
<ul>
  <li><a href="09-01.html">Oracle 12c をダウンロードする間に OTN ライセンスについて勉強する</a></li>
  <li><a href="10-01.html">Oracle 12c をインストールする</a></li>
</ul>
<p>今回はプラガブル・データベースにユーザを作り、テーブルを1つ作るところまでやってみる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%83%97%E3%83%A9%E3%82%AC%E3%83%96%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A3%E3%81%A6%E4%BD%95">プラガブル・データベースって何？</a></li>
  <li><a href="#%E3%81%A7%E3%82%8F%E3%81%A7%E3%82%8F%E3%81%95%E3%81%A3%E3%81%9D%E3%81%8F">でわでわさっそく。</a></li>
  <li><a href="#1-oracle-%E8%B5%B7%E5%8B%95%E7%8A%B6%E6%85%8B%E3%81%AE%E7%A2%BA%E8%AA%8D">1. Oracle 起動状態の確認</a></li>
  <li><a href="#2-tnsnamesora-%E3%81%AE%E4%BF%AE%E6%AD%A3">2. <code>tnsnames.ora</code> の修正</a></li>
  <li><a href="#3-pdb-%E3%81%AE%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3">3. PDB のオープン</a></li>
  <li><a href="#4-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90">4. ユーザーの作成</a></li>
  <li><a href="#5-pdborcl-%E3%81%AB%E6%8E%A5%E7%B6%9A">5. PDBORCL に接続</a></li>
  <li><a href="#6-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E4%BD%9C%E6%88%90%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%99%BB%E9%8C%B2%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%96%E5%BE%97">6. テーブル作成、データの登録、データの取得</a></li>
</ul>
<h2 id="プラガブルデータベースって何"><a class="header-link" href="#プラガブルデータベースって何"><span class="header-link-mark"></span></a>プラガブル・データベースって何？</h2>
<p>インストール時に「グローバル・データベース名」に「<code>orcl</code>」、「プラガブル・データベース名」に「<code>pdborcl</code>」というデフォルト名をそのまま設定していたもの。この「プラガブル・データベース」って何？というところから分かっていないと、次の作業が進められない。</p>
<p>プラガブルデータベースの概念は以下のサイトが分かりやすかったので引用する。</p>
<ul>
  <li>参考 : <a href="https://www.climb.co.jp/blog_dbmoto/archives/1272">スキーマ（ユーザ）作成時に「ORA-65096」～Oracle 12cのアーキテクチャはここが違う～:DBMoto | データベース アクセス ブログ</a></li>
</ul>
<blockquote>
  <p>Oracle 12cでは、まず「マルチテナントコンテナデータベース」（CDB）と呼ばれる親DBが存在し、その下に「プラガブルデータベース」（PDB）と呼ばれる子DBが存在します。<br>PDBは仮想DBのようなもので、1つのインスタンス上で複数作成・起動することができます。</p>
  <p>そしてCDBとPDBには以下のルールがあります。</p>
  <ul>
    <li>通常のローカル接続（11gR2までと同じように接続）した場合、CDBに接続される。</li>
    <li>CDBにはユーザスキーマを作成することはできない。（ORA-65096となる）</li>
    <li>ユーザスキーマはPDBに接続して作成する必要がある。</li>
    <li>CDBからはユーザスキーマが見えない。</li>
  </ul>
</blockquote>
<p>Oracle 11g までは、データベースごとにプロセスが分かれており、制御ファイルやログファイルもデータベースごとにそれぞれ作成するつくりになっていた。</p>
<p>これが Oracle 12c では、コンテナデータベース (CDB) 1つがプロセスとして起動しており、その下に仮想的な DB といえるプラガブルデータベース (PDB) が複数接続できる、ということ。「プラガブル」というだけあって、それぞれのプラガブルデータベースは、他のコンテナデータベースに繋ぎ直したりもできるみたい。</p>
<p>で、上述の引用の中にもあるとおり、ユーザスキーマを作る先はプラガブルデータベースであって、コンテナデータベースには作れないようだ。</p>
<p>ということで、冒頭に「プラガブル・データベースにユーザを作り」と書いた次第。</p>
<p>詳細な動作は以下のページも参考になる。</p>
<ul>
  <li>参考 : <a href="http://nobrooklyn.hateblo.jp/entry/2013/10/15/222955">Oracle 12cプラガブルデータベースって何？ - hatenob</a></li>
</ul>
<h2 id="でわでわさっそく"><a class="header-link" href="#でわでわさっそく"><span class="header-link-mark"></span></a>でわでわさっそく。</h2>
<p>では、さっそく環境構築を進めていく。</p>
<p>大部分は以下のサイトに沿って作業を進めた。</p>
<ul>
  <li>参考 : <a href="https://amg-solution.jp/blog/2733">Windows環境でOracle12cを使う！ ～環境構築編～ | 株式会社AMG Solution</a></li>
</ul>
<p>そのため、手順も引用。</p>
<blockquote>
  <ol>
    <li>Oracle起動状態の確認</li>
    <li>tnsnames.oraの修正</li>
    <li>PDBのオープン</li>
    <li>ユーザーの作成</li>
    <li>PDBORCLに接続</li>
    <li>テーブル作成、データの登録、データの取得</li>
  </ol>
</blockquote>
<h2 id="1-oracle-起動状態の確認"><a class="header-link" href="#1-oracle-起動状態の確認"><span class="header-link-mark"></span></a>1. Oracle 起動状態の確認</h2>
<p>「管理ツール」→「サービス」より、以下を「起動」しておく。名称はデフォルト設定でインストールしたときの名称なので、各自読み替える。</p>
<ul>
  <li>OracleServiceORCL (OracleService)</li>
  <li>OracleOraDB12Home1TNSListener (TNSListener)</li>
</ul>
<h2 id="2-tnsnamesora-の修正"><a class="header-link" href="#2-tnsnamesora-の修正"><span class="header-link-mark"></span></a>2. <code>tnsnames.ora</code> の修正</h2>
<p>自分はインストール先フォルダを変更したので多少ルート部分が違うが、<code>C:\Oracle\product\12.1.0\dbhome_1\NETWORK\ADMIN\</code> にある <code>tnsnames.ora</code> を開いて以下を追記する。これもデフォルト設定でインストールした前提なので、変更している場合は適宜変更する。</p>
<pre><code>PDBORCL =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = PDBORCL)
    )
  )
</code></pre>
<h2 id="3-pdb-のオープン"><a class="header-link" href="#3-pdb-のオープン"><span class="header-link-mark"></span></a>3. PDB のオープン</h2>
<p>コマンドプロンプトより以下のとおり入力し、SQL*Plus に接続する。</p>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Sqlplus</span> system<span class="token parameter attr-name">/password</span> as sysdba</span>
</code></pre>
<p>よく分かってないんだけど、system ユーザの後ろの <code>password</code> 部分は、何に変えても接続できた。デフォルトのパスワードが「password」ってワケではない様子？あとで調べる。</p>
<p>この時点では、CDB (コンテナ) に接続している。<code>Show con_name;</code> で確認すると <code>CDB$ROOT</code> と返ってくるので、コンテナに接続していると分かる。</p>
<p>SQL*Plus に接続したら、以下の SELECT 文で PDB のオープン状態を確認する。</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span> OPEN_MODE <span class="token keyword">FROM</span> V$PDBS<span class="token punctuation">;</span>
</code></pre>
<p>「PDBORCL」は「MOUNTED」になっているはず。この状態ではオープンしていないので、以下の SQL でオープンする。</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">ALTER</span> PLUGGABLE <span class="token keyword">DATABASE</span> PDBORCL <span class="token keyword">OPEN</span><span class="token punctuation">;</span>
</code></pre>
<p>(この部分だけ、上述の参考サイトでは記載の SQL が誤っていたので、「<a href="http://d.hatena.ne.jp/replication/20140103/1388741001">Oracle12cでプラガブル・データベース(PDB)に接続しなおす方法 - 大人になったら肺呼吸</a>」を参考にした)</p>
<p>もう一度さきほどの <code>SELECT NAME, OPEN_MODE FROM V$PDBS;</code> を入力すると、今度は「PDBORCL」が「READ WRITE」になっているはず。これで PDB がオープンされ接続できるようになる。</p>
<p>なお、PDB がオープンしていない状態で PDB へ接続しようとすると、ORA-01033 というエラーが出る。このエラー内容では分かりづらいので、まずは PDB がオープンされているかを確認する習慣を付けたい。</p>
<h2 id="4-ユーザーの作成"><a class="header-link" href="#4-ユーザーの作成"><span class="header-link-mark"></span></a>4. ユーザーの作成</h2>
<p>次に、CDB から接続先を PDB の方に変えて、ユーザを作る。</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">SESSION</span> <span class="token keyword">SET</span> CONTAINER <span class="token operator">=</span> PDBORCL<span class="token punctuation">;</span>
</code></pre>
<p>この状態で <code>Show con_name;</code> を確認すると <code>PDBORCL</code> が返ってくるので、プラガブルデータベースに接続していることが分かる。</p>
<p>以下のようにユーザを作る。</p>
<pre class="language-sql"><code class="language-sql"><span class="token comment">-- testUserの作成</span>
<span class="token keyword">CREATE</span>  <span class="token keyword">USER</span> testUser
  IDENTIFIED <span class="token keyword">BY</span> <span class="token string">"password"</span>
  <span class="token keyword">DEFAULT</span> <span class="token keyword">TABLESPACE</span> users
  <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLESPACE</span> <span class="token keyword">temp</span><span class="token punctuation">;</span>

<span class="token comment">-- testUserに権限を付与</span>
<span class="token keyword">GRANT</span> <span class="token keyword">CONNECT</span> <span class="token keyword">TO</span> testUser<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">TO</span> testUser<span class="token punctuation">;</span>

<span class="token comment">-- testUserの表領域usersに対する使用用容量の制限値 (QUOTA) を変更</span>
<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> testUser QUOTA UNLIMITED <span class="token keyword">ON</span> users<span class="token punctuation">;</span>
</code></pre>
<p>これでユーザの作成と設定は完了。</p>
<h2 id="5-pdborcl-に接続"><a class="header-link" href="#5-pdborcl-に接続"><span class="header-link-mark"></span></a>5. PDBORCL に接続</h2>
<p>一旦 <code>quit</code> (<code>exit</code>) で接続を切り、作成したユーザを使って PDB の方に直接接続してみる。ココで書いたネットサービス名 <code>@PDBORCL</code> が、<code>tnsnames.ora</code> に追記した接続記述子に変換されるワケである。</p>
<pre class="language-batch"><code class="language-batch"><span class="token command"><span class="token keyword">Sqlplus</span> testUser/password@PDBORCL</span>
</code></pre>
<p>無事接続できたら OK。</p>
<h2 id="6-テーブル作成データの登録データの取得"><a class="header-link" href="#6-テーブル作成データの登録データの取得"><span class="header-link-mark"></span></a>6. テーブル作成、データの登録、データの取得</h2>
<p>以降はこれまでの Oracle と同様、テーブルを作ってデータを入れたり取得したり、ができるはずだ。</p>
<pre class="language-sql"><code class="language-sql"><span class="token comment">-- テーブルの作成</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_tbl <span class="token punctuation">(</span>
  id      NUMBER<span class="token punctuation">,</span>
  name    VARCHAR2<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- データの登録</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_tbl <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- データの取得</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_tbl<span class="token punctuation">;</span>
</code></pre>
<p>ということで、Oracle 12c からは DB の概念が少し変わっているが、一度理解すればなんてことないし、より合理的で使いやすくなっていると感じる。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2016-04-14</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2016-04-14</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
