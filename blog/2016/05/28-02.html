<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>npm でパッケージ管理しながら Gulp で Browserify を実行させて http-server で動作確認を行う - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2016/05/28-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script defer src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2016/index.html">2016年</a></li>
            <li><a href="/blog/2016/05/index.html">05月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2016-05-28</time></div>
        <h1 id="page-title">npm でパッケージ管理しながら Gulp で Browserify を実行させて http-server で動作確認を行う</h1>

<p>JavaScript ライブラリを色々使ってみようぜってことで、Node.js がお送りする npm でパッケージを管理しながら、Gulp を使って Browserify を試してみようという。そんで動作確認には http-server というお手軽なウェブサーバーを使う。</p>
<p>一連の作業は Mac OSX El Capitan にて、標準のターミナルに Finder、エディタは CotEditor を使った。</p>
<p>Node.js は以下の記事に沿って、v5.11.1 を導入したところ。</p>
<ul>
  <li><a href="26-05.html">Node.js をバージョン管理できる体制でインストールする</a></li>
  <li><a href="27-01.html">Node.js V6 系は新しすぎるので V5 系を使うことにする</a></li>
</ul>
<p>作業の流れは以下のとおり。</p>
<ol>
  <li>作業ディレクトリを作る</li>
  <li><code>npm init</code> で package.json を作る</li>
  <li>Browserify を試すために jQuery をインストールする</li>
  <li>Browserify をインストールして単独で使ってみる</li>
  <li>Gulp をインストールして Browserify のビルドを定義してみる</li>
  <li>http-server で動作確認してみる</li>
</ol>
<h2 id="1-作業ディレクトリを作る"><a class="header-link" href="#1-作業ディレクトリを作る"><span class="header-link-mark"></span></a>1. 作業ディレクトリを作る</h2>
<p>まずは適当なところに作業ディレクトリを作る。</p>
<p>ディレクトリの作り方をいつも悩むが、ぼくは <code>/Users/【User】/Documents/</code> 配下に <code>Dev/NodeTest/</code> とディレクトリを作って、NodeTest ディレクトリを作業ディレクトリのルートにした。npm パッケージは、そのパッケージが依存する別のパッケージをさらに子階層に持つため、特に Windows の場合は、作業するディレクトリはなるべくルートに近いところにしておかないと、パスが長過ぎてエラーが発生する。</p>
<p>以降の作業は <code>/Users/【User】/Documents/Dev/NodeTest/</code> に移動した状態でターミナル操作などを行っている。</p>
<h2 id="2-npm-init-で-packagejson-を作る"><a class="header-link" href="#2-npm-init-で-packagejson-を作る"><span class="header-link-mark"></span></a>2. <code>npm init</code> で package.json を作る</h2>
<p><code>npm init</code> というコマンドを使うと、その作業ディレクトリ内で使う npm のパッケージを管理するための <em>package.json</em> というファイルを対話形式で生成できる。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> /Users/【User】/Documents/Dev/NodeTest/
$ <span class="token function">npm</span> init
</code></pre>
<p>名前とバージョンは必須だが、適当で良い。その他は未入力でもいいので Enter で適当に進めていく。完了すると作業ディレクトリに package.json というファイルができる。</p>
<p>package.json を手書きして、<code>npm install</code> コマンドを叩けば必要なパッケージがインストールできたりする。逆に <code>npm install --save</code> とかでパッケージをインストールするときに、自動的に package.json にパッケージ情報を書かせることもできる。</p>
<p><code>--save</code> オプションには何か違いがあるので以下を参照。今回はあまり考えずになんとなく <code>--save-dev</code> で書いていくことにする。<code>-D</code> という省略記法もある。</p>
<ul>
  <li>参考 : <a href="http://hblog.glamenv-septzen.info/entry/2015/03/22/233241">勉強メモ/npmの使い方(node.js=v0.11.16, npm=2.3.0, 2015-03時点) - Qiita</a></li>
</ul>
<blockquote>
  <h3 id="save--save-dev--save-optional-の違い"><a class="header-link" href="#save--save-dev--save-optional-の違い"><span class="header-link-mark"></span></a>–save / –save-dev / –save-optional の違い</h3>
  <ul>
    <li><code>--save</code> は package.json の <code>dependencies</code> に追記される。</li>
    <li><code>--save-dev</code> は package.json の <code>devDependencies</code> に追記される。</li>
    <li><code>--save-optional</code> は package.json の <code>optionalDependencies</code> に追記される。</li>
  </ul>
  <p>それぞれの違いだが、package.jsonがモジュールとして外部に公開し、他の人がnpm installした時に影響する。</p>
  <p>他の人が npm install した時に、dependencies に指定したパッケージが全てインストールされる。</p>
  <p>devDependencies に追記したものは開発時にのみ使うパッケージを指定するのに使う。そのパッケージの利用者にとっては不要で、開発者のみが使うため、利用者が npm install パッケージ名 するときはこの依存パッケージはインストールされない。もし devDependencies もインストールしたい場合は、–dev 設定を有効化(これはnpm installのオプションではなく、 npm help 7 config にあるようにnpmの設定である)して、npm install パッケージ名 –dev とする。</p>
  <p>ただし、利用者がpackage.json含めたソースコード全体をgitなどからcloneして開発する = 開発者と同等の立場として、追加パラメータ無しで package.json のあるディレクトリで npm install とだけした場合は、開発者の立場になるわけなので、devDependencies もインストールされる。というか、依存関係は全てインストールされるらしい。 –production つければ、package.jsonのところで npm install –production なら devDependencies はインストールされない。</p>
  <p>dependencies と devDependencies の使い分けだが、パッケージやプロジェクトが実行時に必要となるのを dependencies に設定し、ビルド時だけしか使われないようなビルドツール・ライブラリなどは devDependencies に入れておくと良さそう。</p>
</blockquote>
<ul>
  <li>参考 : <a href="http://qiita.com/sinmetal/items/395edf1d195382cfd8bc">npmでnode.jsのpackageを管理する - Qiita</a></li>
</ul>
<h2 id="3-browserify-を試すために-jquery-をインストールする"><a class="header-link" href="#3-browserify-を試すために-jquery-をインストールする"><span class="header-link-mark"></span></a>3. Browserify を試すために jQuery をインストールする</h2>
<p>npm のパッケージは <code>npm install -g</code> とするとグローバルインストールになる、という話はよく見かけるが、その作業ディレクトリ内で使いたいパッケージは、既にグローバルインストールしてあっても再度 <code>npm install --save-dev</code> でその作業ディレクトリ内にインストールする必要がある。</p>
<p>グローバルインストールは、パスが通っている npm の配下にパッケージがインストールされるため、どんな階層に居てもコマンドを叩いて実行することができるようになる。つまり、作業ディレクトリに関係なく、コマンドラインで利用したいパッケージは、グローバルインストールしておく、ということだ。例えば gulp とか bower なんかである。</p>
<p>一方ローカルインストールは、その作業ディレクトリで利用する npm パッケージを入れる方法。そのディレクトリ内で作った成果物が、その npm パッケージを利用している・依存している、という場合はローカルインストールである。そしてこの「依存している」という宣言を、<code>--save</code> オプションなどで示すことで、<code>package.json</code> にその情報が記録される、というワケである。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 普通 jQuery なんかをグローバルインストールすることはないが…。</span>
$ <span class="token function">npm</span> <span class="token function">install</span> -g jquery

<span class="token comment"># 作業ディレクトリ内で使うときはローカルインストールする</span>
$ <span class="token function">npm</span> <span class="token function">install</span> jquery --save-dev
</code></pre>
<h2 id="4-browserify-をインストールして単独で使ってみる"><a class="header-link" href="#4-browserify-をインストールして単独で使ってみる"><span class="header-link-mark"></span></a>4. Browserify をインストールして単独で使ってみる</h2>
<p>JS ファイル内で <code>require()</code> 構文が使えるようになり、単一ファイルにまとめてビルドしてくれる Browserify をインストールしてみる。これも <code>--global</code> でインストール済みでも、再度 <code>npm install</code> しておく。</p>
<p><code>install</code> は <code>i</code> と省略できるので、以下の2つは同じ動作になる。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> browserify --save--dev
$ <span class="token function">npm</span> i browserify -D
</code></pre>
<p>次にサンプルの HTML と JavaScript ファイルを作る。いずれも作業ディレクトリのルートに作ることにする。<code>touch</code> コマンドで空ファイルを作成。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">touch</span> index.html
$ <span class="token function">touch</span> src.js
</code></pre>
<p><em>index.html</em> は以下のように書いて、あとでビルドする予定の JS ファイル「dest.js」を読み込むようにしておく。空ファイルをエディタで開いてカキカキ。</p>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>Node Test<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>Test.<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dest.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p><em>src.js</em> には require を使って jQuery を読み込ませた簡単なコードを書いてみる。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// jQuery を読み込む</span>
<span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jquery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"Test."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>src.js ができたら、試しにコマンドラインから Browserify を実行してビルドしてみる。</p>
<pre class="language-bash"><code class="language-bash">$ browserify src.js <span class="token operator">></span> test.js
</code></pre>
<p>こうすると作業ディレクトリに <em>test.js</em> ができていて、開いてみると何やら jQuery のモジュールがゴッソリ入っていて、最後の方に src.js 内に書いた自分のコードが入っている。</p>
<p>Browserify はこうやって、<code>npm install</code> で入れたライブラリを読み込んで1つの JS ファイルに結合できる。</p>
<h2 id="5-gulp-をインストールして-browserify-のビルドを定義してみる"><a class="header-link" href="#5-gulp-をインストールして-browserify-のビルドを定義してみる"><span class="header-link-mark"></span></a>5. Gulp をインストールして Browserify のビルドを定義してみる</h2>
<p>簡単なビルドであれば <code>npm run</code> というコマンドでもできるらしい。</p>
<ul>
  <li>参考 : <a href="http://qiita.com/hashrock/items/15f4a4961183cfbb2658">フロントエンド開発の３ステップ（npmことはじめ） - Qiita</a></li>
</ul>
<p>でも今回は Gulp をお試しするってことで。</p>
<p>まずは Gulp をインストール。あと、よく分かってないけど vinyl-source-stream ってヤツも、Browserify の時に必要になるようなので入れておく。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> gulp --save--dev
$ <span class="token function">npm</span> <span class="token function">install</span> vinyl-source-stream --save-dev
</code></pre>
<ul>
  <li>参考 : <a href="http://tttttahiti.hatenablog.com/entry/2015/08/18/185325">gulp で browserify - 新しい日記</a></li>
  <li>参考 : <a href="http://umai-bow.hateblo.jp/entry/2014/10/08/002235">gulp と browserify と vinyl の話</a></li>
  <li>参考 : <a href="http://blog.shibayu36.org/entry/2016/01/06/102000">JSをbrowserifyでビルドし、ライセンスコメントを適切に残す - $shibayu36->blog;</a></li>
</ul>
<p>そしたら Gulp のタスクを定義する gulpfile.js を作業ディレクトリ直下に作る。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">touch</span> gulpfile.js
</code></pre>
<p><em>gulpfile.js</em> の中にはこんな感じに書く。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"gulp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> browserify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"browserify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"vinyl-source-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// build-js というタスク名で定義</span>
gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">"build-js"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">browserify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// ビルド対象のファイルを指定する</span>
    entries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src.js"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// Browserify を実行</span>
  <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">"dest.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// bundle() が返したファイルストリームを vinyl っていう形式に変えないといけない。</span>
  <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">"./"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// JS を出力</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>この定義ファイルに沿って Gulp を実行する。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># gulpfile.js 内に書いたタスク名で実行</span>
$ gulp build-js
</code></pre>
<p>こんな風にすると、作業ディレクトリ直下に <em>dest.js</em> が生成されている。</p>
<h2 id="6-http-server-で動作確認してみる"><a class="header-link" href="#6-http-server-で動作確認してみる"><span class="header-link-mark"></span></a>6. http-server で動作確認してみる</h2>
<p>http-server という、コマンドラインで簡単にウェブサーバーが立てられるライブラリがある。手軽に動作確認したい時に使えそう。</p>
<ul>
  <li>参考 : <a href="https://firegoby.jp/archives/5706">Node.jsのhttp-serverっていうコマンドラインのウェブサーバーが便利 | Firegoby</a></li>
</ul>
<p>まずはグローバルインストール。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g http-server
</code></pre>
<p>次に作業ディレクトリで以下のコマンドを実行。</p>
<pre class="language-bash"><code class="language-bash">$ http-server
</code></pre>
<p>たったこれだけでサーバが起動する。アクセス URL はコマンド実行後に表示される。どれでも良い。</p>
<ul>
  <li><a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a></li>
  <li><a href="http://192.168.1.4:8080/">http://192.168.1.4:8080/</a></li>
  <li><a href="http://0.0.0.0:8080/">http://0.0.0.0:8080/</a></li>
</ul>
<p>アクセスすると、作成していた index.html が開き、この中で読み込むように書いておいた dest.js は先程 Gulp タスクとして実行した Browserify のビルド結果ファイル。先ほどのコードでいえばコンソールに「Test.」の文言が出ていれば、正しく jQuery を require できている。</p>
<hr>
<p>では最後にこれまでのコマンドのまとめ。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 作業ディレクトリを用意して移動・npm init で package.json を作る</span>
$ <span class="token builtin class-name">cd</span> /Users/<span class="token punctuation">(</span>User<span class="token punctuation">)</span>/Documents/Dev/NodeTest/
$ <span class="token function">npm</span> init

<span class="token comment"># 必要なモジュールをインストールする</span>
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev jquery
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev browserify
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev gulp
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev vinyl-source-stream

<span class="token comment"># 必要なファイルの生成 (個別の中身は前述のとおり)</span>
$ <span class="token function">touch</span> index.html
$ <span class="token function">touch</span> src.js
$ <span class="token function">touch</span> gulpfile.js

<span class="token comment"># Gulp タスクを実行し JS ファイルをビルドする</span>
$ gulp build-js

<span class="token comment"># http-server で動作確認する</span>
$ <span class="token function">npm</span> <span class="token function">install</span> -g http-server
$ http-server
</code></pre>
<p>以上。長くなったけど、コレで npm と Browserify と Gulp と http-server というライブラリの基礎がお試しできた。</p>
<p>次回はファイルの変更を検知して、Gulp でのビルドを自動で実行させるようにする。</p>
<ul>
  <li><a href="/blog/2016/07/05-01.html">Gulp で Browser-Sync を動かしてブラウザにリアルタイムに変更を反映させる</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2016-05-28</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2016-05-28</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
