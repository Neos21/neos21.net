<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>GitBash in ConEmu で256色を表示させるまでの軌跡 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2016/11/05-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2016/index.html">2016年</a></li>
            <li><a href="/blog/2016/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2016-11-05</time></div>
        <h1 id="page-title">GitBash in ConEmu で256色を表示させるまでの軌跡</h1>

<p>ConEmu 上で GitBash を使い始めて、何やら256色表示できるらしいと聞いて色々知らべてみたら思わぬ地雷だった。</p>
<h2 id="発端"><a class="header-link" href="#発端"><span class="header-link-mark"></span></a>発端</h2>
<p>GitBash を直接起動した場合、以下のように256色表示できる。これは、以下のシェルスクリプトで256色表示をテストしたところ。</p>
<ul>
  <li>参考：<a href="https://gist.github.com/rcmdnk/6457780#file-colcheck-sh">colcheck.sh · GitHub</a></li>
</ul>
<p>
  <img src="05-01-01.png" alt="256色表示">
</p>
<p><em>純正 GitBash であれば、256色表示できるし、コンソールバッファも有効である。</em></p>
<p>だが、同じシェルスクリプトを ConEmu 上で動作させている GitBash で実行すると、256色が正しく表示できない。</p>
<p>
  <img src="05-01-02.png" alt="256色表示できない">
</p>
<p>はてはて、何でだろうと思って調べて試行錯誤していたが、大変だったし、実現するには残念なトレードオフがある。</p>
<h2 id="先に結論"><a class="header-link" href="#先に結論"><span class="header-link-mark"></span></a>先に結論</h2>
<p><em>設定次第で ConEmu 上の GitBash でも256色表示はできる</em>。しかし、<strong>コンソールのバッファを切らないといけない</strong>。要するに画面上に見えている範囲しか残らないので、スクロール表示ができない。これは不便だ。</p>
<p>また、<em>ホームディレクトリにコネクタが出力するログが残る</em>。<code>connector-23944.log</code> といったファイルがボコボコできて、コンソールの全てを記録しているみたい。ログローテーションもなくどんどん増えていくので鬱陶しいのだが、切り方がわからなかった。</p>
<h2 id="具体的な設定方法"><a class="header-link" href="#具体的な設定方法"><span class="header-link-mark"></span></a>具体的な設定方法</h2>
<p>環境は Windows10 64bit。</p>
<ol>
  <li>以下のサイトから <strong>Cygwin-Connector</strong> をダウンロードする (最新版は <code>terminals.v0.7.4.7z</code>)。
    <ul>
      <li><a href="https://github.com/Maximus5/cygwin-connector/releases">Releases · Maximus5/cygwin-connector · GitHub</a></li>
    </ul>
  </li>
  <li>ダウンロードした <code>.7z</code> ファイルを解凍し、<code>conemu-msys2-64.exe</code> を取り出す。
    <ul>
      <li>32bit 版の OS の人は <code>conemu-msys2-32.exe</code> を使えばできると思う (未検証)。</li>
    </ul>
  </li>
  <li><code>conemu-msys2-64.exe</code> を <code>C:\Program Files\Git\usr\bin\</code> 配下にコピーする。</li>
  <li>ConEmu で以下のように設定する。
    <ul>
      <li>Features：「Inject ConEmuHk」「ASNSI and xterm sequences」にチェックを付ける。</li>
      <li>Features - Colors：「TrueMod (24bit color) support」にチェックを付ける。</li>
    </ul>
  </li>
  <li>同じく ConEmu の Startup - Tasks で以下のようなタスクを追加する。</li>
</ol>
<pre class="language-bash"><code class="language-bash"><span class="token string">"%ConEmuDir%\..\Git\git-cmd.exe"</span> --no-cd --command<span class="token operator">=</span>usr/bin/conemu-msys2-64.exe -l -cur_console:h0
</code></pre>
<p>これで完成。</p>
<p>先程の256色表示をテストするシェルスクリプトを実行してみる。</p>
<p>
  <img src="05-01-06.png" alt="一応見えた">
</p>
<p>う～む綺麗。だがバッファを切らないといけないのがな…。</p>
<p>設定箇所のキャプチャ置いときます。</p>
<ul>
  <li>
    <img src="05-01-03.png" alt="設定箇所1">
  </li>
  <li>
    <img src="05-01-04.png" alt="設定箇所2">
  </li>
  <li>
    <img src="05-01-05.png" alt="設定箇所3">
  </li>
</ul>
<p>カラーチェックのスクリプト？は、ConEmu 内にもあるみたい。以下のように実行する。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token string">"C:\Program Files\ConEmu\ConEmu\Addons\AnsiColors256.ans"</span>
</code></pre>
<p>純正 GitBash では何もしなくとも256色綺麗に出るし、バッファも有効。でも ConEmu 上から起動した GitBash では殆どの色が灰色に抜け落ちる。</p>
<p>先程設定した Cygwin-Connector 経由であれば、ConEmu 上の GitBash からも256色表示できる。しかし、バッファを切らないといけない。イマイチ…。</p>
<h2 id="参考文献"><a class="header-link" href="#参考文献"><span class="header-link-mark"></span></a>参考文献</h2>
<ul>
  <li><a href="http://rcmdnk.github.io/blog/2013/09/05/computer-cygwin-putty-vim/">Cygwin+screenで256 colorを有効にする</a>
    <ul>
      <li>256色表示をテストするシェルスクリプトを公開していた記事。</li>
    </ul>
  </li>
  <li><a href="http://e8l.hatenablog.com/entry/2016/03/24/161206">ConEmuからMSYS2のシェルを起動したときに256色対応させる - 水を見ると釣りがしたくなる</a>
    <ul>
      <li>以下の公式記事を紹介していた日本語記事。</li>
    </ul>
  </li>
  <li><a href="http://conemu.github.io/en/CygwinMsysConnector.html">ConEmu | cygwin/msys terminal connector</a>
    <ul>
      <li>公式の記事。</li>
    </ul>
  </li>
  <li><a href="http://oogatta.hatenadiary.jp/entry/2014/04/05/111408">cmd.exe と awsome print - oogatta のブログ</a></li>
  <li><a href="https://github.com/cmderdev/cmder/issues/379">Enable 256 colour support over SSH · Issue #379 · cmderdev/cmder · GitHub</a></li>
  <li><a href="http://conemu.github.io/en/AnsiEscapeCodes.html#Xterm_256_color_map">ConEmu | ANSI X3.64 and Xterm-256 Support</a></li>
  <li><a href="http://superuser.com/questions/1030047/conemu-ls-256-colors-not-working">windows 10 - ConEmu + ls -- 256 colors not working - Super User</a></li>
  <li><a href="http://qiita.com/Ted-HM/items/4f2feb9fdacb6c72083c">MSYS2で快適なターミナル生活 - Qiita</a></li>
  <li><a href="https://github.com/Maximus5/ConEmu/issues/628">Connector for git-cmd.exe? · Issue #628 · Maximus5/ConEmu · GitHub</a></li>
  <li><a href="http://stackoverflow.com/questions/12913392/cant-enable-256-colors-in-conemu">terminal - Can't enable 256 colors in ConEmu - Stack Overflow</a></li>
</ul>
<p>この文字色を変えているのは、ANSI エスケープシーケンスと呼ばれる特殊な文字を渡して実現しているみたい。よー分かってないので勉強します。</p>
<p>…</p>
<p>…あれ、そういやそもそも何で256色表示したかったんだっけ…？</p>
<blockquote>
  <p>You have no need in 256-colors In fact.</p>
</blockquote>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2016-11-05</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2016-11-05</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
