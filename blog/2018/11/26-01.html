<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>ギターのスケール図を生成する Angular アプリを作った - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/11/26-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-11-26</time></div>
        <h1 id="page-title">ギターのスケール図を生成する Angular アプリを作った</h1>

<p>趣味の融合。</p>
<p>最近めっきり弾かなくなったものの、ギターを趣味としているので、Angular アプリでギターのスケール表の一つや二つ作れないといかんぞ (？) ってなって、作った。その名も <strong>Guitar Scale Generator</strong>。</p>
<ul>
  <li><a href="https://neos21.github.io/angular-utilities/guitar-scale-generator">https://neos21.github.io/angular-utilities/guitar-scale-generator</a></li>
</ul>
<p>任意のルート音とスケール名を指定して「Generate」ボタンを押すと、ギター指板を模したテーブルに、そのスケールの構成音を描画する。</p>
<p>フレット数、弦の数 (最近は8弦ギターとかあるんで…)、各弦のチューニングは変更可能にした。また、スケール図は複数描画できるので、曲のコード進行に合わせていくつかのスケールを表示しておく、といったことも可能だ。</p>
<p>選択できるスケールの種類が少ないと思うが、これからちまちま追加していこうと思う。</p>
<p>以下、コレを作るにあたって大変だったこととか語る。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%83%93%E3%82%B8%E3%83%8D%E3%82%B9%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%8C%E8%BE%9B%E3%81%8B%E3%81%A3%E3%81%9F">ビジネスロジックが辛かった…</a></li>
  <li><a href="#%E6%8C%87%E6%9D%BF%E3%82%92%E8%A1%A8%E7%8F%BE%E3%81%99%E3%82%8B-css">指板を表現する CSS</a>
    <ul>
      <li><a href="#%E3%82%AE%E3%82%BF%E3%83%BC%E3%81%AE%E5%BC%A6%E3%82%92%E5%86%8D%E7%8F%BE%E3%81%99%E3%82%8B--%E8%A1%8C%E3%81%AE%E5%9E%82%E7%9B%B4%E4%B8%AD%E5%A4%AE%E3%82%92%E6%A8%AA%E5%88%87%E3%82%8B%E6%A8%AA%E7%B7%9A%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9">ギターの弦を再現する : 行の垂直中央を横切る「横線」の作り方</a></li>
      <li><a href="#%E3%83%9D%E3%82%B8%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%9E%E3%83%BC%E3%82%AF%E3%81%AE%E5%86%8D%E7%8F%BE--nth-of-type-%E3%82%92%E4%BD%BF%E3%81%86">ポジションマークの再現 : <code>nth-of-type</code> を使う</a></li>
    </ul>
  </li>
  <li><a href="#reactiveforms-%E3%81%A8%E9%80%A3%E5%8B%95%E3%81%97%E3%81%A6%E5%86%85%E5%AE%B9%E3%81%8C%E5%A4%89%E5%8C%96%E3%81%99%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9">ReactiveForms と「連動して内容が変化する項目」の作り方</a></li>
  <li><a href="#formarray-%E3%81%A8-formcontrol-%E3%81%AE%E6%93%8D%E4%BD%9C%E3%81%8C%E8%BF%B7%E3%81%A3%E3%81%9F">FormArray と FormControl の操作が迷った</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="ビジネスロジックが辛かった"><a class="header-link" href="#ビジネスロジックが辛かった"><span class="header-link-mark"></span></a>ビジネスロジックが辛かった…</h2>
<p>「この音はなんか気持ちいいなぁ」とか「コレはなんか外してる感あるなぁ」とかいうノリでギターをやってきたので、音楽理論もへったくれも知らず、どうやってスケール表を作るか、というビジネスロジック部分に悩んだ。</p>
<p>音階名は、フラット表記 (Db) とシャープ表記 (C#) があるので、両方に対応できるよう、音階名の定数配列を作った。</p>
<p>スケールについては、ルート音から半音ごとに、その度数の音が構成音か否かを Boolean で示す配列を作った。メジャースケールならこんな感じ。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
  key<span class="token operator">:</span> <span class="token string">'major'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'Major Scale'</span><span class="token punctuation">,</span>
  <span class="token comment">//       Tonic         M2/9          M3     P4/11         P5            M6/13         M7</span>
  <span class="token comment">//              全            全          半       全            全            全           半</span>
  <span class="token comment">//       C             D             E      F             G             A             B       (C)</span>
  scale<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ココは頑張って自分で作っていくしかないのだが、コレを書いているうちに「マイナーサードとかいうのってそういうことかぁ」みたいなことが分かってきた。いまさら…。</p>
<p>弦ごとのチューニングを入力フォームで指定してもらうので、コレで開放弦の音階が分かる。まずは開放弦の音階が、指定のスケールの構成音かどうかを調べ、そこからフレットの数だけループして、1弦あたりの「構成音か否か」を控えていく。コレを指定の弦の数だけループすれば、スケール表の出来上がり。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 擬似コードで表現</span>

<span class="token comment">// スケール図にするデータ。配列で1弦ごとのデータを持つ</span>
<span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">for</span><span class="token punctuation">(</span> 指定の弦の数だけループする <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1弦あたりのデータ。フレットごとのデータを持つ</span>
  <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 指定のチューニング情報から、その弦の0フレット = 開放弦の音階を調べる</span>
  <span class="token keyword">const</span> zeroFret <span class="token operator">=</span> <span class="token function">detectZeroFret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">for</span><span class="token punctuation">(</span> 指定のフレットの数だけループする <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    line<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span> そのフレットの音階が指定のスケールの構成音なら、音階名をセットする <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 1弦のデータをスケール図に追加する</span>
  scale<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// スケール図のデータの出来上がり</span>
<span class="token keyword control-flow">return</span> scale<span class="token punctuation">;</span>
</code></pre>
<p>さきほどのスケール定義 (<code>true</code>・<code>false</code> が並ぶ配列) は1オクターブ分のデータしか蓄えていないので、フレットの数だけループする時に、スケール定義からデータを取り出す添字を途中でリセットしたりする必要がある。この辺は定義したデータに合わせてよしなに…。</p>
<p>結構冗長な実装になってしまったのだが、弦数・フレット数・チューニングをどのように変えても動作するようにはできた。入力フォームとしては用意していないが、10弦の60フレット、みたいな指板も生成できる。</p>
<p>バカなりに頑張った。w</p>
<h2 id="指板を表現する-css"><a class="header-link" href="#指板を表現する-css"><span class="header-link-mark"></span></a>指板を表現する CSS</h2>
<p>スケール図としてギターの指板を再現するために、「ギター弦」の表現と、「ポジションマーク」の再現を頑張った。</p>
<h3 id="ギターの弦を再現する--行の垂直中央を横切る横線の作り方"><a class="header-link" href="#ギターの弦を再現する--行の垂直中央を横切る横線の作り方"><span class="header-link-mark"></span></a>ギターの弦を再現する : 行の垂直中央を横切る「横線」の作り方</h3>
<p>まず「ギター弦」の再現だが、コレはどういうことかというと、「この弦を押さえて！」を表現するには、弦の上に音階名を配置する必要があった。</p>
<p>例えば、5弦 (A 弦) の3フレット・5フレットを押さえて、C 音・D 音を表現するには、以下のように、「C」と「D」の文字が横線に串刺しにされているようなビジュアルにする必要があるのだ。</p>
<pre><code>E |--|--|--|-------|--|-------|--|
B |--|--|--|-------|--|-------|--|
G |--|--|--|-------|--|-------|--|
D |--|--|--|-------|--|-------|--|
A |--|--|--|-[ C ]-|--|-[ D ]-|--|
E |--|--|--|-------|--|-------|--|
    0  1  2       3  4       5  6 ...
</code></pre>
<p>コレを実現するためには、通常の <code>border</code> は使えないので、<strong>横線を表現した <code>linear-gradient</code> を作成する</strong>ことで対応した。</p>
<pre class="language-css"><code class="language-css"><span class="token selector">td</span> <span class="token punctuation">{</span>
  <span class="token comment">/* サイズを固定する */</span>
  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token unit">em</span><span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token unit">em</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* フレットを示す左右の罫線は border で引く */</span>
  <span class="token property">border-right</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">px</span> solid <span class="token hexcode color">#ccc</span><span class="token punctuation">;</span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">px</span> solid <span class="token hexcode color">#ccc</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* 太さ 1px の横線を作り、垂直中央に配置した */</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to bottom<span class="token punctuation">,</span> <span class="token hexcode color">#ccc</span><span class="token punctuation">,</span> <span class="token color">transparent</span> <span class="token number">1</span><span class="token unit">px</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token unit">%</span> <span class="token number">100</span><span class="token unit">%</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token unit">%</span> <span class="token number">50</span><span class="token unit">%</span> no-repeat<span class="token punctuation">,</span> <span class="token color">transparent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>background</code> のショートハンド、なかなか覚えない…。<code>position-x position-y / size-x size-y</code> の順番！</p>
<h3 id="ポジションマークの再現--nth-of-type-を使う"><a class="header-link" href="#ポジションマークの再現--nth-of-type-を使う"><span class="header-link-mark"></span></a>ポジションマークの再現 : <code>nth-of-type</code> を使う</h3>
<p>次に、ギター指板のポジションマークを再現する。6弦ギターの一般的なドットマークは、</p>
<ul>
  <li>3・5・7・9F に1つ・3弦と4弦の間</li>
  <li>12F に2つ・それぞれ2弦と5弦に重なる位置</li>
</ul>
<p>と配置される。そしてコレが 13F 以降もループするので、15・17・19・21F に1つ、24F に2つ、と配置される。</p>
<p>ポジションマーク自体は <code>::before</code> 擬似要素の <code>content: "●";</code> で雑に再現するとして、</p>
<ul>
  <li>12フレットごとにループするにはどうするか</li>
  <li>弦と弦の間 = 今回の場合、スケール図を <code>table</code> で作っているので、行 (<code>tr</code>) を飛び越えたセルとセル (<code>td</code>) の間に、どうやってドットを配置するか</li>
</ul>
<p>というところが課題だった。</p>
<p>まず12フレットごとのループだが、コレは <strong><code>td:nth-of-type(12n + 4)</code></strong> といった書き方で再現できた。</p>
<p>次に、弦と弦にドットを配置する方法は、<strong><code>transform: translateY(-50%)</code></strong> でズラすことで対処した。</p>
<pre class="language-css"><code class="language-css"><span class="token comment">/* 
 * ポジションマーク
 * - 3・5・7・9F : 3・4弦の間
 * - 12F : 本来は2・5弦に重なるが、それだとポジションマークに重なる音階名が見づらいので、今回は2・3弦と4・5弦の間に置く
 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span>  <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span>  <span class="token comment">/* 3F・15F … 3・4弦の間 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span>  <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span>  <span class="token comment">/* 5F・17F … 3・4弦の間 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span>  <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span>  <span class="token comment">/* 7F・19F … 3・4弦の間 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span>  <span class="token comment">/* 9F・21F … 3・4弦の間 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span>  <span class="token comment">/* 12F・24F その1 … 2・3弦の間 */</span>
<span class="token property">tr</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token property">td</span><span class="token punctuation">:</span><span class="token function">nth-of-type</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token unit">n</span> <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>before   <span class="token comment">/* 12F・24F その2 … 4・5弦の間 */</span> <span class="token punctuation">{</span>
  <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">"●"</span><span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token color"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
  
  <span class="token comment">/* td 要素内の邪魔をしないようフロートさせる */</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> <span class="token number">-1</span><span class="token punctuation">;</span>  <span class="token comment">/* td 要素内のコンテンツの裏に重なるようにする */</span>
  
  <span class="token comment">/* 実際は4弦 (12F の場合は3弦と5弦) の行に「●」を配置しているので、1つ上の弦との間に配置されるよう、上にズラす */</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translateY</span><span class="token punctuation">(</span><span class="token number">-50</span><span class="token unit">%</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>translate</code> 最高だな、<code>position: absolute</code> でのズラし以上に柔軟性がある。もう「どこでも配置モード」の悪夢は起こさないぞ…！</p>
<h2 id="reactiveforms-と連動して内容が変化する項目の作り方"><a class="header-link" href="#reactiveforms-と連動して内容が変化する項目の作り方"><span class="header-link-mark"></span></a>ReactiveForms と「連動して内容が変化する項目」の作り方</h2>
<p>スケール作成時のフォームは Angular の ReactiveForms で作成したが、</p>
<ul>
  <li>弦の数を変えると「チューニング」欄にある「各弦のチューニング」項目を増減させる</li>
  <li>「チューニングプリセット」を変えると、それに合わせて「各弦のチューニング」を変更する</li>
  <li>「各弦のチューニング」を変えると、そのチューニングがプリセットと合致するかチェックして「チューニングプリセット」項目を変更する</li>
</ul>
<p>というように、<em>ある項目の変化によって他の項目も変更する</em>、という処理が必要だった。</p>
<p>「項目 A が変わった時に項目 B を操作する」という一方的な操作なら、以下のように <strong><code>valueChanges</code></strong> を <code>subscribe()</code> することで対応できる。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputA'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">valueChanges</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 項目 A の値が、変数「value」の値に変わった</span>
  
  <span class="token comment">// これに応じて項目 B の値を変える</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputB'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setValue</span><span class="token punctuation">(</span>value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>しかし今回は、「チューニングプリセット」と「各弦のチューニング」が相互に監視して値を書き換え合ってしまうので、コレをそのまま実装すると <em><code>Maximum call stack size exceeded</code></em> というエラーが発生してしまう。</p>
<ul>
  <li>項目 A が変わったので項目 B を変える → 項目 B が変わったので項目 A を変える → 項目 A が変わったので項目 B を変える…</li>
</ul>
<p>…という再帰的な呼び出しが大量に発生してしまうことが原因だ。</p>
<p>コレのうまい解決策が見つからず、結局、<strong>ある値が変化した時、一旦他の項目を <code>unsubscribe</code> してから処理を行い、再度 <code>subscribe</code> する</strong>という実装にした。先程のコードでいうとこんな感じだ。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// 項目ごとの Subscription を控えるメンバ変数を作っておく</span>
<span class="token keyword">private</span> subscribes <span class="token operator">=</span> <span class="token punctuation">{</span>
  inputA<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  inputB<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// [★] 項目 A の変更時 : Subscription をメンバ変数に控えておく</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputA</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputA'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">valueChanges</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 項目 B の監視を一時的に止める</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputB</span><span class="token punctuation">.</span><span class="token method function property-access">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputB</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">// null に戻す</span>
  
  <span class="token comment">// 項目 A の変化に応じて項目 B の値を変える</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputB'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setValue</span><span class="token punctuation">(</span>value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 項目 B の監視処理を再度設定する : [☆] 部分の実装と全く同じ</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputB</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputB'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">valueChanges</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span> <span class="token comment">/* 省略 */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [☆] 項目 B の変更時</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputB</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputB'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">valueChanges</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// コチラは逆に、項目 A の監視を一時的に止める</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputA</span><span class="token punctuation">.</span><span class="token method function property-access">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputA</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">// null に戻す</span>
  
  <span class="token comment">// 項目 B の変化に応じて項目 A の値を変える</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputA'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setValue</span><span class="token punctuation">(</span>value <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 項目 A の監視処理を再度設定する : [★] 部分の実装と全く同じ</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subscribes</span><span class="token punctuation">.</span><span class="token property-access">inputA</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'inputA'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">valueChanges</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span> <span class="token comment">/* 省略 */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>このような作りにするため、<code>unsubscribe()</code> 部分の処理と、再度 <code>subscribe()</code> する部分の処理とを、別々の関数に抜き出して対処した。</p>
<p>なんかココはもっと上手いやり方がある気がするんだよなぁ…。でもとりあえず動くモノが作りたくて、勢いで作ってしまった。<em>「FIXME」</em>な実装でろう…。</p>
<h2 id="formarray-と-formcontrol-の操作が迷った"><a class="header-link" href="#formarray-と-formcontrol-の操作が迷った"><span class="header-link-mark"></span></a>FormArray と FormControl の操作が迷った</h2>
<p>以前も FormArray について解説記事を書いたが、その時は、FormGroup を配列で持つ構成にしていた。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// こういう構成のモノは記事で紹介したことがある</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormGroup</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  someArray<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormArray</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormGroup</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  age<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormGroup</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  age<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormGroup</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  age<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li><a href="/blog/2018/05/21-01.html">Angular の FormArray で項目数が動的に増える入力フォームを実現する</a></li>
</ul>
<p>今回、弦ごとのチューニング情報をフォームで保持するにあたって、FormArray 内に FormGroup を作るのは冗長と思い、FormArray 直下に直接 FormControl を置いてみることにした。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// こんな構成にしたい</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormGroup</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  tuning<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormArray</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FormControl</span></span><span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Typescript 側のコードは、この作りで問題ない。問題はコレを HTML 側でループ表示する方法がちょっと手間取った。</p>
<p>FormArray の制約上、型変換が必要になる部分があるので、まずは TypeScript 側で以下のような <em>Getter</em> メソッドを作っておく必要がある。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// 先程作った myForm 内の tuning プロパティを返す Getter。FormArray 型であることを明示する</span>
<span class="token keyword">get</span> <span class="token function">myFormTuing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">FormArray</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">myForm</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'tuning'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token maybe-class-name">FormArray</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>続いて HTML 側。試行錯誤した結果、以下の構成で上手くいった。</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>form</span> <span class="token attr-name">[formGroup]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myForm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ng-container</span> <span class="token attr-name">formArrayName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tuning<span class="token punctuation">"</span></span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>let control of myFormTuning.controls; index as i<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>select</span> <span class="token attr-name">[formControlName]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>option</span><span class="token punctuation">></span></span>適当にオプション項目を用意する<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>option</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>select</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ng-container</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>form</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>formArrayName</code> で、<code>this.myForm.get('tuning')</code> と等価になるよう名前を指定する。</p>
<p>この FormArray をループする時に、Getter メソッドである <code>myFormTuning</code> が必要になる。それを使っているのが <code>*ngFor</code> 部分。しかし、<code>myFormTuning.controls</code> から FormControl を1つずつ取り出して、変数 <code>control</code> に入れたものの、今回は使用しない。必要なのは添字の方なので、<code>index as i</code> (もしくは <code>let i = index</code>) が重要。</p>
<p>この添字を、<code>*ngFor</code> でループする内部の要素の <code>[formControlName]</code> に渡す。すると、<code>formArrayName="tuning"</code> で取得できる FormArray 内の、「0番目の FormControl」「1番目の FormControl」を特定できるようになり、この場合 <code>select</code> 要素のバインディングが出来るようになる。</p>
<p>この辺の構築が少々難儀だが、その分、FormArray に対して動的に FormControl を追加したり、あるいは逆に削除したり、といった複雑な操作も容易にできるようになる。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>ベースとなるロジックはできたので、あとはスケール定義を増やしたり、指定が便利になるようにチューニングのプリセットを増やしたりできれば良いかな、というところ。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-11-26</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-11-26</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
