<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="よく分からないまま Babel 関連のパッケージをアップデートしてみた - Neo's World">
    <meta property="og:description" content="よく分からないまま Babel 関連のパッケージをアップデートしてみた - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2018/11/23-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="よく分からないまま Babel 関連のパッケージをアップデートしてみた - Neo's World">
    <meta property="twitter:description" content="よく分からないまま Babel 関連のパッケージをアップデートしてみた - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2018/11/23-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>よく分からないまま Babel 関連のパッケージをアップデートしてみた - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/11/23-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/11/index.html">11月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-11-23</time></div>
        <h1 id="page-title">よく分からないまま Babel 関連のパッケージをアップデートしてみた</h1>

<p>メインサイト Neo's World には、軽微な JavaScript を組み込んでいる。コーディング時は ES2015 で実装し、Gulp の Watch タスクにて Babelify を使ってトランスパイルと圧縮をしている。</p>
<p>Babelify の使い方については以下の記事で説明した。</p>
<ul>
  <li><a href="/blog/2017/07/27-01.html">Browserify + Babelify + Babel-Preset-ES2015 で ES2015 をトランスパイルして1つのファイルに結合する</a></li>
</ul>
<blockquote>
  <p>お馴染み Browserify で複数のファイルを1つにまとめるのだが、その際にトランスパイルするためのツールを間に挟み込むことができる。そのツールとして Babelify を指定し、Babelify が使用するトランスパイルの設定情報として、Babel-Preset-ES2015 というパッケージを読み込む、という関係。</p>
</blockquote>
<p>Browserify でバンドルする際のオプションに、Babel ラッパー的な位置付けの Babelify が横入りし、どういう言語設定でトランスパイルするか、という内訳は Babel-Preset-ES2015 というパッケージを指定する、という関係だった。</p>
<p>今回、Neo's World の構築に使用するパッケージ群をアップデートしようと思い立っていじりはじめたところ、Babel 周りのパッケージ名が変わっていたので、その部分だけ抜き出してまとめる。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E9%96%8B%E7%99%BA%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA">開発リポジトリ</a></li>
  <li><a href="#%E5%85%83%E3%81%AE%E7%8A%B6%E6%85%8B">元の状態</a></li>
  <li><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">バージョンアップしてみる</a></li>
  <li><a href="#%E5%A4%89%E6%9B%B4%E5%BE%8C">変更後</a></li>
</ul>
<h2 id="開発リポジトリ"><a class="header-link" href="#開発リポジトリ"><span class="header-link-mark"></span></a>開発リポジトリ</h2>
<p>Neo's World のソースコードは以下のリポジトリで公開している。</p>
<ul>
  <li><a href="https://github.com/Neos21/neos21.net">GitHub - Neos21/neos21.net: Repository of Neo's World</a></li>
</ul>
<p>このうち、今回記事にするのはこのコミットの中の一部。</p>
<ul>
  <li><a href="https://github.com/Neos21/neos21.net/commit/ef7c6276c24e661942980e785a8905729a2713a0">各種パッケージをアップデート ef7c627</a></li>
</ul>
<h2 id="元の状態"><a class="header-link" href="#元の状態"><span class="header-link-mark"></span></a>元の状態</h2>
<p>Babel 関連の元の状態を抜粋。</p>
<ul>
  <li><code>package.json</code></li>
</ul>
<pre class="language-json"><code class="language-json"><span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"babel-preset-es2015"</span><span class="token operator">:</span> <span class="token string">"6.24.1"</span><span class="token punctuation">,</span>
  <span class="token property">"babelify"</span><span class="token operator">:</span> <span class="token string">"7.3.0"</span><span class="token punctuation">,</span>
  <span class="token comment">// 中略…</span>
</code></pre>
<ul>
  <li><code>gulpfile.js</code> … JavaScript ファイルの変換タスク</li>
</ul>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">browserify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/scripts/index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// エントリポイント</span>
    transform<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">'babelify'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>         <span class="token comment">// Babelify</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'es2015'</span><span class="token punctuation">]</span>  <span class="token comment">// Babel-Preset-ES2015</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// Do Browserify!</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Browserify Error : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylSourceStream</span><span class="token punctuation">(</span><span class="token string">'scripts.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// Vinyl に変換しリネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">// Uglify できるように変換する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token comment">// Uglify する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// ./dist/scripts.js を出力する</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>['babelify', { presets: ['es2015'] }]</code> 部分で、babelify と babel-presets-es2015 の2パッケージを探しに行ってトランスパイルしている。</p>
<p>その他、当然ながら Gulp 本体、Browserify などは <code>devDependencies</code> に記述してインストールしてある。</p>
<h2 id="バージョンアップしてみる"><a class="header-link" href="#バージョンアップしてみる"><span class="header-link-mark"></span></a>バージョンアップしてみる</h2>
<p>で、<code>npm outdated</code> したり、npmjs で README を見てみたりしたところ、どうも Babel 7 からはスコープ付きパッケージに名前が変わっているっぽかった。</p>
<blockquote>
  <p>今回の Babel 7 で最大の変更点は、何と言ってもスコープ付きパッケージ方式（scoped packages）の採用だと考えます。簡単に言うと、パッケージ名が <code>babel-*</code> から <code>@babel/*</code> に変更された、ということです。以下、例です。</p>
  <ul>
    <li><code>babel-cli</code> -> <code>@babel/cli</code></li>
    <li><code>babel-core</code> -> <code>@babel/core</code></li>
    <li><code>babel-preset-env</code> -> <code>@babel/preset-env</code></li>
  </ul>
</blockquote>
<ul>
  <li>参考 : <a href="https://qiita.com/ybiquitous/items/3e6fe8a252c6097186a6">Babel 7 リリースプレビュー</a></li>
</ul>
<p>それと、<code>babel-presets-es2015</code> のような、プリセット系のパッケージが非推奨になっていて、<code>babel-preset-env</code> ないしは <code>@babel/preset-env</code> を使うように、となっていた。</p>
<blockquote>
  <p>ECMAScript 仕様は年々アップデートされるので、年次を指定する必要性が徐々に薄れてきており、また <code>preset-env</code> パッケージを使えば実行環境に合わせて自動で適切なプリセットを選んでくれます。</p>
</blockquote>
<p>なんか <code>@babel/preset-env</code> がうまいことやってくれるっぽいので、コレに従うことにした。</p>
<p>さらに、<code>@babel/core</code> というコアパッケージが、Dependency ではなく Peer Dependency に変わった。コアモジュールのバージョンを利用者に固定してもらうためと思われる。つまりは <code>@babel/core</code> を <code>package.json</code> に書かないといけなくなった、ということ。</p>
<h2 id="変更後"><a class="header-link" href="#変更後"><span class="header-link-mark"></span></a>変更後</h2>
<p>そういうワケで、バージョンアップして正常に動作するように直したコードは以下のようになった。</p>
<ul>
  <li><code>package.json</code></li>
</ul>
<pre class="language-json"><code class="language-json"><span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"@babel/core"</span><span class="token operator">:</span> <span class="token string">"7.1.2"</span><span class="token punctuation">,</span>        <span class="token comment">// 新規追加</span>
  <span class="token property">"@babel/preset-env"</span><span class="token operator">:</span> <span class="token string">"7.1.0"</span><span class="token punctuation">,</span>  <span class="token comment">// babel-presets-es2015 から変更</span>
  <span class="token property">"babelify"</span><span class="token operator">:</span> <span class="token string">"10.0.0"</span><span class="token punctuation">,</span>          <span class="token comment">// バージョンアップ</span>
  <span class="token comment">// 中略…</span>
</code></pre>
<ul>
  <li><code>gulpfile.js</code></li>
</ul>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> $<span class="token punctuation">.</span><span class="token method function property-access">browserify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/scripts/index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// エントリポイント</span>
    transform<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">'babelify'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                    <span class="token comment">// Babelify : 変更なし</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>  <span class="token comment">// Babel Preset-Env に変更</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// Do Browserify!</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Browserify Error : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylSourceStream</span><span class="token punctuation">(</span><span class="token string">'scripts.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// Vinyl に変換しリネームする</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">vinylBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">// Uglify できるように変換する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token method function property-access">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token comment">// Uglify する</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// ./dist/scripts.js を出力する</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>以上。パッケージ名が変わって混乱するかと思ったが、<code>@babel/core</code> を Dependencies に追加して、<code>babel-presets-es2015</code> を <code>@babel/preset-env</code> に変更して、<code>presets: ['es2015']</code> 部分を <code>presets: ['@babel/preset-env']</code> に変えるだけで済んだ。</p>
<hr>
<p>そうそう、今回、Gulp 本体は v4 に上げていない。Gulp 離れしたいところなんだけど、やっぱり Watch とか楽でつい使い続けている。</p>
<p>あと、gulp-sass でも <code>@import</code> で <code>.css</code> ファイルをインポートした時に警告が出るようになって、うまく直せず。</p>
<ul>
  <li><a href="/blog/2018/08/18-01.html">ポートフォリオサイトっぽいモノを GitHub Pages に作ってみた</a></li>
</ul>
<blockquote>
  <p><code>.css</code> なファイルを <code>@import</code> している SCSS ファイルをコンパイルしようとすると、node-sass がワーニングを出してくるのだが、イマイチ詳細や解決策が分からない。謎の node-sass-loader 的なパッケージを入れろとか書いてあったが、よく分からないのでワーニングごと無視することにした。</p>
</blockquote>
<p>この件の関連。もう <code>@neos21/neos-normalize</code> も SCSS ファイルを配布するか…。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-11-23</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-11-23</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
