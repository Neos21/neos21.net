<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Angular アプリを GitHub Pages に公開する際、ルーティングによる 404 を回避する、具体的な実装方法 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/08/16-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-08-16</time></div>
        <h1 id="page-title">Angular アプリを GitHub Pages に公開する際、ルーティングによる 404 を回避する、具体的な実装方法</h1>

<p>以前書いた以下の記事の詳説。</p>
<ul>
  <li><a href="/blog/2017/11/11-01.html">Angular アプリを GitHub Pages に公開する際、ルーティングによる 404 を回避する</a></li>
</ul>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E4%BA%8B%E8%B1%A1%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84">事象のおさらい</a></li>
  <li><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E6%99%82%E3%81%AF-base-href-%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B">アプリのビルド時は Base Href を変更する</a></li>
  <li><a href="#404html-%E3%81%8B%E3%82%89%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%81%99%E3%82%8B"><code>404.html</code> からリダイレクトする</a></li>
  <li><a href="#appcomponent-%E3%81%A7%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E5%87%A6%E7%90%86%E3%82%92%E8%A1%8C%E3%81%86">AppComponent でリダイレクト処理を行う</a></li>
  <li><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82-hashlocationstrategy-%E3%82%92%E4%BD%BF%E3%81%86%EF%BC%9F">そもそも HashLocationStrategy を使う？</a></li>
</ul>
<h2 id="事象のおさらい"><a class="header-link" href="#事象のおさらい"><span class="header-link-mark"></span></a>事象のおさらい</h2>
<p>Angular アプリを GitHub Pages で公開すると、そのままではトップページの URL しか有効にならない。</p>
<p>例えば拙作の <a href="https://neos21.github.io/angular-utilities/">Angular Utilities</a> でいうと、トップページの URL は <code>https://neos21.github.io/angular-utilities/</code> だが、ある画面に遷移すると、<code>https://neos21.github.io/angular-utilities/text-converter/case-converter</code> という URL がブラウザのアドレスバーに表示される。</p>
<p>そこでこの URL をコピーして、別のタブにでも貼り付けて遷移しようとしてみると、<code>/text-converter/case-converter/</code> やその配下に <code>index.html</code> というファイルはないので、404 エラーになってしまう。GitHub Pages は Angular のルーティング URL を考慮してはくれないのだ。</p>
<p>そこでコレを自前でなんとかしよう、というのが今回の記事。</p>
<h2 id="アプリのビルド時は-base-href-を変更する"><a class="header-link" href="#アプリのビルド時は-base-href-を変更する"><span class="header-link-mark"></span></a>アプリのビルド時は Base Href を変更する</h2>
<p>GitHub Pages にデプロイする Angular アプリは、<em><code>--base-href</code> オプションをデフォルトの <code>/</code> ではなく <code>./</code> という相対パスに変更</em>してやらないと、上手くルーティングが機能しない。よって、ビルド時のコマンドは以下のようになるだろう。</p>
<pre class="language-bash"><code class="language-bash">$ ng build --base-href ./ --prod
</code></pre>
<p>このまま <code>package.json</code> に npm-scripts として記載しておいて良いだろう。</p>
<h2 id="404html-からリダイレクトする"><a class="header-link" href="#404html-からリダイレクトする"><span class="header-link-mark"></span></a><code>404.html</code> からリダイレクトする</h2>
<p>前回の記事でも書いたが、GitHub Pages は、<code>404.html</code> というファイルがあると、それを 404 ページとして利用してくれる機能がある。コレを利用して、まずは 404 になる URL で遷移してきた時に、その URL を記録しつつ、Angular アプリのトップページに遷移させる。</p>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token dom variable">sessionStorage</span><span class="token punctuation">.</span><span class="token property-access">redirect</span> <span class="token operator">=</span> <span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">href</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>refresh<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0;URL=/angular-utilities/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>Angular Utilities<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/angular-utilities/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Angular Utilities<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>a</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p>どうやら <em>IE だけ、404 ページのサイズが 512 バイト以下でないと表示してくれない</em>ようなので、必要最小限の内容にしておく。ちなみに上述のコードで、インデントなど諸々込みで 343 バイト。必要に応じて改行やインデントを削り調整しよう。</p>
<ul>
  <li>参考：<a href="http://www.abilitydesign.net/2011/09/ie404.html">http://www.abilitydesign.net/2011/09/ie404.html</a></li>
</ul>
<p>このファイルでやっているのは、<code>meta</code> 要素によるリダイレクトと、SessionStorage に叩かれた URL を記録するという処理。このままリダイレクトすると、Angular アプリの起動時に SessionStorage から URL 情報が拾える、というワケ。</p>
<h2 id="appcomponent-でリダイレクト処理を行う"><a class="header-link" href="#appcomponent-でリダイレクト処理を行う"><span class="header-link-mark"></span></a>AppComponent でリダイレクト処理を行う</h2>
<p>というワケで、リダイレクトが行われて、Angular アプリが起動する時に、<code>ngOnInit()</code> にてリダイレクト処理を行ってあげる。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppComponent</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnInit</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> router<span class="token operator">:</span> <span class="token maybe-class-name">Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// SessionStorage より 404.html からの遷移元 URL 情報を取得する</span>
    <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> <span class="token dom variable">sessionStorage</span><span class="token punctuation">.</span><span class="token property-access">redirect</span><span class="token punctuation">;</span>
    <span class="token comment">// SessionStorage の情報は削除しておく</span>
    <span class="token keyword">delete</span> <span class="token dom variable">sessionStorage</span><span class="token punctuation">.</span><span class="token property-access">redirect</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 遷移元 URL が取得できていた場合 (もしトップページの URL が取得できた場合は移動する必要ないので無視)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>redirectUrl <span class="token operator">&#x26;&#x26;</span> redirectUrl <span class="token operator">!==</span> <span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">href</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ハッシュやパラメータ「#」「?」「;」を除去する : ココはアプリの要件に応じて、ハッシュやパラメータを別途再現するために抽出して処理分けする</span>
      <span class="token keyword">const</span> pureUrl <span class="token operator">=</span> redirectUrl<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#|\?|;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// アドレスバーの URL (履歴) を修正する</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">history</span><span class="token punctuation">.</span><span class="token method function property-access">replaceState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> pureUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ドメイン・アプリルート部分 ('https://neos21.github.io/angular-utilities/' の部分) を削除する → 配下のパス文字列だけが残る</span>
      <span class="token keyword">const</span> navigateUrl <span class="token operator">=</span> pureUrl<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">http.*:\/\/.*\/angular-utilities</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// パス文字列を渡して遷移する</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">router</span><span class="token punctuation">.</span><span class="token method function property-access">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>navigateUrl<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// 遷移エラー時 (受け取った URL が不正だった場合など) は仕方ないのでトップページに遷移する</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">router</span><span class="token punctuation">.</span><span class="token method function property-access">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>SessionStorage に保存させた <code>location.href</code> はフルパスなので、<code>Router#navigate()</code> に渡すための加工をしている。パラメータを渡したい場合は、別途上手くちぎって、<code>Router#navigate()</code> の第2引数に渡してやったりする必要がある。</p>
<p>もしも整形した URL に移動できない場合は、<code>Router#navigate()</code> が例外を吐くので、<code>.catch()</code> で処理してやる。こうすれば、ルーティングモジュールで <code>'**'</code> でのリダイレクトを宣言していなくても上手くいく。</p>
<ul>
  <li>参考：<a href="https://stackoverflow.com/a/43061648">angular - How to test if a route exists in Angular2? - Stack Overflow</a></li>
</ul>
<p>コレで完了。</p>
<h2 id="そもそも-hashlocationstrategy-を使う？"><a class="header-link" href="#そもそも-hashlocationstrategy-を使う？"><span class="header-link-mark"></span></a>そもそも HashLocationStrategy を使う？</h2>
<p>ところで、そもそもユーザに見せる URL が、実は直接遷移しているワケではなく、このような奇妙なリダイレクトをしている、というのは、気持ち悪さがある。</p>
<p>そこで、別の方法として、Angular デフォルトのルーティングの仕組みである PathLocationStrategy ではなく、ハッシュを利用した <em>HashLocationStrategy</em> を利用できる。</p>
<p>HashLocationStrategy は、一昔前の Ajax ページで流行った、<code>#!</code> で始まる Shebang (シバン) と同じ要領で、</p>
<ul>
  <li><code>https://neos21.github.io/angular-utilities/text-converter/case-converter</code></li>
</ul>
<p>といった URL ではなく、</p>
<ul>
  <li><code>https://neos21.github.io/angular-utilities/#/text-converter/case-converter</code></li>
</ul>
<p>といった URL を利用する。</p>
<p>全てのページは <code>/angular-utilities/</code> というルート URL のハッシュとして扱われるので、この URL をコピペして遷移されても、トップページが踏まれて、Angular によって上手いことリダイレクト的な処理をやってもらえる、というワケだ。</p>
<p>HashLocationStrategy を利用するのは簡単で、<code>AppRoutingModule</code> にて、<code>useHash</code> というフラグを与えてやるだけで良い。</p>
<pre class="language-typescript"><code class="language-typescript">@<span class="token function"><span class="token maybe-class-name">NgModule</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">RouterModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> <span class="token punctuation">{</span> useHash<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// ← 第2引数で指定</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">RouterModule</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppRoutingModule</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre>
<ul>
  <li>参考：<a href="https://codecraft.tv/courses/angular/routing/routing-strategies/">Routing Strategies • Routing • Angular 5</a></li>
</ul>
<p>コレなら手軽ではあるが、URL に余計な <code>#/</code> が挟まるのが嫌かも…？</p>
<p>以上。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2018-08-16</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2018-08-16</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
