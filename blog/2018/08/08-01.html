<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="とある社内業務システムで起こったバグの話 4 - Neo's World">
    <meta property="og:description" content="とある社内業務システムで起こったバグの話 4 - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2018/08/08-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="とある社内業務システムで起こったバグの話 4 - Neo's World">
    <meta property="twitter:description" content="とある社内業務システムで起こったバグの話 4 - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2018/08/08-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>とある社内業務システムで起こったバグの話 4 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/08/08-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-08-08</time></div>
        <h1 id="page-title">とある社内業務システムで起こったバグの話 4</h1>

<h2 id="前回までのあらすじ"><a class="header-link" href="#前回までのあらすじ"><span class="header-link-mark"></span></a>前回までのあらすじ</h2>
<ul>
  <li><a href="03-01.html">とある社内業務システムで起こったバグの話 1</a></li>
  <li><a href="06-01.html">とある社内業務システムで起こったバグの話 2</a></li>
  <li><a href="07-01.html">とある社内業務システムで起こったバグの話 3</a></li>
</ul>
<p>…</p>
<ul>
  <li>社内システム「マハーカーラ」を利用中、不定期に強制ログアウトさせられる不具合が発生する</li>
  <li>原因は、ある利用者が見つけた「ログインボタンを連打するとマハーカーラの動作が速くなる」という「裏技」によるモノだった</li>
  <li>しかし、ログインボタンの連打と、ログインユーザがログアウトさせられることの関係性が見つけられない</li>
  <li>マハーカーラの元々の開発ベンダが残した <code>ReallyPoorCompanyFramework.jar</code> に、ログイン時にのみ行う処理が含まれていた</li>
  <li>ログインしたユーザの ID とログイン日時を、<code>MASTER_USER_BK</code> というテーブルに記録していた (どの辺が「マスタ」データの「バックアップ」なの？)</li>
  <li>このテーブルにそのユーザ ID のレコードがないと、不正アクセスを疑われて画面遷移時に弾かれ、ログイン画面に戻されるという実装になっていた</li>
  <li>何か問題が起こって <code>MASTER_USER_BK</code> テーブルのデータに不整合が発生し、不正アクセスとみなされているのかもしれない？</li>
  <li>詳細調査…</li>
</ul>
<h2 id="どうすれば-master_user_bk-テーブルのデータが消えるか"><a class="header-link" href="#どうすれば-master_user_bk-テーブルのデータが消えるか"><span class="header-link-mark"></span></a>どうすれば <code>MASTER_USER_BK</code> テーブルのデータが消えるか？</h2>
<p>もう一度、<code>MASTER_USER_BK</code> テーブルを DELETE する処理が書かれた、<code>MasterUserBkService#delete()</code> メソッドのコードを見てみよう。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// MASTER_USER_BK テーブルを CRUD 操作するエンティティクラス</span>
<span class="token keyword">class</span> <span class="token class-name">MasterUserBkService</span> <span class="token punctuation">{</span>
  <span class="token comment">// delete() メソッドのみ抜粋して掲載</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> paramStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// SQL 文の構築</span>
      <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"DELETE FROM MASTER_USER_BK "</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 引数 paramStr が6文字だった場合、引数をユーザ ID と見なし、USER_ID との完全一致で絞り込む</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql <span class="token operator">+=</span> <span class="token string">"WHERE USER_ID = '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// 引数 paramStr が8文字だった場合、引数を日付情報 (yyyyMMdd) と見なし、ログイン日付が古いデータを絞り込む</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql <span class="token operator">+=</span> <span class="token string">"WHERE LOGIN_DATE &#x3C; '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// オレオレフレームワークが持っている DB 実行ユーティリティクラスを利用して SQL を実行する</span>
      <span class="token class-name">ReallyPoorCompanyDBUil</span><span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 当然のようにエラーは握り潰す */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>このメソッドの呼び出し元は以下の2箇所のみ。</p>
<p>【1】ログインボタンを押下時、当該ユーザ ID の過去データを削除し、新たなログイン日付のレコードを INSERT する、ログイン時の定型処理。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// これから実行される Action クラスが LoginAction である場合に処理を行う</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"LoginAction"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentActionClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">MasterUserBkService</span> masterUserBkService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MasterUserBkService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// リクエストから "userId" パラメータを取得して、それを引数に MSTER_USER_BK テーブルに DELETE クエリを投げている</span>
    masterUserBkService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 同様に "userId" パラメータを利用し、現在日時を LOGIN_DATE カラムに設定し、INSERT を行う</span>
    masterUserBkService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>この呼び方で、先程の <code>MasterUserBkService#delete()</code> メソッドからは、以下のような SQL が生成される。</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> MASTER_USER_BK <span class="token keyword">WHERE</span> USER_ID <span class="token operator">=</span> <span class="token string">'999999'</span><span class="token punctuation">;</span>
</code></pre>
<p>【2】8時40分から8時50分 (始業時間直後) にログインボタンを押した最初のユーザが、前日分のデータを削除する。通称「人力日次バッチ」。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// 始業時間直後かつ、この時間帯に初めてログインしようとしたユーザの場合</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isBetweenStartTime</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">isFirstUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">MasterUserBkService</span> masterUserBkService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MasterUserBkService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// currentTime が8桁の String</span>
    masterUserBkService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>この呼び方で、先程の <code>MasterUserBkService#delete()</code> メソッドからは、以下のような SQL が生成される。</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> MASTER_USER_BK <span class="token keyword">WHERE</span> LOGIN_DATE <span class="token operator">&#x3C;</span> <span class="token string">'20150711'</span><span class="token punctuation">;</span>
</code></pre>
<hr>
<p>いずれにしても意味不明なコードで、なぜセッションを利用せず DB で「ログインしているか否か」を管理しようとしているのか分からないし、毎日定期実行したい処理はバッチにしろと思うが、とりあえずこういうコードだったのだ。</p>
<p>この2つの呼び出し方のどちらかが誤作動して、<code>MASTER_USER_BK</code> テーブルからログイン中のユーザの情報まで DELETE してしまったとしたら、ログイン中のユーザは、画面遷移時に必ず行われる「不正アクセスチェック処理」によって、ログイン画面に戻されることになる。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// 画面遷移時に必ず動作する共通処理</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token class-name">MasterUserBkService</span> masterUserBkService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MasterUserBkService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ログイン処理後、セッションに格納されている "userId" パラメータを引数に利用し、存在チェックを行う</span>
  masterUserBkService<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// SELECT できなかった場合は、ログインしていないユーザがリクエストしてきたもの = 不正アクセスと見なし、ログイン画面にリダイレクトする</span>
  <span class="token keyword">return</span> <span class="token function">redirectToLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>こんな雰囲気のコードがあったワケだ。</p>
<h2 id="観測の時間だ"><a class="header-link" href="#観測の時間だ"><span class="header-link-mark"></span></a>観測の時間だ</h2>
<p>そろそろ推測を止めよう。ココまでは、強烈な臭いを発するコードを並べて、アレが臭いコレが臭いと言っているだけで、そもそもこれらのコードが本当に元凶なのかどうかはまだ分からないのだ。</p>
<p>だから、推測を止めて、実際に観測することにした。</p>
<p>システム主担当を呼び出し、<code>ReallyPoorCompanyFramework.jar</code> の中にデバッグログを出力するコードを仕込ませてもらえないか説得した。原因特定ができたら元の JAR ファイルに戻すことを条件に、なんとか承知いただけた。</p>
<p>本番 DB サーバから引っこ抜いてきた <code>ReallyPoorCompanyFramework.zip</code> の中身を利用し、上に掲載したコードの前後あちこちに、デバッグログを出力する行を追加した。コレで、アプリログファイルに、<em>実行された SQL や、リクエストパラメータの内容など</em>が出力できるようになった。この JAR ファイルをマハーカーラの Java プロジェクトに取り込み、<code>Mahakala.war</code> を生成した。</p>
<p>いつもどおり時間をかけて忌々しい入室申請を行い、中の JAR ファイルを書き換えたバージョンの <code>Mahakala.war</code> をデプロイした。そして翌日、始業前の少し早い時間に出社し、誰の迷惑にもならない時間帯にマハーカーラを開き、僕が「ログイン」ボタンを連打してみた。</p>
<p>ログインボタンを10回ほどカチカチカチカチっと連続クリックすると、メインメニュー画面に遷移するまで8秒ほど待たされる (いつもなら2・3秒だ)。どうも妙な動きをしている。しかし、始業時間前なので、8:40〜8:50 に発動する「人力日次バッチ」の処理には該当しないはずだ。</p>
<p>始業時間を待ち、本番サーバのログを確認してみた。</p>
<h2 id="デバッグログによって発覚した衝撃の事実"><a class="header-link" href="#デバッグログによって発覚した衝撃の事実"><span class="header-link-mark"></span></a>デバッグログによって発覚した衝撃の事実</h2>
<p>アプリログには、以下のように出力されていた。<em><code>[DEBUG]</code></em> と書かれている行が、自分が追加で仕込んだデバッグログだ。</p>
<pre><code># 分かりやすくするため、連打によって10数回分出力されていたログイン処理のうち、最後の3回分を掲載
2015-09-14 08:28:34.255 [DEBUG] LoginAction 開始
2015-09-14 08:28:34.257 [DEBUG] ログイン認証成功 [614290]  # ← コレは僕のユーザ ID だ
2015-09-14 08:28:34.268 [DEBUG] MASTER_USER_BK テーブルから USER_ID を条件に削除 : DELETE FROM MASTER_USER_BK WHERE USER_ID = '614290';
2015-09-14 08:28:34.268 [DEBUG] LoginAction 開始
2015-09-14 08:28:34.268 [DEBUG] MASTER_USER_BK テーブルに INSERT
2015-09-14 08:28:34.270 [DEBUG] LoginAction 開始
2015-09-14 08:28:34.271 [DEBUG] ログイン認証成功 [614290]
2015-09-14 08:28:34.271 [DEBUG] ログイン認証成功 []  # ← ！？
2015-09-14 08:28:34.284 [DEBUG] MASTER_USER_BK テーブルから USER_ID を条件に削除 : DELETE FROM MASTER_USER_BK WHERE USER_ID = '614290';
2015-09-14 08:28:34.284 [DEBUG] MASTER_USER_BK テーブルから USER_ID を条件に削除 : DELETE FROM MASTER_USER_BK;  # ← ！？
2015-09-14 08:28:34.891 [DEBUG] MASTER_USER_BK テーブルに INSERT
2015-09-14 08:28:34.908 [DEBUG] MASTER_USER_BK テーブルに INSERT
2015-09-14 08:28:35.434 [DEBUG] LoginAction 終了
2015-09-14 08:28:35.434 [DEBUG] LoginAction 終了
2015-09-14 08:28:35.434 [DEBUG] LoginAction 終了
2015-09-14 08:28:49.511 [614290] MainMenuAction Start
2015-09-14 08:28:55.525 [614290] TABLE_USER_NEWS SELECT Start
2015-09-14 08:28:56.529 [614290] TABLE_USER_NEWS SELECT End
2015-09-14 08:28:57.213 [614290] MainMenuAction End
</code></pre>
<p>ログインボタンを連打した時刻は、始業前の8時28分頃。ログインボタンを10回ほど連打したので、<code>LoginAction 開始</code> というデバッグログがつらつらと並んだ。そしてこれらのリクエストがその数だけ並行して処理されているようなのだが、途中で凄いことが起こっている。</p>
<pre><code>2015-09-14 08:28:34.271 [DEBUG] ログイン認証成功 []

2015-09-14 08:28:34.284 [DEBUG] MASTER_USER_BK テーブルから USER_ID を条件に削除 : DELETE FROM MASTER_USER_BK;
</code></pre>
<p>まず、ログイン認証が成功した時点で、ユーザ ID が上手く受け取れていない瞬間が発生している。あとでログイン認証機構を持つサーバ側のログを見ると、レスポンスデータは欠落していないようだったので、どうもマハーカーラ側がそのレスポンスデータを受け取った時に、上手くデータを保持できていなかったようだ。恐らくは同じ処理が並列実行されたことによる不具合か？この部分の挙動の詳細はこれ以上追いきれなかった。</p>
<p>そして次に、<code>MASTER_USER_BK</code> テーブルへの DELETE 処理で発行される SQL が <strong><code>DELETE FROM MASTER_USER_BK;</code></strong> となっている瞬間があった。確かにこの SQL が発行されたら、<em><code>MASTER_USER_BK</code> テーブルの全レコードが削除</em>され、コレによってマハーカーラのシステム上の認識は「今日はまだ誰もログインしていない状態」となるワケだ。その状態で、ログイン済みだったユーザが画面遷移によるリクエストを投げてくると、「誰だこのユーザ ID は！今日まだログインしていないじゃないか！ログイン画面に戻れい！」とリダイレクトされてしまう、というワケだ。</p>
<p>これが、今回の不具合が引き起こされた流れだったようだ。<strong>直接的な原因は、<code>if</code> 文の書き方がイケてなかった、という簡単な問題だったのだ。</strong></p>
<h2 id="where-条件がない-sql-が出来上がる仕組み"><a class="header-link" href="#where-条件がない-sql-が出来上がる仕組み"><span class="header-link-mark"></span></a><code>WHERE</code> 条件がない SQL が出来上がる仕組み</h2>
<p>しかし、DELETE の SQL に、<code>WHERE</code> 句が設定されない条件なんてあり得るのか？僕はもう一度、<code>MasterUserBkService#delete()</code> メソッドのコードを見てみた。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// MASTER_USER_BK テーブルを CRUD 操作するエンティティクラス</span>
<span class="token keyword">class</span> <span class="token class-name">MasterUserBkService</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> paramStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// SQL 文の構築</span>
      <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"DELETE FROM MASTER_USER_BK "</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 引数 paramStr が6文字だった場合、引数をユーザ ID と見なし、USER_ID との完全一致で絞り込む</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql <span class="token operator">+=</span> <span class="token string">"WHERE USER_ID = '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// 引数 paramStr が8文字だった場合、引数を日付情報 (yyyyMMdd) と見なし、ログイン日付が古いデータを絞り込む</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql <span class="token operator">+=</span> <span class="token string">"WHERE LOGIN_DATE &#x3C; '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// SQL を実行する</span>
      <span class="token class-name">ReallyPoorCompanyDBUil</span><span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 当然のようにエラーは握り潰す */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>今回は、<em>引数の <code>paramStr</code> が空文字</em>になっているようだったので、どちらの <code>if</code> 文にも合致しないまま、「<code>SQL を実行する</code>」のコード行に到達したのだろう。そうすると<strong>変数 <code>sql</code> の中身は <code>"DELETE FROM MASTER_USER_BK "</code> となっていて <code>WHERE</code> 条件が付かない</strong>ので、今回と同じ、問題のある SQL が発行されることになる。</p>
<p>盲点だった。引数 <code>paramStr</code> は、大元はログイン認証結果やシステム時刻の取得結果を利用しているのだから、必ず6桁か8桁の文字列が入ってくるはずだろう、と決め付けていて、この <code>if</code> 文の作りを無視していた。しかし、「万が一、どういうワケか」<code>paramStr</code> が6桁でも8桁でもなかったら何が起こるか、もう少し考えるべきだった。</p>
<p>要するに、</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre>
<p>コレでは <code>paramStr.Length()</code> が <code>6</code> でも <code>8</code> でもない場合は、どちらの <code>if</code> 文にも合致せず<em>処理を続けて</em>しまう。</p>
<p>せめて、</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">/* paramStr.length() が 8 の時の処理 */</span> <span class="token punctuation">}</span>
</code></pre>
<p>のようにしておけば、必ず <code>WHERE</code> 条件付きの SQL しか生成されないことになる。</p>
<p>もっとちゃんとするなら、</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>といった形で引数チェックをして、異常な引数の時に処理をしないのが良いだろう。もちろん、<code>Exception</code> は実際にはより適切なサブクラスで表現する。</p>
<p>この後、しばらくデバッグログを出力させたまま経過を見守った。すると、ログインボタン連打の「裏技」を見つけた支払担当の人たち以外でも、<em>ログインボタンを2・3回連続でクリック</em>してしまったような人によって、強制ログアウトの粛清が引き起こされる場合があることが分かった。ログインボタンに対しても、最も基本的な対策である「ダブルサブミット防止」策を取る必要がある。滅茶苦茶簡単なやり方でいけば、以下のような作りにすれば防げる。</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit-btn<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onSubmit()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ログイン<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span>
</code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// ログインボタンを押したかどうか判定するフラグ変数</span>
<span class="token keyword">var</span> isClickedSubmitBtn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ログインボタンが押下済なら何もしない</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>isClickedSubmitBtn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ログインボタンを押したとしてフラグ変数をセットする</span>
  isClickedSubmitBtn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// ボタンを非活性にし、ユーザが再度押下出来ないようにする</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'submit-btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">disabled</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// ログイン処理</span>
  myForm<span class="token punctuation">.</span><span class="token method function property-access">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>サーバサイド (Struts) 側で、リクエストトークンをチェックしたりしても良いが、まずはフロントエンドでできる予防を。</p>
<h2 id="問題解決"><a class="header-link" href="#問題解決"><span class="header-link-mark"></span></a>問題解決</h2>
<p>3日ほど様子を見て、調査結果をシステム主担当に報告した。元々かなり意味不明な実装なので、説明してもなかなか理解してもらえなかったが、ダブルサブミットを防止しつつ、<code>WHERE</code> 条件を持たない状態で DELETE SQL を実行しないように修正すれば、二度と同じ不具合を起こさないように直せる、と説明したところ、「ぜひ直してくれ！」と頼まれた。</p>
<p>僕は不具合を修正した。<code>WHERE</code> 条件がない状態で DELETE SQL が実行されないようにするため、以下のような作りにした。</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MasterUserBkService</span> <span class="token punctuation">{</span>
  <span class="token comment">// delete() は例外をスローするようにした</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> paramStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
    <span class="token comment">// SQL 文の構築</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"DELETE FROM MASTER_USER_BK WHERE "</span><span class="token punctuation">;</span>
    <span class="token comment">// ↑ ココに WHERE まで書いておいて、コレ単体では不正な SQL になるようにしておいた</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 引数 paramStr が6文字だった場合、引数をユーザ ID と見なし、USER_ID との完全一致で絞り込む</span>
      sql <span class="token operator">+=</span> <span class="token string">"USER_ID = '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  <span class="token comment">// ↓ else if で繋いだ</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 引数 paramStr が8文字だった場合、引数を日付情報 (yyyyMMdd) と見なし、ログイン日付が古いデータを絞り込む</span>
      sql <span class="token operator">+=</span> <span class="token string">"LOGIN_DATE &#x3C; '"</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  <span class="token comment">// ↓ else で拾い上げるようにした</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 引数 paramStr が意図しない状態だったら例外を投げる</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"引数 paramStr が異常です : ["</span> <span class="token operator">+</span> paramStr <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// SQL を実行する</span>
    <span class="token class-name">ReallyPoorCompanyDBUil</span><span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ダブルサブミットについては先程の JavaScript コードそのままの対応を入れた。リクエストトークンの設定は <code>ReallyPoorFramework</code> の都合上設定が難しかったので断念したが、本来はトークン設定しておくのが望ましい。そもそも PreparedStatement で書けよとかなんとかいわれそうだが、あんまり原型を留めない変更は<em>現場の人間がコードレビューできなくて許可されない</em>ので諦める。悲しい。</p>
<h2 id="平穏"><a class="header-link" href="#平穏"><span class="header-link-mark"></span></a>平穏</h2>
<p>当時の ReallyPoorCompany がどうしてこんなコードを生み出したのか、それはもう考えないことにした。考えても仕方がない。考えたところで何も成果がない、無駄なことだ。</p>
<p>いずれにしても、コレで「一斉ログアウト」という恐怖の事態は二度と発生しなくなった。1ヶ月ほどアプリログを監視していたが、ログインボタンのダブルサブミットも発生していなかったし、他人のログイン履歴まで削除してしまうような <code>MASTER_USER_BK</code> テーブルの DELETE 文も発行されていなかった。めでたしめでたしである。</p>
<p>数ヶ月に及んだ不具合追跡と修正がようやく解決した。</p>
<p>暑かった夏も、いつの間にかクリスマス直前だ。今日は早く帰ってクリスマス・イブの準備でもしようかな。デートに行く約束は取り付けたけど、ディナーはどこにしようかな。早く予約しないともうギリギリだからな…</p>
<p>…なんて考えていたその時、僕のデスクの電話が鳴った。電話機のディスプレイには「システムタントウ ヤマグチ」の文字。</p>
<p>受話器を持ち上げるなり、システム主担当の喚き声が漏れ聞こえてきた。</p>
<p><strong>「ちょっと〜〜！！今期の売上データが全部0円になってるんだけどぉ〜〜〜！？」</strong></p>
<p>(いいちこたぁちこ、おわり)</p>
<hr>
<h2 id="あとがき"><a class="header-link" href="#あとがき"><span class="header-link-mark"></span></a>あとがき</h2>
<p>くぅ〜疲れましたｗこれにて完結です！3万字以上も書いてしまいました！</p>
<p>この物語は完全なるフィクションであり、東京オリンピックの年に設立した老舗大手 SIer も、2000年代に顧客情報が流出した会社も、十数ベンダから無茶な引き継ぎをやった会社も、何も関係ありません。</p>
<p>ただ、バグというのは大抵こうした考慮不足、<code>if</code> 文の些細な構成ミスみたいなことから引き起こされるもので、無知によって生み出されたオレオレフレームワークやスパゲッティコードがそうしたバグの原因をとことん分かりにくくさせる。</p>
<p>こんなシステムの保守担当にはなりたくないものだが、もしもなってしまったら、上司に許可を求めることなく、独断でリファクタリングしていこう。技術力をもって先にやってしまって、「でもコッチの方が良いっしょ？」と思い知らせてやろう。マインドだけでなく、良いアクションを継続して見せていけば、周りもいつか説得できるはずだ。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-08-08</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-08-08</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
