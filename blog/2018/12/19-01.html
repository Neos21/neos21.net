<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>無料プランの Heroku Web アプリ (Web Dyno) を Sleep させないようにするには cron-job.org が良いかも - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/12/19-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/12/index.html">12月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-12-19</time></div>
        <h1 id="page-title">無料プランの Heroku Web アプリ (Web Dyno) を Sleep させないようにするには cron-job.org が良いかも</h1>

<p>Heroku の無料プラン (Free Dyno) で使える、Web アプリを稼動させる仮想環境<em>「Web Dyno」</em>は、30分間その Web アプリにアクセスがないと自動的に Sleep してしまう。</p>
<p>Web Dyno が Sleep してしまうと、次回その Heroku アプリに初回アクセスした時に、Web Dyno が再起動してレスポンスを返すまで、15〜30秒くらい待たされてしまう。</p>
<p>この初回アクセス時のレスポンスの悪さを解消するために、自分が Heroku アプリを使いたくなる時間帯には、予め Web Dyno の Sleep を解除しておきたいと思った。</p>
<p>今回は Web Dyno を Sleep させないようにする、Sleep していたら自動的に再起動させてやるための方法を調べたので、それを紹介する。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#web-dyno-%E3%82%92-sleep-%E3%81%95%E3%81%9B%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%E3%80%81heroku-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%8C%E3%81%82%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84">Web Dyno を Sleep させないようにするには、Heroku アプリにアクセスがあればいい</a></li>
  <li><a href="#heroku-scheduler-%E3%81%8B%E3%82%89%E8%87%AA%E8%BA%AB%E3%81%AE-heroku-web-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AB-curl-%E3%81%99%E3%82%8B">Heroku Scheduler から自身の Heroku Web アプリに <code>curl</code> する</a></li>
  <li><a href="#uptimerobot-%E3%81%A8%E3%81%84%E3%81%86%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%86">UptimeRobot というサービスを使う</a></li>
  <li><a href="#web-%E3%82%A2%E3%83%97%E3%83%AA%E8%87%AA%E8%BA%AB%E3%81%AB%E8%87%AA%E5%88%86%E3%81%B8%E3%81%AE%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E6%8A%95%E3%81%92%E3%82%8B%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86">Web アプリ自身に自分へのリクエストを投げる処理を実装してしまう</a></li>
  <li><a href="#cron-joborg-%E3%82%92%E4%BD%BF%E3%81%86">cron-job.org を使う</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="web-dyno-を-sleep-させないようにするには、heroku-アプリにアクセスがあればいい"><a class="header-link" href="#web-dyno-を-sleep-させないようにするには、heroku-アプリにアクセスがあればいい"><span class="header-link-mark"></span></a>Web Dyno を Sleep させないようにするには、Heroku アプリにアクセスがあればいい</h2>
<p>Web Dyno が Sleep するのは、30分間アクセスが一切なかった場合だ。ということは、<strong>30分以内に1回以上 Heroku アプリにアクセスがあれば、その Web Dyno は Sleep しない</strong>ということだ。</p>
<p>Heroku アプリの URL に対してリクエストが飛ばせれば何でも良いので、ブラウザからのアクセスでなくても良くて、<code>curl</code> で叩くだけでも良いのだ。</p>
<p>ココからの問題は、<em>「24時間好きなタイミングで Heroku アプリに <code>curl</code> するにはどうしたらいいか」</em>ということだ。Heroku の他に自分でサーバを借りたりしていれば、そこに定期的なジョブを仕込んだりもできるかもしれないし、自宅の PC を24時間つけっぱなしにしているような人であれば、そこでスクリプトを常駐させるだけでも良いだろう。</p>
<p>しかし今回は、24時間稼動している自分用のサーバを持っていない人向けの方法を考えてみる。</p>
<h2 id="heroku-scheduler-から自身の-heroku-web-アプリに-curl-する"><a class="header-link" href="#heroku-scheduler-から自身の-heroku-web-アプリに-curl-する"><span class="header-link-mark"></span></a>Heroku Scheduler から自身の Heroku Web アプリに <code>curl</code> する</h2>
<p>前述のとおり、定期的に自アプリの URL を <code>curl</code> できれば良い、というのであれば、最初に思いつくのは <em>Heroku Scheduler</em> だろうか。</p>
<p>起こしておきたい Heroku プロジェクトに Heroku Scheduler をインストールし、起こしたいタイミングで</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> https://example-app.herokuapp.com/
</code></pre>
<p>といったコマンドを実行するジョブを設定する、というモノ。</p>
<ul>
  <li>参考：<a href="https://www.shookuro.com/entry/2018/05/05/112133">【Heroku】無料プランの Sleep を回避する - 山崎屋の技術メモ</a></li>
</ul>
<p>Heroku プロジェクト内で完結するので導入が簡単ではあるが、Heroku Scheduler は</p>
<ul>
  <li>1日ごと</li>
  <li>1時間ごと</li>
  <li>10分ごと</li>
</ul>
<p>という設定しかできないため、タイミングの制御が難しい。</p>
<p>24時間つけっぱなしにしたいのであれば10分ごとに叩けば良いが、「昼休みの間だけ使いたい」というような特定の時間帯だけ <code>curl</code> したい場合には設定が面倒になる。作れるジョブ数に制限はないようだが、「1日ごと」の時刻指定を細かく作らないといけなさそうだ。</p>
<p>「30分間無アクセス」な状態を作るには、「30分間隔でのジョブ」では足りなくて、20〜25分間隔ぐらいで動作するようにしたいが、Heroku Scheduler はそのような細かな分 (minutes) の設定もできないので難儀。</p>
<p>自分の用途でそれに向いているなら良いのだが…。</p>
<h2 id="uptimerobot-というサービスを使う"><a class="header-link" href="#uptimerobot-というサービスを使う"><span class="header-link-mark"></span></a>UptimeRobot というサービスを使う</h2>
<p><strong>UptimeRobot</strong> というサービスは、任意の URL に対して定期的に <code>ping</code> を投げられるサービスだ。</p>
<ul>
  <li><a href="https://uptimerobot.com/">Uptime Robot</a></li>
</ul>
<p>実際に登録して設定してみたが、「実行間隔」を分単位でしか設定できず、「この時間帯は実行しない」といった制御ができなかった。「25分ごとにアクセス」といった定期実行はできるので、24時間稼動させっぱなしにしたい場合はコレでも良いかもしれない。</p>
<h2 id="web-アプリ自身に自分へのリクエストを投げる処理を実装してしまう"><a class="header-link" href="#web-アプリ自身に自分へのリクエストを投げる処理を実装してしまう"><span class="header-link-mark"></span></a>Web アプリ自身に自分へのリクエストを投げる処理を実装してしまう</h2>
<p>24時間、自アプリを立ち上げっぱなしにしたいのであれば、Web アプリ自身に、自サイトへのリクエストを投げさせる処理を組み込む、ということも考えられる。</p>
<p>例えば Node.js 製のプロジェクトで、Express サーバを立ち上げているのであれば、こんな乱暴なコードを埋め込んでも良いかもしれない。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// サーバを起動したり (コードは省略)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 25分ごとに自サイトへリクエストを投げる</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'https://example-app.herokuapp.com/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Keep-Alive'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>要は Web Dyno が Sleep する前に、自身へのリクエストを自分で投げておけば、この <code>setInterval()</code> の処理も動き続けるだろう、ということだ。このようなスケジューリングを行うライブラリは色々存在するので、しっかり組むつもりならもう少し調べた方が良いが、原理的にはそういうことだ。</p>
<p>ただ、このやり方は24時間稼動させっぱなしになることが前提。Web Dyno が Sleep した時にはこのようなインターバル処理は実行されなくなるからだ。</p>
<ul>
  <li>参考：<a href="https://qiita.com/yuya_takeyama/items/4187258fc403abff7a2c">HTTP サーバと Worker プロセスを 1 つの Dyno で立ち上げて節約 - Qiita</a> … Worker プロセスに該当する処理を Web Dyno 内に仕込んで定期実行できるのでは、というアイデア。</li>
</ul>
<h2 id="cron-joborg-を使う"><a class="header-link" href="#cron-joborg-を使う"><span class="header-link-mark"></span></a>cron-job.org を使う</h2>
<p>最後に本命。最初に紹介した Heroku Scheduler は柔軟性がなかったのがデメリットだったワケだが、であれば <code>cron</code> が組めるウェブサービスがないかと思い探したところ、<strong>cron-job.org</strong> というサイトがあった。</p>
<ul>
  <li><a href="https://cron-job.org/en/">cron-job.org - Free cronjobs - from minutely to once a year.</a></li>
</ul>
<p>このサイトに登録すると、指定の URL にアクセスする <code>cron</code> ジョブをウェブ上で組める。</p>
<p>ユーザ定義で実行タイミングを設定しようとすると、日・曜日・月・時・分を細かく指定できる。この時、「何も選択していない項目」があると、いずれの条件にも合致せず一生実行されないジョブになってしまうので注意。「曜日に関わらず0時15分に…」と設定する時は、日・曜日・月の各項目を全選択することで、<code>cron</code> における <code>*</code> のような表現になる。</p>
<p>指定する時刻のタイムゾーンだが、ユーザ設定画面で指定したタイムゾーンに則って設定できるため、ユーザ設定で「Asia/Tokyo」を選んであれば、日本時間 (JST) の感覚のままで「9時」「17時」などと設定できる。</p>
<p>設定が上手くいっていると、ジョブ一覧画面で「次回の実行予定時刻」が表示される他、実行結果ログも後で見られたりする。</p>
<ul>
  <li>参考：<a href="https://www.lancork.net/2014/08/cron-job-org/">無料で指定したURLを定期的に自動実行できるサービス「cron-job.org」 | Lancork</a></li>
  <li>参考：<a href="http://drupal.jp/guide/cron_task_cron-job_org">cron タスクの設定 【 Cron-job.org の利用】 | ≡ Drupal Japan ≡</a></li>
</ul>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>cron-job.org なら、「昼間だけ」「夕方だけ」Heroku アプリを Sleep させないでおく、といった細かな設定も柔軟にできる。</p>
<p>自分は cron-job.org に3つのジョブを作り、好みの時間帯に20分間隔で ping を飛ばすように設定した。コレで、通勤と昼休みの間だけ、自分の Heroku アプリを Sleep させないでおいて、スムーズにアクセスできるように設定できた。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2018-12-19</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2018-12-19</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
