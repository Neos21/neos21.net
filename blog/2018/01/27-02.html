<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘 - Neo's World">
    <meta property="og:description" content="Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘 - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2018/01/27-02.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘 - Neo's World">
    <meta property="twitter:description" content="Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘 - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2018/01/27-02.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/01/27-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/01/index.html">01月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-01-27</time></div>
        <h1 id="page-title">Angular5 + Cordova なアプリで Protractor + Appium による iOS シミュレータ・iOS 実機 E2E テストを実施する際の備忘</h1>

<p>以前、<em>AngularJS</em> ベースの Cordova アプリを E2E テストするための記事を書いた。</p>
<p>以下が iOS シミュレータでの実施用。</p>
<ul>
  <li><a href="/blog/2017/07/29-01.html">AngularJS + Cordova なプロジェクトに Protractor + Appium を導入して iOS シミュレータで E2E テストを動かす</a></li>
</ul>
<p>コチラが iOS 実機で実施するための追加情報。</p>
<ul>
  <li><a href="/blog/2017/07/31-01.html">AngularJS + Cordova なアプリに Protractor + Appium を使って iOS 実機で E2E テストを実施する方法</a></li>
</ul>
<p>この頃から時は流れ、<strong>Angular5</strong> にバージョンアップした Cordova プロジェクトで、E2E テストをやろうと思ったのだが、少々設定の類に違いがあって苦戦したので備忘をまとめる。</p>
<p>ベースの環境構築は上述の2つの記事がそのまま参考になるはずなので、あわせて読んでいただければ。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AF-angular-cli-%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B">プロジェクトのベースは Angular CLI で構築する</a></li>
  <li><a href="#e2e-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92-ios-%E5%90%91%E3%81%91%E3%81%AB%E5%A4%89%E3%81%88%E3%82%8B"><code>e2e</code> コマンドを iOS 向けに変える</a></li>
  <li><a href="#protractor-%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E8%A8%AD%E5%AE%9A%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B%E3%81%A8%E5%AE%89%E5%AE%9A%E3%81%99%E3%82%8B">Protractor 設定ファイルにタイムアウト設定を追加すると安定する</a></li>
  <li><a href="#browserget-%E3%81%AB%E3%82%88%E3%82%8B%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><code>browser.get()</code> による画面遷移ができない</a></li>
  <li><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B1%E3%83%BC%E3%82%B9%E6%95%B0%E3%81%8C%E5%A2%97%E3%81%88%E3%82%8B%E3%81%A8%E5%BE%8C%E7%B6%9A%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B">テストケース数が増えると後続のテストが失敗することがある</a></li>
  <li><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB%E3%81%AA%E3%81%A9%E3%81%8C%E9%AB%98%E9%80%9F%E3%81%A7%E8%A1%8C%E3%82%8F%E3%82%8C%E3%82%8B%E3%81%A8-html-%E6%A7%8B%E9%80%A0%E3%81%AB%E4%B8%8D%E6%95%B4%E5%90%88%E3%81%8C%E7%94%9F%E3%81%98%E3%81%9F%E3%82%8A%E3%81%99%E3%82%8B">画面遷移などが高速で行われると HTML 構造に不整合が生じたりする</a></li>
  <li><a href="#%E5%B0%91%E3%81%97%E3%81%A0%E3%81%91%E3%82%B1%E3%83%BC%E3%82%B9%E6%95%B0%E3%81%8C%E5%A4%9A%E3%81%84%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E8%BB%BD%E3%81%8F%E5%AE%9F%E8%A1%8C%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95">少しだけケース数が多いテストを軽く実行させる方法</a></li>
  <li><a href="#%E8%87%AA%E5%8B%95%E6%93%8D%E4%BD%9C%E3%81%AE%E5%87%A6%E7%90%86%E9%96%93%E9%9A%94%E3%82%92%E9%96%8B%E3%81%91%E3%82%8B%E6%96%B9%E6%B3%95">自動操作の処理間隔を開ける方法</a></li>
</ul>
<h2 id="プロジェクトのベースは-angular-cli-で構築する"><a class="header-link" href="#プロジェクトのベースは-angular-cli-で構築する"><span class="header-link-mark"></span></a>プロジェクトのベースは Angular CLI で構築する</h2>
<p>Angular5 プロジェクトのベースは Angular CLI の <code>$ ng new</code> で作成しよう。この後に Cordova アプリとしての修正を行う。こうすれば Protractor を動作させる <code>e2e</code> コマンドが最初から用意されているので、カスタマイズがしやすい。</p>
<p>このあたりは、以下に Angular4 版ではあるが Cordova アプリ化したボイラープレートを用意したので、参考にしてほしい。</p>
<ul>
  <li><a href="https://github.com/Neos21/boilerplate-angular-cordova">GitHub - Neos21/angular-cordova: Angular4 + Cordova iOS App Boilerplate</a></li>
</ul>
<h2 id="e2e-コマンドを-ios-向けに変える"><a class="header-link" href="#e2e-コマンドを-ios-向けに変える"><span class="header-link-mark"></span></a><code>e2e</code> コマンドを iOS 向けに変える</h2>
<p>iOS で E2E テストを動作させるため、Appium を起動した状態で E2E テストを開始する必要がある。そこで、<code>package.json</code> に Appium 起動コマンドと iOS で E2E テストを行うためのコマンドを用意する。</p>
<ul>
  <li><a href="https://github.com/Neos21/boilerplate-angular-cordova/blob/master/package.json#L15-L16">angular-cordova/package.json at master · Neos21/angular-cordova · GitHub</a></li>
</ul>
<p>上述の E2E 実行コマンドは若干古い。<em>以下のように変えると余計なビルド処理などが走らず起動が高速化する。</em></p>
<pre class="language-json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token property">"e2e-ios-exec"</span><span class="token operator">:</span> <span class="token string">"ng e2e --config ./protractor.ios.conf.js --no-webdriver-update --serve=false"</span><span class="token punctuation">,</span>
</code></pre>
<p>アプリは E2E テスト実行前に Cordova ビルドして iOS シミュレータなり iOS 実機なりに入れておかないとダメ。WebDriverAgent に関しては iOS シミュレータは勝手に入れてくれるけど、iOS 実機の場合は手動で事前に入れておかないといけない。</p>
<h2 id="protractor-設定ファイルにタイムアウト設定を追加すると安定する"><a class="header-link" href="#protractor-設定ファイルにタイムアウト設定を追加すると安定する"><span class="header-link-mark"></span></a>Protractor 設定ファイルにタイムアウト設定を追加すると安定する</h2>
<p>Angular5 系にバージョンアップして、<code>protractor.conf.js</code> にて<em>タイムアウト設定を追加</em>してやらないと、テストの開始処理などがうまくいかなかった。</p>
<ul>
  <li><a href="https://github.com/Neos21/boilerplate-angular-cordova/blob/master/protractor.ios.conf.js">angular-cordova/protractor.ios.conf.js at master · Neos21/angular-cordova · GitHub</a></li>
</ul>
<p>ベースはこの <code>protractor.ios.conf.js</code> の記載のままで良いのだが、<code>capabilities</code> に以下の2つのタイムアウト処理を追加する。</p>
<pre class="language-javascript"><code class="language-javascript">capabilities<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// …中略…</span>
  
  <span class="token comment">// グローバルなタイムアウト設定</span>
  allScriptsTimeout<span class="token operator">:</span> <span class="token number">600000</span><span class="token punctuation">,</span>
  <span class="token comment">// レスポンスのタイムアウト設定</span>
  webkitResponseTimeout<span class="token operator">:</span> <span class="token number">10000</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="browserget-による画面遷移ができない"><a class="header-link" href="#browserget-による画面遷移ができない"><span class="header-link-mark"></span></a><code>browser.get()</code> による画面遷移ができない</h2>
<p>AngularJS 時代は、<code>browser.get('')</code> と書くことで、ページを読み直してトップページに戻れたりできたのだが、<strong>Angular5 だと一切の <code>browser.get()</code> が正しく動作しなかった。</strong></p>
<p>良い対処法が見つからなかったので、仕方なく各テストの <code>beforeAll()</code> にて、要素クリックなどで頑張って初期画面に戻してから当該画面に移動する、という一連の処理を書いた。何か良い方法はないのだろうか…。</p>
<h2 id="テストケース数が増えると後続のテストが失敗することがある"><a class="header-link" href="#テストケース数が増えると後続のテストが失敗することがある"><span class="header-link-mark"></span></a>テストケース数が増えると後続のテストが失敗することがある</h2>
<p>イマイチ原因がハッキリしていないが、WebDriverAgent がバックグラウンドで起動している状態でアプリを触っていると、段々と動きがもっさりしてくる。</p>
<p>特定の処理を待つために <code>browser.sleep()</code> を使っていたりすると、動作がもっさりしてくるせいで待機時間が不十分になったりする。</p>
<p>自動操作される E2E テストにおいても、テストケース数が増えてくると、後半のテストが失敗しやすくなった。勿論、そのテストだけを動作させた時は成功するので、テストコードに誤りがあるワケではないのだ。</p>
<p>コレも良い解決策が見つからず、<strong>テストを分割して実行する</strong>ことで、テストとして一応の担保をとるようにした。自動回帰テストみたいなことがうまくできないのでつらい…。</p>
<h2 id="画面遷移などが高速で行われると-html-構造に不整合が生じたりする"><a class="header-link" href="#画面遷移などが高速で行われると-html-構造に不整合が生じたりする"><span class="header-link-mark"></span></a>画面遷移などが高速で行われると HTML 構造に不整合が生じたりする</h2>
<p>E2E テストはキー入力やクリック操作が人間の限界を超えた速度で実行されるので、<em>前画面の処理が完了しないまま次画面に遷移</em>してしまったりすることで、HTML の構造に不整合が発生し、正常にテストができなくなることがある。</p>
<p>例えば <a href="https://valor-software.com/ngx-bootstrap/">ngx-bootstrap</a> のモーダルのような、アニメーション動作を含むライブラリを使ったりしていると、この問題に遭遇しやすい。<code>browser.wait()</code> や <code>browser.sleep()</code> で待ってやれば良いのかというとそれだけでもなく、前述の「テストケース数に比例して動作がもっさりする問題」も絡んできて、見た目上は表示されている要素が見つからないなど、おかしな状態になりやすい。</p>
<p>コチラも残念ながら良い回避策がなく、テストを分割して実行することで逃げてしまった。</p>
<h2 id="少しだけケース数が多いテストを軽く実行させる方法"><a class="header-link" href="#少しだけケース数が多いテストを軽く実行させる方法"><span class="header-link-mark"></span></a>少しだけケース数が多いテストを軽く実行させる方法</h2>
<p>テストを分割実行するには、<code>fdescribe()</code> などを手で書き加えて、毎回テストし直すやり方を取ったが、<code>protractor.conf.js</code> でスペックファイルの指定方法を変えるだけでも、少し動作が軽くなった。コレで回避できるなら、楽なのでコチラを選びたい。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 最初はこうなっていると思うので…</span>
specs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./e2e/**/*.e2e-spec.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

<span class="token comment">// このように画面ごとぐらいでファイルを列挙する</span>
specs<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'./e2e/login-page/**/*.e2e-spec.ts'</span><span class="token punctuation">,</span>
  <span class="token string">'./e2e/news-page/**/*.e2e-spec.ts'</span><span class="token punctuation">,</span>
  <span class="token string">'./e2e/settings-page/**/*.e2e-spec.ts'</span><span class="token punctuation">,</span>
  <span class="token string">'./e2e/user-page/**/*.e2e-spec.ts'</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre>
<h2 id="自動操作の処理間隔を開ける方法"><a class="header-link" href="#自動操作の処理間隔を開ける方法"><span class="header-link-mark"></span></a>自動操作の処理間隔を開ける方法</h2>
<p>以下のようなコードをテストクラスの最上部に書いておくと、Control Flow の処理ごとに動作を止められる。</p>
<p>いくつかのテキストボックスに値が入力されるのをゆっくり見たい時とかに、いちいち <code>browser.sleep()</code> などと書かなくても良くなる。うまく使えば「もっさり問題」対策にもなるかもしれない。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// 前略… import 文など…</span>

<span class="token keyword">const</span> origFn <span class="token operator">=</span> browser<span class="token punctuation">.</span><span class="token property-access">driver</span><span class="token punctuation">.</span><span class="token method function property-access">controlFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">execute</span><span class="token punctuation">;</span>
browser<span class="token punctuation">.</span><span class="token property-access">driver</span><span class="token punctuation">.</span><span class="token method function property-access">controlFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">execute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
  origFn<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span><span class="token property-access">driver</span><span class="token punctuation">.</span><span class="token method function property-access">controlFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 100ms 遅らせる</span>
    <span class="token keyword">return</span> protractor<span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token punctuation">.</span><span class="token method function property-access">delayed</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> origFn<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span><span class="token property-access">driver</span><span class="token punctuation">.</span><span class="token method function property-access">controlFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'各画面のテスト'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 以下略…</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>参考 : <a href="https://qiita.com/akiko-pusu/items/1cc7081c480630d240d7">Protractorのテストが早すぎて目が追いつかない... - Qiita</a></li>
</ul>
<hr>
<p>いずれも、良い感じの根本解決作がなく、せっかく楽できそうな E2E テストなのに次から次へと違う問題が出てくる感じでつらみがある…。</p>
<p>今回紹介した事象に関して、より良い対処法をご存知の方は、ぜひ情報をお寄せください。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-01-27</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-01-27</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
