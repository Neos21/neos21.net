<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="JavaScript : Promise の挙動をおさらいする - Neo's World">
    <meta property="og:description" content="JavaScript : Promise の挙動をおさらいする - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2018/09/23-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="JavaScript : Promise の挙動をおさらいする - Neo's World">
    <meta property="twitter:description" content="JavaScript : Promise の挙動をおさらいする - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2018/09/23-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>JavaScript : Promise の挙動をおさらいする - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/09/23-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MZCGD23');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MZCGD23" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/09/index.html">09月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-09-23</time></div>
        <h1 id="page-title">JavaScript : Promise の挙動をおさらいする</h1>

<p>普段は決まった書式で非同期処理を書いているのだが、Promise の仕様を押さえるため、思い付きで変な書式を試してみたりした。</p>
<p>今回紹介するサンプルコードは、全て <code>promise-test.js</code> というファイル名で保存し、Node.js で実行した結果を確認している。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AA%E5%87%A6%E7%90%86%E3%81%AF%E7%9B%B4%E6%8E%A5%E5%80%A4%E3%82%92-return-%E3%81%99%E3%82%8C%E3%81%B0%E8%89%AF%E3%81%84">同期的な処理は直接値を <code>return</code> すれば良い。</a></li>
  <li><a href="#%E5%A4%B1%E6%95%97%E4%BE%8B--%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%82%92-promise-%E3%81%A7%E3%83%A9%E3%83%83%E3%83%97%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84">失敗例 : 非同期処理を Promise でラップできていない</a></li>
  <li><a href="#%E3%81%82%E3%82%8B%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%97%E3%81%A6%E3%82%82%E5%BE%8C%E7%B6%9A%E3%81%AE-then-%E3%81%AB%E7%B9%8B%E3%81%92%E3%82%8B%E3%81%AB%E3%81%AF">ある非同期処理が失敗しても後続の <code>then()</code> に繋げるには</a></li>
  <li><a href="#%E9%85%8D%E5%88%97%E3%82%92%E7%9B%B4%E5%88%97%E3%81%A7%E9%A0%86%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B-promise-%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%82%92%E4%BD%9C%E3%82%8B">配列を直列で順に実行する Promise チェーンを作る</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="同期的な処理は直接値を-return-すれば良い"><a class="header-link" href="#同期的な処理は直接値を-return-すれば良い"><span class="header-link-mark"></span></a>同期的な処理は直接値を <code>return</code> すれば良い。</h2>
<p><code>then()</code> 内の処理が同期的な処理であれば、きちんと待って次の <code>then()</code> に移行してくれるので、</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">HOGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">FUGA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>というように、全ての <code>then()</code> 内で <code>new Promise()</code> を生成して <code>return</code> しなくて良い。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token constant">HOGE</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token constant">HUGA</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em>同期的な処理であれば</em>、コレで良いのだ。</p>
<p>以下により詳しいサンプルコードと実行結果を置く。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// resolve() 以降のコードも実行はされる</span>
    val <span class="token operator">+=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 同期的だが時間がかかる処理を用意する</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">10000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      str <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword control-flow">return</span> str<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 3 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-bash"><code class="language-bash">$ node promise-test.js
Start
Promise <span class="token number">1</span> <span class="token builtin class-name">:</span>  <span class="token number">25</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  <span class="token number">5</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  <span class="token number">9989999999</span>

$ node promise-test.js
<span class="token comment"># ↓ コマンド実行後すぐ出力される</span>
Start

<span class="token comment"># ↓ setTimeout 内に書いてあるので1秒後に出力される</span>
Promise <span class="token number">1</span> <span class="token builtin class-name">:</span>  <span class="token number">25</span>
<span class="token comment"># resolve している値は 5 だが、console.log の値は += 20 した値</span>

<span class="token comment"># ↓ 「Promise 1」の直後に出力される</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  <span class="token number">5</span>
<span class="token comment"># resolve している値は 5 なので、resolve 後に += 20 されていても無関係</span>
<span class="token comment"># 時間のかかる for ループの処理が行われる</span>
<span class="token comment"># then 内の関数が直接 return しているが、この値は Promise でラップされるので、次の then の仮引数で受け取れる</span>

<span class="token comment"># ↓ 「Promise 2」の出力後、数秒開いて出力される</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  <span class="token number">9989999999</span>
<span class="token comment"># 時間のかかる for 文の処理を待って出力される</span>
<span class="token comment"># 「Promise 2」の then 内の関数が return した str.slice(-10) が、仮引数 val で受け取れている</span>
</code></pre>
<h2 id="失敗例--非同期処理を-promise-でラップできていない"><a class="header-link" href="#失敗例--非同期処理を-promise-でラップできていない"><span class="header-link-mark"></span></a>失敗例 : 非同期処理を Promise でラップできていない</h2>
<p><code>then()</code> の中に非同期処理が含まれているのに、Promise でラップしていない場合は、後続の <code>then()</code> に値を渡せない。</p>
<p>以下サンプル。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Resolve!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 SetTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> <span class="token string">'Resolve?'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 3 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-bash"><code class="language-bash">$ node promise-test.js
Promise <span class="token number">1</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  Resolve<span class="token operator">!</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  undefined
Promise <span class="token number">2</span> SetTimeout

$ node promise-test.js
<span class="token comment"># ↓ コマンド実行直後に出力される</span>
Promise <span class="token number">1</span>

<span class="token comment"># ↓ 「Promise 1」の直後に出力される</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  Resolve<span class="token operator">!</span>
<span class="token comment"># 「Promise 1」は resolve で値を渡しているので「Resolve!」が引き継げている</span>

<span class="token comment"># ↓ 「Promise 2」の直後、1秒待たずに出力される</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  undefined
<span class="token comment"># setTimeout の処理を待てていないので、「Resolve?」の値が引き継げていない</span>

<span class="token comment"># ↓ 「Promise 3」の約1秒後に出力される</span>
Promise <span class="token number">2</span> SetTimeout
<span class="token comment"># 宙に浮いた非同期処理になっているので、Promise のチェーン全体が終わった後に出力されてしまっている</span>
</code></pre>
<p>「Promise 3」が結果を受け取れず、変数 <code>val</code> が <code>undefined</code> になってしまっているのが分かる。</p>
<p>コレを修正するには、「Promise 2」部分で <code>new Promise()</code> を <code>return</code> するようにする。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Resolve!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 「Promise オブジェクトを生成する関数」として作る</span>
    <span class="token comment">// then() の第1引数に直接 Promise オブジェクトを渡す、「then( new Promise() )」このような書き方は動かないので注意</span>
    <span class="token comment">// then() の第1引数を関数として実行してくるので、then(() => new Promise()) でないといけない</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 SetTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Resolve?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// return ではなく resolve で値を渡す</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 3 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-bash"><code class="language-bash">$ node promise-test.js
Promise <span class="token number">1</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  Resolve<span class="token operator">!</span>   <span class="token comment"># ← ココまではコマンド実行直後に出力される</span>
Promise <span class="token number">2</span> SetTimeout    <span class="token comment"># ← その1秒後に出力される</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  Resolve?   <span class="token comment"># ← SetTimeout の直後に出力され、「Resolve?」の文字列が取得できている</span>
</code></pre>
<h2 id="ある非同期処理が失敗しても後続の-then-に繋げるには"><a class="header-link" href="#ある非同期処理が失敗しても後続の-then-に繋げるには"><span class="header-link-mark"></span></a>ある非同期処理が失敗しても後続の <code>then()</code> に繋げるには</h2>
<p>サンプルとして以下のようにランダムに Reject する関数を用意。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 1秒後にランダムに Resolve か Reject する関数</span>
<span class="token keyword">function</span> <span class="token function">randomPromise</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// resolve・reject の仮引数は好きな名前に変えても動く</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span>val <span class="token operator">||</span> <span class="token string">'Default Resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token function">rej</span><span class="token punctuation">(</span>val <span class="token operator">||</span> <span class="token string">'Default Reject'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// この関数を3回呼び出してみる</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1 : Start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">randomPromise</span><span class="token punctuation">(</span><span class="token string">'Promise 1 Result'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token function">randomPromise</span><span class="token punctuation">(</span><span class="token string">'Promise 2 Result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Promise 3 : '</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token function">randomPromise</span><span class="token punctuation">(</span><span class="token string">'Promise 3 Result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'Error! : '</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 実行するたびに、どのタイミングで Reject されるかは変わる</span>
$ node promise-test.js
Promise <span class="token number">1</span> <span class="token builtin class-name">:</span> Start
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  Promise <span class="token number">1</span> Result
Error<span class="token operator">!</span> <span class="token builtin class-name">:</span>  Promise <span class="token number">2</span> Result
</code></pre>
<p>今回は、この <code>randomPromise()</code> で仮に <strong>Reject されても、必ず後続処理に繋げる</strong>仕組みを作ってみる。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">randomPromise</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span>val <span class="token operator">||</span> <span class="token string">'Default Resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token function">rej</span><span class="token punctuation">(</span>val <span class="token operator">||</span> <span class="token string">'Default Reject'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>  <span class="token comment">// ← この then だけ追加、あとのコードは変えていない</span>
      <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (Resolved)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// then(onFulfilled, onRejected) と書けるのでこのように書く</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Reject されたが続行 : '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (Rejected)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 実行するたびに動作は変わるが、「Error!」は実行されない</span>
$ node promise-test.js
Promise <span class="token number">1</span> <span class="token builtin class-name">:</span> Start

<span class="token comment"># ↓ 1秒後に実行される</span>
Promise <span class="token number">2</span> <span class="token builtin class-name">:</span>  Promise <span class="token number">1</span> Result <span class="token punctuation">(</span>Resolved<span class="token punctuation">)</span>
<span class="token comment"># 最初の randomPromise('Promise 1 Result') は Resovled した</span>

<span class="token comment"># ↓ さらに1秒後に出力される</span>
Reject されたが続行 <span class="token builtin class-name">:</span>  Promise <span class="token number">2</span> Result
<span class="token comment"># 「Promise 2」の randomPromise('Promise 2 Result') が Rejected したが、そのエラーをキャッチしている</span>

<span class="token comment"># ↓ 直後に出力される</span>
Promise <span class="token number">3</span> <span class="token builtin class-name">:</span>  Promise <span class="token number">2</span> Result <span class="token punctuation">(</span>Rejected<span class="token punctuation">)</span>
<span class="token comment"># return `${val} (Rejected)`; としたとおり、onRejected が return した値を受け取っている</span>
</code></pre>
<p>このように、エラーを握り潰したい Promise オブジェクトの後ろに、空の <code>onRejected</code> なチェーンを作っておけばよいので、以下のいずれかの構成が基本となるだろう。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// then(onFulfilled, onRejected) で書く場合</span>
<span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 条件によって Resolve したり Reject したりする処理…</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span> <span class="token comment">/* 条件 */</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> error<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// もしくは、then().catch() と書く場合。結果は同じ</span>
<span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 条件によって Resolve したり Reject したりする処理…</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> error<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>それぞれの <code>then()</code>・<code>catch()</code> 内でログだけ切り替えても良いし、return する値はエラー時のみ差し替えるなどしても良い。</p>
<h2 id="配列を直列で順に実行する-promise-チェーンを作る"><a class="header-link" href="#配列を直列で順に実行する-promise-チェーンを作る"><span class="header-link-mark"></span></a>配列を直列で順に実行する Promise チェーンを作る</h2>
<p><code>Promise.all()</code> は配列で渡した非同期処理たちを並列で実行するが、直列で、順次実行したい場合は、<em>Promise チェーン</em>を作る。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 適当な配列データ</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'111'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'222'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'333'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'444'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Promise チェーンを開始する最初の Promise オブジェクトは、空の Promise.resolve() で作る</span>
<span class="token keyword">let</span> promiseChain <span class="token operator">=</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 配列 data を順にループする</span>
data<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 変数 promiseChain に、promiseChain.then() と定義して代入を繰り返していく</span>
  promiseChain <span class="token operator">=</span> promiseChain<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token string">'Start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最終的に promiseChain は、Promise.resolve().then(id: 1).then(id: 2).then(id: 3).then(id: 4) な Promise チェーンになっている</span>

<span class="token comment">// 後から promiseChain に then() を繋げると、そこだけ後で実行される</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  promiseChain<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Finished'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>let promiseChain</code> で変数を用意し、<code>data.forEach()</code> 内で <code>promiseChain = promiseChain.then();</code> と繋げていくのは、直感的で読解しやすいコードにはなるが、<code>let</code> が登場するところがイマイチか。</p>
<p>そこで、<em><code>Array.prototype.reduce</code></em> を使って同様の Promise チェーンを構築する方法も紹介する。<strong>コレが一番エレガントだと思います。</strong></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> promiseChain <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevPromise<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> prevPromise
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token string">'Start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  promiseChain<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Finished'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>reduce()</code> は、第1引数の関数が <code>return</code> した値を順に渡していく。また、第2引数に最初の値を指定できるので、まずは第2引数で <code>Promise.resolve()</code> を用意する。</p>
<p>第1引数の関数にて、前回の関数が <code>return</code> した値と今回のループで取り出した要素を取得できるので、<code>return prevPromise.then();</code> とすることで Promise チェーンを実現する。</p>
<p><code>let promiseChain</code> で代入を繰り返した場合も、<code>reduce()</code> で一気に構築した場合も、いずれも以下のような出力結果になる。</p>
<pre class="language-bash"><code class="language-bash">$ node promise-test.js
<span class="token number">2018</span>-08-15T07:35:40.345Z <span class="token punctuation">{</span> id: <span class="token number">1</span>, name: <span class="token string">'111'</span> <span class="token punctuation">}</span> <span class="token string">'Start'</span>
<span class="token number">2018</span>-08-15T07:35:41.354Z <span class="token punctuation">{</span> id: <span class="token number">2</span>, name: <span class="token string">'222'</span> <span class="token punctuation">}</span> <span class="token string">'Start'</span>
<span class="token number">2018</span>-08-15T07:35:43.360Z <span class="token punctuation">{</span> id: <span class="token number">3</span>, name: <span class="token string">'333'</span> <span class="token punctuation">}</span> <span class="token string">'Start'</span>
<span class="token number">2018</span>-08-15T07:35:46.366Z <span class="token punctuation">{</span> id: <span class="token number">4</span>, name: <span class="token string">'444'</span> <span class="token punctuation">}</span> <span class="token string">'Start'</span>
<span class="token number">2018</span>-08-15T07:35:50.372Z <span class="token string">'Finished'</span>
</code></pre>
<ul>
  <li>参考 : <a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Using_promises#Composition">Promiseを使う - JavaScript | MDN</a></li>
</ul>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>かなり Promise が身体に馴染んできた。そろそろ async・await も覚えねば…。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-09-23</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-09-23</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
