<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>アンケートサイトで使える！ドラッグ・アンド・ドロップで選択した範囲を一括でクリックするブックマークレット - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2018/03/25-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script defer src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2018/index.html">2018年</a></li>
            <li><a href="/blog/2018/03/index.html">03月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2018-03-25</time></div>
        <h1 id="page-title">アンケートサイトで使える！ドラッグ・アンド・ドロップで選択した範囲を一括でクリックするブックマークレット</h1>

<p>ドラッグ・アンド・ドロップで選択した範囲を一括でクリックするブックマークレットを作った。</p>
<p>アンケートサイトなんかで、大量のラジオボタンやチェックボックスをクリックするのが面倒になった時は、コチラをドウゾ。</p>
<h2 id="サンプル"><a class="header-link" href="#サンプル"><span class="header-link-mark"></span></a>サンプル</h2>
<p>以下のサンプルをドウゾ。</p>
<ul>
  <li>デモ : <a href="https://neos21.github.io/frontend-sandboxes/survey-helpers/click-selected-range.html">Click Selected Range</a></li>
  <li>コード : <a href="https://github.com/neos21/frontend-sandboxes/blob/master/survey-helpers/click-selected-range.html">frontend-sandboxes/click-selected-range.html at master · Neos21/frontend-sandboxes</a></li>
</ul>
<p>画面内をドラッグすると水色の選択領域が見えるので、そのままドラッグしてチェックボックスをいくつか囲んでみよう。ドラッグ・アンド・ドロップを終了した領域にある要素に対して <code>click()</code> イベントを発火させるので、チェックボックスが一括でセットできるだろう。</p>
<h2 id="ブックマークレット用コード"><a class="header-link" href="#ブックマークレット用コード"><span class="header-link-mark"></span></a>ブックマークレット用コード</h2>
<p>ブックマークレットに使えるコードは以下。</p>
<pre class="language-javascript"><code class="language-javascript">javascript<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span>t<span class="token punctuation">,</span>o<span class="token punctuation">,</span>a<span class="token punctuation">,</span>l<span class="token punctuation">,</span>n<span class="token punctuation">,</span>p<span class="token punctuation">,</span>s<span class="token punctuation">,</span>i<span class="token punctuation">,</span>d<span class="token punctuation">,</span>r<span class="token punctuation">,</span>h<span class="token punctuation">,</span>c<span class="token punctuation">,</span>g<span class="token punctuation">,</span>m<span class="token punctuation">,</span>u</span><span class="token punctuation">)</span><span class="token arrow operator">=></span><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">(</span>d<span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token arrow operator">=></span><span class="token punctuation">(</span>e<span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>h<span class="token operator">=</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"mousedown"</span><span class="token punctuation">,</span><span class="token parameter">t</span><span class="token arrow operator">=></span><span class="token punctuation">{</span>p<span class="token operator">=</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>r<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">cssText</span><span class="token operator">=</span>i<span class="token operator">+</span><span class="token string">"border:1px solid rgba(0,0,255,.2);background:rgba(99,255,255,.2)"</span><span class="token punctuation">,</span>h<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">cssText</span><span class="token operator">=</span>i<span class="token punctuation">,</span>c<span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token property-access">pageX</span><span class="token punctuation">,</span>g<span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token property-access">pageY</span><span class="token punctuation">,</span>m<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token property-access">scrollX</span><span class="token punctuation">,</span>u<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token property-access">scrollY</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span>t<span class="token punctuation">,</span>o</span><span class="token punctuation">)</span><span class="token arrow operator">=></span><span class="token punctuation">{</span>p<span class="token operator">&#x26;&#x26;</span><span class="token punctuation">(</span>s<span class="token operator">=</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>t<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token property-access">pageX</span><span class="token operator">-</span>c<span class="token punctuation">,</span>r<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">left</span><span class="token operator">=</span><span class="token punctuation">(</span>t<span class="token operator">&#x3C;</span><span class="token number">0</span><span class="token operator">?</span>c<span class="token operator">+</span>t<span class="token operator">:</span>c<span class="token punctuation">)</span><span class="token operator">+</span>n<span class="token punctuation">,</span>o<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token property-access">pageY</span><span class="token operator">-</span>g<span class="token punctuation">,</span>r<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">top</span><span class="token operator">=</span><span class="token punctuation">(</span>o<span class="token operator">&#x3C;</span><span class="token number">0</span><span class="token operator">?</span>g<span class="token operator">+</span>o<span class="token operator">:</span>g<span class="token punctuation">)</span><span class="token operator">+</span>n<span class="token punctuation">,</span>r<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token operator">=</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">abs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token operator">+</span>n<span class="token punctuation">,</span>r<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token operator">=</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">abs</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"mouseup"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">,</span>i<span class="token punctuation">,</span>d<span class="token punctuation">,</span>r<span class="token punctuation">,</span>b<span class="token punctuation">,</span>f<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token constant">M</span></span><span class="token punctuation">)</span><span class="token arrow operator">=></span><span class="token punctuation">{</span><span class="token keyword control-flow">if</span><span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token keyword control-flow">for</span><span class="token punctuation">(</span>s<span class="token operator">=</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>i<span class="token operator">=</span>o<span class="token punctuation">.</span><span class="token property-access">pageX</span><span class="token punctuation">,</span>d<span class="token operator">=</span>o<span class="token punctuation">.</span><span class="token property-access">pageY</span><span class="token punctuation">,</span>r<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>f<span class="token operator">=</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token operator">&#x3C;</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token operator">+=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token keyword control-flow">for</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token method function property-access">scrollTo</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token operator">&#x3C;</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token operator">+=</span><span class="token number">9</span><span class="token punctuation">)</span>h<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">top</span><span class="token operator">=</span>f<span class="token operator">+</span>n<span class="token punctuation">,</span>h<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">left</span><span class="token operator">=</span>b<span class="token operator">+</span>n<span class="token punctuation">,</span>x<span class="token operator">=</span>h<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token method function property-access">scrollTo</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token operator">=</span>h<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token method function property-access">elementFromPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&#x26;&#x26;</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">)</span><span class="token operator">&#x26;&#x26;</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">,</span><span class="token dom variable">document</span><span class="token punctuation">,</span><span class="token string">"addEventListener"</span><span class="token punctuation">,</span><span class="token string">"getBoundingClientRect"</span><span class="token punctuation">,</span><span class="token string">"style"</span><span class="token punctuation">,</span><span class="token string">"px"</span><span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"position:absolute;top:0;left:0;width:1px;height:1px;pointer-events:none;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="ソースコード"><a class="header-link" href="#ソースコード"><span class="header-link-mark"></span></a>ソースコード</h2>
<p>ソースコードは以下。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">win<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> addEvent<span class="token punctuation">,</span> getRect<span class="token punctuation">,</span> sty<span class="token punctuation">,</span> px<span class="token punctuation">,</span> isMouseDown<span class="token punctuation">,</span> isDragging<span class="token punctuation">,</span> defaultStyle<span class="token punctuation">,</span> createElement<span class="token punctuation">,</span> rangeElem<span class="token punctuation">,</span> pointElem<span class="token punctuation">,</span> beginX<span class="token punctuation">,</span> beginY<span class="token punctuation">,</span> beginScrollX<span class="token punctuation">,</span> beginScrollY</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 要素を生成して返す関数を作る</span>
  <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">elem</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    elem <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> elem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 選択範囲を示す要素</span>
  rangeElem <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ポインタ要素</span>
  pointElem <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// マウスボタン押下</span>
  doc<span class="token punctuation">[</span>addEvent<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// マウスボタン押下中</span>
    isMouseDown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 選択範囲を消すため初期値を再指定する</span>
    rangeElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">cssText</span> <span class="token operator">=</span> defaultStyle <span class="token operator">+</span> <span class="token string">'border:1px solid rgba(0,0,255,.2);background:rgba(99,255,255,.2)'</span><span class="token punctuation">;</span>
    pointElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">cssText</span> <span class="token operator">=</span> defaultStyle<span class="token punctuation">;</span>
    <span class="token comment">// 選択開始位置を控えておく</span>
    beginX <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageX</span><span class="token punctuation">;</span>
    beginY <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageY</span><span class="token punctuation">;</span>
    <span class="token comment">// 選択開始時のスクロール位置を控えておく</span>
    beginScrollX <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token property-access">scrollX</span><span class="token punctuation">;</span>
    beginScrollY <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token property-access">scrollY</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// マウス移動中</span>
  doc<span class="token punctuation">[</span>addEvent<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// マウスボタン押下中の移動なら処理する</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>isMouseDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ドラッグ中</span>
      isDragging <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 始点より左に移動する場合を考慮して left を制御する</span>
      x <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageX</span> <span class="token operator">-</span> beginX<span class="token punctuation">;</span>
      rangeElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">left</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token operator">?</span> beginX <span class="token operator">+</span> x <span class="token operator">:</span> beginX<span class="token punctuation">)</span> <span class="token operator">+</span> px<span class="token punctuation">;</span>
      <span class="token comment">// 始点より上に移動する場合を考慮して top を制御する</span>
      y <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageY</span> <span class="token operator">-</span> beginY<span class="token punctuation">;</span>
      rangeElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token operator">?</span> beginY <span class="token operator">+</span> y <span class="token operator">:</span> beginY<span class="token punctuation">)</span> <span class="token operator">+</span> px<span class="token punctuation">;</span>
      <span class="token comment">// 始点と現在の位置の差を絶対値にして幅・高さとして設定する</span>
      rangeElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">width</span>  <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> px<span class="token punctuation">;</span>
      rangeElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">height</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">abs</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">+</span> px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// マウスボタンを離した時</span>
  doc<span class="token punctuation">[</span>addEvent<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> endY<span class="token punctuation">,</span> clickedElems<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> position<span class="token punctuation">,</span> elem</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// マウスボタンを離した</span>
    isMouseDown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// ドラッグ中なら処理する</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>isDragging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ドラッグ終了</span>
      isDragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">// 終了位置を控えておく</span>
      endX <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageX</span><span class="token punctuation">;</span>
      endY <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">pageY</span><span class="token punctuation">;</span>
      <span class="token comment">// クリックした要素を入れておく配列</span>
      clickedElems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 左上から 9px ずつズラす (圧縮時に1桁の数値で済ませたいので…)</span>
      <span class="token comment">// elementFrompoint はスクロールして画面上に要素が見えていないと null になってしまうので、スクロールして対象要素が画面内に表示されている状態にしている</span>
      <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>  y <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span>beginY<span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span> y <span class="token operator">&#x3C;</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span>beginY<span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 開始位置にスクロールし直す</span>
        win<span class="token punctuation">.</span><span class="token method function property-access">scrollTo</span><span class="token punctuation">(</span>beginScrollX<span class="token punctuation">,</span> beginScrollY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span>beginX<span class="token punctuation">,</span> endX<span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">&#x3C;</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span>beginX<span class="token punctuation">,</span> endX<span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          pointElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">top</span>  <span class="token operator">=</span> y <span class="token operator">+</span> px<span class="token punctuation">;</span>
          pointElem<span class="token punctuation">[</span>sty<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">left</span> <span class="token operator">=</span> x <span class="token operator">+</span> px<span class="token punctuation">;</span>
          <span class="token comment">// 絶対配置したポインタ要素の位置にスクロールする</span>
          position <span class="token operator">=</span> pointElem<span class="token punctuation">[</span>getRect<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          win<span class="token punctuation">.</span><span class="token method function property-access">scrollTo</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span> position<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// ポインタ要素の座標を再度拾い、その位置にある要素を取得する</span>
          position <span class="token operator">=</span> pointElem<span class="token punctuation">[</span>getRect<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          elem <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token method function property-access">elementFromPoint</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span> position<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// クリック済の要素は無視してクリックする</span>
          <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>elem <span class="token operator">&#x26;&#x26;</span> <span class="token operator">!</span>clickedElems<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            elem<span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clickedElems<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token dom variable">window</span><span class="token punctuation">,</span>                   <span class="token comment">// win</span>
  <span class="token dom variable">document</span><span class="token punctuation">,</span>                 <span class="token comment">// doc</span>
  <span class="token string">'addEventListener'</span><span class="token punctuation">,</span>       <span class="token comment">// addEvent</span>
  <span class="token string">'getBoundingClientRect'</span><span class="token punctuation">,</span>  <span class="token comment">// getRect</span>
  <span class="token string">'style'</span><span class="token punctuation">,</span>                  <span class="token comment">// sty</span>
  <span class="token string">'px'</span><span class="token punctuation">,</span>                     <span class="token comment">// px</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>                    <span class="token comment">// isMouseDown</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>                    <span class="token comment">// isDragging</span>
  <span class="token string">'position:absolute;top:0;left:0;width:1px;height:1px;pointer-events:none;'</span>  <span class="token comment">// defaultStyle</span>
  <span class="token comment">// createElem</span>
  <span class="token comment">// rangeElem</span>
  <span class="token comment">// pointElem</span>
  <span class="token comment">// beginX</span>
  <span class="token comment">// beginY</span>
  <span class="token comment">// beginScrollX</span>
  <span class="token comment">// beginScrollY</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>ブックマークレットとして利用するため即時関数の形にしておき、引数を利用してグローバル領域を汚さないようにしている。</li>
  <li>予めドラッグ・アンド・ドロップ領域を示すための要素 <code>rangeElem</code> と、クリックする座標を特定するために使用する要素 <code>pointElem</code> を生成しておく。</li>
  <li><code>mousedown</code>・<code>mousemove</code>・<code>mouseup</code> でドラッグ・アンド・ドロップした領域を拾うための処理を管理している。<code>rangeElem</code> を <code>position: absolute</code> で絶対配置し、その <code>top</code>・<code>left</code> が画面左上の始点となる座標、<code>width</code>・<code>height</code> で終点となる右下の座標を特定できるようにする。</li>
  <li>ブックマークレットとして利用するため即時関数の形にしておき、引数を利用してグローバル領域を汚さないようにしている。</li>
  <li>予めドラッグ・アンド・ドロップ領域を示すための要素 <code>rangeElem</code> と、クリックする座標を特定するために使用する要素 <code>pointElem</code> を生成しておく。</li>
  <li><code>mousedown</code>・<code>mousemove</code>・<code>mouseup</code> でドラッグ・アンド・ドロップした領域を拾うための処理を管理している。<code>rangeElem</code> を <code>position: absolute</code> で絶対配置し、その <code>top</code>・<code>left</code> が画面左上の始点となる座標、<code>width</code>・<code>height</code> で終点となる右下の座標を特定できるようにする。</li>
  <li>座標を指定して要素を特定するには <code>elementFromPoint()</code> というメソッドを使う。
    <ul>
      <li><a href="/blog/2018/01/01-02.html">elementFromPoint() という API があった</a></li>
    </ul>
  </li>
  <li>だが、<code>elementFromPoint()</code> は<em>スクロールが発生すると要素が取得できなくなる</em>。どうもスクロールに対するオフセットを考慮しないといけないようだが、それでも画面内に表示されていないと上手く要素が取得できないようであった。</li>
  <li>また、画面外の要素をなんとか座標で特定しても、<code>click()</code> イベントを上手く発火させられないことがあった。</li>
  <li>コレを解消するため、以下の順に処理した。
    <ol>
      <li>クリックしたい座標に <code>pointElem</code> 要素を配置する。</li>
      <li>配置した <code>pointElem</code> 要素の座標を <strong><code>getBoundingClientRect()</code></strong> で取得する。この座標値は、ドラッグ中のスクロールを伴い、画面外になっている場合がある。</li>
      <li>この座標が画面内に表示されるよう <code>scrollTo()</code> でスクロール移動する。</li>
      <li>そのうえで再度 <code>pointElem</code> 要素の座標を <code>getBoundingClientRect()</code> で取得する。</li>
      <li>こうして取得した座標に対して <code>elementFromPoint()</code> で要素を拾えば、正しく要素が拾える。</li>
    </ol>
  </li>
  <li>ドラッグ領域を示す <code>rangeElem</code> や <code>pointElem</code> には <code>pointer-events: none</code> を指定しておき、この要素が選択されないようにしておいた。</li>
  <li>このような処理を、選択領域の左上から右に 9px ずつズラしていき、右端に行ったら下に 9px ズラして…を繰り返す。9px というオフセット値は「大体」なので適当。</li>
  <li>一度クリックした要素は配列に控えておき、再度クリックしないようにしておく。</li>
</ul>
<p>「ブラウザで見えている範囲の要素でないとうまく操作できない」というところが面倒臭かった。</p>
<p>スクロールを伴うドラッグ・アンド・ドロップをサポートしないのであれば、スクロールし直したりする必要もなく、<code>rangeElem</code> の <code>top</code>・<code>left</code> の座標から <code>width</code>・<code>height</code> の値まで <code>elementFromPoint()</code> を繰り返せばいいだけ。もう少し楽に実装できるのだが…。</p>
<p>とりあえずコレで、大量に領域を選択して、一気にクリックできるようになったので、雑にアンケートサイトの回答ができるようになった。ｗ</p>
<hr>
<p>以下続編。</p>
<ul>
  <li><a href="/blog/2018/03/29-01.html">アンケートサイトで使える！都道府県セレクトボックスを自動選択するブックマークレット</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2018-03-25</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2018-03-25</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
