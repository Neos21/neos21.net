<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <!-- Open Graph・Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Neo's World">
    <meta property="og:title" content="Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした - Neo's World">
    <meta property="og:description" content="Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした - Neo's World">
    <meta property="og:url" content="https://neos21.net/blog/2017/08/07-01.html">
    <meta property="og:image" content="https://neos21.net/ogp.png">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした - Neo's World">
    <meta property="twitter:description" content="Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした - Neo's World">
    <meta property="twitter:url" content="https://neos21.net/blog/2017/08/07-01.html">
    <meta property="twitter:image" content="https://neos21.net/ogp.png">
    <title>Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2017/08/07-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MZCGD23');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MZCGD23" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2017/index.html">2017年</a></li>
            <li><a href="/blog/2017/08/index.html">08月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2017-08-07</time></div>
        <h1 id="page-title">Cordova アプリのページ背景に動画録画中の映像を表示する cordova-background-video プラグインを Fork して 1080p 動画を録画できるようにした</h1>

<p><strong>cordova-background-video</strong> というプラグインがある。動画が撮影できる Cordova プラグインなのだが、面白いのは録画を始めると、Cordova アプリを構成する HTML ページの背景に録画中の映像が表示されるのだ。cordova-plugin-camera-preview という写真撮影ができるプラグインも、HTML ページの任意の場所にプレビューを表示できたりするが、これの動画撮影版、みたいなプラグインだ。</p>
<p>このプラグイン、やたらと Fork されていて、一番最近も更新が盛んにされていそうな @mlingos 氏の Fork を使ってみたのだが、<em>撮影できる画質が凄く悪くて使い物にならない</em>。</p>
<ul>
  <li>参考 : <a href="https://github.com/mlingos/cordova-background-video">GitHub - mlingos/cordova-background-video: A simple Cordova/Phonegap plugin to capture video and then display it onscreen via a transparent overlay without affecting app functionality.</a> … @mlingos 氏の Fork 版。</li>
</ul>
<h2 id="objective-c-コードを修正した-fork-版を作った"><a class="header-link" href="#objective-c-コードを修正した-fork-版を作った"><span class="header-link-mark"></span></a>Objective-C コードを修正した Fork 版を作った</h2>
<p>動画の画質が悪く、動画のサイズも 640x480px くらいの小さなもの。せっかくページ中にプレビューを埋め込めて面白いプラグインなのに、動画の画質が悪いとダメだなー…。</p>
<p>そう思いながらソースコードを何気なく眺めていたら、Objective-C は全然知らないけど、何となく画質を向上させられそうな気がしてきた。</p>
<p>そこで GitHub リポジトリを Fork して、独自に開発を始めた。そしてこのプラグインで、iOS 版では <strong>1080p の動画を撮影できるように改造できた</strong>。それが以下のリポジトリだ。</p>
<ul>
  <li><a href="https://github.com/Neos21/cordova-background-video">GitHub - Neos21/cordova-background-video: A simple Cordova/Phonegap plugin to capture video and then display it onscreen via a transparent overlay without affecting app functionality.</a></li>
</ul>
<h2 id="画質向上のために書き換えたのは1行だけ"><a class="header-link" href="#画質向上のために書き換えたのは1行だけ"><span class="header-link-mark"></span></a>画質向上のために書き換えたのは1行だけ</h2>
<p>実際のところ、1080p の動画を撮影できるように書き換えたコードは<strong>たった1行</strong>。</p>
<ul>
  <li><a href="https://github.com/Neos21/cordova-background-video/commit/6e376fe8d137e086a237c67099d71b1968407797#diff-2b653200478ad92108ab6e918d0d750fL56">Set quality to 1080p · Neos21/cordova-background-video@6e376fe · GitHub</a></li>
</ul>
<p><em><code>AVCaptureSessionPresetMedium</code> という記述箇所を <code>AVCaptureSessionPreset1920x1080</code> と書き換えただけだ。</em></p>
<p>AVFoundation という API が、何やら iOS で動画撮影を行うための API らしく、その中で画質を決めているのがこの記述箇所だった。以下のサイトを参考に、1080p で撮影できるプリセットを探して書き換えたという寸法。</p>
<ul>
  <li>参考 : <a href="http://dev.classmethod.jp/smartphone/ios-avfundation/">iOS AVFundationを使用して、「ビデオ録画」や「連写カメラ」や「QRコードリーダー」や「バーコードリーダー」を作ってみた ｜ DevelopersIO</a></li>
</ul>
<h2 id="コンパイルビルドなどは不要テキストエディタで書き換えただけ"><a class="header-link" href="#コンパイルビルドなどは不要テキストエディタで書き換えただけ"><span class="header-link-mark"></span></a>コンパイル・ビルドなどは不要、テキストエディタで書き換えただけ</h2>
<p>Objective-C のコードだが、Mac 標準のテキストエディタで <code>src/ios/backgroundvideo.m</code> を開いて書き換えただけで、特にビルド等は必要ない。Cordova プラグインは <code>$ cordova build</code> 時によしなにやってくれるみたいだ。</p>
<p>ちなみに同名の <code>backgroundvideo.h</code> というファイルはヘッダファイルと呼ばれ、実コードが書いてある <code>.m</code> ファイルとセットになっている。使用する型宣言みたいなことをやるみたい。<code>.m</code> は Module の「M」かな？</p>
<h2 id="その他修正"><a class="header-link" href="#その他修正"><span class="header-link-mark"></span></a>その他修正</h2>
<p>前述のとおり、このプラグインはあちこちで Fork されて適当に改良されてきたらしく、<code>cordova.plugins.backgroundvideo.start()</code> 関数の引数が無茶苦茶になっていた。使っていない引数もあったりしたので、それを整理するため、Objective-C のコードとそれを呼び出す JavaScript コードを修正した。</p>
<p>Cordova プラグインの JavaScript コード (<code>www/backgroundvideo.js</code>) の方は、<code>cordova.exe()</code> という共通関数を叩いてプラグインのネイティブコードにアクセスするようになっている。</p>
<p>Objective-C のコードの方を見ると、<code>command.arguments objectAtIndex:0</code> に相当するはずの、第1引数に指定するディレクトリパスが使われていないようだったので、使用されていない引数は削って動くようにした。</p>
<h2 id="思いの他簡単に改造できた"><a class="header-link" href="#思いの他簡単に改造できた"><span class="header-link-mark"></span></a>思いの他簡単に改造できた！</h2>
<p>「Cordova ならフロントエンド技術だけでアプリが作れる」といっても、Cordova プラグインがやっていることはネイティブの iOS アプリと同様のこと。iOS アプリ開発に関する情報はネット上にも豊富にあり、Cordova プラグインがどのようにその処理を実現しているのかは意外と簡単に読み解けた。JavaScript からどのようにネイティブコードに連携しているか、ネイティブコードは何をしているか、を知っておくと、より上手く使いこなせると思うので、Objective-C が分からなくても何となく読んでおくだけでだいぶ違うかも。</p>
<p>Cordova アプリとして表示している HTML 要素部分も、ネイティブコードでは1つのレイヤとして扱われており、プレビュー画面はそのレイヤより下に表示するとか、ステータスバーは上に表示するだとか、そういった設定もできるようだ。レイヤの感覚があると、cordova-plugin-googlemaps プラグインの表示位置がズレる問題に関しても納得がいくと思う。</p>
<p>Objective-C コードをゼロから書き上げてはいないので、IDE も入れていないことだし、<code>.h</code> ファイルをどういうタイミングで追加・変更するのか分からず。複雑な変更はまだやれなさそうだが、現行のコードを見るに、例えば JS からオプションでサイズや座標を与えればそれに合わせてプレビュー画面を表示することもできそうだったりする。これができるようになると本当に cordova-plugin-camera-preview プラグインの動画版みたいにできそうだ。</p>
<p>コンパイルやビルドが必要ないのも開発しやすいところかな。ソースコードを書いたら、実際に Cordova アプリにプラグインとして追加して、<code>$ cordova build</code> なり <code>$ cordova run ios</code> なりで Cordova ビルドを行えばすぐさま使用感を確認できる。</p>
<h2 id="使い方説明などは次回"><a class="header-link" href="#使い方説明などは次回"><span class="header-link-mark"></span></a>使い方説明などは次回</h2>
<p>今回は、既存プラグインを Fork して、たった1行の変更でも、さも大きな機能改修をしたかのような成果を挙げられた、というお話でした。</p>
<p>このプラグインの使い方については、次回触れる。</p>
<ul>
  <li><a href="/blog/2017/08/14-02.html">ぼくが Fork した cordova-background-video を紹介する</a></li>
</ul>
<h2 id="その他読んだ記事"><a class="header-link" href="#その他読んだ記事"><span class="header-link-mark"></span></a>その他読んだ記事</h2>
<ul>
  <li><a href="http://d.hatena.ne.jp/shu223/20121202/1354436478">シャッター音の鳴らないカメラアプリの実装方法 - Over&#x26;Out その後</a></li>
  <li><a href="http://qiita.com/shu223/items/51f764101e6fd5c2161b">AV Foundationで240fpsスローモーション動画撮影を実装する - Qiita</a></li>
  <li><a href="http://dev.classmethod.jp/smartphone/ios-avfundation/">iOS AVFundationを使用して、「ビデオ録画」や「連写カメラ」や「QRコードリーダー」や「バーコードリーダー」を作ってみた ｜ DevelopersIO</a></li>
  <li><a href="http://qiita.com/hkato193/items/9fa2145c5583487bb859">iPhoneで使える写真・ビデオ撮影のいろんな機能を紹介します。 - Qiita</a></li>
  <li><a href="http://tomoyaonishi.hatenablog.jp/entry/2014/06/29/024010">AVFoundationのキャプチャ機能について - tomoyaonishiのブログ</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2017-08-07</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2017-08-07</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
