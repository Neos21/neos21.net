<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>.m3u8 ファイルから .mp4 ファイルを保存する方法 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2017/09/09-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2017/index.html">2017年</a></li>
            <li><a href="/blog/2017/09/index.html">09月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2017-09-09</time></div>
        <h1 id="page-title">.m3u8 ファイルから .mp4 ファイルを保存する方法</h1>

<p>一部の動画サイトは、Firefox アドオンの FlashGot で動画ファイルを特定できず、動画ダウンロードが上手くできない。</p>
<p>そこで開発者ツールでネットワーク通信を眺めてみると、<strong><code>.m3u8</code></strong> というファイルが鍵を握っているらしいことが分かった。</p>
<p>調べてみると、<code>.m3u8</code> ファイルというのは<em>動画ファイルのプレイリストファイル</em>で、このファイルをダウンロードしてメモ帳で開いてみると、細切れにされた動画ファイルの URL が羅列されていた。中身はこんな感じ。</p>
<pre><code>#EXTM3U
#EXT-X-TARGETDURATION:10
#EXT-X-ALLOW-CACHE:YES
#EXT-X-PLAYLIST-TYPE:VOD
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:1
#EXTINF:6.006,
http://hoge.com/764422617.mp4/seg-1-v1-a1.ts
#EXTINF:10.010,
http://hoge.com/764422617.mp4/seg-2-v1-a1.ts
#EXTINF:10.010,
http://hoge.com/764422617.mp4/seg-3-v1-a1.ts

…「EXTINF」と URL の行が大量に並ぶ…

#EXT-X-ENDLIST
</code></pre>
<blockquote>
  <p>HLSとはHTTP Live Streamingの略で、Appleによって開発された動画配信技術です。</p>
  <p>HLSを使用した配信では、インデックスファイルと分割された動画ファイルにより構成されています。</p>
  <p>m3u8はインデックスファイルのことです。もともとM3U はマルチメディアプレイリストのファイルフォーマットで、M3U8はUTF-8で書かれたM3Uファイルということを表しています。</p>
</blockquote>
<ul>
  <li>参考 : <a href="https://shotaste.com/blog/convert-hls/">HLS(m3u8+ts)形式の動画をFFmpegを使ってmp4に一発変換する方法 | しょたすてーしょん</a></li>
</ul>
<p><code>.m3u8</code> ファイルを開くと何やら <code>.mp4</code> ファイルが見えるので、このファイルを上手く保存できないかと調べてみた。すると、<strong>ffmpeg を使って <code>.m3u8</code> ファイルから <code>.mp4</code> ファイルを生成・保存できる</strong>ことが分かった。</p>
<p>以下、やり方を説明。</p>
<h2 id="ffmpeg-のインストール"><a class="header-link" href="#ffmpeg-のインストール"><span class="header-link-mark"></span></a>ffmpeg のインストール</h2>
<p>まずは ffmpeg をインストールする。以下のサイトからダウンロード・インストールしてもいいし、Chocolatey でインストールしても良い。</p>
<ul>
  <li><a href="http://ffmpeg.zeranoe.com/builds/">Builds - Zeranoe FFmpeg</a></li>
</ul>
<p>Chocolatey の場合は管理者モードで起動した PowerShell で以下のように叩く。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">PS</span>> choco install ffmpeg
</code></pre>
<p>Chocolatey の場合、ffmpeg のインストール先は <em><code>C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffmpeg\</code></em> というよく分からない場所になっている。このディレクトリごと任意の場所にコピーして使うと良いかと。</p>
<h2 id="m3u8-ファイルをダウンロードしておく"><a class="header-link" href="#m3u8-ファイルをダウンロードしておく"><span class="header-link-mark"></span></a><code>.m3u8</code> ファイルをダウンロードしておく</h2>
<p>動画ファイルをダウンロードしたいページでブラウザの開発者ツールを開き、「ネットワーク」タブから <code>.m3u8</code> ファイルを特定し、URL をコピーしたらアドレス欄に叩きつけて <code>.m3u8</code> ファイルをローカルにダウンロードする。</p>
<p>Firefox でも Chrome でも同じようにできるはず。</p>
<h2 id="ffmpeg-でコマンドを叩く"><a class="header-link" href="#ffmpeg-でコマンドを叩く"><span class="header-link-mark"></span></a>ffmpeg でコマンドを叩く</h2>
<p>分かりやすくするため、<code>.m3u8</code> ファイルは <code>ffmpeg.exe</code> と同じディレクトリに置いておく。Chocolatey でインストールした場合は <code>C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffmpeg\bin\ffmpeg.exe</code> に <code>ffmpeg.exe</code> があるので、このディレクトリにでも置いておく。</p>
<p>で、コマンドプロンプトか PowerShell で、以下のようにコマンドを打つ。</p>
<pre class="language-batch"><code class="language-batch">> ffmpeg -protocol_whitelist file,http,https,tcp,tls -i 【m3u8 ファイル名】.m3u8 -movflags faststart -c copy 【生成したいファイル名】.mp4
</code></pre>
<p><code>-protocol_whitelist file,http,https,tcp,tls</code> というオプションを指定しないと</p>
<pre><code>[ffmpeg] http: Protocol not on whitelist 'file,crypto'!
</code></pre>
<p>といったエラーが発生する。このオプションは先頭の方に書いておかないといけなかった。</p>
<p><code>-i 【m3u8 ファイル名】.m3u8</code> でインプットの指定、<code>-movflags faststart</code> でエンコード後にメタデータを先頭に移動させる (イマイチ効果不明)、<code>-c copy 【生成したいファイル名】.mp4</code> でオーディオとビデオを動画ファイルにコピーする。</p>
<p>これで <code>.m3u8</code> ファイルをインプットに、<code>.mp4</code> ファイルをダウンロード保存することができた。</p>
<h2 id="参考"><a class="header-link" href="#参考"><span class="header-link-mark"></span></a>参考</h2>
<ul>
  <li><a href="https://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q14174977604">動画のダウンロード</a></li>
  <li><a href="http://freesoft-plaza.com/blog-entry-148.html">ffmpegだけでGYAO動画をダウンロードする方法｜ギャッターのフリーソフト広場</a></li>
  <li><a href="http://qiita.com/joker1007/items/def9d58ddb00fafc936d">HTML5のvideoタグで利用するmp4の動画を作る時のTips - Qiita</a></li>
  <li><a href="http://d.hatena.ne.jp/zariganitosh/20150619/understand_ffmpeg">なるべく理解したいffmpeg - ザリガニが見ていた...。</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2017-09-09</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2017-09-09</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
