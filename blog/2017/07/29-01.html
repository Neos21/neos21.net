<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>AngularJS + Cordova なプロジェクトに Protractor + Appium を導入して iOS シミュレータで E2E テストを動かす - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2017/07/29-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2017/index.html">2017年</a></li>
            <li><a href="/blog/2017/07/index.html">07月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2017-07-29</time></div>
        <h1 id="page-title">AngularJS + Cordova なプロジェクトに Protractor + Appium を導入して iOS シミュレータで E2E テストを動かす</h1>

<p>タイトルが長くなってしまったが、</p>
<ul>
  <li>AngularJS に Cordova を取り込んだプロジェクトにおいて、</li>
  <li>Protractor を使った E2E テストを行いたいが、</li>
  <li>iOS シミュレータ上で E2E テストを動かすために Appium というツールを併用する</li>
</ul>
<p>という流れである。</p>
<p><em>Protractor</em> は AngularJS 向けに作られた E2E テストツール。</p>
<p>一方 <strong>Appium</strong> は Selenium WebDriver の一種で、E2E テストツールと WebDriver の間に割り込んで、iOS シミュレータや iOS 実機を操作してくれる。細かな仕組みは厄介なので、とりあえず「iOS シミュレータで E2E テストする時に使う Selenium の亜種」ぐらいに思っておけばよいかと。</p>
<ul>
  <li>参考：<a href="http://qiita.com/k5n/items/899cf40a0021a6a92efd">Appiumの仕組みと使い方 - Qiita</a></li>
  <li>参考：<a href="http://www.atmarkit.co.jp/ait/articles/1504/27/news025.html">SeleniumのUIテスト自動化をiOS／AndroidにもたらすAppiumの基礎知識とインストール方法、基本的な使い方：スマホ向け無料システムテスト自動化ツール（8） - ＠IT</a></li>
</ul>
<p>iOS シミュレータの動作、および Appium の動作のために色々とインストールが必要なモノが多いので、それらをまとめて紹介する。</p>
<h2 id="実際のコードはコチラ"><a class="header-link" href="#実際のコードはコチラ"><span class="header-link-mark"></span></a>実際のコードはコチラ</h2>
<p>今回紹介したパッケージとサンプルコードを利用し、<strong>AngularJS + Cordova なアプリで Appium を使った E2E テストを行うサンプルプロジェクト</strong>を作成した。以下を参考にしてほしい。</p>
<ul>
  <li><a href="https://github.com/Neos21/example-angular-js-cordova-appium">GitHub - Neos21/AngularJSCordovaAppium: AngularJS + Cordova + Appium な環境で iOS アプリの E2E テストを行うサンプル</a></li>
</ul>
<h2 id="xcode-のライセンスに同意する"><a class="header-link" href="#xcode-のライセンスに同意する"><span class="header-link-mark"></span></a>XCode のライセンスに同意する</h2>
<p>AppStore から XCode をインストールした後、コマンドラインでライセンスに同意しないといけない。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> xcodebuild -license
</code></pre>
<p>このコマンドを叩くと何やら文章が出てくる。<code>Space</code> キーで抜けたら「<code>agree</code>」と入力して Enter することでライセンス認証ができる。</p>
<ul>
  <li>参考：<a href="http://qiita.com/hirose504@github/items/ce178f30ad157520bc15">Xcode ライセンスに同意をコマンドラインで実行する方法 - Qiita</a></li>
</ul>
<h2 id="homebrew-でインストールするモノ"><a class="header-link" href="#homebrew-でインストールするモノ"><span class="header-link-mark"></span></a>Homebrew でインストールするモノ</h2>
<p>Homebrew より</p>
<ul>
  <li>Carthage</li>
  <li>iOS WebKit DebugProxy</li>
  <li>Lib iMobile Device</li>
</ul>
<p>をインストールする。</p>
<p>Lib iMobile Device は iOS WebKit Debug Proxy が依存しているのか、一緒にインストールされるが、最新版 (<code>--HEAD</code>) にアップデートしないと上手く動かないので更新をかけておく。</p>
<pre class="language-bash"><code class="language-bash">$ brew <span class="token function">install</span> carthage ios-webkit-debug-proxy
$ brew upgrade libimobiledevice --HEAD

<span class="token comment"># これで以下3つが追加されていれば OK</span>
$ brew list
carthage                <span class="token comment"># Cathage : appium-xcuitest-driver が依存している</span>
<span class="token function">git</span>
ios-webkit-debug-proxy  <span class="token comment"># iOS WebKit Debug Proxy : Safari インスペクタでデバッグする際に使用する</span>
libimobiledevice        <span class="token comment"># Lib iMobile Device : USB 接続された iOS デバイスの情報を取得するモノ</span>
</code></pre>
<h2 id="rubygems-でインストールが必要なモノ"><a class="header-link" href="#rubygems-でインストールが必要なモノ"><span class="header-link-mark"></span></a>RubyGems でインストールが必要なモノ</h2>
<p>RubyGems で XC Pretty というツールを入れておく。</p>
<pre class="language-bash"><code class="language-bash">$ gem <span class="token function">install</span> xcpretty

<span class="token comment"># これで以下2つがインストールされていれば OK</span>
$ gem list
*** LOCAL GEMS ***
rouge <span class="token punctuation">(</span><span class="token number">2.0</span>.7<span class="token punctuation">)</span>     <span class="token comment"># Rouge : XCPretty が依存しているシンタックスハイライタ</span>
xcpretty <span class="token punctuation">(</span><span class="token number">0.2</span>.8<span class="token punctuation">)</span>  <span class="token comment"># XCPretty : XCode のログを整形して表示する</span>
</code></pre>
<h2 id="npm-でグローバルインストールが必要なモノ"><a class="header-link" href="#npm-でグローバルインストールが必要なモノ"><span class="header-link-mark"></span></a>npm でグローバルインストールが必要なモノ</h2>
<p>最後に npm でグローバルインストールしておくモノたち。</p>
<ul>
  <li>appium-doctor … コレは必須ではないが Appium が動作する環境かチェックできるため入れておく</li>
  <li>authorize-ios</li>
  <li>deviceconsole</li>
  <li>ios-deploy</li>
  <li>ios-sim</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># グローバルインストールする</span>
$ <span class="token function">npm</span> <span class="token function">install</span> -g appium-doctor authorize-ios deviceconsole ios-deploy ios-sim

<span class="token comment"># iOS の認証を行う</span>
$ <span class="token function">sudo</span> authorize-ios

<span class="token comment"># Appium が動作する環境になっているかチェックする</span>
<span class="token comment"># 何か問題があれば別途確認する</span>
$ appium-doctor --ios

<span class="token comment"># 以下がインストールされていれば OK</span>
$ <span class="token function">npm</span> list -g
├── appium-doctor@1.4.2  <span class="token comment"># Appium Doctor : Appium が使える環境かチェックする</span>
├── authorize-ios@1.0.5  <span class="token comment"># Authorize iOS : iOS の認証を行う</span>
├── deviceconsole@1.0.1  <span class="token comment"># Device Console : iOS のログを整形する</span>
├── ios-deploy@1.9.1     <span class="token comment"># iOS Deploy : XCode を経由せず iOS アプリをインストールするために使用する</span>
├── ios-sim@6.0.0        <span class="token comment"># iOS Sim : XCode を経由せず iOS アプリを起動するために使用する</span>
</code></pre>
<p>これで Mac 環境全体で用意しておくモノは終わり。</p>
<h2 id="プロジェクトに-protractor-と-appium-をインストールする"><a class="header-link" href="#プロジェクトに-protractor-と-appium-をインストールする"><span class="header-link-mark"></span></a>プロジェクトに Protractor と Appium をインストールする</h2>
<p>いよいよプロジェクトの準備。Protractor と Appium、そしてその連携に必要な WD (WebDriver) と WD Bridge というツールを入れる。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i -D protractor wd wd-bridge appium
</code></pre>
<p>今回は Gulp スクリプトから Protractor を実行したいのと、Appium サーバの起動も Gulp スクリプトに定義したいため、以下も入れておく。Jasmine-Spec-Reporter は Protractor の実行結果を整形して出力するためのモノ。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i -D gulp-protractor gulp-shell jasmine-spec-reporter
</code></pre>
<h2 id="appium-の設定ファイルを作る"><a class="header-link" href="#appium-の設定ファイルを作る"><span class="header-link-mark"></span></a>Appium の設定ファイルを作る</h2>
<p>Appium はサーバとして起動させるため、その設定ファイルを用意する。<code>nodeConfig.json</code> という名前でプロジェクト直下に以下のようなファイルを作る。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"configuration"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"cleanUpCycle"</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
    <span class="token property">"timeout"</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    <span class="token property">"proxy"</span><span class="token operator">:</span> <span class="token string">"org.openqa.grid.selenium.proxy.DefaultRemoteProxy"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://127.0.0.1:4723/wd/hub"</span><span class="token punctuation">,</span>
    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">4723</span><span class="token punctuation">,</span>
    <span class="token property">"maxSession"</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>何か色々な文献を見て研究した結果、こういう設定ファイルに落ち着いたけど、何が必要で何が不要かもう忘れてしまった。大体はデフォルト設定だと思うのだが、これでいいと思う。</p>
<p>続いて <code>gulpfile.js</code> に Appium サーバを起動するタスクを作成する。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'appium'</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token property-access">shell</span><span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token string">'appium --nodeconfig ./nodeConfig.json --session-override'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> quiet<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>要するにコンソールで <code>$ appium --nodeconfig ./nodeConfig.json --session-override</code> と打てば良いだけなのだが、コレを <code>$ gulp appium</code> で呼べるようにするために Gulp-Shell を使っている。</p>
<h2 id="protractor-の設定ファイルを用意する"><a class="header-link" href="#protractor-の設定ファイルを用意する"><span class="header-link-mark"></span></a>Protractor の設定ファイルを用意する</h2>
<p>続いて Protractor の設定ファイルの用意。<code>protractor.conf.js</code> なんて名前でプロジェクト直下にファイルを作って、以下のように書く。</p>
<pre class="language-javascript"><code class="language-javascript">exports<span class="token punctuation">.</span><span class="token property-access">config</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Appium サーバの URL</span>
  seleniumAddress<span class="token operator">:</span> <span class="token string">'http://127.0.0.1:4723/wd/hub'</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Base URL : 未指定で OK</span>
  baseUrl<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Capabilities</span>
  capabilities<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Browser Name : Cordova アプリの場合は空にしておく</span>
    browserName<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// Auto WebView : AngularJS などハイブリッドアプリの場合は true にしておく</span>
    autoWebview<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    
    <span class="token comment">// App : アプリファイルのパスを指定する</span>
    app<span class="token operator">:</span> <span class="token string">'./platforms/ios/build/emulator/【アプリ名】.app'</span><span class="token punctuation">,</span>
    <span class="token comment">// Bundle ID : config.xml に記載のアプリの識別子を指定する</span>
    bundleId<span class="token operator">:</span> <span class="token string">'【アプリの識別子】'</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Device Name : iOS シミュレータで E2E テストをする場合はシミュレータのデバイスを指定する</span>
    deviceName<span class="token operator">:</span> <span class="token string">'iPhone 7'</span><span class="token punctuation">,</span>
    <span class="token comment">// UDID : iOS 実機で E2E テストをする場合に使用する。今回は割愛</span>
    <span class="token comment">// udid: '',</span>
    
    <span class="token comment">// Platform Name : 「iOS」で OK</span>
    platformName<span class="token operator">:</span> <span class="token string">'iOS'</span><span class="token punctuation">,</span>
    <span class="token comment">// Platform Version : XCode でインストールしている SDK のバージョンに合わせておく</span>
    platformVersion<span class="token operator">:</span> <span class="token string">'10.3'</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Full Reset : iOS シミュレータの場合に起動する度にアプリを再インストールするか否かの設定</span>
    fullReset<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// Auto WebView Timeout : タイムアウトの設定</span>
    autoWebviewTimeout<span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span>
    <span class="token comment">// Auto Accept Alerts : 認証系のアラートを自動的に許可する</span>
    autoAcceptAlerts<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token function-variable function">onPrepare</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// Jasmine Spec Reporter の設定 (テスト結果をコンソールにイイカンジに出力する)</span>
    <span class="token keyword">const</span> <span class="token maybe-class-name">SpecReporter</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jasmine-spec-reporter'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">SpecReporter</span></span><span class="token punctuation">;</span>
    jasmine<span class="token punctuation">.</span><span class="token method function property-access">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">addReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpecReporter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      spec<span class="token operator">:</span> <span class="token punctuation">{</span>
        displayStacktrace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        displayPending<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      summary<span class="token operator">:</span> <span class="token punctuation">{</span>
        displayPending<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Implicitly Wait</span>
    browser<span class="token punctuation">.</span><span class="token method function property-access">manage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">timeouts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">implicitlyWait</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// この設定が謎。環境によっては false にしないと Click 等の動作を待たなくなる場合もあったが</span>
    <span class="token comment">// 検証時は true にしておかないとアプリが正しく動作してくれなかった</span>
    browser<span class="token punctuation">.</span><span class="token property-access">ignoreSynchronization</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Wd (Web Driver)・Wd Bridge の設定</span>
    <span class="token keyword">const</span> wd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> protractor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'protractor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> wdBridge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wd-bridge'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>protractor<span class="token punctuation">,</span> wd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wdBridge<span class="token punctuation">.</span><span class="token method function property-access">initFromProtractor</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token property-access">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Cordova アプリ向けに URL の表記を http プロトコルから file プロトコルに直す</span>
    <span class="token keyword">const</span> defer <span class="token operator">=</span> protractor<span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token punctuation">.</span><span class="token method function property-access">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    browser<span class="token punctuation">.</span><span class="token method function property-access">executeScript</span><span class="token punctuation">(</span><span class="token string">'return window.location;'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token dom variable">location</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        browser<span class="token punctuation">.</span><span class="token property-access">resetUrl</span> <span class="token operator">=</span> <span class="token string">'file://'</span>
        browser<span class="token punctuation">.</span><span class="token property-access">baseUrl</span> <span class="token operator">=</span> <span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">origin</span> <span class="token operator">+</span> <span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">;</span>
        defer<span class="token punctuation">.</span><span class="token method function property-access">fulfill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> defer<span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">//  Spec ファイルの指定</span>
  specs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./e2e/**/*.spec.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Jasmine Node の設定</span>
  jasmineNodeOpts<span class="token operator">:</span> <span class="token punctuation">{</span>
    showColors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    defaultTimeoutInterval<span class="token operator">:</span> <span class="token number">500000</span><span class="token punctuation">,</span>
    includeStackTrace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    isVerbose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">print</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>長ったらしいが、この設定に落ち着くのに時間がかかった。</p>
<p>特に <code>browser.ignoreSynchronization</code> の設定が難儀で、アプリによって <code>true</code> じゃないとダメだったり、<code>false</code> じゃないとダメだったりでよく分からない。AngularJS を HTML に埋め込むやり方の違いによるものかなと思慮。</p>
<p>あと Gulp スクリプトから Protractor を起動するためのタスクを作る。</p>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token method function property-access">task</span><span class="token punctuation">(</span><span class="token string">'e2e'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  gulp
    <span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./e2e/**/*.spec.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token property-access">protractor</span><span class="token punctuation">.</span><span class="token method function property-access">protractor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      configFile<span class="token operator">:</span> <span class="token string">'protractor.conf.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>これは単純に Gulp-Protractor から Protractor を実行するだけ。</p>
<h2 id="e2e-テストコードを書いてみる"><a class="header-link" href="#e2e-テストコードを書いてみる"><span class="header-link-mark"></span></a>E2E テストコードを書いてみる</h2>
<p>では実際にこの設定で Protractor と Appium を動かすため、簡単な E2E テストコードを書いてみる。</p>
<p>テスト対象とするのは AngularJS の公式ページのトップにある、「テキストボックスに文字列を入力すると、その文字列が h1 要素に表示される」というモノ。実コードは GitHub で見てみてください。</p>
<p>テストコード <code>e2e/index.spec.js</code> はこんな感じ。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'トップページ'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// トップページを開き直す</span>
    browser<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'名前を入れると表示される'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// テキストボックスに文字を入力する</span>
    <span class="token function">element</span><span class="token punctuation">(</span>by<span class="token punctuation">.</span><span class="token method function property-access">id</span><span class="token punctuation">(</span><span class="token string">'your-name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">sendKeys</span><span class="token punctuation">(</span><span class="token string">'My Name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// h1#message に入力した文字を含めたテキストが出力されているべき</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">element</span><span class="token punctuation">(</span>by<span class="token punctuation">.</span><span class="token method function property-access">id</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'Hello My Name!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 目視で iOS シミュレータの動作を見てみたいのでココでは2秒停止させてみた</span>
    browser<span class="token punctuation">.</span><span class="token method function property-access">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Protractor は Jasmine ベースでテストコードが書ける。細かな書き方は別途 Protractor の使い方を調べてみてほしい。</p>
<h2 id="実際に-e2e-テストを行ってみる"><a class="header-link" href="#実際に-e2e-テストを行ってみる"><span class="header-link-mark"></span></a>実際に E2E テストを行ってみる</h2>
<p>ようやく E2E テストの実施にこぎつけた…。</p>
<p>予め Cordova アプリをビルドしておく。実際にテストする iOS シミュレータでアプリが起動するところまでやっておくと良いだろう。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 何らかのビルドタスクで www ディレクトリに成果物を作り…</span>
$ <span class="token function">npm</span> run build
<span class="token comment"># www ディレクトリのブツを Cordova ビルドして iOS シミュレータにインストールする</span>
$ <span class="token function">npm</span> run cordova emulate --target<span class="token operator">=</span>iPhone-7
</code></pre>
<p>アプリの準備ができたら、まず1つ目のターミナルで、Gulp の <code>appium</code> タスクを実行する。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> run gulp appium
</code></pre>
<p>これで Appium サーバが立ち上がるので、このターミナルはこの状態で放っておく。</p>
<p>次に、2つ目の別のターミナルを開き、コチラで Gulp の <code>e2e</code> タスクを叩いて Protractor を実行する。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> run gulp e2e
</code></pre>
<p><code>e2e</code> タスクを実行すると iOS シミュレータが起動し、iOS 上で操作を再現するための WebDriver アプリが自動的にインストールされる。その後テスト対象の Cordova アプリが開き、E2E テストが開始される。</p>
<p>結果は <code>e2e</code> タスクを実行したコンソールに表示される他、iOS シミュレータとの接続状況は <code>appium</code> タスクを実行したコンソールにも随時表示されている。</p>
<hr>
<p>これにて Protractor + Appium による、AngularJS + Cordova アプリの E2E テストが出来た。</p>
<p>iOS 実機でも E2E テストを実行することは可能だが、ローカルにインストールした appium に対して追加で設定が必要だったりしてそこが難儀なので、別途紹介する。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2017-07-29</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2017-07-29</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
