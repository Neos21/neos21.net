<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Cordova アプリでサクサク動く Google Map を実現する「cordova-plugin-googlemaps」 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2017/07/14-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2017/index.html">2017年</a></li>
            <li><a href="/blog/2017/07/index.html">07月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2017-07-14</time></div>
        <h1 id="page-title">Cordova アプリでサクサク動く Google Map を実現する「cordova-plugin-googlemaps」</h1>

<p>2018-03-22 追記：本記事は v1.4.1 時点の内容を取り扱っている。現時点で v2.2.8 がリリースされており、API にもいくつか違いが出てきているため、情報の取り扱いには注意されたし。</p>
<p><strong>cordova-plugin-googlemaps</strong> というプラグインを使うと、Cordova アプリ上に Google マップを表示でき、柔軟にカスタマイズすることができる。</p>
<p>API キーの取得などでちょっとつまづいたので丁寧に紹介。</p>
<ul>
  <li><a href="https://github.com/mapsplugin/cordova-plugin-googlemaps">GitHub - mapsplugin/cordova-plugin-googlemaps: Google Maps plugin for Cordova</a></li>
</ul>
<p>今回も iOS 向けのサンプルアプリを以下に実装したので、<code>feat/googleMaps</code> ブランチのソースを見てみてもらいたい。実際に動作させる際には、後述の API キーの設定が必要になる。</p>
<ul>
  <li><a href="https://github.com/Neos21/example-cordova/tree/feat/googleMaps">GitHub - Neos21/CordovaExamples at feat/googleMaps</a></li>
</ul>
<h2 id="google-maps-api-キーを取得する"><a class="header-link" href="#google-maps-api-キーを取得する"><span class="header-link-mark"></span></a>Google Maps API キーを取得する</h2>
<p>まずは、iOS アプリから Google Maps にアクセスする許可をもらうため、API キーというものを Google で発行する。</p>
<ul>
  <li><a href="https://developers.google.com/maps/documentation/javascript/get-api-key?hl=ja">Get API Key  |  Maps JavaScript API  |  Google Developers</a></li>
</ul>
<p>上のページの「キーを取得する」ボタンから取得できる。細かな取得方法などは以下のサイトなどを参考のこと。</p>
<ul>
  <li>参考：<a href="https://nendeb.com/276">【2018年7月16日版】Google Maps の APIキー を取得する – ねんでぶろぐ</a></li>
</ul>
<p>API キーを取得する際は、<em>「キーの制限」で「iOS アプリ」を選択</em>し、<strong>「リクエストを受けるアプリのバンドル ID」に <code>config.xml</code> に記載のアプリ識別子を設定する</strong>必要がある。<code>&#x3C;widget id="【ココがアプリ識別子】"</code> 部分と一致させること。</p>
<p>登録できると、以下の URL で登録した API キーの参照・編集ができるはずだ。生成されたランダムな文字列が API キーになるので、これを控えておく。</p>
<ul>
  <li><a href="https://console.developers.google.com/apis/credentials">Google Cloud Platform</a></li>
</ul>
<h2 id="プラグインのインストール"><a class="header-link" href="#プラグインのインストール"><span class="header-link-mark"></span></a>プラグインのインストール</h2>
<p>先に API キーの取得を行ったのには理由があって、プラグインをインストールする際に API キーを合わせて指定する必要があったためだ (後からでも良いのだが、合わせてやるようにしておくと間違いがない)。先程取得した API キーを挿入して、以下のようなコマンドでインストールできる。</p>
<pre class="language-bash"><code class="language-bash">$ cordova plugin <span class="token function">add</span> cordova-plugin-googlemaps --variable <span class="token assign-left variable">API_KEY_FOR_IOS</span><span class="token operator">=</span><span class="token string">"【ココに API キー】"</span>
</code></pre>
<p>こうすると、<code>config.xml</code> に API キー情報が書き込まれる。コレが誤っていたり、API キー側に設定したアプリのバンドル識別子と <code>config.xml</code> の記載が食い違ったりしていると、マップが正しく表示されないので注意。</p>
<p>API キーの取り扱いについては、むやみに <code>config.xml</code> に API キーを書いたままコードを公開したりしないよう注意。と言っても突然課金が始まる、といったことはないが、API のリクエスト制限に達するとしばらく使えなくなったりするので、悪用されないようには注意したい。</p>
<h2 id="サンプルアプリを動作させる場合は"><a class="header-link" href="#サンプルアプリを動作させる場合は"><span class="header-link-mark"></span></a>サンプルアプリを動作させる場合は</h2>
<p>拙作のサンプルアプリを動作させてみたい場合は、API キーにサンプルアプリのアプリ識別子を登録しておき、<code>config.xml</code> の「<code>Your API Key Here</code>」部分に API キーを追記したら、<code>cordova prepare</code> コマンドで <code>config.xml</code> を基にプラグイン・プラットフォーム情報を復元すれば良い。</p>
<ul>
  <li><a href="https://github.com/Neos21/example-cordova/tree/feat/googleMaps">GitHub - Neos21/CordovaExamples at feat/googleMaps</a></li>
</ul>
<h2 id="プラグインのバージョンについて"><a class="header-link" href="#プラグインのバージョンについて"><span class="header-link-mark"></span></a>プラグインのバージョンについて</h2>
<p>現時点で、GoogleMaps プラグインは v1.4.1 がインストールされるはずだ。v2.0 Beta も存在していて、v1 系は2017年中に旧バージョンに落とされるようだが、現時点ではギリギリ v1 系が主流なので、<em>v1.4.1 を使用する</em>ことにする。</p>
<h2 id="マップを表示するには"><a class="header-link" href="#マップを表示するには"><span class="header-link-mark"></span></a>マップを表示するには</h2>
<p>まずはとにかくマップを表示してみようと思う。まずは HTML と CSS で、ページ中にマップを表示する領域を作る。</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token unit">px</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
</code></pre>
<p>CSS は別途 CSS ファイルで定義しても問題ない。要素を特定するために id 属性を振っておく。</p>
<p>そして JavaScript 側で以下のように実装し、ページ読み込み時にマップを初期表示させる。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// マップオブジェクトを控えておく変数</span>
<span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

<span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'deviceready'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 対象の DOM 要素に Google マップを配置する</span>
  <span class="token keyword">var</span> mapElement <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'map'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// マップの初期位置を表示する (座標は日本の中心あたりを適当に)</span>
  map <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token known-class-name class-name">Map</span><span class="token punctuation">.</span><span class="token method function property-access">getMap</span><span class="token punctuation">(</span>mapElement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    camera<span class="token operator">:</span> <span class="token punctuation">{</span>
      latLng<span class="token operator">:</span> <span class="token punctuation">{</span>
        lat<span class="token operator">:</span> <span class="token number">38.2586</span><span class="token punctuation">,</span>
        lng<span class="token operator">:</span> <span class="token number">137.6850</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      zoom<span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// マップが初期表示できる状態になったら何かする場合はこのように設定する</span>
  map<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">.</span><span class="token constant">MAP_READY</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ココに処理…</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>camera</code> オプションの <code>lat</code> と <code>lng</code> で座標を指定する。いつも経度と緯度がごっちゃになるので整理。</p>
<ul>
  <li><code>lat</code> : latitude・緯度 … 南北 → 縦位置 (y 座標)</li>
  <li><code>lng</code> : longitude・経度 … 東西 → 横位置 (x 座標)</li>
</ul>
<p>こんな感じ。</p>
<ul>
  <li>参考：<a href="http://d.hatena.ne.jp/pasela/20130124/lat_lng">緯度、経度、latitude、longitude…どれがなんだっけ？ - ぱせらんメモ</a></li>
</ul>
<p>コレでページを初期表示した時に日本列島を表示できているはずだ。タップやスライド、ピンチ操作などができると思う。</p>
<ul>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps-doc/blob/master/v1.4.0/class/Map/getMap/README.md">cordova-plugin-googlemaps-doc/README.md at master · mapsplugin/cordova-plugin-googlemaps-doc · GitHub</a></li>
</ul>
<h2 id="マップが表示される仕組み"><a class="header-link" href="#マップが表示される仕組み"><span class="header-link-mark"></span></a>マップが表示される仕組み</h2>
<p>このマップオブジェクトは、実際は<em>ブラウザがレンダリングしているものではなく、ネイティブで動作させているものを HTML 上に透過表示させている</em>に過ぎないのだ。動作がサクサクしているのはネイティブで動作しているから。</p>
<p>そのため、マップを表示している領域上に、HTML で独自のメニューを置いたりもできる。<code>div#map</code> 要素内に Form 部品を配置し、スタイリングしてやれば良い。</p>
<ul>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps-doc/blob/master/v1.4.0/class/Map/README.md#how-does-the-plugin-work">cordova-plugin-googlemaps-doc/README.md at master · mapsplugin/cordova-plugin-googlemaps-doc · GitHub</a></li>
</ul>
<h2 id="指定座標にアニメーション移動してマーカーを打ってみる"><a class="header-link" href="#指定座標にアニメーション移動してマーカーを打ってみる"><span class="header-link-mark"></span></a>指定座標にアニメーション移動してマーカーを打ってみる</h2>
<p>では、先程のマップの初期表示が終わったところで、指定の座標値にアニメーションしながら移動し、マーカーを打ってみたいと思う。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 変数「map」は、先程紹介した初期表示処理 getMap() ができているテイ</span>
<span class="token keyword">var</span> map<span class="token punctuation">;</span>
<span class="token comment">// マップ上に打ったマーカーを控えておくための変数</span>
<span class="token keyword">var</span> markerCache<span class="token punctuation">;</span>

<span class="token comment">// マップが初期表示できる状態になったら処理を開始する</span>
map<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">.</span><span class="token constant">MAP_READY</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 指定座標に向けてアニメーション移動する</span>
  map<span class="token punctuation">.</span><span class="token method function property-access">animateCamera</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>
      lat<span class="token operator">:</span> <span class="token number">35.658581</span><span class="token punctuation">,</span>
      lng<span class="token operator">:</span> <span class="token number">139.745433</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    zoom<span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
    tilt<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
    bearing<span class="token operator">:</span> <span class="token number">140</span><span class="token punctuation">,</span>
    duration<span class="token operator">:</span> <span class="token number">5000</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// アニメーション後のコールバック関数</span>
    
    <span class="token comment">// ズームが終わったらマーカーを付ける</span>
    map<span class="token punctuation">.</span><span class="token method function property-access">addMarker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// アニメーション移動で指定した座標と同じ座標</span>
      position<span class="token operator">:</span> <span class="token punctuation">{</span>
        lat<span class="token operator">:</span> <span class="token number">35.658581</span><span class="token punctuation">,</span>
        lng<span class="token operator">:</span> <span class="token number">139.745433</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// マーカーをクリックした時に表示するインフォメーション</span>
      title<span class="token operator">:</span> <span class="token string">'Welecome to\nCordova GoogleMaps plugin'</span><span class="token punctuation">,</span>
      snippet<span class="token operator">:</span> <span class="token string">'This plugin is awesome!'</span><span class="token punctuation">,</span>
      animation<span class="token operator">:</span> plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Animation</span></span><span class="token punctuation">.</span><span class="token constant">BOUNCE</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// マーカーを付けた後のコールバック関数</span>
      
      <span class="token comment">// 後でマーカーを削除するため、マーカーオブジェクトを退避する</span>
      markerCache <span class="token operator">=</span> marker<span class="token punctuation">;</span>
      <span class="token comment">// インフォウィンドウを表示する</span>
      marker<span class="token punctuation">.</span><span class="token method function property-access">showInfoWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// マーカーのインフォメーションウィンドウがクリックされた時のイベントを設定する</span>
      marker<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">.</span><span class="token constant">INFO_CLICK</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>コレで、マップが初期表示された後に、東京タワーめがけてカメラがズームしていって、マーカーが地図上に打たれるようになった。少々コードが長くなった上にコールバック関数が多く、この調子だと「コールバック地獄」が目に見えているのが分かるかと思う。実際は適宜関数を外出しして管理してほしい。</p>
<p>マーカーをクリックするとインフォメーションのフキダシウィンドウが出るのだが、ココに改行 <code>¥n</code> を含められるのがこのプラグインの強みらしい。今回は指定の座標地点にマーカーを置いたが、他にもマップを円で囲んだり、任意の図形を描いたりと色々なことができる。</p>
<p>一度打ったマーカーは、<code>marker.remove()</code> を呼ぶことで削除できるのだが、全く別の処理でマーカーを消す場合は、コールバック関数で受け取った <code>marker</code> を一旦別の場所に保持しておく必要がある。というワケでグローバル付近に <code>markerCache</code> という変数を作っておいた次第。マーカーを含めた全てのオブジェクトをまっさらに削除するのであれば、<code>map.clear()</code> というメソッドがある。</p>
<ul>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps-doc/blob/master/v1.4.0/class/Marker/README.md">cordova-plugin-googlemaps-doc/README.md at master · mapsplugin/cordova-plugin-googlemaps-doc · GitHub</a></li>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps-doc/blob/master/v1.4.0/class/Map/clear/README.md">cordova-plugin-googlemaps-doc/README.md at master · mapsplugin/cordova-plugin-googlemaps-doc · GitHub</a></li>
</ul>
<h2 id="任意の住所文字列を基に地図検索-ジオコーディング-をする"><a class="header-link" href="#任意の住所文字列を基に地図検索-ジオコーディング-をする"><span class="header-link-mark"></span></a>任意の住所文字列を基に地図検索 (ジオコーディング) をする</h2>
<p>ユーザが入力した住所や地名などを基に地図検索することをジオコーディングというそうなのだが、これをやってみようと思う。</p>
<p>まずはユーザに向けて検索窓を提供する。</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&#x3C;!-- マップを表示する領域 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>

<span class="token comment">&#x3C;!-- 検索窓 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>例 : 東京スカイツリー<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>住所検索<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
</code></pre>
<p>次に、「住所検索」ボタンが押された時に、<code>#address</code> の値を拾ってジオコーディングを行う処理を書く。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 「住所検索」ボタンが押された時の処理</span>
<span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ユーザ入力値を取得する (確実に文字列化するため空文字を結合)</span>
  <span class="token keyword">var</span> addressValue <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'address'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token comment">// 入力チェック</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>addressValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'検索文字列を入力してください'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    
  <span class="token comment">// ジオコーディングを行う</span>
  plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Geocoder</span></span><span class="token punctuation">.</span><span class="token method function property-access">geocode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      address<span class="token operator">:</span> addressValue
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ジオコーディング語のコールバック関数</span>
    
    <span class="token comment">// 検索結果がない場合は終了</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>results<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'指定の情報が見つかりませんでした'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 検索結果1件目の位置に移動する</span>
    <span class="token keyword">var</span> resultPosition <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">;</span>
    <span class="token comment">// 検索した位置にアニメーション移動する</span>
    map<span class="token punctuation">.</span><span class="token method function property-access">animateCamera</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      target<span class="token operator">:</span> resultPosition<span class="token punctuation">,</span>
      zoom<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
      duration<span class="token operator">:</span> <span class="token number">2000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// アニメーション移動後のコールバック関数</span>
      <span class="token comment">// マーカーを打つ</span>
      map<span class="token punctuation">.</span><span class="token method function property-access">addMarker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        position<span class="token operator">:</span> resultPosition<span class="token punctuation">,</span>
        title<span class="token operator">:</span> addressValue
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// マーカーを打った後のコールバック関数</span>
        <span class="token comment">// マーカーオブジェクトを退避する</span>
        markerCache <span class="token operator">=</span> marker<span class="token punctuation">;</span>
        <span class="token comment">// インフォウィンドウを表示する</span>
        marker<span class="token punctuation">.</span><span class="token method function property-access">showInfoWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>見事なコールバック地獄になっているので、実際は適宜処理を分割したい。</p>
<p>ひとまず、ジオコーディングを行う最小構成は</p>
<pre class="language-javascript"><code class="language-javascript">plugin<span class="token punctuation">.</span><span class="token property-access">google</span><span class="token punctuation">.</span><span class="token property-access">maps</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Geocoder</span></span><span class="token punctuation">.</span><span class="token method function property-access">geocode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  address<span class="token operator">:</span> <span class="token string">'検索する住所情報'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 検索結果1件目の位置を取得する</span>
  <span class="token keyword">var</span> resultPosition <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>この形になる。</p>
<p>あとはココから、検索した住所に対して移動するだとか、マーカーを打つだとかすれば良い。</p>
<h2 id="ステータスバープラグインとの相性について"><a class="header-link" href="#ステータスバープラグインとの相性について"><span class="header-link-mark"></span></a>ステータスバープラグインとの相性について</h2>
<p>この GoogleMaps プラグインだが、cordova-plugin-statusbar プラグインとの相性が悪い。cordova-plugin-statusbar プラグインによってステータスバーを表示するよう設定していると、その高さ分だけ Google マップが表示領域の上側にズレて表示されてしまう。</p>
<p>GitHub にも Issue は上がっており、解消方法はいくつかあるのだが、手っ取り早いのは <strong><code>div#map</code> に <code>padding-top:20px;</code> を付与する</strong>という方法。マップの表示領域の上側に、ステータスバーの高さ 20px 分の余白を予め開けておくというワケだ。</p>
<ul>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps/issues/242">Layout issue with status bar · Issue #242 · mapsplugin/cordova-plugin-googlemaps · GitHub</a></li>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps/issues/657">iOS Status Bar and this plugin causing web view to shift down 20px · Issue #657 · mapsplugin/cordova-plugin-googlemaps · GitHub</a></li>
</ul>
<hr>
<p>他にも色々な API が用意されていてココでは紹介しきれないので、公式の README や、紹介記事を見てみてほしい。</p>
<ul>
  <li>参考：<a href="https://github.com/mapsplugin/cordova-plugin-googlemaps-doc/blob/master/v1.4.0/README.md">cordova-plugin-googlemaps-doc/README.md at master · mapsplugin/cordova-plugin-googlemaps-doc · GitHub</a></li>
  <li>参考：<a href="http://qiita.com/wf9a5m75/items/c5ecb1b7c55751b2da64">Android,iOS, PWAに対応したGoogleMapを操作できるプラグイン - Qiita</a></li>
</ul>
<p>手軽に快適な動作の Google マップを実現できるのでオススメ。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2017-07-14</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2017-07-14</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
