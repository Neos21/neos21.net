<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>cordova-background-geolocation-lt でアプリがバックグラウンドになっても位置情報を送信する - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2017/10/27-02.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" title="Feeds" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <script src="/scripts.js"></script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-theme"><a href="#" title="Toggle Theme"><span>Toggle Theme</span></a></li>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2017/index.html">2017年</a></li>
            <li><a href="/blog/2017/10/index.html">10月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2017-10-27</time></div>
        <h1 id="page-title">cordova-background-geolocation-lt でアプリがバックグラウンドになっても位置情報を送信する</h1>

<p><strong>cordova-background-geolocation-lt</strong> という Cordova プラグインは、位置情報を取得し、任意のサーバに情報を送信できるプラグインだ。このプラグインの特徴はなんといっても、<em>アプリがバックグラウンド動作に切り替わっても位置情報の取得・送信を続ける</em>ところであろう。名前のとおり、Background でも Geolocation による LT : Location Tracking を行う、ということだ。</p>
<ul>
  <li><a href="https://github.com/transistorsoft/cordova-background-geolocation-lt">GitHub - transistorsoft/cordova-background-geolocation-lt: The most sophisticated background location-tracking &#x26; geofencing module with battery-conscious motion-detection intelligence for iOS and Android.</a></li>
</ul>
<p>今回はこのプラグインの使い方を説明する。想定する環境は iOS のみだが、Android の方が iOS より柔軟に設定ができるようだ。</p>
<h2 id="プラグインのインストール"><a class="header-link" href="#プラグインのインストール"><span class="header-link-mark"></span></a>プラグインのインストール</h2>
<p>cordova-background-geolocation-lt のインストールは以下のようにする。</p>
<pre class="language-bash"><code class="language-bash">$ cordova plugin <span class="token function">add</span> cordova-background-geolocation-lt
</code></pre>
<h2 id="初期設定と起動"><a class="header-link" href="#初期設定と起動"><span class="header-link-mark"></span></a>初期設定と起動</h2>
<p>プラグインをインストールすると、<code>window.BackgroundGeolocation</code> というグローバル変数でプラグインの API が使えるようになる。</p>
<p>予め <code>on()</code> でイベントハンドラを設定し、そのうえで <code>configure()</code> メソッドを使って設定適用と位置情報の取得を開始させることができる。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 位置情報を取得した際に発火するイベント</span>
<span class="token comment">// 位置情報を取得する周期は configure() にて設定する・位置情報の取得時に HTTP 送信も行われる</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'location'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token dom variable">location</span><span class="token punctuation">,</span> taskId</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token dom variable">location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// タスクを終了させる</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">finish</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">errorCode</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Location Service が無効な場合などに発火する</span>
  <span class="token keyword">const</span> locationError <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">0</span><span class="token operator">:</span> <span class="token string">'Location Unknown (位置不明)'</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'Location Permission Denied (位置情報の取得許可なし)'</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token operator">:</span> <span class="token string">'Network Error (ネットワークエラー)'</span><span class="token punctuation">,</span>
    <span class="token number">408</span><span class="token operator">:</span> <span class="token string">'Location Timeout (位置情報取得処理がタイムアウト)'</span>
  <span class="token punctuation">}</span><span class="token punctuation">[</span>errorCode<span class="token punctuation">]</span> <span class="token operator">||</span> errorCode<span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>locationError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 位置情報を HTTP 送信し、レスポンスを受け取った際に発火する</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">responseText</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// デバイスの位置が停止している場合に heartbeatInterval の設定値に従って発火する</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'heartbeat'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">params<span class="token operator">/</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// heartbeat イベント自体は位置情報を取得しないため HTTP 通信も発生しない</span>
  <span class="token comment">// ハートビートにより位置情報を再送信したい場合は、getCurrentPosition() を実行する</span>
  <span class="token comment">// getCurrentPosition() で位置情報を取得すると location イベントが発火し、HTTP 通信も発生して http イベントが発火する</span>
  <span class="token comment">// params.location.isMoving を見て、直近の位置情報が動いていなければハートビートとして位置情報の取得・送信を行う、などしても良い</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">getCurrentPosition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token dom variable">location</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token dom variable">location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">errorCode</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// デバイスが止まったり動き出したりしたとき</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'motionchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">isMoving<span class="token punctuation">,</span> <span class="token dom variable">location</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>isMoving <span class="token operator">?</span> <span class="token string">'移動中'</span> <span class="token operator">:</span> <span class="token string">'停止中'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 動作の種類が変化したとき</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'activitychange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// アクティビティの種類を和訳する</span>
  <span class="token keyword">const</span> activity <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'still'</span><span class="token operator">:</span> <span class="token string">'停止中'</span><span class="token punctuation">,</span>
    <span class="token string">'on_foot'</span><span class="token operator">:</span> <span class="token string">'徒歩移動'</span><span class="token punctuation">,</span>
    <span class="token string">'in_vehicle'</span><span class="token operator">:</span> <span class="token string">'車移動'</span><span class="token punctuation">,</span>
    <span class="token string">'on_bicycle'</span><span class="token operator">:</span> <span class="token string">'自転車移動'</span><span class="token punctuation">,</span>
    <span class="token string">'running'</span><span class="token operator">:</span> <span class="token string">'ランニング'</span>
  <span class="token punctuation">}</span><span class="token punctuation">[</span>event<span class="token punctuation">.</span><span class="token property-access">activity</span><span class="token punctuation">]</span> <span class="token operator">||</span> event<span class="token punctuation">.</span><span class="token property-access">activity</span><span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>activity <span class="token operator">+</span> <span class="token string">' : '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token property-access">confidence</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 設定オブジェクトを指定して位置情報取得処理を開始する</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 位置情報の正確さ : 0, 10, 100, 1000 の4つ・0 が正確だが電池を使う・1000 は正確さに劣るが省エネ</span>
  desiredAccuracy<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">// 移動イベントを発火させるために待機する最低移動距離 (メートル)</span>
  <span class="token comment">// Android だとこれを 0 にした上で locationUpdateInterval を指定することで、指定秒数ごとに Location を取得できるが、iOS ではできない</span>
  distanceFilter<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token comment">// [iOS Only] 停止状態から動き始めたと検知するまでの最低移動距離</span>
  stationaryRadius<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
  <span class="token comment">// 動作の種類の変化を検知するインターバル。0 にすると可能な限り早く行動検知を行う。デフォルトは 10000 (10秒)</span>
  activityRecognitionInterval<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  <span class="token comment">// 停止状態になってから位置情報サービスを停止するまでの間隔 (分)</span>
  stopTimeout<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>

  <span class="token comment">// HTTP 送信する対象の URL</span>
  url<span class="token operator">:</span> <span class="token string">'http://my-location-server.example.com/'</span><span class="token punctuation">,</span>
  <span class="token comment">// 任意のパラメータを渡したい場合は指定する</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'some-token'</span><span class="token operator">:</span> <span class="token string">'任意のトークンを付けるとか'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 任意の HTTP ヘッダを付与したい場合は指定する</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'X-HOGE-FUGA'</span><span class="token operator">:</span> <span class="token string">'foo-bar'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// HTTP 通信時のメソッド指定。通常は 'POST' 送信で良いが、対象のサーバにあわせて 'PUT' を選択することも可能</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  <span class="token comment">// 位置情報を取得した順に送信するようプラグインに自動調整させる</span>
  autoSync<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  
  <span class="token comment">// 本プラグインがローカルの SQLite DB に位置情報を残しておく日数</span>
  maxDaysToPersist<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token comment">// ローカルの SQLite DB に保存しておく位置情報の件数。-1 で無制限、0 で保存させない</span>
  maxRecordsToPersist<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
  <span class="token comment">// アプリを閉じてもトラッキングを続ける</span>
  stopOnTerminate<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">// デバイスの再起動後にトラッキングできるようにする</span>
  startOnBoot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// heartbeat イベントを発火させるまでの秒数</span>
  heartbeatInterval<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token comment">// [iOS Only] heartbeatInterval を指定する際は true にし、停止時のサスペンドを禁止する</span>
  preventSuspend<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// true にするとバックグラウンド動作時に通知を表示する</span>
  debug<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'初期設定完了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 通常はこの時点で位置情報の取得も開始される</span>
  <span class="token comment">// もし位置情報の取得状況が停止状態の場合は開始させる</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token property-access">enabled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'位置情報取得開始'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'初期設定・起動失敗'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>特に気になるのは <code>location</code> イベントと <code>http</code> イベントだと思うが、これらは「位置情報を取得した後」「位置情報を送信し、レスポンスを受け取った後」に発火するだけなので、基本的にはログ出力ぐらいしかやることがない。</p>
<p><code>heartbeat</code> はハートビートを検知した場合のイベントだが、このイベント自体は位置情報の取得・送信を行わないので、必要であれば <code>getCurrentPosition()</code> を叩いて位置情報を再取得する。<code>motionchange</code> や <code>activitychange</code> も状態の変化を知るのみで、このイベント自体が発火しても位置情報の取得などは行われていないので注意。</p>
<p>その他、GPS や Wi-Fi などの設定が変わった時は <code>providerchange</code> イベント、ジオフェンスのイベント検知は <code>geofence</code> および <code>geofenceschange</code>、スケジュールに沿ったイベントの発火は <code>schedule</code> で検知できたりする。</p>
<p><code>on()</code> で設定をしたら、<code>configure()</code> で設定の適用と位置情報の取得を開始する。設定項目が大量にあり、iOS 専用・Android 専用なオプションもあったりするので、公式の API ドキュメントを参照されたし。</p>
<ul>
  <li>参考 : <a href="https://github.com/transistorsoft/cordova-background-geolocation-lt/blob/master/docs/README.md">cordova-background-geolocation-lt/README.md at master · transistorsoft/cordova-background-geolocation-lt · GitHub</a></li>
</ul>
<p><code>configure()</code> のコールバック関数の中で、状態 <code>state</code> を確認できる。もしも位置情報の取得が始まっていないようであれば <code>start()</code> を叩くようにする。</p>
<p>この処理を <code>deviceready</code> イベントの中で発火させれば、アプリ起動時から位置情報の取得・送信を開始できるし、任意のボタンを押した時のイベントに追加しても良い。</p>
<p>これで位置情報を取得し始めることができた。バックグラウンドでも位置情報を取得してくれる。</p>
<h2 id="ios-シミュレータでの位置情報設定"><a class="header-link" href="#ios-シミュレータでの位置情報設定"><span class="header-link-mark"></span></a>iOS シミュレータでの位置情報設定</h2>
<p>iOS 実機の場合は実際に動作検証がしやすいが、iOS シミュレータの場合も、位置情報サービスをシミュレートすることができるので、このプラグインの動作確認ができる。</p>
<p>iOS シミュレータを起動したら、メニューより Debug → Location と進む。項目の内容は以下のとおり。</p>
<table>
  <thead>
    <tr>
      <th>項目名</th>
      <th>内容</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>None</td>
      <td>位置指定なし</td>
    </tr>
    <tr>
      <td>Custom Location</td>
      <td>任意の座標を指定する</td>
    </tr>
    <tr>
      <td>Apple</td>
      <td>アップルの本社に立ち止まる</td>
    </tr>
    <tr>
      <td>City Bicycle Ride</td>
      <td>自転車移動を再現したスピードで移動する</td>
    </tr>
    <tr>
      <td>City Run</td>
      <td>ジョギングを再現したスピードで移動する</td>
    </tr>
    <tr>
      <td>Freeway Drive</td>
      <td>車移動を再現したスピードで移動する</td>
    </tr>
  </tbody>
</table>
<p>試しに <code>Freeway Drive</code> でも選ぶと、<code>location</code>・<code>http</code> イベントによるログが頻繁に出力されることが Safari インスペクタなどから確認できるであろう。また、<code>Apple</code> など停止状態のものを選ぶと、<code>heartbeat</code> が効いているかも確認できる。</p>
<h2 id="位置情報の取得処理を停止する"><a class="header-link" href="#位置情報の取得処理を停止する"><span class="header-link-mark"></span></a>位置情報の取得処理を停止する</h2>
<p>このままだとアプリをアプリスイッチャーから完全に終了させるまで位置情報の取得を続けてしまうので、停止ボタンを作ろう。停止するための処理は以下のとおり。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 現在のプラグインの動作状況を確認する</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">getState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 既に停止していれば何もしない</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token property-access">enabled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 動作中であれば、位置情報の取得を停止する</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">stop</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// on() で設定したイベント類を全て削除する</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BackgroundGeolocation</span></span><span class="token punctuation">.</span><span class="token method function property-access">removeListeners</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'停止完了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>コールバック関数の入れ子が3つになるので、適宜 Promise 化したヘルパーメソッドを作っても良いだろう。</p>
<p>メインは <code>stop()</code> さえ呼べれば良いワケだが、<code>removeListeners()</code> により、<code>on()</code> で登録していた各種イベントを削除しておいたので、また上述の開始処理をまるごと呼び出してもイベントが重複しないようになっている。</p>
<h2 id="サーバ側に送られる情報は"><a class="header-link" href="#サーバ側に送られる情報は"><span class="header-link-mark"></span></a>サーバ側に送られる情報は？</h2>
<p>一方、位置情報を受け取るサーバ側は、どのように情報が受け取れるだろうか。プラグインが POST 送信する内容は、以下のような内容になっている。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"coords"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"speed"</span><span class="token operator">:</span> <span class="token number">7.5</span><span class="token punctuation">,</span>
      <span class="token property">"longitude"</span><span class="token operator">:</span> <span class="token number">-120.327218</span><span class="token punctuation">,</span>
      <span class="token property">"latitude"</span><span class="token operator">:</span> <span class="token number">35.33500926</span><span class="token punctuation">,</span>
      <span class="token property">"accuracy"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">"altitude_accuracy"</span><span class="token operator">:</span> <span class="token number">-1</span><span class="token punctuation">,</span>
      <span class="token property">"altitude"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"heading"</span><span class="token operator">:</span> <span class="token number">245.02</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"extras"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"is_moving"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"event"</span><span class="token operator">:</span> <span class="token string">"motionchange"</span><span class="token punctuation">,</span>
    <span class="token property">"odometer"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"59881E61-4CB8-4028-A557-151089948542"</span><span class="token punctuation">,</span>
    <span class="token property">"activity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span>
      <span class="token property">"confidence"</span><span class="token operator">:</span> <span class="token number">100</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"battery"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">-1</span><span class="token punctuation">,</span>
      <span class="token property">"is_charging"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2017-01-01T01:02:03.456Z"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"some-token"</span><span class="token operator">:</span> <span class="token string">"任意のトークンを付けるとか"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre>
<p>iOS シミュレータによる位置偽装を使い、JSON-Server で受信したデータがこんな感じ。<code>some-token</code> は <code>configure()</code> 内で <code>params</code> を指定した時の内容なので、何も設定していなければ何も付かない。それ以外はプラグインが付与する内容。</p>
<p><code>location</code> と <code>coords</code> の内容を見ると、以前紹介した Geolocation API の形式に則っていることが分かる。ココだけ抽出すれば、緯度・経度や移動速度が分かるであろう。その他、<code>is_moving</code> や <code>event</code> などが <code>coords</code> の外に付与されているし、<code>uuid</code> や <code>battery</code> など端末情報も確認できる。</p>
<hr>
<p>プラグインを入れるだけで位置情報を継続的に取得できるのでオススメ。</p>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2017-10-27</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2017-10-27</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
