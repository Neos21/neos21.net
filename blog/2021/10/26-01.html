<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>ホスティング先を XREA から GitHub Pages に変えた詳細 - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2021/10/26-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2021/index.html">2021年</a></li>
            <li><a href="/blog/2021/10/index.html">10月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2021-10-26</time></div>
        <h1 id="page-title">ホスティング先を XREA から GitHub Pages に変えた詳細</h1>

<p>XREA Plus が2,514円/年もかかるのは高いなぁと思い、ホスティング先を XREA サーバから GitHub Pages に変えた。</p>
<ul>
  <li>過去記事：<a href="./23-01.html">Value Domain・XREA Plus を更新した</a></li>
  <li>過去記事：<a href="./25-01.html">ホスティング先を XREA から GitHub Pages に変えた</a></li>
</ul>
<p>今回はその技術的な詳細について書いておく。</p>
<h2 id="目次"><a class="header-link" href="#目次"><span class="header-link-mark"></span></a>目次</h2>
<ul>
  <li><a href="#%E7%A7%BB%E8%A1%8C%E6%96%B9%E9%87%9D">移行方針</a></li>
  <li><a href="#github-pages-%E3%81%AB%E7%8B%AC%E8%87%AA%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%92%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B">GitHub Pages に独自ドメインを割り当てる</a></li>
  <li><a href="#xrea-%E3%82%B5%E3%83%BC%E3%83%90%E5%81%B4%E3%81%AE%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E7%B4%90%E4%BB%98%E3%81%91%E3%82%92%E8%A7%A3%E9%99%A4%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F">XREA サーバ側のドメイン紐付けを解除しておく</a></li>
  <li><a href="#xrea-%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E3%81%AF-freenom-%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%A0%E3%81%91%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%A6%E3%81%8A%E3%81%8F">XREA サーバには Freenom ドメインだけ割り当てておく</a></li>
  <li><a href="#github-pages-%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">GitHub Pages へのデプロイパイプラインを調整する</a>
    <ul>
      <li><a href="#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E7%92%B0%E5%A2%83%E3%81%A7%E3%81%AF%E4%BA%8C%E9%87%8D-git-clone%E3%81%A7%E5%AF%BE%E5%BF%9C">ローカル環境では「二重 <code>git clone</code>」で対応</a></li>
      <li><a href="#github-actions-%E3%81%A7%E5%B7%AE%E5%88%86%E3%83%93%E3%83%AB%E3%83%89%E3%81%97-gh-pages-%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%AB%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">GitHub Actions で差分ビルドし <code>gh-pages</code> ブランチにコミットする方法</a></li>
    </ul>
  </li>
  <li><a href="#%E8%82%A5%E5%A4%A7%E5%8C%96%E3%81%97%E3%81%9F-git-%E5%B1%A5%E6%AD%B4%E3%82%92%E5%85%A8%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F">肥大化した Git 履歴を全削除した</a></li>
  <li><a href="#%E4%BB%A5%E4%B8%8A">以上</a></li>
</ul>
<h2 id="移行方針"><a class="header-link" href="#移行方針"><span class="header-link-mark"></span></a>移行方針</h2>
<p>このサイトは現状、静的なコンテンツしかないので、GitHub Pages に移行することで特に問題はなかった。XREA Plus は広告も除去されていて、元々広告がない GitHub Pages 向けに調整する必要はなかった。</p>
<p><code>neos21.net</code> というドメインを取得しているので、DNS で向き先だけ変えれば、既存の URL 等には影響がないようにしたく、移行作業をしていった。</p>
<h2 id="github-pages-に独自ドメインを割り当てる"><a class="header-link" href="#github-pages-に独自ドメインを割り当てる"><span class="header-link-mark"></span></a>GitHub Pages に独自ドメインを割り当てる</h2>
<p><a href="https://github.com/Neos21/neos21.net">GitHub リポジトリ自体は以前から変わらず同じ。</a>ただし今回の移行作業の中で、リポジトリの要領削減のため<em>過去のコミットを全て削除した。</em>その話は後述。</p>
<p>まずはローカルで全量ビルドし、<code>gh-pages</code> ブランチに全資材を Push した。その際、<code>neos21.net</code> というドメイン名だけを書いた <em><code>CNAME</code> という1行のファイル</em>をルート直下にコミットしている。</p>
<p>次に GitHub リポジトリの「Settings」→「Pages」画面に移動し、</p>
<ul>
  <li>「Source」が <code>gh-pages</code> ブランチの <code>/ (root)</code> を指していること</li>
  <li>「Custom Domain」に <code>neos21.net</code> が指定されていること
    <ul>
      <li>(CNAME ファイルを検知していること)</li>
    </ul>
  </li>
</ul>
<p>を確認する。</p>
<p>そしたら、<em>DNS 設定を変更</em>していく。以下の GitHub 公式ドキュメントを参考に設定する。</p>
<ul>
  <li><a href="https://docs.github.com/ja/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site">GitHub Pages サイトのカスタムドメインを管理する - GitHub Docs</a></li>
</ul>
<p><code>neos21.net</code> ドメインは Value Domain で管理しているので、Value Domain の DNS 設定に移る。</p>
<ul>
  <li>NS レコードはとりあえずそのままで、</li>
  <li>Apex ドメイン (<code>@</code>) に対して GitHub Pages 用の IP を指定した A レコード4つ、</li>
  <li><code>www</code> に対して <code>neos21.github.io</code> という自分の GitHub Pages のユーザサイト URL を指定した CNAME レコードを1つ</li>
</ul>
<p>指定する。</p>
<p>
  <img src="./26-01-01.png" alt="Value Domain 設定画面">
</p>
<p>設定後、1・2時間待って <code>dig</code> コマンドで確認した時に、以下のようなレコードが取得できていれば OK。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># ネイキッドドメインに対する NS レコードはそのままにしておく</span>
$ <span class="token function">dig</span> neos21.net +nostats +nocomments +nocmd -t NS
<span class="token punctuation">;</span>neos21.net.                    IN      NS
neos21.net.             <span class="token number">0</span>       IN      NS      01.dnsv.jp.
neos21.net.             <span class="token number">0</span>       IN      NS      02.dnsv.jp.
neos21.net.             <span class="token number">0</span>       IN      NS      03.dnsv.jp.
neos21.net.             <span class="token number">0</span>       IN      NS      04.dnsv.jp.

<span class="token comment"># ネイキッドドメインには A レコード4つ</span>
$ <span class="token function">dig</span> neos21.net +nostats +nocomments +nocmd
<span class="token punctuation">;</span>neos21.net.                    IN      A
neos21.net.             <span class="token number">0</span>       IN      A       <span class="token number">185.199</span>.108.153
neos21.net.             <span class="token number">0</span>       IN      A       <span class="token number">185.199</span>.109.153
neos21.net.             <span class="token number">0</span>       IN      A       <span class="token number">185.199</span>.110.153
neos21.net.             <span class="token number">0</span>       IN      A       <span class="token number">185.199</span>.111.153

<span class="token comment"># www ドメインには CNAME のみ</span>
$ <span class="token function">dig</span> www.neos21.net +nostats +nocomments +nocmd
<span class="token punctuation">;</span>www.neos21.net.                        IN      A
www.neos21.net.         <span class="token number">0</span>       IN      CNAME   neos21.github.io.
</code></pre>
<p>ちなみに、Freenom で取得している無料ドメインを使って、Freenom DNS でも試してみたのだが、Freenom でも同様に、A レコード4つ、CNAME レコード1つを作れば1・2時間でしっかり反映された。</p>
<p>Freenom DNS も Value Domain も、若干 <code>www</code> ドメインに対する CNAME の反映がちょっと遅れた。ネイキッドドメインでは上手くアクセスできるのに、<code>www</code> サブドメインが付いているとまだ反映されていない、みたいな状態が長めに続いた。</p>
<p>DNS の反映が終わったら、再び GitHub リポジトリの「Settings」→「Pages」画面に戻る。</p>
<blockquote>
  <p>Your site is published at <a href="https://neos21.net/">https://neos21.net/</a></p>
</blockquote>
<p>と無事表示されたら、下部にある<strong>「Enforce HTTPS」チェックボックス</strong>が押下できるようになっていると思う (なっていなかったら F5 更新などして試してみてほしい)。コレにチェックを入れることで、HTTPS 化してくれる。コレも反映には若干時間がかかるので、10分程度は気長に待とう。</p>
<p>コレでドメイン設定は完了。すげー簡単だった…！</p>
<p>GitHub Pages への CNAME ファイル設置・DNS 設定変更と反映待ち・Enforce HTTPS までが完了したら、アクセス URL は次のようになるはずだ。</p>
<ul>
  <li><code>https://neos21.net/</code> へのアクセス → そのままブラウザのアドレスバーに表示される</li>
  <li><code>https://neos21.github.io/neos21.net/</code> (ホスティングしている GitHub Pages の本来の URL) → HTTP 301 で <code>https://neos21.net/</code> にリダイレクトされる</li>
  <li><code>https://www.neos21.net/</code> (<code>www</code> 付き) → HTTP 301 で <code>https://neos21.net/</code> にリダイレクトされる</li>
</ul>
<p><code>$ dig</code> コマンドの他、<code>$ curl -I</code> でヘッダ情報を確認してみたり、<code>$ nslookup</code> でも疎通確認してみたりすると良いだろう。TTL の関係で、反映には1時間はかかると思って良いだろう。どうも外部の dig サービスだと反映されているのに、ローカルからコマンド実行するとまだ反映されていない、みたいな状態は結構長めに続いた印象。</p>
<ul>
  <li>参考：<a href="https://stackoverflow.com/questions/44081863/how-can-i-use-dot-tk-domain-with-github-pages">http - How can I use dot.tk domain with GitHub Pages? - Stack Overflow</a></li>
  <li>参考：<a href="https://cartman0.hatenablog.com/entry/2019/03/05/">freenomで無料ドメインを取得してみる - はしくれエンジニアもどきのメモ</a></li>
  <li>参考：<a href="https://qiita.com/lamplus/items/9451bc2f1f4612f9e647">freenomで無料ドメインを取得してGitHub Pagesに独自ドメインを設定してみた - Qiita</a></li>
  <li>参考：<a href="https://qiita.com/dropcontrol/items/e955f9aabe3c0926d081">Github PagesにValue Domainを使って独自ドメインを割りあてる - Qiita</a></li>
  <li>参考：<a href="https://stackoverflow.com/questions/59596179/github-pages-redirect-non-www-root-domain-to-www-subdomain">jekyll - Github pages redirect non www (root domain) to www subdomain - Stack Overflow</a></li>
  <li>参考：<a href="https://dev.to/aurangzaibdanial/custom-domain-for-github-pages-18a2">Custom domain for GitHub pages - DEV Community</a></li>
  <li>参考：<a href="https://blog.beachside.dev/entry/2020/02/27/183000">GitHub Pages に カスタムドメイン を 設定 ( Google Domains, VuePress ) - BEACHSIDE BLOG</a></li>
  <li>参考：<a href="https://zenn.dev/donchan922/articles/59c54fe659128294bb65">GitHub Pagesに独自ドメインを設定する方法</a></li>
  <li>参考：<a href="https://uwazumi.honeniq.net/2018/01/14/github-pages-custom-domain.html">GitHub Pagesにカスタムドメインを設定する | ほねにくのうわずみ</a></li>
  <li>参考：<a href="http://blog.awairo.net/blog/2013/12/14/custom-domain-for-gh-pages/">GitHub Pagesで独自ドメインを使う方法 - AwAlog</a></li>
</ul>
<h2 id="xrea-サーバ側のドメイン紐付けを解除しておく"><a class="header-link" href="#xrea-サーバ側のドメイン紐付けを解除しておく"><span class="header-link-mark"></span></a>XREA サーバ側のドメイン紐付けを解除しておく</h2>
<p><code>neos21.net</code> ドメインと関わりがなくなった XREA サーバ側の設定をしておく。</p>
<ul>
  <li>XREA 管理画面の「サーバ設定」と「ドメイン設定」から、<code>neos21.net</code> と <code>www.neos21.net</code> の設定を削除する</li>
  <li>Value Domain 管理画面にて「サーバの自動更新設定」を「自動更新しない」に変更する
    <ul>
      <li>来年はもう XREA Plus (広告なし・100GB スペース) にしない。期限を迎えたら XREA Free (広告付き・1GB スペース) に戻ることになる</li>
    </ul>
  </li>
</ul>
<h2 id="xrea-サーバには-freenom-ドメインだけ割り当てておく"><a class="header-link" href="#xrea-サーバには-freenom-ドメインだけ割り当てておく"><span class="header-link-mark"></span></a>XREA サーバには Freenom ドメインだけ割り当てておく</h2>
<p>以前から <code>neo.s21.xrea.com</code> に対して割り当てていた <code>neos21.tk</code> ドメインだが、以下のように <code>www</code> の方は CNAME を使っても大丈夫だったのでこのように変更しておいた。</p>
<p>
  <img src="./26-01-02.png" alt="Freenom DNS 設定">
</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">dig</span> neos21.tk +nostats +nocomments +nocmd -t A
<span class="token punctuation">;</span>neos21.tk.                     IN      A
neos21.tk.              <span class="token number">0</span>       IN      A       <span class="token number">150.95</span>.8.121

$ <span class="token function">dig</span> www.neos21.tk +nostats +nocomments +nocmd -t CNAME
<span class="token punctuation">;</span>www.neos21.tk.                 IN      CNAME
www.neos21.tk.          <span class="token number">0</span>       IN      CNAME   neo.s21.xrea.com.

<span class="token comment"># ちなみに、Freenom DNS では NS レコードが見えないがこんなのが設定されていた</span>
$ <span class="token function">dig</span> neos21.tk +nostats +nocomments +nocmd -t NS
<span class="token punctuation">;</span>neos21.tk.                     IN      NS
neos21.tk.              <span class="token number">0</span>       IN      NS      ns01.freenom.com.
neos21.tk.              <span class="token number">0</span>       IN      NS      ns02.freenom.com.
neos21.tk.              <span class="token number">0</span>       IN      NS      ns03.freenom.com.
neos21.tk.              <span class="token number">0</span>       IN      NS      ns04.freenom.com.
ns01.freenom.com.       <span class="token number">0</span>       IN      A       <span class="token number">54.171</span>.131.39
ns02.freenom.com.       <span class="token number">0</span>       IN      A       <span class="token number">52.19</span>.156.76
ns03.freenom.com.       <span class="token number">0</span>       IN      A       <span class="token number">104.155</span>.27.112
ns04.freenom.com.       <span class="token number">0</span>       IN      A       <span class="token number">104.155</span>.29.241
</code></pre>
<p>コチラも、Apex ドメインへの反映は15分くらいで確認できたが、<code>www</code> への CNAME レコードの反映が2時間近くかかった印象。</p>
<h2 id="github-pages-へのデプロイパイプラインを調整する"><a class="header-link" href="#github-pages-へのデプロイパイプラインを調整する"><span class="header-link-mark"></span></a>GitHub Pages へのデプロイパイプラインを調整する</h2>
<p>ホスティング先の移行作業と、XREA サーバに対する後処理はコレで終わり。以降は本サイトで導入しているオレオレデプロイパイプラインを調整していく。</p>
<p>元々は、GitHub Actions にて Push 時のコミットを見て差分だけビルドして XREA サーバに FTP アップロードしていた。また、毎朝予約投稿するためにファイル内に書かれた更新日時を見て、同様に差分ビルドして FTP アップロードしていた。</p>
<p>ブログの記事数も多いし画像ファイルもあるので、毎回全量ビルドすると 500MB くらい扱うことになり無駄が多い。GitHub Pages に移行しても、差分ビルドの仕組みはそのまま活かしたかった。</p>
<p>つまりは、<code>master</code> ブランチの <code>dist/</code> ディレクトリ配下に出力されたファイルを <code>gh-pages</code> ブランチにコミットしたいが、全量ビルドしなくても差分だけ <code>git add</code> できれば良いワケだ。その方法を色々検討したので紹介する。</p>
<h3 id="ローカル環境では二重-git-cloneで対応"><a class="header-link" href="#ローカル環境では二重-git-cloneで対応"><span class="header-link-mark"></span></a>ローカル環境では「二重 <code>git clone</code>」で対応</h3>
<p>まずローカル環境で出来そうだと考えたのは、<code>dist/</code> ディレクトリ自体が<em>「<code>gh-pages</code> ブランチをチェックアウトしたローカルリポジトリ」</em>になれば良いのだろう、という手法。</p>
<ul>
  <li>参考：<a href="https://hail2u.net/blog/internet/hello-github-pages.html">GitHub Pagesへ移行した</a>
    <blockquote>
      <p>今まではrsyncでリモート・サーバーにミラーしていたのを、そのままbuildという名前のサブディレクトリーにミラーするように変える方法にした。その後常にgh-pagesブランチをチェックアウトしているbuildディレクトリーで全追加（add --all）してからコミット、そしてpushするという形で公開する。</p>
    </blockquote>
  </li>
</ul>
<p>hail2u 様で行われている作業を参考に、要はこんなことをやってみたワケだ。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># まずは普通に `master` ブランチを Clone する</span>
$ <span class="token function">git</span> clone https://github.com/Neos21/neos21.net.git
$ <span class="token builtin class-name">cd</span> ./neos21.net/
$ <span class="token builtin class-name">pwd</span>
/home/neo/neos21.net
$ <span class="token function">git</span> branch
* master

<span class="token comment"># `.gitignore` には `dist/` を書かないでいるので、ローカルのみ除外するように以下を設定する</span>
$ <span class="token builtin class-name">echo</span> <span class="token string">'dist/'</span> <span class="token operator">>></span> ./.git/info/exclude

<span class="token comment"># `gh-pages` ブランチを `dist/` ディレクトリに Clone する</span>
$ <span class="token function">git</span> clone -b gh-pages https://github.com/Neos21/neos21.net.git dist
$ <span class="token builtin class-name">cd</span> ./dist/
$ <span class="token builtin class-name">pwd</span>
/home/neo/neos21.net/dist
$ <span class="token function">git</span> branch
* gh-pages
</code></pre>
<p>Git リポジトリを Clone したディレクトリ内で、また別に Git リポジトリを Clone している。コレでローカルでは問題が起きなかった。</p>
<p>親ディレクトリで全量ビルドすれば、<code>./dist/</code> 配下にビルドされたファイルが配置される。<code>./dist/</code> ディレクトリに移動して <code>git diff</code> を確認しながら <code>gh-pages</code> ブランチに Push していけば良い。</p>
<p>手作業でファイル削除など込みでやるなら、コレでやるのが良さそうかなと思う。</p>
<h3 id="github-actions-で差分ビルドし-gh-pages-ブランチにコミットする方法"><a class="header-link" href="#github-actions-で差分ビルドし-gh-pages-ブランチにコミットする方法"><span class="header-link-mark"></span></a>GitHub Actions で差分ビルドし <code>gh-pages</code> ブランチにコミットする方法</h3>
<p>今回の移行作業のキモはココだった。</p>
<ul>
  <li><code>master</code> ブランチでは <code>./src/</code> ディレクトリのファイルを元に <code>./dist/</code> ディレクトリ配下にファイルをビルドしている</li>
  <li><code>gh-pages</code> ブランチは、<code>./dist/</code> 配下がルート直下に配置されているような状態にする</li>
</ul>
<p>ということで、<code>master</code> ブランチへの Push 時に実行される GitHub Actions では、</p>
<ul>
  <li>コレまでどおり、ファイル追加・変更された <code>./src/</code> 配下のファイルをビルドし <code>./dist/</code> に出力しておく</li>
  <li><strong>なんとかして <code>./dist/</code> 配下を退避しておきつつ、<code>gh-pages</code> ブランチに切り替える</strong></li>
  <li><code>./dist/</code> 配下のファイルを <code>gh-pages</code> ブランチに配置する (コレで、ファイル単位で発生した差分が反映できることになる)</li>
  <li><code>gh-pages</code> ブランチに対して <code>git add</code>・<code>git commit</code>・<code>git push</code> を行う</li>
</ul>
<p>といった処理を行えば良いことになる。中でも「なんとかして <code>./dist/</code> を退避して <code>gh-pages</code> ブランチに切り替える」のが難しかった。<code>git subtree</code> を使う方法とか色々出てきたが、結局以下のように作業すればなんとかなった。</p>
<ol>
  <li><code>master</code> ブランチに、コレまでどおり差分ビルドして <code>./dist/</code> 配下にファイルを配置しておく
    <ul>
      <li><code>./dist/</code> 配下に全量ビルドする必要はない</li>
      <li>どのファイルを対象にするかなどはコレまで自分が自作したスクリプトそのまま</li>
    </ul>
  </li>
  <li><code>npm install</code> コマンドで <code>package.json</code> が整形されて「ファイルの更新」差分として扱われてしまうので、元に戻しておく
    <ul>
      <li><code>$ git checkout ./package.json</code></li>
      <li>コレをやらないと、このあと <code>git checkout</code> でブランチ切替が上手くいかない (<code>-f</code> オプションで逃げても良いかも知れないが)</li>
    </ul>
  </li>
  <li><code>./dist/</code> 配下を <code>git stash</code> で退避する
    <ul>
      <li><em><code>$ git stash --include-untracked -- ./dist</code></em></li>
      <li>この時、<code>.gitignore</code> に <code>./dist/</code> の記載があると上手く Stash できないので、<em><code>.gitignore</code> には <code>dist/</code> を記載しないでおく</em></li>
    </ul>
  </li>
  <li>GitHub Actions 内では直近のコミットのみ取得しており、<code>gh-pages</code> ブランチの存在が分からなかったりするので Fetch しておく
    <ul>
      <li><code>$ git fetch origin</code></li>
    </ul>
  </li>
  <li>GitHub Actions 内でブランチを切り替えるには、以下のように書く
    <ul>
      <li><code>$ git checkout -b gh-pages --track origin/gh-pages</code></li>
      <li>全く <code>gh-pages</code> ブランチが存在しない状態では動かないので、予め <code>gh-pages</code> ブランチを生やす作業だけは手作業でやっておく</li>
    </ul>
  </li>
  <li>Stash した <code>./dist/</code> ディレクトリを復元する
    <ul>
      <li><em><code>$ git stash pop</code></em></li>
    </ul>
  </li>
  <li>復元した <code>./dist/</code> ディレクトリ内の資材を <code>./</code> 配下に置き直す
    <ul>
      <li><code>$ cp -r ./dist/* .</code></li>
      <li><code>mv</code> で何とか移せないかと試行錯誤していたが、どうにも色んなところで詰まるのでコピーにした</li>
    </ul>
  </li>
  <li><code>./dist/</code> ディレクトリやその他 <code>master</code> ブランチで使用していたファイルが「ファイルの追加」差分として残っているので、これらを削除する
    <ul>
      <li><code>$ rm -rf ./dist ./node_modules ./package-lock.json</code></li>
      <li><code>npm install</code> 時に <code>node_modules/</code> や <code>package-lock.json</code> ができていて、これらが <code>gh-pages</code> ブランチに <code>git add</code> されると死ぬので消しておく</li>
    </ul>
  </li>
  <li><code>gh-pages</code> ブランチにコミット・Push していく
    <ul>
      <li>先にコミッタの設定が必要なのでしておく</li>
      <li><code>$ git config --global user.email 'neos21@gmail.com'</code></li>
      <li><code>$ git config --global user.name 'Neos21'</code></li>
      <li><code>$ git add .</code></li>
      <li><code>$ git commit -m 'Deploy gh-pages'</code></li>
      <li><code>$ git push origin gh-pages</code></li>
      <li>GitHub Actions 内では特にトークン管理などせずとも Push できた</li>
    </ul>
  </li>
</ol>
<p><em>Git Stash を使い、ブランチ切替後に復元する</em>という手法だ。あとは <code>gh-pages</code> ブランチ内でコミットしたくないファイルを上手く除外して <code>git add</code>・<code>git commit</code> できていれば OK。</p>
<ul>
  <li>参考：<a href="https://hydrocoast.jp/index.php?Git/%E7%95%B0%E3%81%AA%E3%82%8B%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%A7%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88">Git/異なるブランチでコミット - Takuya Miyashita</a>
    <ul>
      <li>ココが大変参考になった</li>
    </ul>
  </li>
  <li>参考：<a href="https://qiita.com/KTakata/items/4a25b6e47475b73b43b6">git stash についてまとめてみた(file単位でstashしたい) - Qiita</a></li>
</ul>
<p>要は <code>master</code> ブランチにおける <code>./dist/</code> ディレクトリ配下が、<code>gh-pages</code> ブランチのルートディレクトリになるので、<code>.gitignore</code> がいなくなったりして扱いがダルくなるというワケだ。<code>gh-pages</code> ブランチ用の <code>.gitignore</code> を置いても良いのだろうけどな～、そうするかなー。</p>
<p>これらの処理を GitHub Actions YAML 内で全部シェルスクリプトで実装したのも、<code>master</code> ブランチにいる <code>./lib/</code> などの自作スクリプト群がブランチ切替によって使えなくなるためだ。</p>
<p>当初はローカル環境と同じく、<code>./dist/</code> ディレクトリ部分に <code>gh-pages</code> ブランチを Clone しようかと思ったのだが、何か微妙そうだったので止めた。</p>
<ul>
  <li>参考：<a href="https://qiita.com/broken55/items/fd2f65474243560b71eb">Github Actionsで他リポジトリをCloneする - Qiita</a></li>
  <li>参考：<a href="https://qiita.com/icoxfog417/items/5776e0f0f758f0f0e48a">リモートから特定のブランチを指定してcloneする - Qiita</a></li>
</ul>
<p>GitHub Actions 内でブランチを切り替えるにはちょっとひと手間必要だった。</p>
<ul>
  <li>参考：<a href="https://weblike-curtaincall.ssl-lolipop.jp/blog/?p=565">GitHub Pages (gh-pages) のブランチをローカルにcloneする – rilakkuma3xjapan's blog</a></li>
</ul>
<p><code>./dist/</code> 配下の全ファイルを <code>./</code> 配下に移したいところは、当初 <code>mv</code> コマンドでやろうとしていたのだが、</p>
<ul>
  <li>普通に <code>mv ./dist/* ./</code> でやろうとすると隠しファイルが対象にならない</li>
  <li>隠しファイルを対象にしようとして <code>mv ./dist/* ./dist/.[^\.]* ./</code> と書くと、隠しファイルがなかった時にエラーコードが立って GitHub Actions が中断してしまう</li>
  <li><code>find -maxdepth 1 ./dist -exec mv {} . \;</code> で <code>./dist/</code> 直下のディレクトリから <code>mv</code> しようとすると、既存ディレクトリの中身が消えるっぽく、「追加・変更があったファイルを上書きするだけ」という動きが上手くできなかった</li>
  <li><code>find -type f ./dist -exec mv {} . \;</code> だと、子階層・孫階層のファイルが「自身のフルパスから見て1階層上」へ上手く移動させられなかった</li>
</ul>
<p>などなど、つらみが増えたので、諦めて <code>cp -r</code> で全上書きして <code>./dist/</code> ディレクトリを丸ごと消す、という処理にした。シェルスクリプトってこんな簡単なことも未だにうまくできんのかいな…。頼むで…。</p>
<ul>
  <li>参考：<a href="https://linux.just4fun.biz/?%E9%80%86%E5%BC%95%E3%81%8DUNIX%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89/%E9%9A%A0%E3%81%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%82%E5%90%AB%E3%82%81cp%E3%82%84mv%E3%82%92%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">逆引きUNIXコマンド/隠しファイルも含めcpやmvをする方法 - Linuxと過ごす</a></li>
  <li>参考：<a href="https://ja.softwareuser.asklobster.com/posts/88202/linux%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%84%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E8%A6%AA%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%81%AB%E7%A7%BB%E5%8B%95%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B/">Linuxでファイルやディレクトリを親フォルダに移動するにはどうすればいいですか？</a></li>
</ul>
<p>あと、<code>gh-pages</code> ブランチへの切替はコストがかかるので、デプロイ対象のファイルがなければその処理をスキップしたい。ということで、手順 1. で差分ビルドした時に、ビルドしたファイルの情報を <code>./temp/upload.json</code> に書き出すことにした。デプロイしたいファイルが1つもなければ、このファイルは生成されない仕組み。</p>
<p>そして、ファイルの存在チェックをしてくれる <a href="https://github.com/andstor/file-existence-action">andstor/file-existence-action</a> を使ってこのファイルの存在チェックを行い、次のステップで <code>if</code> 文を書いてチェックすることにした。</p>
<p>ということで出来上がった YAML ファイルは次のとおり。</p>
<ul>
  <li><code>./.github/workflows/deploy-on-commit.yaml</code></li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy To GitHub Pages On Commit
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
    <span class="token comment"># 手動実行</span>
    <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy-on-commit</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Use Node.js
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> 14.x
      <span class="token comment"># 変更があったファイルを JSON ファイルに書き出す</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get Changed Files
        <span class="token key atrule">id</span>  <span class="token punctuation">:</span> get_changed_files
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> jitterbit/get<span class="token punctuation">-</span>changed<span class="token punctuation">-</span>files@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">format</span><span class="token punctuation">:</span> json
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Write Changed Files
        <span class="token key atrule">run</span> <span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          mkdir -p ./temp/
          echo '${{ steps.get_changed_files.outputs.added_modified }}' > ./temp/added_modified.json
          echo '${{ steps.get_changed_files.outputs.renamed }}' > ./temp/renamed.json
          echo '${{ steps.get_changed_files.outputs.removed }}' > ./temp/removed.json
          cat ./temp/added_modified.json
          cat ./temp/renamed.json
          cat ./temp/removed.json</span>
      <span class="token comment"># npm install 後、一部ファイルはビルドしておく (アップロードするかどうかは後で特定する)</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup npm
        <span class="token key atrule">run</span> <span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          npm install
          npm run clear-dist
          npm run build-css
          npm run build-feeds
          npm run build-sitemap</span>
      <span class="token comment"># JSON ファイルを基にビルドする (削除されたファイルについては扱わないので手作業する・ビルドしたファイルがあれば `./temp/upload.json` を生成する)</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Detect And Build
        <span class="token key atrule">run</span> <span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          node ./.github/workflows/deploy-on-commit.js</span>
      <span class="token comment"># ビルドしたアップロード対象ファイルのリストがあるかチェックする</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check File Exists
        <span class="token key atrule">id</span><span class="token punctuation">:</span> check_file_exists
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> andstor/file<span class="token punctuation">-</span>existence<span class="token punctuation">-</span>action@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token string">'./temp/upload.json'</span>
      <span class="token comment"># ファイルがあればそれをデプロイする</span>
      <span class="token comment"># `npm install` 時に `package.json` が整形されて差分扱いになるようなのでチェックアウトして戻しておく (コレをしないとブランチ切替に失敗する)</span>
      <span class="token comment"># `./dist/` を Stash し `gh-pages` ブランチに切替後 Pop することで、`./dist/` ディレクトリを `gh-pages` ブランチ内に復元する</span>
      <span class="token comment"># `./dist/` 配下の全ファイル (隠しファイルは含まれない) を再帰的にコピーし `./dist/` ディレクトリを削除する (ファイル移動だと上手く処理しきれなかったので諦めた)</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy To GitHub Pages
        <span class="token key atrule">if</span>  <span class="token punctuation">:</span> steps.check_file_exists.outputs.files_exists == 'true'
        <span class="token key atrule">run</span> <span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          cat ./temp/upload.json
          rm -rf ./temp
          git checkout ./package.json
          git stash --include-untracked -- ./dist
          git fetch origin
          git checkout -b gh-pages --track origin/gh-pages
          git stash pop
          cp -r ./dist/* .
          rm -rf ./dist ./node_modules ./package-lock.json
          git config --global user.email 'neos21@gmail.com'
          git config --global user.name 'Neos21'
          git add .
          git commit -m 'Deploy gh-pages'
          git push origin gh-pages</span>
</code></pre>
<p>予約投稿のための GitHub Actions についても、ほぼ同様の方法で差分のみビルドして <code>gh-pages</code> にコミット・Push している。うまく動いてくれてよかった。</p>
<h2 id="肥大化した-git-履歴を全削除した"><a class="header-link" href="#肥大化した-git-履歴を全削除した"><span class="header-link-mark"></span></a>肥大化した Git 履歴を全削除した</h2>
<p><a href="https://github.com/Neos21/neos21.net">neos21.net リポジトリ</a>全体の容量が爆増して、<code>git pull</code> に時間がかかるようになってしまったので、思い切って過去のコミットを全部削除した。もう過去には戻れない。前に前になのだ。ｗ</p>
<ul>
  <li>参考：<a href="https://cm3.hateblo.jp/entry/2016/10/25/213008">GitHub のコミット一括削除方法 - Drafts</a></li>
</ul>
<p>一般的には上述の記事のような、<code>git rebase -i</code> を使って、一部のコミットだけなかったことにするやり方があるが、今回は<strong>「最新の1コミットだけを生かす」</strong>ことにした。新規リポジトリを作って最新のファイルだけ配置したのと同じような感じのことをやる。</p>
<ul>
  <li>参考：<a href="https://qiita.com/okashoi/items/6b1a8ca9a4b001200167">git のコミット履歴をすべて消す（現時点の状態の1コミットだけにする） - Qiita</a></li>
</ul>
<p>↑ コチラが参考になった。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># `master` ブランチの最新コミットだけ生かすとする</span>
$ <span class="token function">git</span> checkout master
<span class="token comment"># `--orphan` オプションを付けると、親を共有しない独立したブランチが作れる</span>
$ <span class="token function">git</span> checkout --orphan temp-master
<span class="token comment"># 既に存在するファイルが全て Add された状態になっているので、そのままコミットする</span>
$ <span class="token function">git</span> commit -m <span class="token string">'Initial Commit'</span>
<span class="token comment"># `-B` オプションにより、既存の `master` ブランチを上書きして `temp-master` ブランチのみを引き継がせる</span>
$ <span class="token function">git</span> checkout -B master
<span class="token comment"># `temp-master` ブランチを消す</span>
$ <span class="token function">git</span> branch -d temp-master
<span class="token comment"># 1コミットだけとなった `master` ブランチを強制 Push する</span>
$ <span class="token function">git</span> push -f
</code></pre>
<p>このやり方で <code>master</code> と <code>gh-pages</code> ブランチをまっさらに作り直して今に至る。ローカル作業時もかなり速くなった。</p>
<h2 id="以上"><a class="header-link" href="#以上"><span class="header-link-mark"></span></a>以上</h2>
<p>こうして <code>neos21.net</code> ドメインは GitHub Pages で運用していくことになった。</p>
<p>XREA Plus の更新直後に実質的な利用を止めてしまう結果となったが、逆にいえばあと1年間は XREA Plus 環境が使えるので、何か試してみようかな。</p>
<p><a href="http://neo.s21.xrea.com/">http://neo.s21.xrea.com/</a> で運営してきた XREA のスペースには <a href="https://neos21.tk/">https://neos21.tk/</a> という Freenom ドメインを割り当てて HTTPS 化してあり、「Neo's World Origin」という仮題を付けてある。ドメイン違いで CGI や DB が使える環境として、何か用途を思い付けば使っていこうと思う。</p><div class="ad-general">
  <a href="https://px.a8.net/svt/ejp?a8mat=3HN0M2+AWY41E+1JUK+ZRXQP" rel="nofollow">
  <img border="0" width="300" height="250" alt="" src="https://www24.a8.net/svt/bgt?aid=211025882660&wid=001&eno=01&mid=s00000007238006009000&mc=1"></a>
  <img border="0" width="1" height="1" src="https://www18.a8.net/0.gif?a8mat=3HN0M2+AWY41E+1JUK+ZRXQP" alt="">
</div>
<div class="ad-general">
  <a href="https://px.a8.net/svt/ejp?a8mat=3HN0M2+AUKDMA+1JUK+HZ2R5" rel="nofollow">
  <img border="0" width="300" height="250" alt="" src="https://www23.a8.net/svt/bgt?aid=211025882656&wid=001&eno=01&mid=s00000007238003019000&mc=1"></a>
  <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=3HN0M2+AUKDMA+1JUK+HZ2R5" alt="">
</div>
<p>↑ A8.net に XREA と Value Domain の広告があったので貼っときます。</p>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2021-10-26</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2021-10-26</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
