<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>onion ドメインのウェブサイトを開設してみる - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2021/04/01-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="site-title"><a href="/index.html">Neo's World</a></div>
        <nav id="header-links">
          <ul>
            <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
            <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
            <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
            <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
          </ul>
        </nav>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2021/index.html">2021年</a></li>
            <li><a href="/blog/2021/04/index.html">04月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2021-04-01</time></div>
        <h1 id="page-title">onion ドメインのウェブサイトを開設してみる</h1>

<p>Tor ブラウザでのみ見られる、<em><code>.onion</code> ドメイン</em>のウェブサイト。素人でも簡単に立ち上げられるらしいので、試してみた。</p><div class="ad-rakuten">
  <div class="ad-rakuten-image">
    <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16047464%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F19763713%2F">
      <img src="https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/2414/9784781702414.jpg?_ex=128x128">
    </a>
  </div>
  <div class="ad-rakuten-info">
    <div class="ad-rakuten-title">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16047464%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F19763713%2F">ダークウェブの教科書 匿名化ツールの実践 （ハッカーの技術書） [ Cheena ]</a>
    </div>
    <div class="ad-rakuten-shop">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2Fbook%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2F">楽天ブックス</a>
    </div>
    <div class="ad-rakuten-price">価格 : 3080円</div>
  </div>
</div>
<p>環境は、OCI (Oracle Cloud Infrastructure) で借りている Ubuntu 18.04 のインスタンスにて。全て <code>root</code> ユーザで実行する。</p>
<p>まずは <code>tor</code> コマンドをインストールする。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/apt/sources.list
</code></pre>
<p>ファイルの末尾に以下2行を追加する。</p>
<ul>
  <li><code>/etc/apt/sources.list</code></li>
</ul>
<pre><code>deb https://deb.torproject.org/torproject.org bionic main
deb-src https://deb.torproject.org/torproject.org bionic main
</code></pre>
<p>リポジトリを追加したらインストールする。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc <span class="token operator">|</span> gpg --import
$ gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 <span class="token operator">|</span> apt-key <span class="token function">add</span> -

$ <span class="token function">apt</span> update
$ <span class="token function">apt</span> <span class="token function">install</span> -y tor deb.torproject.org-keyring

$ tor --version
Tor version <span class="token number">0.4</span>.5.7.
</code></pre>
<p>続いて、Tor の設定ファイルを変更し、Onion サイトとして公開するポートを選択する。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/tor/torrc
</code></pre>
<p>70行目付近に <code>HiddenServiceDir</code>・<code>HiddenServicePort</code> という項目がコメントアウトされている場所があると思うので、それをアンコメントする。</p>
<ul>
  <li><code>/etc/tor/torrc</code></li>
</ul>
<pre><code># アンコメントしながら 8099 ポートを指定する
HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 80 127.0.0.1:8099
</code></pre>
<p>今回は、ローカルの <code>8099</code> ポートで動かしているウェブサーバを Onion サイトとして公開することにする。</p>
<p>配信するサイト、ウェブサーバは Python なんかで作っても良い。自分は慣れている Node.js で、超簡単なウェブサーバを作ってみる。</p>
<pre class="language-bash"><code class="language-bash">$ node -v
v14.8.0

<span class="token comment"># 適当な作業ディレクトリを作る</span>
$ <span class="token function">mkdir</span> ~/onion-site <span class="token operator">&#x26;&#x26;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$_</span>

<span class="token comment"># 8099 ポートで、固定の HTML を返すサーバを立てる</span>
$ <span class="token function">cat</span> <span class="token operator">&#x3C;&#x3C;</span> <span class="token string">EOL<span class="token bash punctuation"> <span class="token operator">></span> index.js</span>
const http = require('http');

const server = http.createServer((request, response) => {
  response.writeHead(200, { 'Content-Type': 'text/html; charset=UTF-8' });
  response.end(<span class="token variable"><span class="token variable">`</span><span class="token operator">&#x3C;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&#x3C;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">"ja"</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
    <span class="token operator">&#x3C;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span>title<span class="token operator">></span>Neo<span class="token string">'s Onion Web&#x3C;/title>
  &#x3C;/head>
  &#x3C;body>
    &#x3C;h1>Neo'</span>s Onion Web<span class="token operator">&#x3C;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>
    <span class="token operator">&#x3C;</span>p<span class="token operator">></span>Go To <span class="token operator">&#x3C;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"https://neos21.net/"</span><span class="token operator">></span>Neo's World <span class="token punctuation">(</span>https://neos21.net/<span class="token punctuation">)</span><span class="token operator">&#x3C;</span>/a<span class="token operator">></span>.<span class="token operator">&#x3C;</span>/p<span class="token operator">></span>
  <span class="token operator">&#x3C;</span>/body<span class="token operator">></span>
<span class="token operator">&#x3C;</span>/html<span class="token operator">></span>
<span class="token variable">`</span></span>);
});

server.listen(8099);
EOL</span>

<span class="token comment"># ウェブサーバをバックグラウンドで起動する</span>
$ <span class="token function">nohup</span> node ./index.js <span class="token operator">&#x26;</span>

<span class="token comment"># 8099 ポートでウェブサーバが公開できているか念のため確認する</span>
$ <span class="token function">curl</span> http://localhost:8099/
</code></pre>
<p>コレで良い感じ。</p>
<p>それではいよいよ、Tor を起動する。参考文献では <code>systemctl</code> や <code>service</code> で制御しているところもあったのだが、自分が試した限りだと <code>systemctl</code> での操作では上手くいかなかった。直接 <code>tor</code> コマンドを叩くことにする。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Tor をバックグラウンドで起動する</span>
$ <span class="token function">nohup</span> tor <span class="token operator">&#x26;</span>
</code></pre>
<p>初回起動時に、<code>HiddenServiceDir</code> で指定したディレクトリ配下に、鍵ペアやホスト名を記したファイルなどが生成される。自分の Onion サイトがどんなドメインで公開されているか調べるには次のように叩く。</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">cat</span> /var/lib/tor/hidden_service/hostname
e3lk3ai76feupwwk47bxuwwi2hjr53xilprczxwk3ubkuffxlhfzrayd.onion
</code></pre>
<p>ランダムな文字列で、末尾が <code>.onion</code> となっている。ちなみに Facebook の Onion 版なんかは、鍵ペアをブルートフォースで生成しまくって、<code>facebook</code> な綴りが登場するドメインをなんとか作り上げてることでも有名。</p>
<p>サーバサイドでの作業はココまで。</p>
<p>続いて、クライアントからこの Onion サイトを見てみる。Chocolatey を使って、Windows マシンに Tor ブラウザをインストールしてみた。</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Tor Browser をインストールして検証する</span>
<span class="token function">PS</span>> choco install tor<span class="token operator">-</span>browser <span class="token operator">-</span>y
</code></pre>
<p>Tor ブラウザは Firefox ベースで、使い心地は普通。先程確認したドメインにアクセスしてみよう。</p>
<ul>
  <li><a href="http://e3lk3ai76feupwwk47bxuwwi2hjr53xilprczxwk3ubkuffxlhfzrayd.onion/">http://e3lk3ai76feupwwk47bxuwwi2hjr53xilprczxwk3ubkuffxlhfzrayd.onion/</a>
    <ul>
      <li>実際に上の作業で公開している自分の Onion サイト。何も内容はないし、いつか消すかも</li>
    </ul>
  </li>
</ul>
<p>
  <img src="01-01-01.png" alt="実際の様子">
</p>
<p>ちゃんとアクセスできた。</p>
<p>なお、クラウドサービスのファイアウォール設定 (Security List とか Security Group とか) で、8099 ポートは開放しなくて良い。IP 直打ちではアクセスできないことを確認。ちゃんと Hidden Service を経由していて、Tor でのみ閲覧できるサイトになった。</p><div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/4781702414?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51K7Kyb7XOL._SL160_.jpg" width="113" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/4781702414?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">ダークウェブの教科書 匿名化ツールの実践 (ハッカーの技術書)</a>
    </div>
  </div>
</div>
<ul>
  <li>参考：<a href="https://www.youtube.com/watch?v=GVMjk9pj2Cw">Host Your Own Tor Hidden Service with an Onion Address Tutorial - YouTube</a></li>
  <li>参考：<a href="https://milestone-of-se.nesuke.com/product/oss/construct-tor-site-with-ubuntu/amp/">【ダークウェブ構築】EC2のUbuntuでtor Hidden Service (.onion) サイトを構築する | SEの道標</a></li>
  <li>参考：<a href="https://qiita.com/charichuma_hack/items/ba3fc74f73f1929ef50b">onionドメインのサーバを建ててみた - Qiita</a></li>
  <li>参考：<a href="http://epcnt19.hatenablog.com/entry/2017/04/16/200745">onionアドレスの生成 - 断片</a></li>
  <li>参考：<a href="https://2019.www.torproject.org/docs/debian.html.en">Tor Project: Debian/Ubuntu Instructions</a></li>
</ul>

      </main>
      <footer id="footer">
        <div id="date-time">
          <dl>
            <dt>Created</dt>
            <dd><time>2021-04-01</time></dd>
            <dt>Last-Modified</dt>
            <dd><time>2021-04-01</time></dd>
          </dl>
        </div>
        <nav id="footer-links">
          <ul>
            <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
            <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
            <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
            <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
          </ul>
        </nav>
        <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
      </footer>
    </div>
  </body>
</html>
