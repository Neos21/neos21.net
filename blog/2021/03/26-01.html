<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0990d0">
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="AvoEr3mUJFF2H_mPWWgShfmjBVP3ywRpyx9hxeeq2d4">
    <title>Node.js アプリから Heroku Postgres に接続できなくなったので SSL 通信設定を直す - Neo's World</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://neos21.net/blog/2021/03/26-01.html">
    <link rel="search" type="application/opensearchdescription+xml" title="neos21.net" href="/opensearch.xml">
    <link rel="alternate" type="application/atom+xml" href="/feeds.xml">
    <link rel="author" href="http://www.hatena.ne.jp/neos21/">
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMHFLZP1M1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-YMHFLZP1M1');gtag('config','UA-106501-1');</script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6475907504235292" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="container">
      <header id="header">
        <div id="header-brand">
          <div id="header-brand-contents">
            <div id="site-title"><a href="/index.html">Neo's World</a></div>
            <nav id="header-links">
              <ul>
                <li id="header-link-about"><a href="/about/index.html" title="About"><span>About</span></a></li>
                <li id="header-link-search"><a href="/about/search.html" title="Search"><span>Search</span></a></li>
                <li id="header-link-feeds"><a href="/feeds.xml" title="Feeds"><span>Feeds</span></a></li>
                <li id="header-link-to-bottom"><a href="#footer" title="To Bottom"><span>▼ To Bottom</span></a></li>
              </ul>
            </nav>
          </div>
        </div>
        <nav id="global-nav">
          <ul>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/tech/index.html">Tech</a></li>
            <li><a href="/music/index.html">Music</a></li>
            <li><a href="/games/index.html">Games</a></li>
            <li><a href="/gallery/index.html">Gallery</a></li>
            <li><a href="/etc/index.html">Etc.</a></li>
          </ul>
        </nav>
        <nav id="path">
          <ul>
            <li><a href="/index.html">Neo's World</a></li>
            <li><a href="/blog/index.html">Blog</a></li>
            <li><a href="/blog/2021/index.html">2021年</a></li>
            <li><a href="/blog/2021/03/index.html">03月</a></li>
          </ul>
        </nav>
      </header>
      <main id="main">
        <div id="header-date"><time>2021-03-26</time></div>
        <h1 id="page-title">Node.js アプリから Heroku Postgres に接続できなくなったので SSL 通信設定を直す</h1>

<p>拙作の <a href="https://github.com/Neos21/neos-hatebu">Neo's Hatebu</a> は、Heroku 上で稼動させている Angular + Express.js アプリだ。データ永続化に <em>Heroku Postgres</em> を使用しており、Express.js からは Sequelize という O/R マッパーを利用して接続している。</p><div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/B07VVQSZXD?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51O+aaOfA2L._SL160_.jpg" width="127" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/B07VVQSZXD?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">PostgreSQL徹底入門 第4版 インストールから機能・仕組み、アプリ作り、管理・運用まで</a>
    </div>
  </div>
</div>
<div class="ad-rakuten">
  <div class="ad-rakuten-image">
    <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16006399%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F19715671%2F">
      <img src="https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/0436/9784798160436.jpg?_ex=128x128">
    </a>
  </div>
  <div class="ad-rakuten-info">
    <div class="ad-rakuten-title">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F16006399%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2Fi%2F19715671%2F">PostgreSQL徹底入門 第4版 インストールから機能・仕組み、アプリ作り、管理・運用まで [ 近藤 雄太 ]</a>
    </div>
    <div class="ad-rakuten-shop">
      <a href="https://hb.afl.rakuten.co.jp/hgc/g00q0722.waxyc9ff.g00q0722.waxyd017/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2Fbook%2F&amp;m=http%3A%2F%2Fm.rakuten.co.jp%2Fbook%2F">楽天ブックス</a>
    </div>
    <div class="ad-rakuten-price">価格 : 3608円</div>
  </div>
</div>
<p>2021-03-17 頃、いつものようにこのアプリにログインしようとすると、次のようなエラーメッセージが表示されてしまった。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"normalizedNames"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"lazyUpdate"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
  <span class="token property">"statusText"</span><span class="token operator">:</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span>
  <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://neos-hatebu.herokuapp.com/login"</span><span class="token punctuation">,</span>
  <span class="token property">"ok"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"HttpErrorResponse"</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Http failure response for https://neos-hatebu.herokuapp.com/login: 401 Unauthorized"</span><span class="token punctuation">,</span>
  <span class="token property">"error"</span><span class="token operator">:</span> <span class="token string">"Unauthorized"</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>401 Unauthorized</code> とな。</p>
<p>Heroku 管理画面の「View logs」で動作中のアプリログを見てみると、<strong><code>no pg_hba.conf entry for host ...</code></strong> といったエラーログが見えた。</p>
<p>調べてみると以下に当たった。</p>
<ul>
  <li>参考：<a href="https://help.heroku.com/DR0TTWWD/seeing-fatal-no-pg_hba-conf-entry-errors-in-postgres">Seeing "FATAL: no pg_hba.conf entry" errors in Postgres - Heroku Help</a>
    <ul>
      <li>
        <blockquote>
          <p>The authentication failed because the connection didn't use SSL encryption: (<code>SSL off</code>). ]All Heroku Postgres production databases require using SSL connections](<a href="https://devcenter.heroku.com/articles/heroku-postgresql#heroku-postgres-ssl">https://devcenter.heroku.com/articles/heroku-postgresql#heroku-postgres-ssl</a>) to ensure that communications between applications and the database remain secure. If your client is not using SSL to connect to your database, you would see these errors even if you're using the right credentials to connect to it.</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>参考：<a href="https://devcenter.heroku.com/articles/heroku-postgresql#connecting-in-node-js">Heroku Postgres | Heroku Dev Center</a></li>
</ul>
<p>公式のガイドでは次のようなコードを載せている。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Client</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  connectionString<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span>
  ssl<span class="token operator">:</span> <span class="token punctuation">{</span>
    rejectUnauthorized<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>ssl.rejectUnauthorized</code> とかいうプロパティを付けている。コレを Sequelize でも渡してやれば良いのかな？Sequelize は内部的に <code>pg</code> パッケージを使っているので、何らか渡し方がありそうだ。</p>
<p>調べてみると、あった。</p>
<ul>
  <li>参考：<a href="https://stackoverflow.com/questions/25000183/node-js-postgresql-error-no-pg-hba-conf-entry-for-host">Node.js, PostgreSQL error: no pg_hba.conf entry for host - Stack Overflow</a>
    <blockquote>
      <p>Include in config when initialize <code>new Sequelize(...)</code></p>
    </blockquote>
  </li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  database<span class="token operator">:</span> <span class="token string">"DB"</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"pass"</span><span class="token punctuation">,</span>
  host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>
  dialect<span class="token operator">:</span> <span class="token string">"postgres"</span><span class="token punctuation">,</span>
  dialectOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    ssl<span class="token operator">:</span> <span class="token punctuation">{</span>
      require<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// This will help you. But you will see nwe error</span>
      rejectUnauthorized<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// This line will fix new error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
  <li>参考：<a href="https://github.com/sequelize/sequelize/issues/956">Can't use SSL with Postgres · Issue #956 · sequelize/sequelize</a></li>
</ul>
<p>Sequelize の <code>dialectOptions</code> という隠しオプションを使うと、裏にいる <code>pg</code> パッケージに直接このオプションを渡せるようだ。<code>ssl.rejectUnauthorized</code> を <code>false</code> にする他、<code>ssl.require: true</code> を渡すことで確実に SSL 通信にするみたい。</p>
<p>そういえば、環境変数 <code>PGSSLMODE</code> は既に <code>allow</code> にしていて、コレは <code>require</code> にしなくても大丈夫だった。文献には <code>no-verify</code> を使う、みたいな記事もあったんだけど、とりあえず <code>allow</code> のままにした。</p>
<p>…ということで、自分のアプリ内だと以下のコード修正のみで対応が完了した。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token maybe-class-name">Sequelize</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> connectionString <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  timezone<span class="token operator">:</span> <span class="token string">'+09:00'</span><span class="token punctuation">,</span>  <span class="token comment">// JST タイムゾーン : Sequelize で SELECT すると全て UTC の ISO 形式になっており DB 上の記録と異なる</span>
  logging<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// ログ出力</span>
  <span class="token comment">// SSL 接続のため指定する (↓ 以下を追加した)</span>
  dialect<span class="token operator">:</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
  dialectOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    ssl<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    rejectUnauthorized<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>既存コードからの変更点は <code>dialect</code> と <code>dialectOptions</code> プロパティを追加したのみだ。ローカルで Express.js サーバを動かして Heroku Postgres に接続することも出来たし (別途 CORS 設定のみしておいた)、このコードを Heroku にデプロイすることで、正常に Heroku Postgres に接続できるようになった。</p>
<p>なお、接続時に次のようなワーニングメッセージが出力されるが、無視している。<code>rejectUnauthorized: false</code> にしてるじゃん…？ｗ</p>
<pre><code>(node:23) DeprecationWarning: Implicit disabling of certificate verification is deprecated and will be removed in pg 8. Specify `rejectUnauthorized: true` to require a valid CA or `rejectUnauthorized: false` to explicitly opt out of MITM protection.
</code></pre>
<p>とりあえず問題は解消したんだけど、どうして数年間上手く動いていたのに、今回突然こんなことになったのかな？と思って、<em>Heroku の Change Log</em> を追ってみた。</p>
<ul>
  <li>参考：<a href="https://devcenter.heroku.com/changelog-items/2035">All Heroku Postgres client connections require SSL | Heroku Dev Center</a>
    <ul>
      <li>
        <blockquote>
          <p>Change effective on 23 February 2021</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>
<p>2月23日に変更が反映されていくモノ、として Heroku Postgres への SSL 接続が必須になったようだが、自分が利用している Free プランは、3月17日までこの変更が反映されていなかったのか、のらりくらりとやり過ごせていたようだ。</p>
<p>以上。エンジニアだけど、SSL めんどくせーって思いしかない。ｗ</p>
<ul>
  <li>参考：<a href="https://qiita.com/p-t-a-p-1/items/575377c577a993e1ead0">HerokuのPostgreSQLにSSL接続する - Qiita</a></li>
  <li>参考：<a href="https://www.i-ryo.com/entry/2020/10/27/183001">【Express】HerokuのPostgreSQLのデータを表示する - クモのようにコツコツと</a></li>
</ul><div class="ad-amazon">
  <div class="ad-amazon-image">
    <a href="https://www.amazon.co.jp/dp/4798059315?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">
      <img src="https://m.media-amazon.com/images/I/51Gq2-8PNOL._SL160_.jpg" width="124" height="160">
    </a>
  </div>
  <div class="ad-amazon-info">
    <div class="ad-amazon-title">
      <a href="https://www.amazon.co.jp/dp/4798059315?tag=neos21-22&amp;linkCode=osi&amp;th=1&amp;psc=1">個人開発のための Webサービス公開マニュアル</a>
    </div>
  </div>
</div>

      </main>
      <footer id="footer">
        <div id="footer-contents">
          <div id="date-time">
            <dl>
              <dt>Created</dt>
              <dd><time>2021-03-26</time></dd>
              <dt>Last-Modified</dt>
              <dd><time>2021-03-26</time></dd>
            </dl>
          </div>
          <nav id="footer-links">
            <ul>
              <li id="footer-link-about"><a href="/about/index.html" title="About">About</a></li>
              <li id="footer-link-search"><a href="/about/search.html" title="Search">Search</a></li>
              <li id="footer-link-feeds"><a href="/feeds.xml" title="Feeds">Feeds</a></li>
              <li id="footer-link-github"><a href="https://github.com/Neos21/" title="GitHub">GitHub</a></li>
            </ul>
          </nav>
          <nav id="to-top"><a href="#" title="To Top"><span>▲ To Top</span></a></nav>
        </div>
      </footer>
    </div>
  </body>
</html>
